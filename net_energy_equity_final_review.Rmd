---
title: A measurement strategy to address disparities across household energy burdens
subtitle: 
titlerunning: Net Energy Equity
authorrunning: Scheier & Kittner
# thanks:
author:
 - Eric Scheier:
     institute: [emergi, e3p]
 - name: Noah Kittner
   email: kittner@unc.edu
   institute: [e3p, gillings, planning]
   correspondence: true
institute:
 - emergi: Emergi Foundation, Carrboro, NC, USA
 - e3p: Environment, Ecology, and Energy Program, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
 - gillings: Department of Environmental Sciences and Engineering, Gillings School of Global Public Health, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
 - planning: Department of City and Regional Planning, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
keywords:
  - energy burden
  - net energy
  - macro-energy systems
  - energy inequality
bibliography: references.bib
bibstyle: spphys
csl: nature-no-et-al.csl
journalname: Nature Energy
date: "`r format(Sys.time(), '%d %B %Y')`"
toc: false
output:
  bookdown::pdf_document2:
    number_sections: false
    keep_tex: true
    documentclass: article
    pandoc_args:
      - '--lua-filter=color-text.lua'
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
    includes:  
      in_header: preamble-latex.tex
  bookdown::html_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=color-text.lua'
  bookdown::word_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=color-text.lua'
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
  bookdown::pdf_book:
    base_format: rticles::springer_article
    keep_tex: true
tables: true
fig_caption: true
always_allow_html: true
header-includes:
- \usepackage{booktabs}
# - \usepackage[left]{lineno}
# - \linenumbers
- \usepackage{setspace}
- \usepackage{xcolor}
- \usepackage{mathtools}
- \usepackage[normalem]{ulem}
- \usepackage{float}
# - \doublespacing
- \usepackage{color}
- \usepackage{soul}
- \definecolor{lightblue}{rgb}{0.90, 0.95, 1}
- \definecolor{fancycolor}{rgb}{0.258, 0.517, 0.960}
- \sethlcolor{fancycolor}
- \usepackage{caption}
---

```{r setup, include=FALSE}
is_final=FALSE #TRUE
is_preview= TRUE #FALSE
is_draft= TRUE
set.seed(456)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','asis')),
                      fig.keep='all', #'last'
                      dev='cairo_pdf',#'pdf',
                      fig.show='hold',#'hide
                      # fig.pos = "!H",
                      # out.extra = "",
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=TRUE, #ifelse(is_draft, TRUE, ifelse(is_preview, TRUE, !is_final)),
                      cache.lazy=FALSE,
                      fig.margin=FALSE,
                      fig.fullwidth=TRUE, #FALSE
                      eval.after = "fig.cap"#,
                      # cache.path = 'net_energy_equity_cache/', 
                      # fig.path = 'net_energy_equity_files/'
                      )

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 
    "latex" else "pipe"
})

edit_color = "black" #"red" #"black
strike_show = "hide" #"show" #"hide"
hide = "FALSE" #"TRUE" #
highlight = "FALSE" #"TRUE" #"FALSE"
```

```{r option-view, include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)

# knitr::opts_current$get(c(
#   "cache",
#   "cache.path",
#   "cache.rebuild",
#   "dependson",
#   "autodep"
# ))

kable(knitr::opts_chunk$get() %>% enframe())
```


```{r sources, cache=FALSE}
source("sources.R")
```

```{r parameters}
states <- "all" #c("ca","nc","sc") #
refresh <- FALSE
acs_version <- 2018
energy_burden_poverty_line <- 0.06
# geographic_scope <- "tract" #statecitycounty
```

```{r run-methods, cache=TRUE}
paper_methods(states=states,
              acs_version=acs_version,
              energy_burden_poverty_line=energy_burden_poverty_line,
              refresh=refresh)
```


```{r preprocessing}
source("paper_source.R")
```

```{r}
# Things in here should probably be moved further up the data processing pipeline
# clean_data_ami$number_of_units <- as.factor(ifelse(clean_data_ami$min_units > 1, "mf", "sf"))
# clean_data_fpl$number_of_units <- as.factor(ifelse(clean_data_fpl$min_units > 1, "mf", "sf"))
```




\newpage

**Abstract: [Energy inequity is an issue of increasing urgency. Few policy-relevant datasets evaluate the energy burden of typical American households. Here, we develop a framework using Net Energy Analysis and household socioeconomic data to measure systematic energy inequity among critical groups that need policy attention. We find substantial instances of energy poverty in the United States -- `r scales::percent(energy_poverty_rate, accuracy=1)` of households experience energy poverty as presently defined as spending more than `r to_percent(energy_burden_poverty_line)` of household income on energy expenditures and more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` households above the Federal Poverty Line face energy poverty, disproportionately burdening Black, Hispanic, and Native American communities. For solar, wind, and energy efficiency to address socioeconomic mobility, programs must reduce energy expenditures by expanding eligibility requirements for support and access to improved conservation measures, efficiency upgrades, and distributed renewables. We recommend the United States develop a more inclusive federal energy poverty categorization that increases assistance for household energy costs.]{highlight=`r highlight`}**

## [Introduction]{highlight=`r highlight`}

Household energy use for services such as cooking[@mobarakLowDemandNontraditional2012] or space heating and cooling[@limaReviewRelationHousehold2020] is crucial for decent living conditions[@raoEnergyRequirementsDecent2019]. Unaffordable energy is a persistent trend[@brownPersistenceHighEnergy2020] that is negatively related to social cohesion, climate change responses, and disproportionate environmental impacts on low-income populations and minority groups [@carleyJusticeEquityImplications2020]. [Furthermore, e]{color=`r edit_color`}nergy inequity is not just a lack of money to meet basic energy needs - it is a lack of [access to the capabilities[@dayConceptualisingEnergyUse2016] that]{color=`r edit_color`} enable a sustainable and prosperous society built on just principles[[@sovacoolEnergyJusticeConceptual2015]]{color=`r edit_color`}. Energy inequity could have significant implications for navigating sustainable development and meeting societal goals around decarbonization and energy use. [In this study, we demonstrate the magnitude of energy inequity in the United States (US) using a metric informed by Net Energy Analysis (NEA). Without a set of inclusive indicators and data tools to examine energy inequity, many households that are at risk of energy poverty and injustice may remain unidentified. This analysis applies lessons from NEA to address energy poverty in the US.]{color=`r edit_color`}

[Many frameworks are currently being explored to understand energy poverty and equity, while differentiating between related concepts. In a thematic exploration of energy equity, Brown et al. identify energy access, energy poverty, energy insecurity, and energy burden as key concepts for understanding the issue[@brownLowincomeEnergyAffordability2020], but quantitative measurement of these concepts has been limited. Pachauri & Rao establish measures for the sustainable development context that incorporate periods when energy is available, the quality of voltage supplied, the reliability in terms of the number of disruptions, the capacity in terms of power available, the consumption levels allowed per day, and affordability of the standard consumption package as a percentage of household income[@pachauriAdvancingEnergyPoverty2020]. Energy metrics have been assessed quantitatively across several countries. Though some aspects, such as formal disconnections from energy service[@graffWhichHouseholdsAre2021], are translatable to the US context, these methods require normalizing many variables amongst different types of data and are overly broad for applications in areas where electricity access is relatively high and reliable.]{color=`r edit_color`}

[Of such areas, the United Kingdom (UK) has a richer history of incorporating energy poverty formally into its government programs: since 2000, the UK has used some form of an energy burden metric to assess whether households are facing energy poverty and determine the level of support that they require as a result[@bednarRecognitionResponseEnergy2020]. This metric has evolved from a simple ratio of household income and energy expenditures to one that incorporates building efficiency ratings and average incomes in the community. While the European Union (EU) currently lacks a unified metric for energy poverty, similar metrics have been developed in member countries, such as a metric which compares incomes and expenditures to local averages and absolute heating needs to determine energy poverty levels in Italy[@faiellaEnergyPovertyHow2021] or a multidimensional index of building quality and ability to pay bills in Poland[@sokolowskiMultidimensionalIndexMeasure2020].]{color=`r edit_color`}

Prior research of household prosperity in limited global jurisdictions [using these sorts of measures]{color=`r edit_color`} has found that gender, age, housing age[@rossHighCostEnergy2018], tenure type[@mayerTwoFacesEnergy2014], energy inefficiency[@drehoblUSLowIncomeEnergy2016], education, employment[@linAffordabilityAccessFocus2018], geography[@linDoesEnergyPoverty2020], socioeconomic status[@bednarIntersectionEnergyJustice2017], race/ethnicity[@tongMeasuringSocialEquity2021], and macroeconomic conditions[@kawaiSpendingHouseholdEnergy2021] are associated with high energy burdens in various geographical areas. [The US lags in part due to a lack of metrics and tracking, and this paper develops a tool to show how net energy is a valuable resource to evaluate energy burden and inequality.]{color=`r edit_color`}

In the US, energy inequity is a significant challenge as families struggle to meet monthly bills and live paycheck to paycheck[@bednarRecognitionResponseEnergy2020]. There is a growing disparity between wealthier and lower-income households based on their abilities to meet basic energy needs[@brownLowincomeEnergyAffordability2020]. While per-unit residential energy prices have increased below the rate of inflation in the [US]{color=`r edit_color`} since the 1980s[@unitedstatesenergyinformationadministrationShortTermEnergyOutlook2021], many households still struggle to make utility bill payments and are especially vulnerable to economic shocks[@kawaiSpendingHouseholdEnergy2021].

[Ross and Drehobl performed distinct urban[@drehoblUSLowIncomeEnergy2016] and rural[@rossHighCostEnergy2018] analyses to describe energy inequity in the US. While limited by geographic and demographic focus and a lack of peer-review, these studies have established the proportion of income (*G*) spent on energy expenditures (*S*), or energy burden (*E~b~*), as the standard benchmark for energy poverty in the US today (Equation 1).]{color=`r edit_color`} [The US Department of Energy (DOE) significantly improved upon Ross and Drehobl's underlying methodology by assembling its Low-Income Energy Affordability Dataset (LEAD)[@maLowIncomeEnergyAffordability2019], which estimates incomes and energy expenditures for most households in the US at a census tract scale.]{color=`r edit_color`}

\begin{align}
Energy\ Burden\ (E_{b})= \frac{S}{G}
\end{align}

[[Therefore, stakeholders relying solely on energy burden have limited knowledge of which historical interventions have effectively promoted the energy system's success and a limited ability to design new interventions to promote community growth and address inequity in the energy system. ]{strike=`r strike_show`}]{color=`r edit_color`}NEA offers potential support to understanding energy equity through the use of formally defined Energy Return Ratios (ERRs) like *E~b~* that articulate the relationships among energy flows within complex systems[[[@carbajales-daleBetterCurrencyInvesting2014]. The properties of numerous metrics have been explored through this lens to date]{strike=`r strike_show`}]{color=`r edit_color`}[@brandtGeneralMathematicalFramework2011]. Net Energy Return (NER), which describes the newly released potential to do work as a result of some activity, is recommended as a basis for future analysis[@carbajales-daleBetterCurrencyInvesting2014], especially in the study of macro-energy systems like the US residential housing stock[@leviMacroEnergySystemsNew2019]. [[Treating the income remaining after energy expenditures (i.e., net income) as the focus of analysis to avoid the double-counting of energy expenditures, and portray net income as a result of energy consumption rather than a cause.]{strike=`r strike_show`}]{color="red"}

Here, we examine the relationship between energy spending and household energy income and observe spatial disparities across a census-tract scale—particularly across race and ethnicity, income, housing tenure, and educational attainment. A difference of $500 in annual energy expenditures dramatically improves many middle and high-income households’ ability to enjoy benefits from energy services for low cost (2-5% of annual income), but basic energy expenditures comprise approximately 14% of annual earnings for low-income households. The categorizations for federal assistance programs that are based on poverty line indices fail to capture at least 5.3 million households that would benefit from energy support and assistance. Households in communities of color experience energy poverty at a rate 60% greater than those in white communities based on this study. Additionally, state-level analysis demonstrates wider spatial disparities across states such as Maine, where residential heating oil and fuelwood remain common heat energy sources and states such as Alabama and Mississippi which have among the lowest net energy returns on average. This empirical analysis fills a gap in the current discussion about energy equity by providing a framework to evaluate disparities and include more households in energy poverty metrics that are aligned with the assessment of energy flows through biological, physical, and economic systems.

## [Results]{highlight=`r highlight`}

#### Applying Net Energy Return to Energy Equity  {#ratios}

```{r metric-comparison-data}
eb_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% 
                                            mutate(energy_burden = round(100*energy_burden,digits=1)),
                                          group_columns = c("energy_burden","income_bracket"), 
                                          metric_name="net_income", 
                                          metric_cutoff_level = energy_burden_poverty_line) %>% 
  mutate(metric_name="Energy Burden (%)") %>% 
  rename(energy_metric=energy_burden) #%>% 
  # mutate(energy_metric=100*energy_metric)

ner_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% mutate(ner = round(ner,digits=0)), 
                                     group_columns = c("ner","income_bracket"), 
                                     metric_name="net_income", 
                                     metric_cutoff_level = ner_poverty_line) %>% 
  mutate(metric_name="Net Energy Return ($/$)") %>% rename(energy_metric=ner)

comparison_chart_data <- rbind(eb_chart_data,ner_chart_data)

metric_comparison_net_income_lbound <- -1000
metric_comparison_net_income_ubound <- 6*10^4
metric_comparison_x_axis_lbound <- -10
metric_comparison_x_axis_ubound <- 400
metric_comparison_pct <- sum(comparison_chart_data$household_count[
  comparison_chart_data$energy_metric <= metric_comparison_x_axis_ubound & 
    comparison_chart_data$energy_metric >= metric_comparison_x_axis_lbound & 
    comparison_chart_data$metric_mean <= metric_comparison_net_income_ubound & 
    comparison_chart_data$metric_mean >= metric_comparison_net_income_lbound & 
    !is.na(comparison_chart_data$metric_mean) & 
    is.finite(comparison_chart_data$metric_mean)]) / 
  sum(comparison_chart_data$household_count)

comparison_chart <- comparison_chart_data %>% 
  ggplot(aes(x=energy_metric, y=metric_mean, fill=income_bracket, color=income_bracket)) +
  # scale_x_continuous(trans=scales::pseudo_log_trans(base = 10)) +
  scale_y_continuous(labels=scales::dollar_format()) + 
  ggrastr::rasterise(geom_point(aes(size=household_count), 
                                alpha=0.25, 
                                position="jitter")) + 
  scale_fill_discrete(name="Income Bracket") + 
  scale_color_discrete(name="Income Bracket") + 
  scale_size_continuous(name="Households", labels=scales::label_comma()) + 
  # geom_hline(yintercept = .1) + 
  # geom_vline(xintercept = 9) + 
  # geom_smooth(method="lm",#NULL,#
  #             mapping=aes(weight=household_count),
  #             # formula=y~,
  #             se=FALSE,
  #             fullrange=TRUE,
  #             linetype="solid",
  #             alpha=0.75
  #             ) + 
  facet_grid(cols=vars(metric_name), switch="x", scales="free_x") +#, space="free_x") + 
  theme_bw() +
  labs(title = "Energy Burden and Net Energy Return in United States Households", 
       x="Energy Metric", 
       y="Household Annual Net Income ($)") + 
  theme(legend.position = c(.3,.6),
        legend.background = element_rect(fill = "#ffffffaa", colour = NA), 
        legend.key.size = unit(10, "points")#,
        # legend.justification = c(0, 0)
        )+
  coord_cartesian(#xlim=c(0,120),
               ylim=c(metric_comparison_net_income_lbound,
                      metric_comparison_net_income_ubound),
               xlim=c(metric_comparison_x_axis_lbound,
                      metric_comparison_x_axis_ubound),
               # default=FALSE,
               expand=TRUE)
```

[The main contribution of the study is the application of NER as an indicator of household energy poverty by utilizing a set of energy burden metrics based on NER to represent the disparity across those who face significant energy burdens in the US with those who do not. NER displays critical thresholds where more households face energy and income challenges.]{highlight=`r highlight`}

The [NER]{color=`r edit_color`} of a process is a relationship between the gross amount of energy extracted and the amount of embodied energy directed toward extraction[@brandtCalculatingSystemsscaleEnergy2013]. [For households extracting income from the economy, these ratios can be composed of gross income (*G*) and spending on energy (*S*)]{color=`r edit_color`}.

[Household NER (*N~h~*)]{color=`r edit_color`} represents the net earnings a household receives for every expenditure on secondary energy, defined according to Equation 2.

\begin{align}
Household\ Net\ Energy\ Return\ (N_{h}) = \frac{G - S}{S}
\end{align}

The NER is the standard metric of NEA because it reflects the role of energy as an input to a value-generating process in ecosystems[@brandtHowDoesEnergy2017]. *E~b~* is the metric of choice in the energy insecurity literature due to its [presumed]{color=`r edit_color`} interpretability as a percentage[@rossHighCostEnergy2018]^,^ [@bednarIntersectionEnergyJustice2017]^,^ [@drehoblUSLowIncomeEnergy2016]^,^ [@kawaiSpendingHouseholdEnergy2021]

While most [ERRs]{color=`r edit_color`}, including NER, are hyperbolic paraboloids, NER has several useful mathematical properties: it can smoothly handle systems with negative incomes and energy costs, accept households with zero income, and emphasize extreme incomes and energy costs in an interpretable fashion, as shown in Figure \@ref(fig:metric-comparison). [While *E~b~* appears inversely correlated to income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes (approximately n=`r to_big(round(clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum(),-3))` households in the dataset have *E~b~*>100% or *E~b~*<0%). Due to the structure of the *E~b~* equation (Equation 1), the *E~b~* of these households approaches infinity and cannot be captured on the standard 0-100% scale the metric is intended to be interpreted within: around `r to_big(round(clean_data_fpl$households[!is.finite(clean_data_fpl$energy_burden)] %>% sum(),-3))` homes have an infinite energy burden. Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. *N~h~* provides a framing of the same dataset that allows for exploration of most households on a similar scale without the long tail. *N~h~* appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing *N~h~* avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, *N~h~* offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent. Many households with moderate-to-high *E~b~*s are actually higher-income households with high energy expenditures, making their *N~h~*s quite high (e.g., >\$100 of income per \$1 of energy spending). Almost `r to_percent(metric_comparison_pct)` of the households in the dataset have net incomes between `r to_dollar(metric_comparison_net_income_lbound)` and `r to_dollar(metric_comparison_net_income_ubound)`, with *N~h~*s (or *E~b~*s) of between `r metric_comparison_x_axis_lbound` (`r to_percent(metric_comparison_x_axis_lbound/100)`) and `r metric_comparison_x_axis_ubound` (`r to_percent(metric_comparison_x_axis_ubound/100)`).]{color=`r edit_color`} Only households with no energy costs are excluded from the analysis, whereas households with no energy costs or incomes must be excluded from an analysis utilizing *E~b~*.

(ref:metric-comparison-fig-cap) Display of the relationship between [*E~b~*]{color=`r edit_color`} and [*N~h~*]{color=`r edit_color`} with net income (gross income - energy expenditures) for US households. While [*E~b~*]{color=`r edit_color`} appears inversely correlated to net income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the [*E~b~*]{color=`r edit_color`} equation (Equation 1), the [*E~b~*]{color=`r edit_color`} of these households approaches infinity [and cannot be captured on the standard 0-100% scale the metric is intended to be interpreted within]{color=`r edit_color`}. Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. [*N~h~*]{color=`r edit_color`} frames the same dataset on a scale without the long tail. [*N~h~*]{color=`r edit_color`} appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing [*N~h~*]{color=`r edit_color`} avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, [*N~h~*]{color=`r edit_color`} offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent: many households with moderate-to-high *E~b~*s are actually higher-income households with high energy expenditures, making their [*N~h~*]{color=`r edit_color`}s quite high (e.g., >\$100 of income per \$1 of energy spending)[, which is only visible on an *N~h~* scale]{color=`r edit_color`}.

```{r metric-comparison, include=TRUE, results='asis', fig.cap='(ref:metric-comparison-fig-cap)', fig.width=8.0,fig.height=5.5}
metric_comparison_fig_cap_old <- paste0("Display of the relationship between ",colorize("*E~b~*",edit_color)," and ",colorize("*N~h~*",edit_color)," with net income (gross income - energy expenditures) for US households. While *E~b~* appears inversely correlated to net income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the *E~b~* equation (Equation 1), the *E~b~* of these households approaches infinity ",colorize("and cannot be captured on the standard 0-100\\% scale the metric is intended to be interpreted within",edit_color),". Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. *N~h~* frames the same dataset on a scale without the long tail. *N~h~* appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing *N~h~* avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, *N~h~* offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent: many households with moderate-to-high *E~b~*s are actually higher-income households with high energy expenditures, making their *N~h~*s quite high (e.g., >\\$100 of income per \\$1 of energy spending)",colorize(", which is only visible on an *N~h~* scale",edit_color),".")

comparison_chart
```

For the discussion of household energy poverty, we are primarily interested in how households of different characteristics are distributed according to their [*N~h~*]{color=`r edit_color`}s, representing how many net dollars are earned by a household for every dollar it spends on energy. Since the *N~h~* is unitless but is a ratio of return on investment, we present it below interchangeably with no units or in units of $\$/\$$ depending on context. Other proposed indicators of energy poverty may be similarly examined in this manner. 


#### Application to Energy Poverty  {#poverty-line}

[While a variety of thresholds have been developed and explored, energy-poor households in the US are]{color=`r edit_color`} commonly defined in terms of *E~b~* as [those with]{color=`r edit_color`} an expenditure of greater than [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} of household income on energy [based on the logic that energy expenditures should not be greater than 20% of housing expenses, which themselves should not exceed 30% of household income[@brownLowincomeEnergyAffordability2020]]{color=`r edit_color`}. Calibrating our [*N~h~*]{color=`r edit_color`} analysis to this level will help gauge different thresholds of energy poverty and benchmark the results of this paper to the energy poverty literature while acknowledging the continuum of experiences across household energy consumption. Translated into its relative level for [*N~h~*]{color=`r edit_color`}, the energy poverty line *N~h~* is defined according to Equation 3 as `r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r round(ner_poverty_line,0)`.

\begin{gather}
\nonumber E_{B}^{*} = \frac{S}{G} = `r colorize(100*energy_burden_poverty_line, edit_color)`\%\\
N_{h}^{*} = \frac{G-S}{S}\ such\ that \ \frac{S}{G} = `r colorize(100*energy_burden_poverty_line,edit_color)`\%\\
\nonumber N_{h}^{*} `r ner_nice_text`\Rightarrow Household\ at\ Energy\ Poverty\ Line
\end{gather}

This means that a household that earns less than [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r to_dollar(ner_poverty_line)`]{color=`r edit_color`} of income for every dollar it spends on secondary energy will be considered to be in energy poverty by the traditional *E~b~* accounting method. An *N~h~* of [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r round(ner_poverty_line,0)`]{color=`r edit_color`} or lower is equivalent to an *E~b~* of [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} or higher. This threshold is arbitrary and may not be suitable in situations where households fall very close to this line or where the numbers of family members or measures of certain building characteristics vary widely. Simply, it is presented as a benchmark. We examine the [*N~h~*]{color=`r edit_color`} at a community scale across the [US]{color=`r edit_color`} in Table \@ref(tab:comparison-table).


#### The US Household Net Energy Landscape  {#landscape}


```{r comparison-table-math}
# table with states'/groups' median annual household energy expenditures, incomes, net incomes, *N~h~*, and *E~b~*
compare_metrics <- function(metric_name="ner",
                            dataset=NULL
                            ){
  gwm <- calculate_weighted_metrics(filter_graph_data(dataset,c("income_bracket"),metric_name),
                           c("income_bracket"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)
  gwm$metric_name <- metric_name
  return(gwm)
}

create_comparison_table <- function(
    metrics_to_compare=c("income",
                         "energy_cost",
                         # "energy_burden",
                         "net_income"#,
                         # "ner"
                                    ),
    dataset=NULL,
    include_totals=TRUE
){
  minimum_metrics_to_compare <- c("income","energy_cost","net_income")
  
  metrics_to_compare <- unique(c(metrics_to_compare,minimum_metrics_to_compare))
  
  compare_table <- data.table::rbindlist(lapply(metrics_to_compare, 
                                                compare_metrics,
                                      dataset=clean_data_ami))
  
  
  compare_table <- compare_table %>% 
    pivot_wider(id_cols=income_bracket,
                names_from=metric_name,
                values_from=metric_mean) %>% 
    mutate(energy_burden = energy_burden_func(g=income, s=energy_cost),
           ner = ner_func(g=income, s=energy_cost)) %>% 
    pivot_longer(cols=unique(c("income","energy_cost","energy_burden","net_income","ner"), 
                             minimum_metrics_to_compare))
  
  if(include_totals){
    compare_table_totals <- compare_table %>% 
    filter(metric_name=="income") %>% 
    pivot_wider(id_cols=income_bracket,
                names_from=metric_name,
                values_from=household_count,
                ) %>% 
    rename(households=income) %>% pivot_longer(cols="households")
    
    compare_table <- rbind(compare_table_totals, compare_table)
  }
  
  #format the metrics accordingly
  # income = 0 decimal place $
  # energy_cost = 0 decimal place $
  # energy_burden = 0 decimal place %
  # net_income = 0 decimal place $
  # ner = 1 decimal place number
  
  which_metric <- "value" #"metric_mean" #"metric_median"
  
  compare_table$print_value <- ifelse(compare_table$name %in% c("income",
                                                                       "energy_cost",
                                                                       "net_income"),
                                      to_dollar(compare_table[[which_metric]],latex=TRUE),
                                      ifelse(compare_table$name %in% c("energy_burden"),
                                             to_percent(compare_table[[which_metric]],latex=TRUE),
                                             ifelse(compare_table$name %in% c("ner"),
                                                    round(compare_table[[which_metric]],1),
                                                    ifelse(compare_table$name %in% c("households"),
                                                           to_million(compare_table[[which_metric]]),
                                                    to_big(compare_table[[which_metric]])))))
  
  compare_table$display_income_bracket <- dplyr::recode_factor(compare_table$income_bracket, 
                                         very_low="0-30\\% AMI",
                                         low_mod="30-80\\% AMI", 
                                         mid_high="Above 80\\% AMI",
                                         All="All",
                                         .ordered=TRUE)
  
  energy_burden_label <- "\\textit{E\\textsubscript{b}} (\\textit{S}/\\textit{G})" #if html etc. <- "*E~b~* (S/G)"
  ner_label <- "\\textit{N\\textsubscript{h}} ([\\textit{G}-\\textit{S}]/\\textit{S})" #if html etc. <- "*N~h~* ([G-S]/S)"
  
  compare_table[,"Metric Name"] <- dplyr::recode(compare_table$name,
                                                 households="Households in Sample",
                                      income="Annual Income (\\textit{G})",
                                      energy_cost="Annual Energy Expenditures (\\textit{S})",
                                      energy_burden=energy_burden_label,
                                      net_income="Net Income (\\textit{G}-\\textit{S})",
                                      ner=ner_label)
  
  print_table <- compare_table[,c("Metric Name","display_income_bracket","print_value")] %>% 
    arrange(display_income_bracket) %>% 
    pivot_wider(names_from=display_income_bracket,values_from=print_value)
  
  return(print_table)
}

print_table <- create_comparison_table <- function(
    metrics_to_compare=NULL,
    dataset=NULL,
    include_totals=TRUE
)
  
write_csv(print_table, "comparison_table.csv")

highlight_metrics <- rbindlist(lapply(c(
                                    "energy_burden",
                                    "ner"
                                    ), compare_metrics,
                                    dataset=clean_data_ami))

highlight_energy_burden <- as.numeric(highlight_metrics[metric_name=="energy_burden" & income_bracket=="very_low","metric_mean"])

highlight_ner <- as.numeric(highlight_metrics[metric_name=="ner" & income_bracket=="very_low","metric_mean"])

num_one <- paste0(to_big(highlight_energy_burden*100),"\\%")
num_two <- round(highlight_ner,1)
# glue::glue(
```


```{r}
total_homes <- tidycensus::get_acs(geography = "us",
                    variables = c(households="B25002_002"),
                    year = acs_version)
# head(total_homes)
estimated_homes <- compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","value"]
min_homes <- total_homes$estimate - total_homes$moe
max_homes <- total_homes$estimate + total_homes$moe
```


[We use LEAD[@maLowIncomeEnergyAffordability2019] (n=`r compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","print_value"]` households) to evaluate the *N~h~* dynamics across the US. The average US home in the dataset]{color=`r edit_color`} has an income of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="income","print_value"]` and an annual energy expenditure of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","print_value"]` (`r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","value"])/12)`/month), which equates to an average *E~b~* of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_burden","print_value"]` or an average [*N~h~*]{color=`r edit_color`} of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="ner","print_value"]`. While the dataset slightly overrepresents households below the median income due to the limitations of the statistical methods used to compile them, it represents estimates for approximately `r to_percent(as.numeric(estimated_homes/(max_homes)))`-`r to_percent(as.numeric(estimated_homes/(min_homes)))` of the `r to_million(min_homes, suffix="")`-`r to_million(max_homes)` family-occupied households evaluated by the American Community Survey. Table \@ref(tab:comparison-table) shows a summary of these data for households and their average statistics [delineated by their]{color=`r edit_color`} incomes relative to [the median income of similar size families in the same metropolitan area or non-metropolitan county, known as]{color=`r edit_color`} Area Median Income (AMI). We can see that high burdens are found mostly in the very-low-income group, with an average *E~b~* of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` or [*N~h~*]{color=`r edit_color`} of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="ner","print_value"]`. Income drives the escape from energy poverty: middle and high-income groups do not spend drastically different amounts on energy (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` and `r to_percent(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` more, respectively) but earn `r to_big(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` and `r to_big(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` times that of the very low-income group, respectively. An *E~b~* of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` means that `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month is spent on energy, which is quite high on a monthly income of `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"])/12)`. The additional `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month that the next rung of moderate-income groups spends on energy represents a minuscule proportion of their income (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"]))`).


(ref:comparison-table-caption) Average annual household energy expenditures, incomes, net incomes, [*N~h~*]{color=`r edit_color`}s, and [*E~b~*]{color=`r edit_color`}s portrayed for different income groups based on their relationship to [AMI]{color=`r edit_color`}. Note that the statistics for [*E~b~*]{color=`r edit_color`} and [*N~h~*]{color=`r edit_color`} are calculated per cohort after averaging the income and expenditure statistics to avoid the effect of extreme values skewing the interpretability of these metrics as described in the text. For example, the actual weighted average [*E~b~*]{color=`r edit_color`} for households from 0-30% AMI is `r num_one`, and the average [*N~h~*]{color=`r edit_color`} for this cohort is `r num_two` due to subsets of the dataset with very low incomes or low energy expenditures. [*N~h~*]{color=`r edit_color`} is not as susceptible to this skewing effect.

```{r comparison-table, include=TRUE, results="asis"}
final_table <- subset(print_table, select=-All) %>%  
  knitr::kable(booktabs=T,
               escape = F,
               caption='(ref:comparison-table-caption)') %>% 
  kableExtra::kable_styling(latex_options = "H") %>% 
  kableExtra::add_footnote(
    # input,
    label = c(
      "AMI: Area Median Income",
      #"*E~b~*: Energy Burden",
      #"*N~h~*: Net Energy Return",
      "\\textit{N\\textsubscript{h}}: Household Net Energy Return",
      "\\textit{E\\textsubscript{b}}: Household Energy Burden"
              ),
    notation = "none", #number, alphabet, symbol and none
    threeparttable = FALSE,
    escape = FALSE
    )
  # kableExtra::row_spec(c(2,3,4,6), bold=T)
  # kableExtra::kable_styling(latex_options = c("striped"), #,"hold_position"
                            # position="center")
final_table
```

[[Because cleaner investments could lower costs over time, we can immediately see a disproportionate burden for those making low income to shifting expenditures to other forms of fuel if any upfront investment is required. Fossil fuel costs are not internalized, so it seems like lower-income cohorts are paying less monetarily. Still, they are paying the costs in other ways, such as through health and environmental externalities. Even without these externalities priced in, the burden of energy for low-income groups is already very high.]{strike=`r strike_show`}]{color=`r edit_color`}

[Another contribution of this work is that by using *N~h~*, we can display these data spatially across the US to explore how different communities are experiencing energy outcomes as in Figure \@ref(fig:continental-map) and investigate specific communities at multiple scales such as census tract, county, state, and regional as in Figure \@ref(fig:inset-map). Furthermore, we can break down the data among meaningful subsets as in Figure \@ref(fig:density-charts) and examine state-by-state trends as in Figure \@ref(fig:state-violin). This is useful because the presence of energy inequity is harder to see in urban areas compared to rural areas for which census tracts are a larger physical area or when certain household characteristics such as primary heating fuel are related to widely differing energy outcomes in the same area. Additionally, it shows a spatial variation of energy poverty that includes `r to_million(number_in_poverty[1]+clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum())` more households that would not be captured by traditional poverty metrics because their incomes are too low (*E~b~*>100%) or too high (above the FPL). By processing disparate data sources into a coherent structure and providing a convenient open-source tool for others to do the same, these data can be used in urban planning, public policy, and other relevant contexts.]{color=`r edit_color`}

Displayed geospatially in Figure \@ref(fig:continental-map), the Black Belt in the American Southeast is visibly perceptible [as an area of high burden]{color=`r edit_color`}, indicating that low-*N~h~* follows racial lines[[in areas where inexpensive energy is available, and burdens are more dependent on housing quality and patterns of consumption than they are dependent on price]{strike=`r strike_show`}]{color=`r edit_color`}. Likewise, border populations and immigrant populated areas in the Southwest have higher burdens, as do Native American lands. [[The use of heating oil in the Northeast states such as Maine can be seen through the prevalance of low-*N~h~* communities in this area since heating oil is a notably expensive and inefficient source of heating commonly used in this region]{strike=`r strike_show`} High burdens can also be seen in rural Northeast states where heating burdens are high]{color=`r edit_color`}. [*N~h~* allows a nuanced view of these widely ranging income dynamics by portraying them on a scale that matches the scope of the issues: areas of high energy burden (close to *N~h~*=0) are visible in orange while highly affluent areas are also visually perceptible as dark blue even though these groups' average metrics are multiple orders of magnitude apart.]{color=`r edit_color`}

(ref:continental-map-fig-cap) Map of the average net earned income per secondary energy expenditure for each census tract in the continental [US]{color=`r edit_color`}. Shades of yellow and red[, respectively,]{color=`r edit_color`} indicate communities at or below the energy poverty line as defined by earning [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately ")` `r round(ner_poverty_line,0)`]{color=`r edit_color`} dollars or less in income per dollar of energy expenditures. This corresponds to the traditional definition of energy poverty as spending [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} or more of income on energy. Low [*N~h~*]{color=`r edit_color`}s can be starkly observed in the Black Belt across the Southeastern US, Hispanic communities near the US-Mexico border, Native American lands, and rural New England.

```{r continental-map, include=TRUE, results='asis', fig.cap='(ref:continental-map-fig-cap)', fig.width=8.0,fig.height=5.5}

old_continental_map_fig_cap <- paste0("Map of the average net earned income per secondary energy expenditure for each census tract in the continental ",
                                  colorize("US",edit_color),
                                  ". Shades of yellow and red",
                                  colorize(",respectively,",edit_color),
                                  " indicate communities at or below the energy poverty line as defined by earning ",
                                  ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately "),
                                  round(ner_poverty_line,0),
                                  " dollars or less in income per dollar of energy expenditures. This corresponds to the traditional definition of energy poverty as spending ",
                                  to_percent(energy_burden_poverty_line),
                                  " or more of income on energy. Low ",
                                  colorize("*N~h~*",edit_color),
                                  "s can be starkly observed in the Black Belt across the Southeastern US, Hispanic communities near the US-Mexico border, Native American lands, and rural New England.")

group_variable <- "geoid"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))
# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

# full_map_data <- left_join(tract_shp, gwm, by=c("geoid"))

gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami,c("income_bracket"),metric_name),
                           c("income_bracket"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)

gwm$metric_name <- metric_name

map_data <- left_join(continental_shp, gwm, by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(graph_data %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens Across the United States"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = TRUE,
    metric_long_name = bquote(N[h]) #"Net\nEnergy Return"
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)

# print(choropleth_chart_footnote)
```

Urban inequity results in lower *N~h~* populations not showing up in many dense or gentrified urban areas such as the San Francisco Bay Area, New York City, and New Orleans, as shown in Figure \@ref(fig:inset-map). [[A notable exception to this trend is Detroit, in which t]{strike=`r strike_show`}T]{color=`r edit_color`}he pervasiveness of urban energy poverty [in Detroit]{color=`r edit_color`} has been studied extensively and shown to have distinct geographic boundaries [down to the street level]{color=`r edit_color`}[@bednarIntersectionEnergyJustice2017]. While some of these conclusions are supported by existing evidence and literature, they should be confirmed with a rigorous analysis of this dataset using the *N~h~* metric for the reasons explained in [Applying NER to Energy Equity](#ratios)[: extremely low-income households are not visible on a 0-100% scale, and households with no income are often discarded as outliers.]{color=`r edit_color`} Additional analyses should incorporate additional demographic and household dimensions due to potential disparities within census tracts since diverse neighborhoods may not be represented accurately by aggregate census tract metrics.

(ref:inset-map-fig-cap) An inset focused on the city of New Orleans, Louisiana (Orleans Parish). This view shows an example of the dynamics of energy poverty in an urban area where the presence of energy inequity is harder to see compared to rural areas for which census tracts are a larger physical area.

```{r inset-map, include=TRUE, results='asis', fig.cap='(ref:inset-map-fig-cap)', fig.width=8.0,fig.height=5.5}

old_inset_map_fig_cap <- "An inset focused on the city of New Orleans, Louisiana (Orleans Parish), showing an example of the dynamics of energy poverty in an urban area where the presence of energy inequity is harder to see compared to rural areas for which census tracts are a larger physical area."

nola_msa_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish")

nola_csa_parishes <- c(nola_msa_parishes, 
                       "Tangipahoa Parish",
                       "Washington Parish")

nola_rpc_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   # "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish",
                   "Tangipahoa Parish")

orleans_and_neighbors <- c("Orleans Parish",
                           "St. Tammany Parish",
                           "Jefferson Parish",
                           "Plaquemines Parish", 
                   "St. Bernard Parish"
                           )

inset_map_data <- map_data %>% filter(county_name=="Orleans Parish"
                                     & state_abbr=="LA")

inset_bb <- st_buffer(st_as_sfc(st_bbox(inset_map_data)) %>% st_transform(3857), dist=100000)

choropleth_chart_highlight <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    legend_position = "none"
    ) + 
  geom_sf(data = inset_bb, fill = NA, color = "green", size = 0.25) + 
  theme_void() + 
  theme(
      legend.position = "none")

# https://en.wikipedia.org/wiki/New_Orleans_metropolitan_area
choropleth_chart_inset <- choropleth_map(
    clean_data=inset_map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="Inset of Energy Burdens in New Orleans, Louisiana",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    legend_position = c(.85,.4),
    include_compass = TRUE,
    metric_long_name = bquote(N[h]))

gg_inset_map = ggdraw() +
  draw_plot(choropleth_chart_inset) +
  draw_plot(choropleth_chart_highlight, x = 0.150, y = 0.625, width = 0.35, height = 0.35)

# gg_inset_map

gg_inset_map_footnote <- gridExtra::grid.arrange(
  gg_inset_map,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
# ggsave2("national_map.pdf",plot=choropleth_chart)
# ggsave2("inset_map.pdf",plot=gg_inset_map)

# grid.arrange(choropleth_chart,gg_inset_map, nrow=2)
# cowplot::plot_grid(choropleth_chart,gg_inset_map, align = "v", nrow=2)
```

From this high level, we can see in Figure \@ref(fig:density-charts)[.a]{color=`r edit_color`} that approximately `r scales::percent(energy_poverty_rate, accuracy=1)` of households in the [US]{color=`r edit_color`} experience energy poverty. Displaying these communities defined by their relationship to the US Federal Poverty Line (FPL), which indicates income poverty status according to government policy, in [Figure \@ref(fig:density-charts).b]{color=`r edit_color`} provides a stark picture. While `r scales::percent(in_both_poverty, accuracy=1)` of households below the FPL also face energy poverty, [more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` of those households]{color=`r edit_color`} above the FPL face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap [and the inadequacy of FPL as an indicator of energy poverty in particular]{color=`r edit_color`}. When we break the group of relatively prosperous households into subsets [as outlined in Table \@ref(tab:comparison-table)]{color=`r edit_color`}, we find that `r scales::percent(as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","households_below_cutoff"])/as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","household_count"]),accuracy=1)` of households living at 30-80% of their [AMI]{color=`r edit_color`} are experiencing energy poverty. This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in [*N~h~*]{color=`r edit_color`} on the households’ energy investments is surprising.

```{r}
clean_data_fpl$simplified_primary_heating_fuel <- as.factor(ifelse(clean_data_fpl$primary_heating_fuel=="ELECTRICITY",
                                                              "Electricity", 
                                                               ifelse(clean_data_fpl$primary_heating_fuel %in% 
                                                                        c("UTILITY GAS","BOTTLED GAS"),
                                                                      "Gas",
                                                    ifelse(clean_data_fpl$primary_heating_fuel=="SOLAR",
                                                           "Solar",
                                                                      "Other"))))

clean_data_fpl$super_simplified_primary_heating_fuel <- 
  as.factor(ifelse(clean_data_fpl$primary_heating_fuel=="SOLAR",
                                                           "Solar",
                                                                      "Other"))


clean_data_ami$all <- as.factor("all")

clean_data_ami <- dplyr::left_join(clean_data_ami, replica_sup[c("geoid","company_ty","locale")], by=c("geoid"))

clean_data_ami$simplified_utility_type <- ifelse(clean_data_ami$company_ty %in% c("Coop","DistCoop"),
                                                 "Cooperatively Owned",
                                                 ifelse(clean_data_ami$company_ty %in% c("Federal",
                                                                                         "Muni",
                                                                                         "State"),
                                                        "Government Owned",
                                                        ifelse(clean_data_ami$company_ty %in% 
                                                                 c("Private","PSubdiv"),
                                                               "Privately Held",
                                                               ifelse(clean_data_ami$company_ty=="IOU",
                                                                      "Publicly Held",
                                                                      "Other")
                                                               )
                                                        ))

clean_data_ami$simplified_locale <- sub(" .*", "", clean_data_ami$locale)
```


```{r}
top_line_group <- NULL

p1 <-   density_chart(graph_data, 
                                 metric_name, 
                                 metric_label="", 
                                 group_columns=top_line_group, 
                                 metric_cutoff_level, 
                                 metric_cutoff_label, 
                                 chart_title=NULL, 
                                 chart_subtitle=NULL,
                                 x_label="")
```

```{r}
top_line_group <- "income_bracket"

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p2=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p3=top_line_charts[["density"]]
p3_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("super_simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")

fuel_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("super_simplified_primary_heating_fuel",
                    "income_bracket")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")

fuel_income_stats=top_line_charts[["metrics"]]
```


[Figure \@ref(fig:density-charts).c shows that h]{color=`r edit_color`}ouseholds with solar as a primary heating fuel have a higher [*N~h~* (*N~h~*=`r round(fuel_stats$metric_mean[fuel_stats$super_simplified_primary_heating_fuel=="Solar"],0)`)]{color=`r edit_color`} than those which rely on other fuel sources [(*N~h~*=`r round(fuel_stats$metric_mean[fuel_stats$super_simplified_primary_heating_fuel=="Other"],0)`)]{color=`r edit_color`}, [even for]{color=`r edit_color`} households far below the poverty line[: the average *N~h~* for income-impoverished households utilizing solar power is `r round(fuel_income_stats$metric_mean[fuel_income_stats$super_simplified_primary_heating_fuel=="Solar" & fuel_income_stats$income_bracket=="Below Federal Poverty Line"],0)`, compared to `r round(fuel_income_stats$metric_mean[fuel_income_stats$super_simplified_primary_heating_fuel=="Other" & fuel_income_stats$income_bracket=="Below Federal Poverty Line"],0)` for those relying on any other fuel source]{color=`r edit_color`}. [The slope of the *N~h~* density lines in Figure \@ref(fig:density-charts).c indicates that these lower-income households seem to experience a different rate of return on *N~h~* from the benefits of increased energy adoption than higher-income households.]{color=`r edit_color`} Why are [certain]{color=`r edit_color`} households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households' low consumption, meaning that the potential savings from [implementing energy efficiency measures]{color=`r edit_color`} are lower than for high-income households [according to the prebound effect identified by Sunikka-Blank and Galvin [@sunikka-blankIntroducingPreboundEffect2012] and Cong et al.[@congEnergyEquityGap2021]]{color=`r edit_color`}. Despite technological progress and rapid declines in technology costs and availability for cleaner, renewable electricity generation options such as solar photovoltaics and energy storage, many households cannot take advantage. Most households do not have access to advancements such as low-cost rooftop solar or energy efficiency upgrades that improve air quality, lower greenhouse gas emissions, and save money[@castellanosRooftopSolarPhotovoltaic2017][: only 18% of households that have adopted rooftop solar have been below the median household income in the US [@barboseIncomeTrendsResidential2020]]{color=`r edit_color`}.

```{r}
top_line_group <- c("number_of_units")
# c("number_of_units", "occupancy_type"),
#                           c("occupancy_type", "income_bracket"),
#                           c("number_of_units", "occupancy_type", "income_bracket"),

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p4=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("housing_tenure")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p5=top_line_charts[["density"]]
p5_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("housing_tenure",
                    "number_of_units")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
multifam_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("housing_tenure",
                    "income_bracket")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
housing_income_stats=top_line_charts[["metrics"]]
```


Examining these dynamics by the status of homeownership [in Figure \@ref(fig:density-charts).d]{color=`r edit_color`} reveals further disparities. Though renters and homeowners are similarly distributed below the energy poverty line [(`r to_percent(p5_stats$pct_in_group_below_cutoff[p5_stats$housing_tenure=="rented"])` of renters and `r to_percent(p5_stats$pct_in_group_below_cutoff[p5_stats$housing_tenure=="owned"])` of homeowners are in energy poverty)]{color=`r edit_color`}, there appears to be an advantage of homeownership from a net energy perspective for lower-income households [(*N~h~*=`r round(p5_stats$metric_mean[p5_stats$housing_tenure=="owned"],0)` for homeowners versus *N~h~*=`r round(p5_stats$metric_mean[p5_stats$housing_tenure=="rented"],0)` for renters)]{color=`r edit_color`}. Only at a relatively high [*N~h~*]{color=`r edit_color`} do renters seem to have an advantage[[, due to these tenants living in relatively new and efficient urban rentals]{strike=`r strike_show`}]{color=`r edit_color`}: owners of multi-family apartments earn `r round(multifam_stats$metric_mean[multifam_stats$housing_tenure=="owned" & multifam_stats$number_of_units=="multi-family"]/multifam_stats$metric_mean[multifam_stats$housing_tenure=="rented" & multifam_stats$number_of_units=="single-family"],1)` times as much as renters of single-family homes when normalized by energy expenditures. Renters face systemic disadvantages in the energy transition; they typically pay the home's energy costs while the landlord controls infrastructure upgrades, commonly understood as the split incentive problem[@birdPolicyOptionsSplit2012]. Tenure matters for more than just equity itself: renters are less likely to take actions to improve their [*N~h~*]{color=`r edit_color`}s due to a lack of property rights and [split incentives]{color=`r edit_color`}. Even when action is taken to improve the energy efficiency of a rental building, tenants are less likely to see any economic benefits from it.

```{r}
top_line_group <- c("simplified_utility_type")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p6=top_line_charts[["density"]]
```

```{r}
# "pop_hispanic"                               
# [35] "pop_african_american"                        "pop_asian"                                  
# [37] "pop_native_american"                         "pop_caucasian" 
# "pop_total"

minority_races <- c("hispanic","african_american","asian","native_american")
races <- c(minority_races,"caucasian")

pct_races <- replica_sup[,paste0("pop_",races)] / rowSums(replica_sup[,paste0("pop_",races)])
names(pct_races) <- paste0("pct_",races)

plurality_race <- races[max.col(pct_races,ties.method = "first")]

plurality_race <- ifelse(plurality_race=="african_american","black",
                                   ifelse(plurality_race=="native_american","indian",
                                          ifelse(plurality_race=="caucasian","white",
                                          plurality_race)))

race_data <- data.frame("geoid"=replica_sup$geoid,
                        "race"=plurality_race)

data_with_race <- inner_join(x=clean_data_ami, 
                             y=na.omit(race_data), by = "geoid")

top_line_group <- c("race")

top_line_charts <- make_all_charts(data_with_race,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p7=top_line_charts[["density"]]
p7_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("simplified_race")

data_with_race$simplified_race <- ifelse(data_with_race$race=="white",
                                         "white",
                                         "non-white")

top_line_charts <- make_all_charts(data_with_race,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")

simplified_race_stats=top_line_charts[["metrics"]]
```


```{r}
# "pop25_some_college_plus"                     "pop25_high_school"                          
# [41] "pop25_no_high_school"
# "pop_total"

# minority_races <- c("african_american","hispanic","asian","native_american")
# races <- c(minority_races,"caucasian")

education_levels <- c("some_college_plus","high_school", "no_high_school")

pct_education_levels <- replica_sup[,paste0("pop25_",education_levels)] / 
  rowSums(replica_sup[,paste0("pop25_",education_levels)])
names(pct_education_levels) <- paste0("pct_",education_levels)

plurality_education_level <- education_levels[max.col(pct_education_levels,ties.method = "first")]

plurality_education_level <- ifelse(plurality_education_level %in% 
                                      c("high_school","no_high_school"),
                                    "high school or less",
                                    ifelse(plurality_education_level=="some_college_plus",
                                           "college or more",
                                          plurality_education_level))

education_data <- data.frame("geoid"=replica_sup$geoid,
                        "simplified_education"=plurality_education_level)


top_line_group <- c("simplified_education")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(education_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p8=top_line_charts[["density"]]
p8_stats=top_line_charts[["metrics"]]

color_poverty_frequency <- (simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="non-white"] - 
                              simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="white"]) / 
  simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="white"]

color_poverty_frequency_modifier <- ifelse(color_poverty_frequency>0,"greater","less")

color_poverty_frequency_pct <- to_percent(abs(color_poverty_frequency))
```

[Furthermore, Figure \@ref(fig:density-charts).e shows that *N~h~* varies widely by racial demography. `r str_to_title(p7_stats$race[p7_stats$metric_mean==max(p7_stats$metric_mean)])` households have the highest *N~h~* across the entire population distribution (*N~h~*=`r round(sort(p7_stats$metric_mean, TRUE)[1],0)`), and `r str_to_title(p7_stats$race[p7_stats$metric_mean==sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)]])` households have the lowest (*N~h~*=`r round(sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)],0)`), with `r str_to_title(p7_stats$race[p7_stats$metric_mean==sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)-1]])` households a close second from the lowest (*N~h~*=`r round(sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)-1],0)`). These relative positions are the same across the entire population distribution, with only White (*N~h~*=`r round(p7_stats$metric_mean[p7_stats$race=="white"],0)`) and Hispanic (*N~h~*=`r round(p7_stats$metric_mean[p7_stats$race=="hispanic"],0)`) populations showing different relative *N~h~*s across the population. Households in communities of color experience energy poverty at a rate `r color_poverty_frequency_pct` `r color_poverty_frequency_modifier` than those in white communities. Education level also seems to be correlated with disparate *N~h~* outcomes according to Figure \@ref(fig:density-charts).f, with a wide gap between those households in areas with mostly high-school (*N~h~*=`r round(p8_stats$metric_mean[p8_stats$simplified_education=="high school or less"],0)`) or college-educated (*N~h~*=`r round(p8_stats$metric_mean[p8_stats$simplified_education=="college or more"],0)`) populations.]{color=`r edit_color`}


```{r}
# "climate_zone"                               
# [75] "climate_zone_description"

simplified_climate <- ifelse(replica_sup$climate_zone_description %in% c("Hot","Very Hot"), "Hot",
                             ifelse(replica_sup$climate_zone_description %in% c("Cold",
                                                                                "Very Cold",
                                                                                "Subarctic"),"Cold","Moderate")
                             )

climate_data <- data.frame("geoid"=replica_sup$geoid,
                           "simplified_climate"=simplified_climate)

top_line_group <- c("simplified_climate")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(climate_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p9=top_line_charts[["density"]]
```

(ref:density-charts-fig-cap) The distribution of [*N~h~*]{color=`r edit_color`}s across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure **b** shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure **c** shows the difference among groups of households identified by their primary heating fuel. Subfigure **d** shows the difference based on whether they are renters or owners. Subfigure **e** shows the difference based on the most prominent race in the census tract of each cohort. Subfigure **f** shows the difference based on the most prominent education history in the census tract of each cohort.

```{r density-charts, include=TRUE, results='asis', fig.cap='(ref:density-charts-fig-cap)', fig.width=8.0,fig.height=5.5}

old_density_charts_fig_cap <- paste0("The distribution of ",colorize("*N~h~*",edit_color),"s across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure b shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure c shows the difference among groups of households identified by their primary heating fuel. Subfigure d shows the difference based on whether they are renters or owners. Subfigure e shows the difference based on the most prominent race in the census tract of each cohort. Subfigure f shows the difference based on the most prominent education history in the census tract of each cohort.")

# grid.arrange(p1,
#              p2,
#              p3,
#              # p4,
#              p5,
#              # p6,
#              p7,
#              p8,
#              # p9,
#              nrow=2,
#              # top=chart_title,
#              # subtitle
#              bottom="Proportion of Households",
#              left=grid.text(label=
#                as.expression(
#                bquote(
#                  N[h]
#                  )
#                ),
#                draw=FALSE
#              )
# )  + 
#   plot_annotation(tag_levels = 'a') &
#   theme(plot.tag = element_text(face = 'bold'))
# 
# 
# facetted_plot <- patchwork::wrap_plots(p1,p2,p3,p5,p7,p8,
#                                        nrow=2) + 
#   plot_annotation(tag_levels = 'a') &
#   theme(plot.tag = element_text(face = 'bold'))
# 
# density_final <- arrangeGrob(grobs=facetted_plot,
#              bottom="Proportion of Households",
#              left=grid.text(label=
#                as.expression(
#                bquote(
#                  N[h]
#                  )
#                ),
#                draw=FALSE
#              )
# )

# result <- (p1+p2+p3)/(p5+p7+p8)
gt <- patchwork::patchworkGrob((p1+p2+p3)/(p5+p7+p8)  + 
                                 plot_layout(heights = c(1,1)) +
  plot_annotation(tag_levels = 'a') &
  theme(plot.tag = element_text(face = 'bold')))
# gridExtra::grid.arrange(gt, left = "Disp", bottom = "Hp // Cyl")
gt_all <- gridExtra::arrangeGrob(gt, 
                        top="Distribution of Energy Burdens Across Household Characteristics",
                        bottom="Proportion of Households",
                        left=grid.text(label=
                                         as.expression(
                                           bquote(~italic(
                                             N[h]
                                             ))
                                           ),
                                       draw=FALSE
                                       ))

gt_all_footnote <- gridExtra::grid.arrange(
  gt_all,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)

# multi_plot <- cowplot::plot_grid(p1,p2,p3,p4,p5,p6,p7,p8,p9,
#                    nrow=3, align="none",rel_heights = c(2,2,2))
# 
# #create common x and y labels
# 
# y.grob <- textGrob(paste0(str_to_upper(metric_name)," (",metric_label,")"), 
#                    gp=gpar(fontface="bold", col="black", fontsize=12), rot=90)
# 
# x.grob <- textGrob("Proportion of Households", 
#                    gp=gpar(fontface="bold", col="black", fontsize=12))
# 
# #add to plot
# 
# grid.arrange(arrangeGrob(multi_plot, left = y.grob, bottom = x.grob))
```

```{r}
group_columns <- c("state_abbr")
# utility type? see chartbook
graph_data <- filter_graph_data(clean_data=clean_data_ami[clean_data_ami$state_abbr!="DC",], 
                                group_columns=group_columns, 
                                metric_name=metric_name)

# percent of "other" fuel expenditures toward fossil fuel combustion
# want to make this more precise by state, county, and/or balancing authority eventually
other_gwm <- grouped_weighted_metrics(clean_data_fpl[clean_data_fpl$state_abbr!="DC",], 
                                      c("primary_heating_fuel"),
                                      "other_spend",
                                      0)

other_fuels <- c("COAL","FUEL OIL","NONE","OTHER","SOLAR","WOOD","BOTTLED GAS")
non_fossil_other_fuels <- c("NONE","SOLAR","WOOD")
fossil_other_fuels <- other_fuels[!(other_fuels %in% non_fossil_other_fuels)]

other_fossil <- other_gwm[other_gwm$primary_heating_fuel %in% fossil_other_fuels,
                              c("household_count","metric_mean")]

pct_other_fossil <- sum(other_fossil$household_count*other_fossil$metric_mean)/
  sum(other_gwm$household_count*other_gwm$metric_mean)

graph_data$pct_other_fossil <- pct_other_fossil

# percent of each state's electric grid decidated to fossil fuel combustion
# can refine by balancing authority based on REPLICA dataset
egrid <- get_state_egrid()

egrid$pct_electricity_fossil <- egrid$STCLPR + #coal
  egrid$STOLPR + #oil
  egrid$STGSPR + #gas
  egrid$STOFPR #+ #other fossil
  # egrid$STNCPR #+ #nuclear
  # egrid$STHYPR #+ #hydro
  # egrid$STOPPR #unknown/purchased

graph_data <- left_join(graph_data, egrid, by=c("state_fips"="FIPSST"))

# graph_data <- graph_data[graph_data$state_abbr!="DC",]

# percent of natural gas expenditures dedicateed to fossil fuel combustion...
pct_gas_fossil <- 1.0

graph_data$pct_gas_fossil <- pct_gas_fossil

graph_data$pct_fossil_tract <- (graph_data$pct_gas_fossil * graph_data$gas_spend + 
  graph_data$pct_electricity_fossil * graph_data$electricity_spend + 
  graph_data$pct_other_fossil * graph_data$other_spend) / 
  (graph_data$gas_spend + graph_data$electricity_spend + graph_data$other_spend)


pct_fossil_gwm <- grouped_weighted_metrics(graph_data, "state_fips","pct_fossil_tract",0) %>% 
  dplyr::rename(pct_fossil=metric_mean)

graph_data <- left_join(graph_data, 
                        pct_fossil_gwm[,c("state_fips","pct_fossil")], 
                        by="state_fips")

top_line_charts <- make_all_charts(graph_data,
                            group_columns="state_abbr",
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL)

state_by_state <- top_line_charts[["metrics"]]

electricity_prices_summary <- calculate_weighted_metrics(graph_data, 
                                                         c("state_abbr"), 
                                                         "dlrs_kwh", 
                                                         metric_cutoff_level = 
                                                           ner_poverty_line)
```


Assessing the [*N~h~*]{color=`r edit_color`}s among different states in Figure \@ref(fig:state-violin) presents a counterintuitive picture of how states address energy poverty and energy equity. [*N~h~*]{color=`r edit_color`} can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as Connecticut [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CT"],0)`)]{color=`r edit_color`} and Vermont [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="VT"],0)`)]{color=`r edit_color`}, where [`r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="CT"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` and `r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="VT"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])`]{color=`r edit_color`} higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="MS"],0)`)]{color=`r edit_color`} and Alabama [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="AL"],0)`)]{color=`r edit_color`}, which have significant low-income populations and low per-unit energy prices [(`r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="MS"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` and `r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="AL"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` lower than average, respectively)]{color=`r edit_color`}. Not only are households in these states falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood may suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on a diverse selection of metrics.

Although they are the states with the highest [*N~h~*]{color=`r edit_color`}, California [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CA"],0)`)]{color=`r edit_color`} and Colorado [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CO"],0)`)]{color=`r edit_color`} are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely, this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation are a common thread [among the top-performing states on an *N~h~* basis]{color=`r edit_color`}, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure \@ref(fig:state-violin) shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high [*N~h~*]{color=`r edit_color`}s than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.

(ref:state-violin-fig-cap) A comparison of [*N~h~*]{color=`r edit_color`}s among each state in the [US]{color=`r edit_color`}. The bars are sorted by median household [*N~h~*]{color=`r edit_color`} and represent the interquartile range (25%-75% percentiles) of household [*N~h~*]{color=`r edit_color`}s colored by the percent of household energy expenditures in each state that goes to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's [(EPA)]{color=`r edit_color`} [Emissions and Generation Resource Integrated Database (]{color=`r edit_color`}eGRID[)]{color=`r edit_color`} for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users.

```{r state-violin, include=TRUE, eval=TRUE, results='asis', fig.cap='(ref:state-violin-fig-cap)', fig.width=8.0,fig.height=5.5}

old_state_violin_fig_cap <- paste0("A comparison of ",colorize("*N~h~*",edit_color),"s among each state in the ",colorize("US",edit_color),". The bars are sorted by median household *N~h~* and represent the interquartile range (25%-75% percentiles) of household *N~h~*s colored by the percent of household energy expenditures in each state that go to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's ",colorize("(EPA)",edit_color)," ",colorize("Emissions and Generation Resource Integrated Database (",edit_color),"eGRID",colorize(")",edit_color)," for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users.")
# violin plot
# x_label <- bquote(~italic(N[h]))
x_label <- as.expression(bquote(~italic(N[h])~": Household Net Energy Return"))


y <- make_violin_chart(graph_data=graph_data,
                      group_columns=group_columns,
                      metric_name=metric_name,
                      metric_label=metric_label,
                      metric_cutoff_level=metric_cutoff_level,
                      fill_metric="pct_fossil",#"STCYPR",#"STSOPR",
                      fill_label="% of Energy Expenditures on \nFossil Fuel Combustion",#Combustion",#Solar",
                      group_name="State",
                      chart_title="Comparison of Energy Burdens Among the United States",
                      x_label=x_label)
print(y)
```

```{r}
group_variable <- "eia_id"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(left_join(clean_data_ami, replica_sup, by=c("geoid")), group_columns, metric_name)

util_group <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)

member_minumum <- 10000
lowest_ner_utility <- filter(arrange(util_group,metric_mean),household_count>=member_minumum)[1,]

unique_utils <- distinct(replica_sup[c("eia_id","company_na","state_name","dlrs_kwh")])

lowest_ner_utility_specs <- filter(unique_utils,eia_id==as.numeric(lowest_ner_utility["eia_id"]))

lowest_ner_utility_name <- lowest_ner_utility_specs$company_na
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Corp","Corporation")
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Member","Membership")
```

#### Discussion  {#discussion}

A sensible prior hypothesis is that everyone experiences the same efficiency from the energy system as measured by return on energy investment. Differences in absolute outcomes may be related to the quantity of energy investment, but the marginal unit of energy consumed by one household should lead to as much benefit for that household as any other. However, here we see that [*N~h~*]{color=`r edit_color`}s are different among different groups of households in the US. This difference is often correlated to factors out of the households’ control and even those related to persistent social inequalities, such as race and education. These striking disparities suggest the existence of deeply structural barriers to prosperity in the US. Energy is central to equity and economic prosperity, but the[[odds are stacked against many people. The]{strike=`r strike_show`}]{color=`r edit_color`} energy system appears to be regressive in that costs accrue disproportionately to those of lower-income levels[[and the most energy-efficient homes belong to wealthier families]{strike=`r strike_show`}]{color=`r edit_color`}.

Furthermore, we demonstrate that owning a home and consuming solar power are associated with increased income multipliers for energy expenditures. This advantage leads to gains that are not being realized by many communities. When households adopt solar power, their *N~h~* increases as a result of decreasing their energy expenditures, which creates a disparity between those with access to renewable energy and those reliant on fossil-fuel-based energy sources. This helps explain why there has been a disparity in how the benefits of the energy transition are accruing among socioeconomic groups [@vaishnavWasItWorthwhile2017]. There is the potential for electrification and the transition to clean fuels to exacerbate this division if appropriate policies are not implemented[@cullenwardDynamicallyEstimatingDistributional2016].

Indeed, there are clear, mutually synergistic, positive reinforcement mechanisms to alleviate health and environmental disparities in air pollution exposure by reducing household energy burdens and improving economic mobility across low-income households. Combustion of biofuels and hydrocarbons is a significant source of air pollution and exacerbates other household costs like healthcare and maintenance[, yet we find that utilization of these sources is not associated with increased *N~h~*s at a state or household scale]{color=`r edit_color`}. [Not only are h]{color=`r edit_color`}ouseholds living in more poverty and closer proximity to highly polluted areas [at greater risk of adverse health impacts; they]{color=`r edit_color`} must [also]{color=`r edit_color`} consume more energy to overcome the particulate emissions[, which, themselves, reduce the efficiency of clean sources such as solar panels[@heIncreaseDomesticElectricity2020]]{color=`r edit_color`}.

The inherent benefits of solar electricity must be accessible to all populations in the [US]{color=`r edit_color`} to promote sustainability, but [[barriers such as high capital investment, lack of financing, and inability to take advantage of existing business models continue to hold back]{strike=`r strike_show`}]{color=`r edit_color`} communities of color [[from]{strike=`r strike_show`}are not]{color=`r edit_color`} receiving a similar benefit to white and wealthier households [from their energy expenditures]{color=`r edit_color`}. Net energy metrics exhibit this income multiplier effect and the resulting divide. Designing solar policies to benefit those facing low [*N~h~*]{color=`r edit_color`}s may substantially improve net energy income ratios and raise households out of energy poverty in the [US]{color=`r edit_color`}.

Pachauri et al. distinguish between affordability and cost of supply, implying that more focus should be applied toward how energy burdens vary among customers of different energy suppliers than on how per-unit costs of energy vary[@pachauriAdvancingEnergyPoverty2020]. For instance, `r lowest_ner_utility_name` is the electric utility with more than `r to_big(member_minumum)` customers whose members have the lowest average [*N~h~*]{color=`r edit_color`} (`r to_big(lowest_ner_utility$metric_mean)`)[, according to LEAD]{color=`r edit_color`}. At the same time, the per-unit cost of electricity in this service territory is only more expensive than `r to_percent(ecdf(unique_utils$dlrs_kwh)(lowest_ner_utility_specs$dlrs_kwh))` of utilities at `r to_dollar(lowest_ner_utility_specs$dlrs_kwh)`/kWh. [Is an exceptionally high burden acceptable because the per-unit costs are not exceptional?]{color=`r edit_color`}

This relevance especially holds for electricity because it is a commodity delivered via a stationary, centralized grid system, and households retain little control over their own energy choices. [[The vastness of the modern electric grid eludes affordability for everyday households because of the relationships between the utility companies and the users. Secondary energy is unique among residential consumption categories because a single service provider is usually the authority for determining energy costs for each of its customers.]{strike=`r strike_show`}]{color=`r edit_color`} In vertically integrated energy markets, the monopoly utility is the only option available to all consumers. In organized energy markets, the public utility is designated as the last resort provider for those unable or unwilling to participate in the competitive procurement of energy. Even in organized markets, local utilities retain monopolistic control of the transmission and distribution systems. 

Consumers are price takers with relatively inelastic demand. Changes in the unit price of energy or slight differences in consumption patterns matter more to those with low incomes than those with higher incomes. Furthermore, the current lack of storage infrastructure on the grid and behind each meter means that households are bound to electricity providers at the time of use. The "forward-looking" or "reactive" tendencies of these public electric utilities have implications for the energy transition in their jurisdictions and beyond[@wolakFutureElectricityRetailing2020]. A more in-depth examination of the energy system’s underlying regulatory structures and robust assessments of energy burden could provide a path forward and track how the benefits of the energy transition are being accrued.

In some markets, specialized rates or programs are available for Low and Moderate Income (LMI) consumers, who may have higher energy burdens. We find it notable that more than half of all funding to address high energy burdens in the US is from utility ratepayer-funded bill and energy efficiency assistance[@rossHighCostEnergy2018]. At a national scale, the Low Income Home Energy Assistance Program (LIHEAP) and the Weatherization Assistance Program (WAP) in the US seek to address aspects of energy poverty through bill payment assistance and energy efficiency measures, but the efficacy of these programs has been mixed in addressing distributional equity in energy burdens and receiving benefits from energy efficiency programs[@bednarRecognitionResponseEnergy2020]. [In part, this may be because these programs rely on income-based poverty lines such as the FPL to determine eligibility for benefits.]{color=`r edit_color`}

The [US]{color=`r edit_color`} benchmarks its FPL to the food requirements of the average household[@coferFamilyFoodPlans1962] and uses this threshold as is an eligibility criterion for more than 40 federal programs across ten agencies (in addition to state, charitable, and private enterprises that also do so)[@unitedstatesdepartmentofhealthandhumanservicesProgramsThatUse2015]. Practitioners have posited that the standard policy of “using the ‘economy food plan’ to determine who can afford to hire an attorney” may be depriving citizens of their basic rights[@grossTooPoorHire2013]. In some cases, food assistance programs are more inclusive than energy assistance programs[: we show that more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` households above the FPL experience energy poverty.]{color=`r edit_color`}

[Research using detailed qualitative sociological and public health interview data links energy burden with housing and energy policy[@hernandezEnergyBurdenNeed2010]. Other articles have linked technology adoption barriers to low-income communities of color[@hsuPublicElectricVehicle2021]^,^[@tidwellDecarbonizingDisparitiesProblematizing2021]^,^[@brockwayInequitableAccessDistributed2021a] and identified that households that are in the same peer social network often adopt technologies such as solar[@bollingerPeerEffectsDiffusion2012]. While some studies already acknowledge the benefits of improving energy efficiency and equity outcomes through surveys and interviews[@hernandezBenefitBurdenPerceptions2015], this study adds to the literature by building a comprehensive quantitative framework and empirical result based on a large dataset. This toolkit adds more quantitative backing to this body of qualitative work and can be used in future analysis with technology adoption data to identify strategic opportunities to improve energy efficiency and access to clean technology in a more equitable manner.]{color=`r edit_color`}

[Previous work provided theoretical frameworks for understanding energy poverty beyond a simple income-based measure[@sovacoolEnergyJusticeConceptual2015], and limited examples of applications to empirical data that rely on building-specific efficiency characteristics[@faiellaEnergyPovertyHow2021] or subjective self-assessments[@sokolowskiMultidimensionalIndexMeasure2020]. Applying *N~h~* to a nationwide dataset for the US builds on this work by providing a tangible tool that includes `r to_million(number_in_poverty[1]+clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum())` households with energy expenditures greater than their incomes or with incomes above the FPL that are left out by other measures, and is a way to visualize the disparities between groups that may allow for further investigation around different household characteristics. *N~h~* highlights inequality better than a simple linear metric while allowing the assessment of a wide variety of households, such as those with no income or for which efficiency data is not available.]{color=`r edit_color`} A significant insight from [NEA]{color=`r edit_color`} that should be incorporated into future work is that embodied energy takes many forms across the household budget (food, goods, services, transportation, housing, etc.), and these can all be compared using the same units of measure (e.g., joules) to scale the *N~h~* framework across multiple expenditure categories.

The [Coronavirus Disease 2019 (]{color=`r edit_color`}COVID-19[)]{color=`r edit_color`} pandemic and associated recovery measures may be a critical opportunity to provide relief payments related to energy expenditures and to invest in more efficient residential[@RecoveringFastSlow2020a] and commercial energy infrastructure that enables newer and cleaner systems[@chapmanImpactsCOVID19Transitioning2020]. We show that US households are already spending excessive amounts on energy, notwithstanding more families staying at home for longer periods of time during pandemic lockdowns. The ongoing crisis offers a chance to address inequity with a focus on residential energy burdens[@graffCOVID19AssistanceNeeds2020]. [The EU is in the process of defining how communities can participate in the energy transition[@uihleinEnergyCommunitiesOverview2020] and how burdens can be alleviated through this process using proactive policy tools and business models such as One Stop Shops (OSS) for energy efficiency and renewable energy upgrades[@bertoldiRoleOnestopShops2021].]{color=`r edit_color`} Adopting energy criteria for energy and other programs [like these]{color=`r edit_color`} could expand access for those underserved populations in need of assistance independent of their needs in other consumption categories.

Creating a federal energy poverty line would be a critical step in identifying families that face large disparities in access to affordable electricity and energy in the [US]{color=`r edit_color`} and improve programs’ abilities to address energy burdens. A toolkit based on this analysis enables neighborhood level outreach where burdens are highest and identifies opportunities where households could benefit from emerging technologies.
[[A more comprehensive approach to poverty alleviation in the US would also consider the energy situation of each household and the options available to improve its efficiency. Then, it would make those options accessible to the stakeholders who could benefit.]{strike=`r strike_show`}]{color=`r edit_color`}
[[Even for energy assistance programs that do exist, many households reliant on inefficient fuels such as kerosene for heating must pay upfront costs to fill a tank for the winter season. These subsidy programs are largely ineffective as the cost of kerosene can be expensive, and pressure remains on households to offset existing gaps. Better opportunities to convert to alternative fuels would also provide households the opportunity to take advantage of the efficiency gains in better technology. In this way, broader programs need to be designed to provide households more options.]{strike=`r strike_show`}]{color=`r edit_color`}
[[How can our energy system be operated and improved to provide equitable access? Are there ways that clean electrification can be used to better benefit currently underserved communities?]{strike=`r strike_show`}]{color=`r edit_color`}
[[High burdens may be associated with intermittent grid access when extreme weather events interrupt energy supply chains. The same households are often at greater risk of energy service disconnection due to non-payment. Re-connection fees can compound to increase burdens in ways not captured by our analysis.]{strike=`r strike_show`}]{color=`r edit_color`} 
[[High energy burdens have already been linked to local and global air pollution, and we can connect these impacts directly to the full scope of household prosperity via net energy.]{strike=`r strike_show`}]{color=`r edit_color`}
[[Energy is essential to deal with other inequities in society. There must be a way to design a structure that addresses this disparity more equitably.]{strike=`r strike_show`}]{color=`r edit_color`}
[[While well-intended programs such as PACE or solar loans have reached few people, community-oriented programs focusing on peer-mentorship could improve programmatic outcomes. Building support for community-led programs can also reduce the burden on individuals to expand access to the benefits of solar and efficiency.]{strike=`r strike_show`}]{color=`r edit_color`}
[[Policymakers have not systematically deployed interventions based on [NEA]{color=`r edit_color`} across American households.]{strike=`r strike_show`}]{color=`r edit_color`} 
[[Net energy income is holding back socioeconomic mobility in the US.]{strike=`r strike_show`}]{color=`r edit_color`}
[[However, concerted attention to technology and policy details matter to implement a national scheme.]{strike=`r strike_show`}]{color=`r edit_color`}
[[The data demonstrate a need for quantitative methodologies to support equitable energy infrastructure investments.]{strike=`r strike_show`}]{color=`r edit_color`}

## Methods  {#methods}

#### Data  {#data}
To estimate the Net Energy Return (*N~h~*) of American households, we primarily utilize the Low Income Energy Affordability Data (LEAD)[@maLowIncomeEnergyAffordability2019] and Rooftop Energy Potential of Low-Income Communities in America (REPLICA)[@sigrinRooftopSolarTechnical2018] datasets, which the DOE assembled to help “stakeholders make data-driven decisions on energy goal setting and program planning by providing them information on low-income household populations and associated energy use characteristics”[@maLowIncomeEnergyAffordability2019]. These datasets encompass estimates of household energy expenditures (*S*), income (*G*), and demographic characteristics for most households at the census tract scale in all states and most territories of the [US]{color=`r edit_color`}.  

LEAD: The LEAD portrays the average income, electricity expenditures, gas expenditures, and other fuel expenditures for cohorts of households segmented by location (census tract, county, state) and household characteristics (whether the unit is rented or owned, the building’s year of first construction, the number of units in the building, whether the units are attached, and the unit’s primary heating fuel type). The dataset is assembled by applying an iterative proportional fitting (IPF) algorithm to cross-tabulations of household responses from the 2016 5-year American Community Survey (conducted by the US Census Bureau), which provides the samples for each cohort as Public Use Microdata Samples. IPF is a widely used spatial microsimulation method to allocate individuals (i.e., households) to zones (i.e., census tracts and utility service territories) while calibrating each zone's characteristics to known quantities. Using IPF, the microdata samples are scaled to match aggregate annual values from utility sales and revenues reported in Energy Information Administration forms 861 and 176.

REPLICA: The Renewable Energy Potential of Low-Income Communities in America (REPLICA) dataset includes [the racial and education level composition of each census tract]{color=`r edit_color`} used in the ultimate analysis[@sigrinRooftopSolarTechnical2018]. [In addition to providing a simpler designation of cohorts for each census tract, REPLICA also includes]{color=`r edit_color`} estimates of the technical potential of rooftop solar and additional techno-economic variables (e.g., demographics and electricity rates) [that will be useful for future research.]{color=`r edit_color`}

eGRID: We use the [EPA]{color=`r edit_color`}'s eGRID[@unitedstatesenvironmentalprotectionagencyepaEmissionsGenerationResource2020] to calculate the proportion of household energy expenditures that support fossil fuel combustion through the purchase of electricity. 100% of natural gas purchases are considered to support fossil fuel combustion. Electricity purchases are divided into their respective sources according to the state proportions indicated by the "STCLPR" (coal), "STOLPR" (oil), "STGSPR" (gas), and "STOFPR" (other fossil) fields in the 2018 eGRID dataset. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately `r scales::percent(pct_other_fossil, accuracy=1)` fossil fuel combustion.

#### Treatment  {#treatment}
The LEAD data represents the unit’s ownership status (OWNER vs. RENTER) and income bracket as a fraction of [AMI]{color=`r edit_color`} (0-30%, 30-60%, 60-80%, 80-100%, or 100%+) or [FPL]{color=`r edit_color`} (0-100%, 100-150%, etc.). These categorical variables are saved as factors. Then we create min_units from BLD INDEX, a variable which represents a non-uniformly distributed set of buckets for the range of the number of units in the building and whether single-unit households are attached or detached from neighboring households (1 ATTACHED, 1 DETACHED, 2 UNIT, 3-4 UNIT, 5-9 UNIT, 10-19 UNIT, 20-49 UNIT, 50+ UNIT, MOBILE_TRAILER, BOAT_RV_VAN, OTHER UNIT). We extract the minimum number of units from the range and whether the building is detached. Those households labeled OTHER UNIT, MOBILE_TRAILER, or BOAT_RV_VAN are given values of Not Applicable (NA) for this characteristic. Finally, we calculate *S* and *G* of which each metric is composed: 

*S* = annual expenditures on electricity (ELEP CAL) + natural gas (GASP CAL) + and other fuels (FULP)  

*G* = the cohort’s average annual income (HINCP) 

The metric formulas outlined in [Applying NER to Energy Equity](#ratios) are then used to calculate each cohort’s energy poverty metrics. Since we are examining homes’ relationships with the energy system, we ignore any homes that do not use energy as denoted by rows where *S*==0. The estimation procedure used by the DOE results in an estimated number of occupied housing units for each cohort (UNITS, renamed as households). It displays the number of American Community Survey responses that contribute to the estimate of energy expenditures (COUNT, renamed as acs_responses). We then remove any categories with fewer than 1 unit represented since this is not physically possible. `r removed_households = "This results in removing X% of the available rows (gross: X rows of X). This is a total of X housing units or X% of the estimated total X units in the sample. We have separated any cohorts with incomes or energy costs equal to 0 into another dataset for analysis. This represents approximately X% of the housing units and X% of the examined cohorts, so it will be important to make sure that this subset does not contain systematic bias. However, these data are excluded from the current analysis under the assumption that energy costs equal to 0 are not relevant to this analysis."`

We then combine this dataset with the REPLICA dataset. To do so, we must aggregate the income levels of the LEAD dataset to the simpler schema used by REPLICA for summarizing households’ income relative to the area’s median income (AMI):

- 0-30% AMI: Very-Low-Income
- 30-80% AMI: Low-to-Moderate-Income
- $\geq$ 80% AMI: Middle-to-High-Income

Also, we create an indicator of whether a particular cohort is in income poverty as defined by the relevant standards for its characteristics. For the AMI version of LEAD, this is defined as being “Very-Low-Income” or $\leq$ 30% of AMI. For the FPL version of LEAD, we translate directly from the designation of the income bracket as follows:

- 0-100% FPL: In Poverty
- $\geq$ 100% FPL: Not In Poverty

The REPLICA dataset also simplifies any households with only one unit per building into “Single Family” homes and any households with more than one unit per building as “Multi-family.” Non-stationary and non-traditional homes are not included in the REPLICA analysis. We match these simplifications in the LEAD dataset by aggregating by the number of units:

- 1 Unit: Single-Family
- $>$ 1 Unit: Multi-Family
- Other Unit: NA (excluded from analysis)

After simplifying these characteristics in the LEAD [AMI]{color=`r edit_color`} data, we merge the AMI dataset with the REPLICA dataset along the census tract, simplified income bracket, simplified number of units, and housing tenure variables to achieve the primary dataset used in the analysis. Merging with the REPLICA dataset provides additional demographic and geospatial data not available in the LEAD dataset only[@sigrinRooftopSolarTechnical2018]. Characteristics such as the utility type and locale description are sourced from REPLICA and unavailable in LEAD[, and we source the cost of electricity, racial composition, and education levels of census tracts from REPLICA for this analysis]{color=`r edit_color`}. Similarly, the REPLICA dataset contains only electrical expenditure estimates without natural gas or other fuel costs to households and could not be used to perform this analysis alone.

The FPL version of LEAD is not merged with all of the REPLICA data because of incompatibility between the FPL and [AMI]{color=`r edit_color`} bracket definitions. However, demographic data associated with each census tract as a whole can be merged with the FPL dataset. Both AMI and FPL versions of LEAD are combined with demographic data from the REPLICA dataset and geospatial shapefiles from the Census to produce the final datasets used in the analysis. [Since the FPL version of LEAD is not aggregated to the simpler categories found in REPLICA, more granular variables such as Primary Heating Fuel remain available for assessment across the entire population.]{color=`r edit_color`}

#### Considerations  {#considerations}
[While a helpful place to start, *E~b~* has certain drawbacks.]{color=`r edit_color`} Significantly, a simple proportion does not account for the fact that money spent on energy cannot be spent elsewhere and is therefore not useful income to the household for the purposes of measuring prosperity. Including gross income in *E~b~* has the effect of depressing the average *E~b~*, by definition.

Furthermore, because energy expenditures are a small proportion of even the most impoverished households' total income, *E~b~* is almost always a very small percentage (<10%). This leads to issues with interpretability in public discourse and policy settings and may even affect program outcomes that are based on *E~b~* if small numbers are rounded to even the nearest hundredth of a percent. [As the UK experienced when using *E~b~*, i]{color=`r edit_color`}f the household is above an energy poverty line defined by such a metric for public policy purposes, the family may not receive critical support[[@bednarRecognitionResponseEnergy2020].[, or energy may be sidelined by other basic needs.]{strike=`r strike_show`}]{color=`r edit_color`}

Because such a small proportion of expenditures can impact different income groups so differently, ratios of this type can be useful when delineating across income quantiles or other categories - particularly for vulnerable populations where energy poverty poses a significant difficulty or affordability threshold not captured by measures of absolute poverty. However, *E~b~* is often portrayed at a population scale (e.g., the average energy burden of the population is X%)[, which can be skewed by outliers within the population]{color=`r edit_color`}. Household metrics and surveys are important for further understanding of and policy development around issues of energy poverty. 

Finally, presenting the relationship between household income and energy expenditures as a proportion with income in the denominator suggests that improvements can only be made by decreasing energy expenditures or increasing incomes. However, in reality, there is a positive relationship between energy expenditures and incomes because energy is an input to wealth-creating processes[[and the unit costs of energy decrease as absolute consumption increases]{strike=`r strike_show`}]{color=`r edit_color`}. Households consume energy to unlock the utility that energy services provide to them as participants in society, whether to cook food or connect to the internet. This relationship is generally accepted when understanding individual household behavior[@thomasEstimatingDirectIndirect2013] and macro-economic effects of energy consumption[@saundersKhazzoomBrookesPostulateNeoclassical1992]. Therefore, a metric describing the efficiency of household wealth creation may be more intuitive with income in the numerator.

The iterative proportional fitting method has limitations as an estimation procedure that constrain the strength of conclusions that can be drawn from the simulated LEAD and REPLICA datasets. The relationship between constraint variables such as total energy spending by utility service territory and number of households per census tract will tend toward the average of the initializing dataset and depress variations among otherwise similar regions. This may explain the large quantities of households that are estimated to have very low incomes. Validating these estimated data would require randomized surveys of households along the dimensions of interest.

The meaning of the “primary heating fuel” category comes from the answer to the question “Which fuel is used most for heating this house, apartment, or mobile home?” on the American Community Survey. This question’s power to predict energy expenditures or fuel sources is unknown, and further analysis is required to understand the implications of this survey question for drawing broader conclusions about household energy use. However, the US Census Bureau has been asking this question since 1940. It states that these data are collected to help communities "provide assistance with utilities," "estimate future energy demand," and "measure environmental impacts"[@unitedstatescensusbureauWhyWeAsk2021].

Though the REPLICA dataset relies on a different vintage of the LEAD dataset (assembled in 2017[@sigrinRooftopSolarTechnical2018]) than this analysis (assembled in 2019[@maLowIncomeEnergyAffordability2019]), inferring differences among annual estimates is not meaningful due to the standard error of the data [@maLowIncomeEnergyAffordability2019]. A rigorous treatment of these metrics over time is an area for future research.

The results inferred from eGRID are only as good as the eGRID methodology itself. We choose to outline the proportion of combusted fuels rather than emissions data due to the limitations outlined by proponents of marginal emissions attribution in electric power system models[@vonwaldAnalyzingCaliforniaFramework2020]^,^[@siler-evansMarginalEmissionsFactors2012] and limitations in estimating regional electricity transfers[@vonwaldAccountingGreenhouseGas2021].
[[Expanding quantitative analysis of energy affordability can offer additional context, including the use of ratios to identify populations that could be particularly vulnerable to energy shocks or absolute energy burdens. Developing such metrics can elucidate the scale on which American households must save for energy consumption. Frequently used metrics in this category do not tell the whole story. For instance, the simple proportion of a household’s income spent on energy bills (a.k.a. energy burden) does not capture the underlying monthly cash flow patterns that may stress household budgets.]{strike=`r strike_show`}]{color=`r edit_color`}

## Code Availability {#code-availability}

The code and data to fully reproduce this paper are available on GitHub at [[https://github.com/ericscheier/net_energy_equity](https://github.com/ericscheier/net_energy_equity)]{hide=`r hide`} under the GNU Affero General Public License v3.0. [The most recent release of the software can be found at [DOI: 10.5281/zenodo.5676225](https://doi.org/10.5281/zenodo.5676225)[@scheierMeasurementStrategyAddress2021].]{highlight=`r highlight`}

## Data Availability  {#data-availability}

[The data generated in this study have been deposited in the the Zenodo database under [DOI: 10.5281/zenodo.5676225](https://doi.org/10.5281/zenodo.5676225)[@scheierMeasurementStrategyAddress2021].]{highlight=`r highlight`}

All data necessary for the composition of the source datasets used in this analysis are freely available from [US]{color=`r edit_color`} government sources as open data. All functions to automatically retrieve and assemble these data and compiled versions of these data are made available to the user as part of the software [available at [DOI: 10.5281/zenodo.5676225](https://doi.org/10.5281/zenodo.5676225)[@scheierMeasurementStrategyAddress2021].]{highlight=`r highlight`}.

## References  {#references}

::: {#refs}
:::

```{r eval=FALSE}
# # Works Not Yet Cited  {#uncited}
# 
# ---
# nocite: |
#   @*
# ...
# 
# # Software Used  {#software}
# 
# List of R packages used to be entered here automatically
#
```

## Acknowledgements  {#acknowledgements}
[The authors wish to thank Nikhil Kaza and Andy Yates for insightful conversations, review, comments, feedback, and advice on this study.]{highlight=`r highlight`}

## Author Contributions  {#author-contributions}

ES and NK conceived of and designed the project. ES created the software used for data acquisition and analysis and created the figures. NK contributed the introduction of the topic and interpretation of the results.

## Competing Interests  {#competing-interests}

The authors declare no competing interests.


```{r eval=FALSE}
# 
# # Additional Information  {#additional-information}
# 
# # (APPENDIX) Appendix {-}  {#appendix}
# 
# # Charts for All Variables {#charts}
```

```{r, include = FALSE, eval=FALSE}
r_packages_used <- c("rmarkdown", "knitr")
knitr::write_bib(x = r_packages_used, file = "bibliography.bib")
#https://stackoverflow.com/questions/60026015/use-citation-in-r-markdown-to-automatically-generate-a-bibliography-of-r-packa
```

## Tables

\captionsetup[table]{labelformat=empty}
Table \@ref(tab:comparison-table): 
```{r comparison-table-display, include=TRUE, results="asis"}
final_table
```
\captionsetup[table]{labelformat=default}

## Figure Legends/Captions

Figure \@ref(fig:metric-comparison): (ref:metric-comparison-fig-cap)

Figure \@ref(fig:continental-map): (ref:continental-map-fig-cap)

Figure \@ref(fig:inset-map): (ref:inset-map-fig-cap)

Figure \@ref(fig:density-charts): (ref:density-charts-fig-cap)

Figure \@ref(fig:state-violin): (ref:state-violin-fig-cap)


```{r}
# merge data together
if(!is_preview){
  write.csv(x=clean_data_fpl,file="CohortData_FederalPovertyLine.csv")
  write.csv(x=clean_data_ami,file="CohortData_AreaMedianIncome.csv")
  write.csv(x=replica_sup,file="CensusTractData.csv")
}
# save as csv

```

