---
title: "Identifying At-Risk Communities"
author: "Eric Scheier"
date: "`r Sys.Date()`"
output: html_document
---

# PSPS

See psps.rmd

# Weather-caused Power Outage

? PG&E data
? 

# FEMA National Risk Index Factors

+ Avalanche
+ Coastal Flooding
+ Cold Wave
+ Drought
+ Earthquake
+ Hail
+ Heat Wave
+ Hurricane
+ Ice Storm
+ Landslide
+ Lightning
+ Riverine Flooding
+ Strong Wind
+ Tornado
+ Tsunami
+ Volcanic Activity
+ Wildfire
+ Winter Weather

https://hazards.fema.gov/nri/data-resources#shpDownload

```{r}
"NRI_Shapefile_CensusTracts" #shp
"NRI_Shapefile_Tribal_CensusTracts" #shp
```


<!--chapter:end:ca_at_risk_communities.Rmd-->

---
title: "Identifying Underserved Communities"
author: "Eric Scheier"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo=FALSE,
  message=FALSE,
  warning=FALSE,
  include=FALSE
  )

library(tidyverse)
library(knitr)
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)

source("sources.R")
```

```{r}
# metric_name <- "neb"
# metric_cutoff_level <- ner_func(g = 1,s = 0.06)^-1
# metric_label <- bquote(E[b]^n)

metric_name <- "energy_burden"
metric_cutoff_level <- 0.06
metric_label <- bquote(E[b])

# as.expression(bquote(~italic(nE[b])~": Energy Burden"))
```


```{r load-data}
clean_data_ami_all <- read_csv("CohortData_AreaMedianIncome.csv")
clean_data_fpl_all <- read_csv("CohortData_FederalPovertyLine.csv")
replica_sup <- read_csv("CensusTractData.csv") #get_replica_supplemental_dataset()

census_tracts_shp <- get_tract_shapefiles(
    states="all",
    acs_version=acs_version,
    refresh=refresh,
    return_files=TRUE,
    all_from_list=unique(replica_sup$state_abbr)
  )
```

```{r preprocessing}
clean_data_ami_all$neb <- clean_data_ami_all$ner^-1
clean_data_fpl_all$neb <- clean_data_fpl_all$ner^-1

clean_data_ami_all_sup <- left_join(clean_data_ami_all, replica_sup, by=c("geoid"))
clean_data_fpl_all_sup <- left_join(clean_data_fpl_all, replica_sup, by=c("geo_id"="geoid"))

clean_data_ami_all_sup_shp <- st_sf(left_join(census_tracts_shp, clean_data_ami_all_sup, by=c("gisjoin")))
clean_data_fpl_all_sup_shp <- st_sf(left_join(census_tracts_shp, clean_data_fpl_all_sup, by=c("gisjoin")))
```

```{r}
tract_shp <- st_sf(left_join(census_tracts_shp, replica_sup, by=c("gisjoin")))

continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))

state_shp <- tract_shp %>% filter(state_abbr=="CA")

county_shp <- state_shp %>% filter(county_name %in% c("Sonoma County", "Mendocino County"))

grid_operator_shp <- tract_shp %>% filter(company_na=="Pacific Gas & Electric Co")

territory_shp <- tract_shp %>% filter(state_abbr=="CA", 
                                         county_name %in% 
                                           c("Sonoma County",
                                             "Mendocino County"),
                                         company_na %in% c("Pacific Gas & Electric Co",
                                                           "Trinity Public Utilities District")
                                         )

group_variable <- "geoid"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #


# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

# full_map_data <- left_join(tract_shp, gwm, by=c("geoid"))

gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami_all,
                                                    c("geoid"),
                                                    metric_name),
                           c("geoid"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)

gwm$metric_name <- metric_name

territory_map_data <- left_join(territory_shp, gwm, by=c("geoid"))
state_map_data <- left_join(state_shp, gwm, by=c("geoid"))
county_map_data <- left_join(county_shp, gwm, by=c("geoid"))
continental_map_data <- left_join(continental_shp, gwm, by=c("geoid"))
grid_operator_map_data <- left_join(grid_operator_shp, gwm, by=c("geoid"))


knitr::opts_chunk$set(echo=FALSE)
```

# State Scale

```{r pressure, fig.cap=""}
clean_top_metrics <- grouped_weighted_metrics(filter_graph_data(clean_data_ami_all, 
                                                                group_columns=NULL,
                                                                metric_name),# %>% 
                                                #filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)
```


```{r pressure, fig.cap=""}
choropleth_chart <- choropleth_map(
    clean_data=territory_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens in SCP Service Territory"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    include_compass = TRUE,
    compass_location="bottomleft",
    metric_long_name = bquote(E[b]),
    include_borders=TRUE,
    border_field="tract_fips",
    legend_position="right", #c(0.15, 0.125),
    legend_direction="vertical",
    flip_scale=TRUE
)
  

choropleth_chart

# choropleth_chart_footnote <- gridExtra::grid.arrange(
#   choropleth_chart,
#   bottom = textGrob(as.expression(
#                                            bquote(~italic(
#                                              E[b]
#                                              )~": Energy Burden")
#                                            ), 
#                     x = 1,
#                     hjust = 1, 
#                     gp = gpar(
#                                   # fontface = 3L,
#                                   fontsize = 9))
# )
```

```{r}
d_base <- make_all_charts(
  clean_data=clean_data_ami_all_sup, 
  group_columns=c(NULL),
  metric_name=metric_name, 
  metric_cutoff_level = metric_cutoff_level,
  metric_cutoff_label= NULL
)

# d_base
```

```{r}
clean_data_ami_all_sup_shp_dei <- clean_data_ami_all_sup_shp
```


# AB 841 Priority Communities

AB 841 priority communities are defined as meeting one of the following criteria:

## Disadvantaged Community (PRC Section 75005(g))

(1) Is a “disadvantaged community” as defined by subdivision (g) of Section 75005 of the Public Resources Code.

(g) “Disadvantaged community” means a community with a median household income less than 80% of the statewide average. “Severely disadvantaged community” means a community with a median household income less than 60% of the statewide average.

```{r}
clean_data_ami_all_sup_shp_dei <- clean_data_ami_all_sup_shp_dei %>% 
  group_by(
    STATEFP
  ) %>% 
  mutate(
    state_average_income = mean(sum(income * households, na.rm = T)/sum(households, na.rm = T))
  ) %>% 
  ungroup() %>%
  group_by(
    geoid
  ) %>% 
  mutate(
    tract_average_income = mean(sum(income * households, na.rm = T)/sum(households, na.rm = T))
  ) %>%
  mutate(
    tract_is_disadvantaged = tract_average_income < 0.80*state_average_income,
    tract_is_severely_disadvantaged = tract_average_income < 0.60*state_average_income
  ) %>%
  ungroup() %>% 
  mutate(
    community_is_disadvantaged = income < 0.80*state_average_income,
    community_is_severely_disadvantaged = income < 0.60*state_average_income
  )
    
clean_data_ami_all_sup_shp_dei
```

```{r}
# lens_summary <- calculate_weighted_metrics(filter_graph_data(clean_data_ami_all_sup_shp_dei,
#                                                     c("geoid"),
#                                                     "community_is_disadvantaged"),
#                            c("geoid"),
#                            "community_is_disadvantaged",
#                            metric_cutoff_level=0,
#                            upper_quantile_view = 1,
#                            lower_quantile_view=0)
# 
# lens_summary$metric_name <- "community_is_disadvantaged"

lens_summary <- clean_data_ami_all_sup_shp_dei %>% 
  group_by("geoid") %>% 
  

territory_map_data <- left_join(territory_shp, gwm, by=c("geoid"))

clean_data_ami_all_sup_shp_dei %>% 

left_join(territory_shp, lens_summary)

library(viridis)
p <- ggplot() +
  geom_polygon(data = spdf_fortified, 
               aes(fill = nb_equip, x = long, y = lat, group = group) , size=0, alpha=0.9) +
  theme_void() +
  # scale_fill_viridis(trans = "log", 
  #                    breaks=c(1,5,10,20,50,100), 
  #                    name="Number of restaurant", 
  #                    guide = guide_legend( keyheight = unit(3, units = "mm"), 
  #                                          keywidth=unit(12, units = "mm"), label.position = "bottom", 
  #                                          title.position = 'top', nrow=1) ) +
  # labs(
  #   title = "South of France Restaurant concentration",
  #   subtitle = "Number of restaurant per city district",
  #   caption = "Data: INSEE | Creation: Yan Holtz | r-graph-gallery.com"
  # ) +
  # theme(
  #   text = element_text(color = "#22211d"),
  #   plot.background = element_rect(fill = "#f5f5f2", color = NA),
  #   panel.background = element_rect(fill = "#f5f5f2", color = NA),
  #   legend.background = element_rect(fill = "#f5f5f2", color = NA),
  # 
  #   plot.title = element_text(size= 22, 
  #                             hjust=0.01, color = "#4e4d47", margin = margin(b = -0.1, t = 0.4, l = 2, unit = "cm")),
  #   plot.subtitle = element_text(size= 17, 
  #                                hjust=0.01, color = "#4e4d47", margin = margin(b = -0.1, t = 0.43, l = 2, unit = "cm")),
  #   plot.caption = element_text( size=12, color = "#4e4d47", margin = margin(b = 0.3, r=-99, unit = "cm") ),
  # 
  #   legend.position = c(0.7, 0.09)
  # ) +
  coord_map()
p
```


## Low-income Community (Health and Safety Code Section 39713(2)(d))

(2) Is included within the definition of “low-income communities” as defined by paragraph (2) of subdivision (d) of Section 39713 of Health and Safety Code

(2) “Low-income communities” are census tracts with median household incomes at or below 80 percent of the statewide median income or with median household incomes at or below the threshold designated as low income by the Department of Housing and Community Development's list of state income limits adopted pursuant to Section 50093.

https://www.hcd.ca.gov/state-and-federal-income

```{r}
clean_data_ami_all_sup_shp_dei
```


## Most Disadvantaged 25% on CalEnviroScreen

(3) Is within an area identified as among the most disadvantaged 25 percent in the state according to the California Environmental Protection Agency and based on the most recent California Communities Environmental Health Screening Tool, also known as CalEnviroScreen.

```{r}
"calenviroscreen40gdb_F_2021.gdb"
```


## 75% National School Lunch Program Participation

(4) Is a community in which at least 75 percent of public school students in the project area are eligible to receive free or reduced-price meals under the National School Lunch Program.

https://www.cde.ca.gov/ds/ad/filessp.asp
https://nces.ed.gov/programs/edge/Geographic/RelationshipFiles

```{r}
"frpm2122.xlsx" #"FRPM School-Level Data"
"GRF21/grf21_lea_tract.xlsx"
"Percent (%) Eligible FRPM (K-12)"
```


## California Indian Tribe (Federally Recognized)

(5) Is a community located on lands belonging to a federally recognized California Indian tribe.

https://biamaps.doi.gov/bogs/datadownload.html

```{r}
"BIA_National_LAR_shp"
```


# Opportunity Zones

https://hudgis-hud.opendata.arcgis.com/datasets/ef143299845841f8abb95969c01f88b5_0/about

```{r}
"Opportunity_Zones.geojson"
```

# CalEnviroScreen

## Overall

## Components

# CPUC ESJ Communities

https://www.cpuc.ca.gov/news-and-updates/newsroom/environmental-and-social-justice-action-plan

“Environmental and Social Justice Communities” or “ESJ Communities” are identified as those where residents are:

## Predominantly communities of color or low-income;
## Underrepresented in the policy setting or decision-making process;
## Subject to a disproportionate impact from one or more environmental hazards; and
## Likely to experience disparate implementation of environmental regulations and socio-economic investments in their communities.

These communities also include, but are not limited to:

## Disadvantaged Communities (Defined as census tracts that score in the top 25% of CalEnviroScreen 3.0, along with those that score within the highest 5% of CalEnviroScreen 3.0's Pollution Burden but do not receive an overall CalEnviroScreen score);
## All Tribal lands;
## Low-income households (Defined as household incomes below 80 percent of the area median income); and
## Low-income census tracts (Defined as census tracts where aggregated household incomes are less than 80 percent of area or state median income).

# Additional Considerations

## California Indian Tribe (State Recognized)
We might want to add state recognized tribes.

## CalEnviroScreen Sensitivity
The most disadvantaged 25% under CalEnviroScreen would only be 1-2 census tracts in our territory.

# Energy Burden

# number of members of households
# demographics, census data

<!--chapter:end:ca_underserved_communities.Rmd-->

---
title: "A measurement strategy to address disparities across household energy burdens"
author: ""
institute: 
  - "Focus: Orange County, NC"
  - "These Slides Were Created On:"
date: "`r format(Sys.time(), '%Y-%B-%d')`"
output: 
  beamer_presentation:
    slide_level: 1
    toc: false #true
    theme: "Berkeley"
    colortheme: "seagull"
    fonttheme: "structurebold"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{makecell}
  - \setbeameroption{hide notes} #{show/hide notes}
  - \setbeamerfont{note page}{size=\tiny} 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo=FALSE,
  message=FALSE,
  warning=FALSE,
  include=FALSE
  )

library(tidyverse)
library(knitr)
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)

source("sources.R")
```

```{r parameters}

focus_state <- "North Carolina"
focus_state_abbr <- "NC" #c("ca","nc","sc") #
focus_state

scope_counties <- list("NC"=
                         c(
                           "Orange County",
                           "Durham County",
                           "Wake County"
                           ),
                       "CA"=
                         c("Sonoma County",
                           "Mendocino County")
                       )

focus_counties_table <- data.frame(
  county_abbr=unlist(focus_counties), 
  state_abbr=str_remove(names(unlist(focus_counties)),"[0-9]"))

focus_companies <- c("Duke Energy Carolinas", "Duke Energy Progress")

focus_communities <- 

refresh <- FALSE
acs_version <- 2018
energy_burden_poverty_line <- 0.06
# geographic_scope <- "tract" #statecitycounty

```

```{r load-data}
clean_data_ami_all <- read_csv("CohortData_AreaMedianIncome.csv")
clean_data_fpl_all <- read_csv("CohortData_FederalPovertyLine.csv")
replica_sup <- read_csv("CensusTractData.csv") #get_replica_supplemental_dataset()

census_tracts_shp <- get_tract_shapefiles(
    states="all",
    acs_version=acs_version,
    refresh=refresh,
    return_files=TRUE,
    all_from_list=unique(replica_sup$state_abbr)
  )
```


```{r preprocessing}
clean_data_ami_all_sup <- left_join(clean_data_ami_all, replica_sup, by=c("geoid"))
clean_data_ami_fpl_sup <- left_join(clean_data_fpl_all, replica_sup, by=c("geo_id"="geoid"))

clean_data_ami_all_sup_shp <- st_sf(left_join(census_tracts_shp, clean_data_ami_all_sup, by=c("gisjoin")))
clean_data_fpl_all_sup_shp <- st_sf(left_join(census_tracts_shp, clean_data_fpl_all_sup, by=c("gisjoin")))


clean_data_ami <- clean_data_ami_ami_sup_shp %>%
                                  filter(state_abbr %in% names(focus_counties), 
                                         county_name %in% 
                                           c(focus_counties),
                                         # company_na %in% c("Pacific Gas & Electric Co",
                                                           # "Trinity Public Utilities District")
                                         )

clean_data_fpl <- clean_data_ami_fpl_sup_shp %>%
                                  filter(state_abbr=="NC", 
                                         county_name %in% 
                                           c("Orange County",
                                             "Durham County",
                                             "Wake County"
                                             )#,
                                         # company_na %in% c("Pacific Gas & Electric Co",
                                         #                   "Trinity Public Utilities District")
                                         )

# this is where geospatial and other filtering should happen

## define territory 
## define zoom scope/area - if NULL, use the most populous scale below the territory scale (e.g. largest city in the county)

source("paper_source.R")
# tract_file_name <- paste0("data/",paste(states,collapse="_",sep=""),"_census_tracts.geojson")



tract_shp <- st_sf(left_join(census_tracts_shp, replica_sup, by=c("gisjoin")))

continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))

state_shp <- tract_shp %>% filter(state_abbr %in% focus_states)

county_shp <- tract_shp %>% filter(paste(county_name,state_abbr,sep=";") %in% c("Orange County;NC"))

grid_operator_shp <- tract_shp %>% filter(company_na %in% focus_companies)

territory_shp <- tract_shp %>% filter(state_abbr=="NC", 
                                         county_name %in% 
                                           c("Orange County"),
                                         company_na %in% c("Piedmont Electric Member Corp")
                                         )

group_variable <- "geoid"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #


# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

# full_map_data <- left_join(tract_shp, gwm, by=c("geoid"))

gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami_all,
                                                    c("geoid"),
                                                    metric_name),
                           c("geoid"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)

gwm$metric_name <- metric_name

territory_map_data <- left_join(territory_shp, gwm, by=c("geoid"))
state_map_data <- left_join(state_shp, gwm, by=c("geoid"))
county_map_data <- left_join(county_shp, gwm, by=c("geoid"))
continental_map_data <- left_join(continental_shp, gwm, by=c("geoid"))
grid_operator_map_data <- left_join(grid_operator_shp, gwm, by=c("geoid"))
```

# New Data

Low-Income Energy Affordability Data (LEAD)

**Purpose**: "to help state and local partners understand housing and energy characteristics for the low- and moderate-income (LMI) communities they serve"

  + **Source**: U.S. Department of Energy
  + **Method**: Iterative Proportional Fitting (IPF) of responses from the 5-year American Community Survey (ACS-5)
  + **Geography**: Census tracts for 50 states, D.C., & P.R.
  + **Provides**: Incomes and Energy Costs by Housing Characteristics
  + **Years**: 2016, 2018

\note{
Distinct urban and rural analyses have been performed to describe energy inequity in the US. While limited by geographic and demographic focus and a lack of peer-review, these studies have established the proportion of income (G) spent on energy expenditures (S), or energy burden (Eb), as the standard benchmark for energy poverty in the US today (Equation 1). The US Department of Energy (DOE) significantly improved upon previous methodology by assembling its Low-Income Energy Affordability Dataset (LEAD), which estimates incomes and energy expenditures for most households in the US at a census tract scale.
}

# Energy Burden & Net Energy Return

\[G = Gross\ Income\ ;\ S = Spending\ on\ Energy\]
\[
Energy\ Burden\ (E_{b})= \frac{S}{G}
\]
\[
Household\ Net\ Energy\ Return\ (N_{h}) = \frac{G - S}{S}
\]
\[E_{B}^{*} = \frac{S}{G} = 6\%\ ;\ N_{h}^{*} \approx 16 \Rightarrow Household\ at\ Energy\ Poverty\ Line\]

```{r load-table-full, include=FALSE}
compare_table <- create_comparison_table(
    metrics_to_compare=NULL,
    input_dataset=clean_data_ami_all,
    include_totals=TRUE
)
```

```{r table-full, results="asis"}
create_printable_comparison_table(compare_table) %>%  knitr::kable(booktabs=T, escape = F) %>%
  kable_styling(latex_options="scale_down")
  #kableExtra::kable_styling(latex_options = c("striped","hold_position"))
```

# Geography

```{r pressure, fig.cap=""}
clean_top_metrics <- grouped_weighted_metrics(filter_graph_data(clean_data_ami_all, 
                                                                group_columns=NULL,
                                                                metric_name),# %>% 
                                                #filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=continental_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens in the Continental United States"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = TRUE,
    metric_long_name = bquote(E[b]),
    include_borders=TRUE
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             E[b]
                                             )~": Energy Burden")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```

\note{
Another contribution of this work is that by using Nh, we can display these data spatially across the US to
explore how different communities are experiencing energy outcomes as in Figure 2 and investigate specific
communities at multiple scales such as census tract, county, state, and regional as in Figure 3. This figure shows a spatial display of energy poverty that includes 5.3 million more households that would not be captured by traditional poverty metrics because their incomes are too low (Eb>100\%) or too high (above the FPL). By processing disparate data sources into a coherent structure and providing a convenient open-source tool for others to do the same, these data can be used in urban planning, public policy, and other relevant contexts. Displayed geospatially in Figure 2, the Black Belt in the American Southeast is visibly perceptible as an area of high burden, indicating that low-Nh follows racial lines. Likewise, border populations and immigrant populated areas in the Southwest have higher burdens, as do Native American lands. High burdens can also be seen in rural Northeast states where heating burdens are high. Nh allows a nuanced view of these widely ranging income dynamics by portraying them on a scale that matches the scope of the issues: areas of high energy burden (close to Nh=0) are visible in orange while highly affluent areas are also visually perceptible as dark blue even though these groups’ average metrics are multiple orders of magnitude apart.
}

# State Scale

```{r, fig.cap=""}
choropleth_chart <- choropleth_map(
    clean_data=state_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens in California"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = FALSE,
    legend_position=c(0.25, 0.125),
    metric_long_name = bquote(E[b]),
    include_borders=TRUE,
    border_field="county_fips"
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             E[b]
                                             )~": Energy Burden")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```

# County Scale

```{r}
# clean_top_metrics <- grouped_weighted_metrics(graph_data,# %>% 
#                                                 #filter(!(state_abbr %in% c("HI","AK", NA))), 
#                          group_columns=NULL, 
#                          metric_name, 
#                          metric_cutoff_level, 
#                          upper_quantile_view=.995, 
#                          lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=county_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view=.75,
    lower_quantile_view=.001,
    chart_title=paste0("Energy Burdens in Orange County, NC"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = FALSE,
    legend_position=c(0.25, 0.125),
    metric_long_name = bquote(E[b]),
    include_borders=TRUE,
    border_field="tract_fips"
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             E[b]
                                             )~": Energy Burden")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```


# Service Territory Scale

```{r}
# PG&E
choropleth_chart <- choropleth_map(
    clean_data=grid_operator_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens on Duke Energy NC Grid"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    include_compass = FALSE,
    legend_position=c(0.30, 0.125),
    metric_long_name = bquote(N[h]),
    include_borders=TRUE,
    border_field="county_fips"
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             E[b]
                                             )~": Energy Burden")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```


# Distribution Territory Scale

```{r}
choropleth_chart <- choropleth_map(
    clean_data=territory_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens on Local Distribution Cooperative Grid (Piedmont EMC)"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    include_compass = FALSE,
    legend_position=c(0.30, 0.125),
    metric_long_name = bquote(N[h]),
    include_borders=TRUE,
    border_field="county_fips"
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             E[b]
                                             )~": Energy Burden")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```


```{r}
# Urban Scale

# zoom into Santa Rosa or similar metro area?
```


\note{
Urban inequity results in lower Nh populations not showing up in many dense or gentrified urban areas such
as the San Francisco Bay Area, New York City, and New Orleans, as shown in Figure 3. The pervasiveness
of urban energy poverty in Detroit has been studied extensively and shown to have distinct geographic
boundaries down to the street level19. While some of these conclusions are supported by existing evidence
and literature, they should be confirmed with a rigorous analysis of this dataset using the Nh metric for the
reasons explained in Applying NER to Energy Equity: extremely low-income households are not visible on a
0-100\% scale, and households with no income are often discarded as outliers. Additional analyses should
incorporate additional demographic and household dimensions due to potential disparities within census
tracts since diverse neighborhoods may not be represented accurately by aggregate census tract metrics.
}

# High Level

```{r}

calc_energy_poverty_rates <- function(
    input_dataset,
    metric_name,
    metric_cutoff_level
    ){
      fpl_top_metrics <- grouped_weighted_metrics(
        filter_graph_data(
          input_dataset, 
          group_columns="in_poverty", 
          metric_name),
        group_columns="in_poverty", 
        metric_name=metric_name, 
        metric_cutoff_level=metric_cutoff_level, 
        upper_quantile_view=1.00, 
        lower_quantile_view=0.00)
      
      total_households <- fpl_top_metrics$household_count
      
      number_in_poverty <- fpl_top_metrics$households_below_cutoff
      
      pct_in_poverty <- number_in_poverty / total_households
      
      pct_above_poverty <- 1 - pct_in_poverty
      
      in_both_poverty <- pct_in_poverty[2]
      
      in_only_energy_poverty <- pct_in_poverty[1]
      
      energy_poverty_rate <- sum(number_in_poverty) / sum(total_households)
      
      energy_poverty_rates <- list(
        total_households=total_households,
        number_in_poverty=number_in_poverty,
        pct_in_poverty=pct_in_poverty,
        pct_above_poverty=pct_above_poverty,
        in_both_poverty=in_both_poverty,
        in_only_energy_poverty=in_only_energy_poverty,
        energy_poverty_rate=energy_poverty_rate
      )
      
      return(energy_poverty_rates)
}
```


```{r}
all_ep_rates <- calc_energy_poverty_rates(
    input_dataset=clean_data_fpl_all,
    metric_name,
    metric_cutoff_level
    )

territory_ep_rates <- calc_energy_poverty_rates(
    input_dataset=clean_data_fpl,
    metric_name,
    metric_cutoff_level
    )

energy_poverty_rate <- all_ep_rates$energy_poverty_rate
territory_energy_poverty_rate <- territory_ep_rates$energy_poverty_rate

territory_energy_burden_poverty_line <- energy_burden_poverty_line

fpl_gap_households <- ifelse(
  all_ep_rates$number_in_poverty[1]>10^6,
  to_million(all_ep_rates$number_in_poverty[1]),
  to_big(all_ep_rates$number_in_poverty[1]))

territory_fpl_gap_households <- ifelse(
  territory_ep_rates$number_in_poverty[1]>10^6,
  to_million(territory_ep_rates$number_in_poverty[1]),
  to_big(territory_ep_rates$number_in_poverty[1]))
```

In Orange County [the United States] -- `r scales::percent(territory_energy_poverty_rate, accuracy=1)` [`r scales::percent(energy_poverty_rate, accuracy=1)`] of households experience energy poverty as presently defined as spending more than `r to_percent(territory_energy_burden_poverty_line)` [`r to_percent(energy_burden_poverty_line)`] of household income on energy expenditures and more than `r territory_fpl_gap_households` [`r fpl_gap_households`] households above the Federal Poverty Line face energy poverty (`r to_percent(territory_ep_rates$in_only_energy_poverty)` [`r to_percent(all_ep_rates$in_only_energy_poverty)`] of this subset).

```{r territory-load-table-full, include=FALSE}
territory_compare_table <- create_comparison_table(
    metrics_to_compare=NULL,
    input_dataset=clean_data_ami,
    include_totals=TRUE
)
```

```{r territory-table-full, results="asis"}
create_printable_comparison_table(territory_compare_table) %>%  knitr::kable(booktabs=T, escape = F) %>%
  kable_styling(latex_options="scale_down")
  #kableExtra::kable_styling(latex_options = c("striped","hold_position"))
```

# Energy Burden Distribution in County

```{r}
top_line_group <- NULL

p1 <-   density_chart(graph_data, 
                                 metric_name, 
                                 metric_label=as.expression(
                                           bquote(~italic(
                                             N[h]
                                             ))
                                           ), 
                                 group_columns=top_line_group, 
                                 metric_cutoff_level, 
                                 metric_cutoff_label, 
                                 chart_title="Distribution of Energy Burdens", 
                                 chart_subtitle=NULL,
                                 x_label="Proportion of Households")
p1
```


# Household Breakdowns

```{r}
top_line_group <- "income_bracket"

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p2=top_line_charts[["density"]]
p2_stats=top_line_charts[["metrics"]]
```
\note{
`r p2_stats`
}

```{r}
top_line_group <- c("simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p3=top_line_charts[["density"]]
p3_stats=top_line_charts[["metrics"]]
```
```{r}
top_line_group <- c("number_of_units")
# c("number_of_units", "occupancy_type"),
#                           c("occupancy_type", "income_bracket"),
#                           c("number_of_units", "occupancy_type", "income_bracket"),

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p4=top_line_charts[["density"]]
```


```{r}
top_line_group <- c("housing_tenure")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p5=top_line_charts[["density"]]
p5_stats=top_line_charts[["metrics"]]
```


```{r}
minority_races <- c("hispanic","african_american","asian","native_american")
races <- c(minority_races,"caucasian")

pct_races <- replica_sup[,paste0("pop_",races)] / rowSums(replica_sup[,paste0("pop_",races)])
names(pct_races) <- paste0("pct_",races)

plurality_race <- races[max.col(pct_races,ties.method = "first")]

plurality_race <- ifelse(plurality_race=="african_american","black",
                                   ifelse(plurality_race=="native_american","indian",
                                          ifelse(plurality_race=="caucasian","white",
                                          plurality_race)))

race_data <- data.frame("geoid"=replica_sup$geoid,
                        "race"=plurality_race)

data_with_race <- inner_join(x=clean_data_ami, 
                             y=na.omit(race_data), by = "geoid")

top_line_group <- c("race")

top_line_charts <- make_all_charts(data_with_race,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p7=top_line_charts[["density"]]
p7_stats=top_line_charts[["metrics"]]
education_levels <- c("some_college_plus","high_school", "no_high_school")
```


```{r}
pct_education_levels <- replica_sup[,paste0("pop25_",education_levels)] / 
  rowSums(replica_sup[,paste0("pop25_",education_levels)])
names(pct_education_levels) <- paste0("pct_",education_levels)

plurality_education_level <- education_levels[max.col(pct_education_levels,ties.method = "first")]

plurality_education_level <- ifelse(plurality_education_level %in% 
                                      c("high_school","no_high_school"),
                                    "high school or less",
                                    ifelse(plurality_education_level=="some_college_plus",
                                           "college or more",
                                          plurality_education_level))

education_data <- data.frame("geoid"=replica_sup$geoid,
                        "simplified_education"=plurality_education_level)


top_line_group <- c("simplified_education")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(education_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p8=top_line_charts[["density"]]
p8_stats=top_line_charts[["metrics"]]
```


```{r breakdowns, fig.cap=""}
gt <- patchwork::patchworkGrob((p2+p3+p4)/(p5+p7+p8)  + 
                                 plot_layout(heights = c(1,1)) +
  plot_annotation(tag_levels = 'a') &
  theme(plot.tag = element_text(face = 'bold')))
# gridExtra::grid.arrange(gt, left = "Disp", bottom = "Hp // Cyl")
gt_all <- gridExtra::arrangeGrob(gt, 
                        top="Distribution of Energy Burdens Across Household Characteristics",
                        bottom="Proportion of Households",
                        left=grid.text(label=
                                         as.expression(
                                           bquote(~italic(
                                             N[h]
                                             ))
                                           ),
                                       draw=FALSE
                                       ))

gt_all_footnote <- gridExtra::grid.arrange(
  gt_all,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```

\note{
From this high level, we can see in Figure 4.a that approximately 16\% of households in the US experience energy poverty.

Displaying these communities defined by their relationship to the US Federal Poverty Line
(FPL), which indicates income poverty status according to government policy, in Figure 4.b provides a stark picture. While 94\% of households below the FPL also face energy poverty, more than 5.2 million of those households above the FPL face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap and the inadequacy of FPL as an indicator of energy poverty in particular. 

This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in Nh on the households’ energy investments is surprising.

Figure 4.c shows that households with solar as a primary heating fuel have a higher Nh (Nh=111) than those which rely on other fuel sources (Nh=33), even for households far below the energy poverty line: the average
Nh for energy-impoverished households utilizing solar power is 19, compared to 7 for those relying on any other fuel source. The slope of the Nh density lines in Figure 4.c indicates that these lower-income households seem to experience a different rate of return on Nh from the benefits of increased energy adoption than higher-income households. Why are certain households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households’ low consumption, meaning that the potential savings from implementing energy efficiency measures are lower than for high-income households.
}

# Confounding Characteristics

```{r}
top_line_group <- c("housing_tenure",
                    "number_of_units")

top_line_charts <- make_all_charts(clean_data_fpl %>% filter(!is.na(number_of_units)),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
multifam_stats=top_line_charts
```

```{r}
top_line_group <- c("housing_tenure",
                    "income_bracket")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
housing_income_stats=top_line_charts
```

```{r}
gt <- patchwork::patchworkGrob(multifam_stats[["density"]]+housing_income_stats[["density"]]  + 
                                 plot_layout(
                                   widths = c(1,1)) +
  plot_annotation(tag_levels = 'a') &
  theme(plot.tag = element_text(face = 'bold')))
# gridExtra::grid.arrange(gt, left = "Disp", bottom = "Hp // Cyl")
gt_all <- gridExtra::arrangeGrob(gt, 
                        top="Distribution of Energy Burdens Across Household Characteristics",
                        bottom="Proportion of Households",
                        left=grid.text(label=
                                         as.expression(
                                           bquote(~italic(
                                             N[h]
                                             ))
                                           ),
                                       draw=FALSE
                                       ))

gt_all_footnote <- gridExtra::grid.arrange(
  gt_all,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```



# State Comparison by Fuel Composition

```{r states, fig.cap=""}
group_columns <- c("state_abbr")
# utility type? see chartbook
graph_data <- filter_graph_data(clean_data=clean_data_ami_all[clean_data_ami_all$state_abbr!="DC",], 
                                group_columns=group_columns, 
                                metric_name=metric_name)

# percent of "other" fuel expenditures toward fossil fuel combustion
# want to make this more precise by state, county, and/or balancing authority eventually
other_gwm <- grouped_weighted_metrics(clean_data_fpl_all[clean_data_fpl_all$state_abbr!="DC",], 
                                      c("primary_heating_fuel"),
                                      "other_spend",
                                      0)

other_fuels <- c("COAL","FUEL OIL","NONE","OTHER","SOLAR","WOOD","BOTTLED GAS")
non_fossil_other_fuels <- c("NONE","SOLAR","WOOD")
fossil_other_fuels <- other_fuels[!(other_fuels %in% non_fossil_other_fuels)]

other_fossil <- other_gwm[other_gwm$primary_heating_fuel %in% fossil_other_fuels,
                              c("household_count","metric_mean")]

pct_other_fossil <- sum(other_fossil$household_count*other_fossil$metric_mean)/
  sum(other_gwm$household_count*other_gwm$metric_mean)

graph_data$pct_other_fossil <- pct_other_fossil

# percent of each state's electric grid decidated to fossil fuel combustion
# can refine by balancing authority based on REPLICA dataset
egrid <- get_state_egrid()

egrid$pct_electricity_fossil <- egrid$STCLPR + #coal
  egrid$STOLPR + #oil
  egrid$STGSPR + #gas
  egrid$STOFPR #+ #other fossil
  # egrid$STNCPR #+ #nuclear
  # egrid$STHYPR #+ #hydro
  # egrid$STOPPR #unknown/purchased

graph_data <- left_join(graph_data, egrid, by=c("state_fips"="FIPSST"))

# graph_data <- graph_data[graph_data$state_abbr!="DC",]

# percent of natural gas expenditures dedicateed to fossil fuel combustion...
pct_gas_fossil <- 1.0

graph_data$pct_gas_fossil <- pct_gas_fossil

graph_data$pct_fossil_tract <- (graph_data$pct_gas_fossil * graph_data$gas_spend + 
  graph_data$pct_electricity_fossil * graph_data$electricity_spend + 
  graph_data$pct_other_fossil * graph_data$other_spend) / 
  (graph_data$gas_spend + graph_data$electricity_spend + graph_data$other_spend)


pct_fossil_gwm <- grouped_weighted_metrics(graph_data, "state_fips","pct_fossil_tract",0) %>% 
  dplyr::rename(pct_fossil=metric_mean)

graph_data <- left_join(graph_data, 
                        pct_fossil_gwm[,c("state_fips","pct_fossil")], 
                        by="state_fips")

top_line_charts <- make_all_charts(graph_data,
                            group_columns="state_abbr",
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL)

state_by_state <- top_line_charts[["metrics"]]

electricity_prices_summary <- calculate_weighted_metrics(graph_data, 
                                                         c("state_abbr"), 
                                                         "dlrs_kwh", 
                                                         metric_cutoff_level = 
                                                           ner_poverty_line)

x_label <- as.expression(bquote(~italic(N[h])~": Household Net Energy Return"))


y <- make_violin_chart(graph_data=graph_data,
                      group_columns=group_columns,
                      metric_name=metric_name,
                      metric_label=metric_label,
                      metric_cutoff_level=metric_cutoff_level,
                      fill_metric="pct_fossil",#"STCYPR",#"STSOPR",
                      fill_label="% of Energy Expenditures on \nFossil Fuel Combustion",#Combustion",#Solar",
                      group_name="State",
                      chart_title="Comparison of Energy Burdens Among the United States",
                      x_label=x_label)
print(y)
```

\note{
Assessing the Nhs among different states in Figure 5 presents a counterintuitive picture of how states address energy poverty and energy equity. Nh can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as
Connecticut (Nh=26) and Vermont (Nh=23), where 47\% and 30\% higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi (Nh=22) and Alabama (Nh=24), which have significant low-income populations
and low per-unit energy prices (22\% and 8\% lower than average, respectively"‘). Not only are households in these states falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in
Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood may suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on new metrics.

Although they are the states with the highest Nh, California (Nh=59) and Colorado (Nh=63) are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely,
this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation are a common thread among the top-performing states on an Nh basis, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure 5 shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high Nhs than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.
}

<!--chapter:end:county_slides.Rmd-->

---
title: "Net energy metrics reveal striking disparities across United States household energy burdens"
author: "Eric Scheier"
institute: 
  - "eric@scheier.org"
  - "INFORMS 2021"
  - "This Presentation Was Recorded On:"
date: "`r format(Sys.time(), '%Y-%B-%d')`"
output: 
  beamer_presentation:
    slide_level: 1
    toc: false #true
    theme: "Berkeley"
    colortheme: "seagull"
    fonttheme: "structurebold"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{makecell}
  - \setbeameroption{show notes} #{show/hide notes}
  - \setbeamerfont{note page}{size=\tiny} 
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)

version_path <- "net_energy_equity_major_review_files"

knitr::opts_chunk$set(
  echo=FALSE,
  message=FALSE,
  warning=FALSE
  )
```

# Energy Affordability is Inequitable in the US

```{r preview, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/continental-map-1.pdf",sep="/"))
```

\note{
Energy inequity in the United States is an issue of increasing urgency. Few policyrelevant datasets evaluate the energy burden of typical American households. Here, we develop a framework using Net Energy Analysis and socioeconomic data at the household level to observe systematic energy inequity across the United States among critical groups that heed policy attention. We find substantial instances of energy poverty in the United States – 16\% of households experience energy poverty. While 94\% of households below the Federal Poverty Line also face energy poverty, more than 5.2 million households above the Federal Poverty Line face this scarcity. We identify that energy expenditures across census tracts disproportionately burden Black, Hispanic, and Native American communities, and we recommend the United States develop a more inclusive federal energy poverty categorization that provides greater assistance for household energy costs.
}

# Energy Burden & Net Energy Return

\[
G = Gross\ Income
\]
\[
S = Spending\ on\ Energy
\]

\[
Energy\ Burden\ (E_{b})= \frac{S}{G}
\]
\[
Household\ Net\ Energy\ Return\ (N_{h}) = \frac{G - S}{S}
\]

\[
E_{B}^{*} = \frac{S}{G} = 6\%
\]
\[
N_{h}^{*} ~16 \Rightarrow Household\ at\ Energy\ Poverty\ Line
\]

\note{
While a variety of thresholds have been developed and explored, energy-poor households in the US are commonly defined in terms of Eb as those with an expenditure of greater than 6\% of household income on energy.

While a helpful place to start, EB has certain drawbacks. A simple proportion does not account for the fact that money spent on energy cannot be spent elsewhere and is therefore not useful income to the household for the purposes of measuring prosperity, effectively depressing the average EB, by definition.

Energy expenditures are a small proportion of even the most impoverished households’ total income, Eb is almost always a very small percentage (<10\%). This leads to issues with interpretability in public discourse and policy settings and may even affect program outcomes that are based on Eb if small numbers are rounded to even the nearest hundredth of a percent. If the household is above an energy poverty line defined by such a metric for public policy purposes, the family may not receive critical support.

Ratios of this type can be useful when delineating across income quantiles or other categories - particularly for vulnerable populations where energy poverty poses a significant difficulty or affordability threshold not captured by measures of absolute poverty. However, Eb is often portrayed at a population scale, which can be skewed by outliers within the population.

Finally, presenting the relationship between household income and energy expenditures as a proportion with income in the denominator suggests that improvements can only be made by decreasing energy expenditures or increasing incomes. However, in reality, there is a positive relationship between energy expenditures and incomes because energy is an input to wealth-creating processes. Households consume energy to unlock the utility that energy services provide to them as participants in society, whether to cook food or connect to the internet. Therefore, a metric describing the efficiency of household wealth creation may be more intuitive with income in the numerator.

Net Energy Return, which describes the newly released potential to do work as a result of some activity, is recommended as a basis for future analysis, especially in the study of macro-energy systems like the US residential housing stock. The main contribution of the study is the application of NER as an indicator of household energy poverty.

Translated into its relative level for Net Energy Return, the 6\% energy poverty line is approximately 16. This means that a household that earns less than approximately \$16 of income for every dollar it spends on secondary energy.
}

# Why Net?

```{r comparison, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/metric-comparison-1.pdf",sep="/"))
```


\note{
Net Energy Return has several useful mathematical properties: it can smoothly handle systems with negative incomes and energy costs, accept households with zero income, and emphasize extreme incomes and energy costs in an interpretable fashion, as shown in Figure 1. While Eb appears inversely correlated to income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes (approximately n=118,000 households in the dataset have Eb>100\% or Eb<0\%). Due to the structure of the Eb equation (Equation 1), the Eb of these households approaches infinity and cannot be captured on the standard 0-100\% scale the metric is intended to be interpreted within: around 37,000 homes have an infinite energy burden. Since our source data is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. Nh provides a framing of the same dataset that allows for exploration of most households on a similar scale without the long tail. Nh appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing Nh avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, Nh offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent. Many households with moderate-to-high Ebs are actually higher-income households with high energy expenditures, making their Nhs quite high (e.g., >\$100 of income per \$1 of energy spending). Only households with no energy costs are excluded from the analysis, whereas households with no energy costs or incomes must be excluded from an analysis utilizing Eb.

}

# New Data

Low-Income Energy Affordability Data (LEAD)

**Purpose**: "to help state and local partners understand housing and energy characteristics for the low- and moderate-income (LMI) communities they serve"

  + **Source**: U.S. Department of Energy
  + **Method**: Iterative Proportional Fitting (IPF) of responses from the 5-year American Community Survey (ACS-5)
  + **Geography**: Census tracts for 50 states, D.C., & P.R.
  + **Provides**: Incomes and Energy Costs by Housing Characteristics
  + **Years**: 2016, 2018

\note{
Distinct urban and rural analyses have been performed to describe energy inequity in the US. While limited by geographic and demographic focus and a lack of peer-review, these studies have established the proportion of income (G) spent on energy expenditures (S), or energy burden (Eb), as the standard benchmark for energy poverty in the US today (Equation 1). The US Department of Energy (DOE) significantly improved upon previous methodology by assembling its Low-Income Energy Affordability Dataset (LEAD), which estimates incomes and energy expenditures for most households in the US at a census tract scale.
}

# Summary

```{r load-table, include=FALSE}
print_table <- read_csv("comparison_table.csv")
```


```{r table, results="asis"}
print_table %>%  knitr::kable(booktabs=T, escape = F) %>%
  kable_styling(latex_options="scale_down")
  #kableExtra::kable_styling(latex_options = c("striped","hold_position"))
```

\note{
Table 1 shows a summary of these data for households and their average statistics delineated by their incomes relative to the median income of similar size families in the same metropolitan area or non-metropolitan county, known as Area Median Income (AMI). We can see that high burdens are found mostly in the very-low-income group, with an average Eb of 14\% or Nh of 6.2. Income drives the escape from energy poverty: middle and high-income groups do not spend drastically different amounts on energy (21\% and 63\% more, respectively) but earn 3 and 10 times that of the very low-income group, respectively. An Eb of 14\% means that \$71 per month is spent on energy, which is quite high on a monthly income of \$510. The additional \$15 per month that the next rung of moderate-income groups spends on energy represents a minuscule proportion of their income (1\%).

}

# Geography

```{r pressure, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/continental-map-1.pdf",sep="/"))
```

\note{
Another contribution of this work is that by using Nh, we can display these data spatially across the US to
explore how different communities are experiencing energy outcomes as in Figure 2 and investigate specific
communities at multiple scales such as census tract, county, state, and regional as in Figure 3. This figure shows a spatial display of energy poverty that includes 5.3 million more households that would not be captured by traditional poverty metrics because their incomes are too low (Eb>100\%) or too high (above the FPL). By processing disparate data sources into a coherent structure and providing a convenient open-source tool for others to do the same, these data can be used in urban planning, public policy, and other relevant contexts. Displayed geospatially in Figure 2, the Black Belt in the American Southeast is visibly perceptible as an area of high burden, indicating that low-Nh follows racial lines. Likewise, border populations and immigrant populated areas in the Southwest have higher burdens, as do Native American lands. High burdens can also be seen in rural Northeast states where heating burdens are high. Nh allows a nuanced view of these widely ranging income dynamics by portraying them on a scale that matches the scope of the issues: areas of high energy burden (close to Nh=0) are visible in orange while highly affluent areas are also visually perceptible as dark blue even though these groups’ average metrics are multiple orders of magnitude apart.
}

# Urban Centers

```{r, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/inset-map-1.pdf",sep="/"))
```

\note{
Urban inequity results in lower Nh populations not showing up in many dense or gentrified urban areas such
as the San Francisco Bay Area, New York City, and New Orleans, as shown in Figure 3. The pervasiveness
of urban energy poverty in Detroit has been studied extensively and shown to have distinct geographic
boundaries down to the street level19. While some of these conclusions are supported by existing evidence
and literature, they should be confirmed with a rigorous analysis of this dataset using the Nh metric for the
reasons explained in Applying NER to Energy Equity: extremely low-income households are not visible on a
0-100\% scale, and households with no income are often discarded as outliers. Additional analyses should
incorporate additional demographic and household dimensions due to potential disparities within census
tracts since diverse neighborhoods may not be represented accurately by aggregate census tract metrics.
}

# Household Breakdowns

```{r breakdowns, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/density-charts-1.pdf",sep="/"))
```

\note{
From this high level, we can see in Figure 4.a that approximately 16\% of households in the US experience energy poverty.

Displaying these communities defined by their relationship to the US Federal Poverty Line
(FPL), which indicates income poverty status according to government policy, in Figure 4.b provides a stark picture. While 94\% of households below the FPL also face energy poverty, more than 5.2 million of those households above the FPL face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap and the inadequacy of FPL as an indicator of energy poverty in particular. 

This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in Nh on the households’ energy investments is surprising.

Figure 4.c shows that households with solar as a primary heating fuel have a higher Nh (Nh=111) than those which rely on other fuel sources (Nh=33), even for households far below the energy poverty line: the average
Nh for energy-impoverished households utilizing solar power is 19, compared to 7 for those relying on any other fuel source. The slope of the Nh density lines in Figure 4.c indicates that these lower-income households seem to experience a different rate of return on Nh from the benefits of increased energy adoption than higher-income households. Why are certain households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households’ low consumption, meaning that the potential savings from implementing energy efficiency measures are lower than for high-income households.
}

# Household Breakdowns

```{r breakdowns-2, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/density-charts-1.pdf",sep="/"))
```

\note{
Examining these dynamics by the status of homeownership in Figure 4.d reveals further disparities. Though renters and homeowners are similarly distributed below the energy poverty line (28\% of renters and 17\% of homeowners are in energy poverty), there appears to be an advantage of homeownership from a net energy
perspective (Nh=37 for homeowners versus Nh=39 for renters). Only at a relatively high Nh do renters seem to have an advantage: owners of multi-family apartments earn 2.4 times as much as renters of single-family homes when normalized by energy expenditures. Renters face systemic disadvantages in the energy transition;
they typically pay the home’s energy costs while the landlord controls infrastructure upgrades, commonly understood as the split incentive problem36. Tenure matters for more than just equity itself: renters are less likely to take actions to improve their Nhs due to a lack of property rights and split incentives. Even
when action is taken to improve the energy efficiency of a rental building, tenants are less likely to see any economic benefits from it.

Furthermore, Figure 4.e shows that Nh varies widely by racial demography. Asian households have the highest Nh across the entire population distribution (Nh=65), and Indian households have the lowest (Nh=18), with Black households a close second from the lowest (Nh=26). These relative positions are the same across the
entire population distribution, with only White (Nh=38) and Hispanic (Nh=36) populations showing different relative Nhs across the population. Households in communities of color experience energy poverty at a rate 60\% more than those in white communities.

Education level also seems to be correlated with disparate Nh outcomes according to Figure 4.f, with a wide gap between those households in areas with mostly high-school (Nh=25) or college-educated (Nh=40) populations.
}

# State Comparison

```{r states, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/state-violin-1.pdf",sep="/"))
```

\note{
Assessing the Nhs among different states in Figure 5 presents a counterintuitive picture of how states address energy poverty and energy equity. Nh can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as
Connecticut (Nh=26) and Vermont (Nh=23), where 47\% and 30\% higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi (Nh=22) and Alabama (Nh=24), which have significant low-income populations
and low per-unit energy prices (22\% and 8\% lower than average, respectively"‘). Not only are households in these states falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in
Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood may suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on new metrics.

Although they are the states with the highest Nh, California (Nh=59) and Colorado (Nh=63) are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely,
this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation are a common thread among the top-performing states on an Nh basis, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure 5 shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high Nhs than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.
}

# Conclusions

+ 16% of households experience energy poverty as presently defined (>6% of household income on energy expenditures)
+ 94% of households below the federal poverty line also face energy poverty
+ More than 5.2m of those above the federal poverty line face this scarcity
+ Fossil fuel reliance does not lead to lower energy poverty rates at a state scale
+ Solar power is associated with decreased energy poverty at a household scale
+ Energy poverty presents an obstacle to decarbonization and wealth creation

# Conclusions

Energy expenditures in the US disproportionately burden those in:

+ Communities of color
+ Communities with limited education
+ Rural cold areas
+ Urban Centers

The United States should develop and implement a federal energy poverty line.

# Thank You!

```{r review, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/continental-map-1.pdf",sep="/"))
```

eric@scheier.org

https://github.com/ericscheier/net_energy_equity

<!--chapter:end:INFORMS_2021_slides.Rmd-->

---
title: Measuring household net energy burdens
author:
  - name: Eric Scheier
    affil: Emergi
    main: true
    email: eric@emergi.eco
date: "`r Sys.Date()`"
poster_height: "24in"
poster_width: "36in"
font_family: "Montserrat"
primary_colour: "#228b2280"
secondary_colour: "#4d4d4d"
accent_colour: "#9e9e9e"
main_width: 0.5
main_fontfamily: "Montserrat"
main_textcol: "#4d4d4d"
main_textsize: "140px"
main_picwidth: "100%"
main_padding_top: "5%"
body_bgcol:	"#9e9e9e20"	#Background colour of the poster's body.
body_textsize: "25px"	#Size of any paragraph text found in the poster.
body_textcol:	"#000000"	#Colour of the body text.
title_textsize: "80pt"	#Text size for the poster title if title is given.
author_textsize: "1.17em"	#Text size for author output (this is only for the option where author has main: true).
author_textcol:	none	#Colour of the author text. Use hex values for easiest use. Will overrule the 'primary' colour if set.
authorextra_textsize:	"35px"	#Text size of all author names if they are note listed as main:true.
affiliation_textsize:	"25px"	#Text size of the affiliation output.
affiliation_textcol:	'#00000060'	#Colour of the affiliation text output.
caption_textsize:	"20pt"	#Text size for any caption text generated by figures or tables in the document.
reference_textsize:	"25px"	#Text size of the automated Reference section if used.
column_padding:	"10mm"	#Padding size for the content of the body section from the edge of the poster as well as from the edge of the main section.
link-citations:	true	#Will make inline citations a clickable link which will direct the reader to the appropriate portion of the "References" section.
bibliography: Poster.bib	#File path to a .bib bibliography file if needed.
csl: nature-no-et-al.csl	#File path to a .csl file which will change the citation style for the document, many options can be found at on the Zotero Styles Repository
output:
  pagedown::chrome_print:
    clean: false
  posterdown::posterdown_betterland:
    self_contained: false
    #pandoc_args: --mathjax
    #highlight: espresso
    number_sections: false
    template: poster_template.html
    clean: false
---

```{r setup, include=FALSE}
# knit: pagedown::chrome_print
# rmarkdown::render("MES_2022_poster.Rmd")
# bookdown::render_book('MES_2022_poster.Rmd', clean = FALSE)
# pagedown::chrome_print("MES_2022_poster.Rmd")
# xaringan::inf_mr()
# servr::daemon_stop(1)

knitr::opts_chunk$set(results = 'asis',
                      echo = FALSE,
                      warning = FALSE,
                      tidy = FALSE,
                      message = FALSE,
                      fig.align = 'center',
                      out.width = "100%",
                      include=FALSE,
                      cache=TRUE,
                      cache.lazy=FALSE
                      )
options(knitr.table.format = "html") 

source("sources.R")
```

```{r parameters}
metric_name <- "neb"

energy_burden_poverty_line <- 0.06
ner_poverty_line <- ner_func(g = 1,s = energy_burden_poverty_line)
metric_cutoff_level <- (ner_poverty_line)^-1

metric_label <- bquote(E[b]^n)

# as.expression(bquote(~italic(nE[b])~": Energy Burden"))
```


```{r load-data}
clean_data_ami_all <- read_csv("CohortData_AreaMedianIncome.csv")
clean_data_fpl_all <- read_csv("CohortData_FederalPovertyLine.csv")
replica_sup <- read_csv("CensusTractData.csv") #get_replica_supplemental_dataset()

census_tracts_shp <- get_tract_shapefiles(
    states="all",
    acs_version=acs_version,
    refresh=refresh,
    return_files=TRUE,
    all_from_list=unique(replica_sup$state_abbr)
  )
```

```{r preprocessing}
clean_data_ami_all$neb <- clean_data_ami_all$ner^-1
clean_data_fpl_all$neb <- clean_data_fpl_all$ner^-1

clean_data_ami_all_sup <- left_join(clean_data_ami_all, replica_sup, by=c("geoid","state_abbr",
                                                                          "state_fips",
                                                                          "company_ty",
                                                                          "locale"))
clean_data_fpl_all_sup <- left_join(clean_data_fpl_all, replica_sup, by=c("geo_id"="geoid",
                                                                          "state_abbr",
                                                                          "state_fips"
                                                                          ))

clean_data_ami_all_sup_shp <- st_sf(left_join(census_tracts_shp, clean_data_ami_all_sup, by=c("gisjoin")))
clean_data_fpl_all_sup_shp <- st_sf(left_join(census_tracts_shp, clean_data_fpl_all_sup, by=c("gisjoin")))
```

```{r scp}
clean_data_ami_all_sup_shp_scp <- clean_data_ami_all_sup_shp %>% filter(state_abbr=="CA", 
                                         county_name %in% 
                                           c("Sonoma County",
                                             "Mendocino County"),
                                         company_na %in% c("Pacific Gas & Electric Co",
                                                           "Trinity Public Utilities District")
                                         )
```


```{r serc}
# C:\Users\Eric Scheier\Documents\apps\net_energy_equity\f8612018\Utility_Data_2018.xlsx
# merge states and territories tabs
# join with clean data on state_abbr and eia utility number
# limit to census tracts in SERC

clean_data_ami_all_sup_shp_serc <- clean_data_ami_all_sup_shp %>% 
  filter(state_abbr %in% 
           c("AL", #Alabama, 
             "GA", #Georgia, 
             "MS", #Mississippi, 
             "MO", #Missouri, 
             "NC", #North Carolina, 
             "SC", #South Carolina, 
             "TN", #Tennessee, 
             #and portions of 
             "AR", #Arkansas, 
             "IL", #Illinois, 
             "KY", #Kentucky, 
             "LA", #Louisiana, 
             "OK", #Oklahoma, 
             "TX", #Texas, 
             "VA", #Virginia, 
             "FL" #Florida, 
             )
                                         )
```

```{r continent}
clean_data_ami_all_sup_shp_continent <- 
  clean_data_ami_all_sup_shp %>% 
  filter(!(state_abbr %in% c("HI","AK", NA)))
```

```{r make-main-chart}
poster_charts <- make_all_charts(
  clean_data=clean_data_ami_all_sup_shp_scp, #clean_data_ami_all_sup_shp, 
  group_columns=c(NULL),
  metric_name=metric_name, 
  metric_label=metric_label,
  metric_cutoff_level = metric_cutoff_level,
  metric_cutoff_label= NULL,
  weighted_metrics_data = clean_data_ami_all_sup_shp,

  upper_quantile_view=1.0,
  lower_quantile_view=0.0,
  
  chart_title=NULL,
  chart_subtitle=NULL,
  chart_caption=NULL,
  x_label="Proportion of Households",
  
  border_field = "state_fips"
)
```

```{r save-main-chart, include=FALSE}
ggsave("poster_map.svg", 
       plot=poster_charts[["choropleth"]],
       # device = NULL,
       # path = NULL,
        scale = 1,
        width = 16,
        height = 12,
        units = "in", #c("in", "cm", "mm", "px"),
        dpi = 300,
        limitsize = TRUE,
        bg = NULL
       )
# print(final_map)
```

```{r make-qr-code}
library(qrcode)
code <- qr_code("https://emergi.shinyapps.io/net_energy_equity/")
# print(code)
# plot(code)
generate_svg(code, 
             filename = "qr.svg", 
             foreground="black",
             background="white",
             show=FALSE)
```

---
main_findings:
  - "**_1 in 6_ American homes faces energy poverty**"
  - '![](poster_map.svg){.main_pic}'
logoleft_name: ![](emergi_logo.png){.main-img-left}{width=250px}
logoright_name: ![](qr.svg){.main-img-right}{width=250px}
---

# Introduction

Energy burden is a standard indicator of energy affordability and equity.

\[G = Gross\ Income\ ;\ S = Spending\ on\ Energy\]
\[
Energy\ Burden\ (E_{b})= \frac{S}{G}
\]

Can we build on the energy burden framework by assessing __*net*__ energy burdens at a macro-energy systems scale? Yes[@scheierMeasurementStrategyAddress2022].

\[
Household\ Net\ Energy\ Return\ (N_{h}) = \frac{G - S}{S}
\]

# Methods

Redefine our net energy metric as a percentage to improve understanding:

\[
Net\ Energy\ Burden\ (E^{n}_{b}) = \frac{S}{G - S}
\]

Apply the Net Energy Burden ($E_b^n$) framework to estimates of spending and income for the U.S. residential housing stock[@maLowIncomeEnergyAffordability2019] to determine how many homes' __net energy burdens__ lie below a standard energy poverty line of **$E_b^n \approx 6\%$**.

\[E_{B}^{*} = \frac{S}{G} = 6\%\ \Rightarrow \ E^{n*}_{b} \approx 6\%\ ;\ N_{h}^{*} \approx 16\]

# Results

+ **1 in `r round(6,0)`** homes in the U.S. faces energy poverty.
+ **1 in `r round(4,0)`** homes facing energy poverty is above the US Federal Poverty Line
+ **Solar** powered homes experience energy poverty **`r to_percent(1/2)` as often** as other homes
+ Homes in minority communities experience energy poverty **`r round(2,0)`x as often** as other homes

# Ongoing Work

## Sonoma Clean Power Authority

![](doe_eere_logo.jpg){width=350px} ![](scp_logo.svg){width=350px}

```{r make-scp-charts, eval=FALSE}
# SCP subset map
poster_charts_scp <- make_all_charts(
  clean_data=clean_data_ami_all_sup_shp_scp, #clean_data_ami_all_sup_shp, 
  group_columns=c(NULL),
  metric_name=metric_name, 
  metric_cutoff_level = metric_cutoff_level,
  metric_cutoff_label= NULL,
  weighted_metrics_data = clean_data_ami_all_sup_shp,
  border_field = "county_fips"
)
```


```{r show-scp-chart, include=TRUE}
# print(poster_charts_scp[["dashboard"]])
print(poster_charts[["dashboard"]])
```

This work is funded by the Solar Energy Innovators Program of the United States Department of Energy's Office of Energy Efficiency & Renewable Energy and hosted by Sonoma Clean Power Authority, the public power provider for 240,000 residents of California's Sonoma and Mendocino Counties in the United States.

## Emergi

![](emergi_logo_wide.png){width=350px} ![](UNC_logo_RGB.svg){width=350px}

```{r make-serc-charts, eval=FALSE}
# SERC Subset Map
poster_charts_serc <- make_all_charts(
  clean_data=clean_data_ami_all_sup_shp_serc, #clean_data_ami_all_sup_shp, 
  group_columns=c(NULL),
  metric_name=metric_name, 
  metric_cutoff_level = metric_cutoff_level,
  metric_cutoff_label= NULL,
  weighted_metrics_data = clean_data_ami_all_sup_shp,
  border_field = "state_fips"
)
```


```{r show-serc-chart, include=TRUE}
# print(poster_charts_serc[["choropleth"]])
print(poster_charts[["dashboard"]])
```

Emergi is a cooperative energy provider which connects its members with local solar farms throughout the Southeastern United States, supported by the University of North Carolina - Chapel Hill and its member-owners.

# References

<!--chapter:end:MES_2022_poster.Rmd-->

---
title: Estimating Community Net Burdens of Housing and Transportation Energy in
  American Homes
author: "Eric Scheier"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo=FALSE,
  message=FALSE,
  warning=FALSE,
  include=FALSE
  )

library(tidyverse)
library(knitr)
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)

source("sources.R")
```

```{r}
metric_name <- "neb"

energy_burden_poverty_line <- 0.06
ner_poverty_line <- ner_func(g = 1,s = energy_burden_poverty_line)
metric_cutoff_level <- (ner_poverty_line)^-1

metric_label <- bquote(E[b]^n)

# as.expression(bquote(~italic(nE[b])~": Energy Burden"))
```


```{r load-data}
clean_data_ami_all <- read_csv("CohortData_AreaMedianIncome.csv")
clean_data_fpl_all <- read_csv("CohortData_FederalPovertyLine.csv")
replica_sup <- read_csv("CensusTractData.csv") #get_replica_supplemental_dataset()

census_tracts_shp <- get_tract_shapefiles(
    states="all",
    acs_version=acs_version,
    refresh=refresh,
    return_files=TRUE,
    all_from_list=unique(replica_sup$state_abbr)
  )
```

```{r preprocessing}
clean_data_ami_all$neb <- clean_data_ami_all$ner^-1
clean_data_fpl_all$neb <- clean_data_fpl_all$ner^-1

clean_data_ami_all_sup <- left_join(clean_data_ami_all, replica_sup, by=c("geoid","state_abbr",
                                                                          "state_fips",
                                                                          "company_ty",
                                                                          "locale"))
clean_data_fpl_all_sup <- left_join(clean_data_fpl_all, replica_sup, by=c("geo_id"="geoid",
                                                                          "state_abbr",
                                                                          "state_fips"
                                                                          ))

clean_data_ami_all_sup_shp <- st_sf(left_join(census_tracts_shp, clean_data_ami_all_sup, by=c("gisjoin")))
clean_data_fpl_all_sup_shp <- st_sf(left_join(census_tracts_shp, clean_data_fpl_all_sup, by=c("gisjoin")))
```

```{r}
clean_data_ami_all_sup_shp_scp <- clean_data_ami_all_sup_shp %>% filter(state_abbr=="CA", 
                                         county_name %in% 
                                           c("Sonoma County",
                                             "Mendocino County"),
                                         company_na %in% c("Pacific Gas & Electric Co",
                                                           "Trinity Public Utilities District")
                                         )
```


```{r}
# C:\Users\Eric Scheier\Documents\apps\net_energy_equity\f8612018\Utility_Data_2018.xlsx
# merge states and territories tabs
# join with clean data on state_abbr and eia utility number
# limit to census tracts in SERC

clean_data_ami_all_sup_shp_serc <- clean_data_ami_all_sup_shp %>% 
  filter(state_abbr %in% 
           c("AL", #Alabama, 
             "GA", #Georgia, 
             "MS", #Mississippi, 
             "MO", #Missouri, 
             "NC", #North Carolina, 
             "SC", #South Carolina, 
             "TN", #Tennessee, 
             #and portions of 
             "AR", #Arkansas, 
             "IL", #Illinois, 
             "KY", #Kentucky, 
             "LA", #Louisiana, 
             "OK", #Oklahoma, 
             "TX", #Texas, 
             "VA", #Virginia, 
             "FL" #Florida, 
             )
                                         )
```

```{r}
clean_data_ami_all_sup_shp_continent <- 
  clean_data_ami_all_sup_shp %>% 
  filter(!(state_abbr %in% c("HI","AK", NA)))
```

```{r}
poster_charts <- make_all_charts(
  clean_data=clean_data_ami_all_sup_shp_continent, #clean_data_ami_all_sup_shp, 
  group_columns=c(NULL),
  metric_name=metric_name, 
  metric_label=metric_label,
  metric_cutoff_level = metric_cutoff_level,
  metric_cutoff_label= NULL,
  weighted_metrics_data = clean_data_ami_all_sup_shp,

  upper_quantile_view=1.0,
  lower_quantile_view=0.0,
  
  chart_title=NULL,
  chart_subtitle=NULL,
  chart_caption=NULL,
  x_label="Proportion of Households"
)
```

```{r}
print(poster_charts[["density"]])
```

```{r}
print(poster_charts[["tree"]])
```

```{r}
print(poster_charts[["violin"]])
```

```{r}
poster_charts[["choropleth"]]
```

```{r}
poster_charts[["dashboard"]]
```


```{r}
poster_charts[["metrics"]]
```



```{r}
clean_data=clean_data_ami_all_sup
  group_columns=c(NULL)
  metric_name=metric_name
  metric_cutoff_level = metric_cutoff_level
  # metric_cutoff_label= NULL
  
#make_all_charts
#clean_data,
                            # group_columns,
                            # metric_name,
                            metric_label=metric_label
                            # metric_cutoff_level=0,
                            metric_cutoff_label=NULL
                            upper_quantile_view=0.99
                            lower_quantile_view=0.01
                            chart_title=NULL
                            chart_subtitle=NULL
                            chart_caption=NULL
                            x_label="Proportion of Households"
  
  
  graph_data <- filter_graph_data(clean_data, group_columns, metric_name)
                        # density_chart
                          # graph_data, 
                          # metric_name, 
                          # metric_label=NULL
                          # group_columns, 
                          # metric_cutoff_level, 
                          # metric_cutoff_label,
                          # upper_quantile_view=1,
                          # lower_quantile_view=0,
                          # chart_title=NULL, 
                          # chart_subtitle=NULL,
                          # chart_caption=NULL,
                          # x_label="Proportion of Households"
  
  if(is.null(metric_label)){
    metric_label <- toupper(metric_name)
  }
  
  legend_title <- group_columns
  if(!is.null(legend_title)){
    # remove simplified_
    legend_title <- gsub("simplified_","", legend_title, fixed=TRUE)
    # normalize words
    legend_title <- gsub("_"," ",legend_title,fixed=TRUE)
    legend_title <- str_to_title(legend_title)
    # combine
    legend_title <- paste0(paste(legend_title, sep=" ", collapse=" &\n"))
  }
  # print(legend_title)
  
  if(!is.null(group_columns)){
    pal_n <- length(levels(interaction(graph_data[,group_columns])))
  } else {
    pal_n <- 1
  }
  
  graph_data$group_name <- str_to_title(gsub("+"," &\n",
                                             graph_data$group_name,fixed=TRUE))
  
  movie <- "Darjeeling1" #"GrandBudapest1"
  #pal <- wes_palette(name=movie, n=pal_n, type="continuous")
  pal <- rev(sample(x=wes_palette(name=movie, n=pal_n, type="continuous"),
                size = pal_n,
                replace = FALSE))
  
  weighted_metrics <- calculate_weighted_metrics(graph_data, 
                                                 group_columns, 
                                                 metric_name, 
                                                 metric_cutoff_level, 
                                                 upper_quantile_view, 
                                                 lower_quantile_view)
  
  
  chart <- graph_data %>% #subset(!is.na(households)) %>% head()
    # ggplot(aes(x=!!sym(metric_name), 
    #            weight=group_household_weights,
    #            color=interaction(!!!sym(group_columns)),
    #            fill=interaction(!!!sym(group_columns))
    # )) + 
    ggplot(aes_string(x=metric_name, 
                      weight="group_household_weights",
                      color=if(is.null(group_columns)){group_columns}else{
                        "group_name"
                        #interaction(!!!sym(group_columns))
                        # paste0("interaction(", paste0(group_columns, collapse =  ", "), ")")
                      },
                      fill=if(is.null(group_columns)){group_columns}else{
                        #interaction(!!!sym(group_columns))
                        "group_name"
                        # paste0("interaction(", paste0(group_columns, collapse =  ", "), ")")
                      },
                      linetype=if(is.null(group_columns)){group_columns}else{
                        #interaction(!!!sym(group_columns))
                        "group_name"
                        # paste0("interaction(", paste0(group_columns, collapse =  ", "), ")")
                      }
    )) + 
    ggrastr::rasterise(stat_ewcdf(geom='line',  
                                  alpha=1, 
                                  na.rm=T, 
                                  show.legend = NA, 
                                  size=0.2),
                       dpi=300
                       ) + 
    # ggrastr::rasterise(stat_ewcdf(aes(ymin=..y.., ymax=1), geom='ribbon', alpha=.1, 
               # na.rm=T, show.legend = NA)) + 
    theme_minimal() + 
    scale_color_manual(name=legend_title, values=pal) + 
    scale_fill_manual(name=legend_title, values=pal) + 
    scale_linetype(name=legend_title) + 
    theme(legend.justification = c(0, 1), 
          legend.position = c(0, 1), 
          legend.title=element_text(size=8),#element_blank(),
          legend.text=element_text(size=6), 
          legend.key.size = unit(10, "points"),
          legend.spacing.y = unit(0.05, 'points'),
          panel.background = element_blank(),#element_rect(fill="#f1f1f1"),
          panel.grid.major = element_blank(),#element_line(color="#DCDCDC"),
          panel.grid.minor = element_blank(),#element_line(color="#DCDCDC"),
          axis.line = element_line(color = "black",
                                   size = 0.5, 
                                   linetype = "solid"),
          axis.text.x=element_text(angle=45, 
                                   hjust=1,
                                   vjust=NULL,
                                   margin=margin(t = 5, 
                                                 r = 0, 
                                                 b = 0, 
                                                 l = 0, 
                                                 unit = "pt")),
          axis.text.y=element_text(angle=10, 
                                   hjust=1,
                                   vjust=0.5,
                                   margin=margin(t = 0, 
                                                 r = 5, 
                                                 b = 0, 
                                                 l = 0, 
                                                 unit = "pt")),
          axis.title.x = element_text(face="bold"),
          axis.ticks=element_line(color = "black"),
          axis.ticks.length = unit(-0.1, "cm")) + 
    # guides(guide_legend(override.aes = list(size = .01))
    guides(guide_legend(override.aes = list(size = 0.05))#,
           # fill = guide_legend(override.aes = list(size = 0)),
           # linetype = guide_legend(override.aes = list(size = 0)),
           # ribbon = guide_legend(override.aes = list(size = 0))
    ) + 
    # geom_segment(y = 0,
    #              x = as.numeric(weighted_medians[weighted_medians$group=="All",c("median_eroi")]),
    #              yend = 0.5,
    #              xend = as.numeric(weighted_medians[weighted_medians$group=="All",c("median_eroi")]),
    #              color="gray25",
    #              linetype="dotted",
    #              size=0.25,
    #              alpha=0.5) +
    # geom_segment(y = 0.5,
    #              x = as.numeric(weighted_medians[weighted_medians$group=="All",c("median_eroi")]),
    #              yend = 0.5,
  #              xend = 0,
  #              color="gray25",
  #              linetype="dotted",
  #              size=0.25,
  #              alpha=0.5) +
  geom_vline(xintercept = metric_cutoff_level,
             linetype="dotted",
             color = "red",
             size=0.5,
             alpha=0.75) #
  
  prechart<-chart
```


```{r}
if(metric_name=="ner"){
  xlims <- c(0,120)
  
  x_scale <- scale_x_continuous(#labels = scales::dollar_format(accuracy=1),
                       breaks=seq(from=xlims[1],to=xlims[2],by=20), 
                       # minor_breaks=seq(from=0,to=20,by=.25),
                       name=metric_label)
} else{ #if(metric_name %in% c("neb","energy_burden")){
  xlims <- c(floor(weighted_metrics$metric_lower*10)/10,ceiling(weighted_metrics$metric_upper*10)/10)
  
  x_scale <- scale_x_continuous(labels = scales::label_percent(accuracy = 1),
                       breaks=seq(from=xlims[1],to=xlims[2],by=.1), 
                       # minor_breaks=seq(from=0,to=20,by=.25),
                       name=metric_label)
}


if(FALSE==TRUE){
  
    chart <- prechart + 
      x_scale + 
    scale_y_continuous(labels = scales::label_percent(accuracy = 1), 
                       breaks=seq(from=0,to=1,by=.25), 
                       # minor_breaks=seq(from=0,to=1,by=.05),
                       name=x_label) + 
    coord_flip(xlim=xlims,
               ylim=c(0,1),
               expand=FALSE)}
if ( TRUE ) {
    chart <- prechart + 
      scale_y_continuous(
        labels=scales::label_percent(accuracy=1)
      ) +
      coord_cartesian(
        xlim=xlims,
        ylim=c(0,1),
      expand=FALSE
      )
}
  
# chart  + geom_histogram(
#   binwidth = 1
#   # aes(y = ..density.., )
# )
```


```{r}
graph_data_cut = graph_data %>%
  group_by(binned_metric=round(!!!syms(metric_name),2)) %>%
  summarise (
    n = n(),
    homes = sum(households)
    ) %>%
  mutate(group_percentile = (homes / sum(homes)))

final_density_chart <- chart + 
  geom_bar(data=graph_data_cut, 
           aes(x = binned_metric, y = group_percentile), 
           stat = "identity",
           position = "dodge", 
           alpha=0.25,
           inherit.aes = FALSE) + 
  # scale_x_discrete(labels = breaks) +  
  ylab("Percentage of Homes") +
  xlab(metric_label) +
  x_scale +
  scale_y_continuous(
        labels=scales::label_percent(accuracy=1)
      ) +
      coord_cartesian(
        xlim=xlims,
        ylim=c(0,1),
      expand=FALSE
      ) + 
    annotate("text",
             y = 0.95,#1,
             x = metric_cutoff_level*1.15,
             angle = 0,
             color="red",
             label = metric_cutoff_label,
             vjust = 0.0,#-0.25,
             hjust = 1.0,
             parse = FALSE,
             alpha=0.75,
             size=2.5) +
    # annotate("text", 
    #          y = 0, 
    #          x = max(weighted_medians$median_eroi), 
    #          angle = 0, 
    #          color="gray25", 
    #          label = "Median", 
    #          vjust = -0.25, 
    #          hjust = -0.1, 
    #          parse = FALSE, 
    #          alpha=0.75) + 
    labs(
      title=chart_title,
      subtitle=chart_subtitle,
      caption=chart_caption
      )

print(final_density_chart)
```
```{r}
final_spending_pie_chart_data <- clean_data %>% 
  pivot_longer(cols=c("electricity_spend","gas_spend","other_spend")) %>% 
  group_by(name) %>%
  summarise(value=sum(value*households)) %>% 
  mutate(
    pct=to_percent(value/sum(value))
  )

final_spending_pie_chart <- final_spending_pie_chart_data %>%
  ggplot(aes(x="", 
             y=value, 
             # weight=households, 
             fill=name,
             # label=pct,
             )) + geom_bar(stat="identity", width=1) +
  coord_polar("y",start=0)

print(final_spending_pie_chart)
```
```{r}
library(treemapify)

final_spending_tree_chart <- final_spending_pie_chart_data %>% 
  ggplot(data=.,aes(area = value, 
             fill = name,
             label = paste(name, pct, sep = "\n\n"),
             )) +
  geom_treemap() + 
  geom_treemap_text(colour = "white",
                    place = "centre",
                    size = 15) +
  theme(legend.position = "none")

print(final_spending_tree_chart)
```


```{r}
# gwm <- calculate_weighted_metrics(filter_graph_data(clean_data,
#                                                     c("geoid"),
#                                                     metric_name),
#                            c("geoid"),
#                            metric_name,
#                            metric_cutoff_level=0,
#                            upper_quantile_view = 1,
#                            lower_quantile_view=0) %>% 
#   mutate(geoid=as.character(geoid))
# 
# gwm$metric_name <- metric_name
# 
# selected_map_data <- inner_join(census_tracts_shp, gwm, by=c("GEOID"="geoid"))
# 
# selected_map_data$geoid <- selected_map_data$GEOID
# selected_map_data$households <- selected_map_data$household_count
# 
# selected_map_data[[metric_name]] <- selected_map_data$metric_mean

clean_top_metrics <- grouped_weighted_metrics(filter_graph_data(clean_data_ami_all, 
                                                                group_columns=NULL,
                                                                metric_name),# %>% 
                                                #filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=clean_data_ami_all_sup_shp, #selected_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Net Energy Burdens in Selected Area"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = TRUE,
    metric_long_name = bquote(E[b]^n),
    include_borders=FALSE
)

final_map <- choropleth_chart
ggsave("poster_map.svg", 
       plot=final_map,
       # device = NULL,
       # path = NULL,
        scale = 1,
        width = 10,
        height = 10,
        units = "in", #c("in", "cm", "mm", "px"),
        dpi = 300,
        limitsize = TRUE,
        bg = NULL
       )
print(final_map)
```

```{r}
gt <- patchwork::wrap_plots((final_map)/(final_density_chart+final_spending_pie_chart)  + 
                                 plot_layout(heights = c(1,1)))


print(gt)
```
```{r}
clean_data_ami_all_sup_shp
```


```{r}
calculate_weighted_metrics(clean_data, NULL, metric_name, metric_cutoff_level)
```


<!--chapter:end:net_energy_burden.Rmd-->

---
title: Net energy metrics reveal striking disparities across United States household energy burdens
subtitle: 
titlerunning: Net Energy Equity
authorrunning: Scheier & Kittner
thanks:
author:
 - Eric Scheier:
     institute: e3p
 - name: Noah Kittner
   email: kittner@unc.edu
   institute: [gillings, planning, e3p]
   correspondence: true
institute:
 - e3p: Environment, Ecology, and Energy Program, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
 - gillings: Department of Environmental Sciences and Engineering, Gillings School of Global Public Health, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
 - planning: Department of City and Regional Planning, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
keywords:
  - energy burden
  - net energy
  - macro-energy systems
  - energy inequality
bibliography: references.bib
bibstyle: spphys
csl: nature-no-et-al.csl
journalname: Nature Energy
date: "`r format(Sys.time(), '%d %B %Y')`"
toc: false
output:
  bookdown::pdf_document2:
    number_sections: false
    keep_tex: true
    documentclass: article
    pandoc_args:
      - '--lua-filter=color-text.lua'
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
    includes:  
      in_header: preamble-latex.tex
  bookdown::html_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=color-text.lua'
  bookdown::word_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=color-text.lua'
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
  bookdown::pdf_book:
    base_format: rticles::springer_article
    keep_tex: true
tables: true
fig_caption: true
always_allow_html: true
header-includes:
- \usepackage{booktabs}
- \usepackage[left]{lineno}
- \linenumbers
- \usepackage{setspace}
- \usepackage{xcolor}
- \usepackage{mathtools}
# - \doublespacing
---

```{r setup, include=FALSE}
is_final=FALSE #TRUE
is_preview= TRUE #FALSE
is_draft= TRUE
set.seed(456)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','asis')),
                      fig.keep='all', #'last'
                      dev='cairo_pdf',#'pdf',
                      fig.show='hold',#'hide
                      # fig.pos = "!H",
                      # out.extra = "",
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=TRUE, #ifelse(is_draft, TRUE, ifelse(is_preview, TRUE, !is_final)),
                      cache.lazy=FALSE,
                      fig.margin=FALSE,
                      fig.fullwidth=TRUE, #FALSE
                      eval.after = "fig.cap"#,
                      # cache.path = 'net_energy_equity_cache/', 
                      # fig.path = 'net_energy_equity_files/'
                      )

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 
    "latex" else "pipe"
})

edit_color = "black"
```

```{r option-view, include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)

# knitr::opts_current$get(c(
#   "cache",
#   "cache.path",
#   "cache.rebuild",
#   "dependson",
#   "autodep"
# ))

kable(knitr::opts_chunk$get() %>% enframe())
```


```{r sources, cache=FALSE}
source("sources.R")
```

```{r parameters}
states <- "all" #c("ca","nc","sc") #
refresh <- FALSE
acs_version <- 2018
energy_burden_poverty_line <- 0.06
# geographic_scope <- "tract" #statecitycounty
```

```{r run-methods, cache=TRUE}
paper_methods(states=states,
              acs_version=acs_version,
              energy_burden_poverty_line=energy_burden_poverty_line,
              refresh=refresh)
```


```{r load-data}
income_metric <- "AMI" #"AMI" #"fpl15" #
geographic_scope <- "Census Tracts" #statecitycounty

version_text <- as.character(acs_version)
if(acs_version==2016){
  version_text <- "sh"
}

base_file_name <- tolower(paste(income_metric,
                                geographic_scope,
                                version_text,
                                paste(states,collapse="_",sep=""), sep = "_"))

clean_data_ami <- read_csv(paste0("data/very_clean_data_",base_file_name,".csv"), guess_max = 10^6)

income_metric <- "FPL"
base_file_name <- tolower(paste(income_metric,
                                geographic_scope,
                                version_text,
                                paste(states,collapse="_",sep=""), sep = "_"))
clean_data_fpl <- read_csv(paste0("data/very_clean_data_",base_file_name,".csv"), guess_max = 10^6)

tract_file_name <- paste0("data/",paste(states,collapse="_",sep=""),"_census_tracts.geojson")

census_tracts_shp <- st_read(tract_file_name)
replica_sup <- get_replica_supplemental_dataset()
tract_shp <- st_sf(left_join(census_tracts_shp, replica_sup, by=c("gisjoin")))
```

```{r}
# Things in here should probably be moved further up the data processing pipeline
# clean_data_ami$number_of_units <- as.factor(ifelse(clean_data_ami$min_units > 1, "mf", "sf"))
# clean_data_fpl$number_of_units <- as.factor(ifelse(clean_data_fpl$min_units > 1, "mf", "sf"))
```


```{r poverty-lines, eval=TRUE}

eroi_poverty_line <- eroi_func(g=1,
                               s=energy_burden_poverty_line)

average_energy_cost <- weighted.mean(clean_data_ami$energy_cost, 
                                     clean_data_ami$total_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.mean(clean_data_ami$total_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)

median_energy_cost <- weighted.median(clean_data_ami$energy_cost, 
                                     clean_data_ami$total_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$total_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)
# 12*(clean_data_ami$electricity_spend + 
#       clean_data_ami$gas_spend + 
#       clean_data_ami$other_spend)
# clean_data_ami$total_kWh <- clean_data_ami$gas_kWh + clean_data_ami$electricity_kWh
median_electricity_cost <- weighted.median(clean_data_ami$electricity_spend,
                              clean_data_ami$electricity_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$electricity_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)

median_gas_cost <- weighted.median(clean_data_ami$gas_spend, 
                                     clean_data_ami$gas_kWh*clean_data_ami$households, 
                                     na.rm = 
                                    T)/weighted.median(clean_data_ami$gas_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)
median_gas_cost_Mcf <- weighted.median(clean_data_ami$gas_spend, 
                                     clean_data_ami$gas_Mcf*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$gas_Mcf,
                                                              clean_data_ami$households,
                                                              na.rm = T)


ner_poverty_line_dlrs <- ner_func(g=1,
                                  s=energy_burden_poverty_line)

ner_poverty_line_mean <- ner_func(g=1,
                             s=energy_burden_poverty_line,
                             se=energy_burden_poverty_line/(average_energy_cost))

ner_poverty_line_median <- ner_func(g=1,
                             s=energy_burden_poverty_line,
                             se=median_energy_cost/energy_burden_poverty_line)

ner_poverty_line <- ner_poverty_line_dlrs #ner_poverty_line_median


dear_poverty_line <- dear_func(g=1,
                               s=energy_burden_poverty_line)

ner_dear_poverty_line <- dear_func(g=1+median_energy_cost*ner_poverty_line_median,
                               s=1)

ner_nice_fraction <- paste0(floor(ner_poverty_line),ifelse(floor(ner_poverty_line)==ner_poverty_line,"",paste0("\\ \\frac{",numerators(fractional(ner_poverty_line-floor(ner_poverty_line))),"}{",denominators(fractional(ner_poverty_line-floor(ner_poverty_line))),"}")))

ner_nice_text <- paste0(ifelse(ner_poverty_line==round(ner_poverty_line,0),"","\\approx"),round(ner_poverty_line))
```

```{r figure-parameters}
#chart_title <- "Household Economic Return on Energy Spending"
chart_title <- "Community Net Energy Return"
chart_subtitle <- "Net Earnings per Dollar of Energy Consumed"

group_columns <- NULL#"income_bracket")#in_poverty
                   #"primary_heating_fuel"

metric_name <- "ner" #"energy_burden" #"ner" #"dear" #"eroi"
metric_label <- "$/$"
metric_cutoff_level <- ner_poverty_line
metric_cutoff_label <- "Energy Poverty Line"

upper_quantile_view <- 1.0
lower_quantile_view <- 0.0
```

```{r top_metrics}
group_variable <- NULL# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

top_metrics <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.99, 
                         lower_quantile_view=0.00)
# head(top_metrics)
```


```{r grouped_weighted_metrics}
#data$GEOID <- sub('.', '', data$gisjoin)
group_variable <- "geoid"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

gwm <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)
# head(gwm)
```

```{r eval=TRUE}
fpl_graph_data <- filter_graph_data(clean_data_fpl, group_columns="in_poverty", metric_name)

fpl_top_metrics <- grouped_weighted_metrics(fpl_graph_data, 
                         group_columns="in_poverty", 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)

fpl_ep_data <- filter_graph_data(clean_data_fpl,
                                 group_columns=c("in_poverty",
                                                 "energy_burden_poverty"), 
                                 metric_name)

fpl_ep_top_metrics <- grouped_weighted_metrics(fpl_ep_data, 
                         group_columns=c("in_poverty",
                                                 "energy_burden_poverty"), 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)


# should replace this with weighted metrics data
# How many households are below the poverty line in this data?
total_households <- fpl_top_metrics$household_count

number_in_poverty <- fpl_top_metrics$households_below_cutoff

pct_in_poverty <- number_in_poverty / total_households

pct_of_ep_below_fpl <- fpl_top_metrics$households_below_cutoff[fpl_top_metrics$in_poverty=="Below Federal Poverty Line"] / sum(number_in_poverty)

# number_above_poverty <- sum((data$income_bracket!=poverty_cutoff) * (data$households))

pct_above_poverty <- 1 - pct_in_poverty

in_both_poverty <- pct_in_poverty[2]

in_only_energy_poverty <- pct_in_poverty[1]

energy_poverty_rate <- sum(number_in_poverty) / sum(total_households)

ami_graph_data <- filter_graph_data(clean_data_ami,
                                    group_columns=c("in_poverty",
                                                    "income_bracket"),
                                    metric_name)
ami_top_metrics <- grouped_weighted_metrics(ami_graph_data, 
                         group_columns=c("in_poverty",
                                         "income_bracket"), 
                         metric_name, 
                         metric_cutoff_level,
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)
```

\newpage

**Abstract: Energy inequity in the United States is an issue of increasing urgency. Few policy-relevant datasets evaluate the energy burden of typical American households. Here, we develop a framework using net energy analysis and socioeconomic data at the census tract-level to observe systematic energy inequity across the United States among critical groups that heed policy attention. We find substantial instances of energy poverty in the United States -- `r scales::percent(energy_poverty_rate, accuracy=1)` of households experience energy poverty as presently defined as spending more than [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} of household income on energy expenditures. The federal poverty line is not enough to capture the experience of energy inequity across the United States and excludes households that would benefit immensely from programs available to support low-income communities: while [`r scales::percent(in_both_poverty, accuracy=1)`]{color=`r edit_color`} of households below the federal poverty line also face energy poverty, [more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` households]{color=`r edit_color`} above the federal poverty line face this scarcity. We identify that energy expenditures across census tracts disproportionately burden Black, Hispanic, and Native American communities. For solar, wind, and energy efficiency to address socioeconomic mobility, programs must reduce relative energy expenditures by expanding eligibility requirements for support and access to improved conservation measures, efficiency upgrades, and distributed renewables. We recommend the United States  develop a more inclusive federal energy poverty categorization that provides greater assistance for household energy costs.**

Main Text:

Household energy use for services such as heating[@tbd], cooling[@limaReviewRelationHousehold2020] and cooking[@mobarakLowDemandNontraditional2012] is crucial for decent living conditions[@raoEnergyRequirementsDecent2019]. Unaffordable energy is a persistent trend[@brownPersistenceHighEnergy2020] that is negatively related to social cohesion, climate change responses, and disproportionate environmental impacts on low-income populations and minority groups [@carleyJusticeEquityImplications2020].

[However, e]{color=`r edit_color`}nergy inequity is not just a lack of money to meet basic energy needs - it is a lack of [access to the capabilities[@dayConceptualisingEnergyUse2016] that]{color=`r edit_color`} enable a sustainable and prosperous society built on just principles[[@sovacoolEnergyJusticeConceptual2015]]{color=`r edit_color`}. Energy inequity could have significant implications for navigating sustainable development and meeting societal goals around decarbonization and energy use.

[In a thematic exploration of energy equity, Brown et al. identify energy access, energy poverty, energy insecurity, and energy burden as key concepts for understanding the issue[@brownLowincomeEnergyAffordability2020], but measurement of these concepts has been limited to date. Pachauris & Rao establish measures for the sustainable development context that incorporate periods when energy is available, the quality of voltage supplied, the reliability in terms of number of disruptions, the capacity in terms of Watts available, the consumption levels allowed per day, and affordability of the standard consumption package as a percentage of household income[@pachauriAdvancingEnergyPoverty2020]. These methods require normalizing many veriables amongst different types of data and are overly broad for applications in areas where electricity access is universal and reliable.]{color=`r edit_color`}

[Of such areas, the United Kingdom (UK) has a rich history of incorporating energy poverty formally into its government programs: since 2000, the UK has used some form of an energy burden metric to assess whether households are facing energy poverty and determine the level of support that they require as a result[@bednarRecognitionResponseEnergy2020]. This metric has evolved from a simple ratio of household income and energy expenditures to one that incorporates building efficiency ratings and average incomes in the community. While the European Union (EU) currently lacks a unified metric for energy poverty, similar metrics have been developed in member countries, such as a metric which compares incomes and expenditures to local averages and absolute heating needs to determine energy poverty levels in Italy[@faiellaEnergyPovertyHow2021] or a multidimensional index of building quality and ability to pay bills in Poland[@sokolowskiMultidimensionalIndexMeasure2020].]{color=`r edit_color`}

Prior research of household prosperity in limited global jurisdictions [using these sorts of measures]{color=`r edit_color`} has found that gender, age, housing age[@rossHighCostEnergy2018], tenure type[@mayerTwoFacesEnergy2014], energy inefficiency[@drehoblUSLowIncomeEnergy2016], education, employment[@linAffordabilityAccessFocus2018], geography[@linDoesEnergyPoverty2020], socioeconomic status[@bednarIntersectionEnergyJustice2017], race/ethnicity[@tongMeasuringSocialEquity2021], and macroeconomic conditions[@kawaiSpendingHouseholdEnergy2021] are associated with high energy burdens in various geographical areas. 

In the United States (US), energy inequity is a significant challenge as families struggle to meet monthly bills and live paycheck to paycheck[@bednarRecognitionResponseEnergy2020]. There is a growing disparity between wealthier and lower-income households based on their abilities to meet basic energy needs[@brownLowincomeEnergyAffordability2020]. While per-unit residential energy prices have increased below the rate of inflation in the [US]{color=`r edit_color`} since the 1980s[@ShortTermEnergyOutlook2021], many households still struggle to make utility bill payments and are especially vulnerable to economic shocks[@kawaiSpendingHouseholdEnergy2021].

[Ross and Drehobl performed distinct urban[@drehoblUSLowIncomeEnergy2016] and rural[@rossHighCostEnergy2018] analyses to describe energy inequity in the US. While limited by geographic and demographic focus and a lack of peer-review, these studies have established the proportion of income (G) spent on energy expenditures (S), or energy burden (EB), as the standard benchmark for energy poverty in the US today (Equation 1).]{color=`r edit_color`} [The US Department of Energy (DOE) significantly improved upon Ross and Drehobl's underlying methodology by assembling its Low-Income Energy Affordability Dataset (LEAD)[@maLowIncomeEnergyAffordability2019], which estimates incomes and energy expenditures for most households in the US at a census tract scale.]{color=`r edit_color`} 

\begin{align}
Energy\ Burden\ (EB)= \frac{S}{G}
\end{align}

[While a helpful place to start, EB has certain drawbacks.]{color=`r edit_color`} Significantly, a simple proportion does not account for the fact that money spent on energy cannot be spent elsewhere and is therefore not useful income to the household for the purposes of measuring prosperity. Including gross income in EB has the effect of depressing the average EB, by definition.

Furthermore, because energy expenditures are a small proportion of even the most impoverished households' total income, EB is almost always a very small percentage (<10%). This leads to issues with interpretability in public discourse and policy settings and may even affect program outcomes that are based on EB if small numbers are rounded to even the nearest hundredth of a percent. [As the UK experienced when using EB, i]{color=`r edit_color`}f the household is above an energy poverty line defined by such a metric for public policy purposes, the family may not receive critical support[[@bednarRecognitionResponseEnergy2020].]{color=`r edit_color`}

Because such a small proportion of expenditures can impact different income groups so differently, ratios of this type can be useful when delineating across income quantiles or other categories - particularly for vulnerable populations where the absolute energy poverty poses a significant difficulty or affordability threshold. However, EB is often portrayed at a population scale (e.g., the average energy burden of the population is X%)[, which can be skewed by outliers within the population]{color=`r edit_color`}. Household metrics and surveys are important for further understanding of and policy development around issues of energy poverty. 

Finally, presenting the relationship between household income and energy expenditures as a proportion with income in the denominator suggests that improvements can only be made by decreasing energy expenditures or increasing incomes. However, in reality, there is a positive relationship between energy expenditures and incomes because energy is an input in wealth-creating processes. Households consume energy to unlock the utility that energy services provide to them as participants in society, whether to cook food or connect to the internet. This relationship is generally accepted when understanding individual household behavior[@thomasEstimatingDirectIndirect2013] and macro-economic effects of energy consumption[@saundersKhazzoomBrookesPostulateNeoclassical1992]. Therefore, a metric describing the efficiency of household wealth creation may be more intuitive with income in the numerator.

Net Energy Analysis (NEA) offers potential support to understanding energy equity through the use of formally defined Energy Return Ratios (ERRs) that articulate the relationships among energy flows within complex systems[@brandtGeneralMathematicalFramework2011]. Net Energy Return (NER), which describes the newly released potential to do work as a result of some activity, is recommended as a basis for future analysis[@carbajales-daleBetterCurrencyInvesting2014], especially in the study of macro-energy systems like the US residential housing stock[@leviMacroEnergySystemsNew2019].

This research's primary contribution to energy poverty measurement is to treat the income remaining after energy expenditures (i.e., net income) as the focus of analysis to avoid the double-counting of energy expenditures, and portray net income as a result of energy consumption rather than a cause.

Here, we [use LEAD to]{color=`r edit_color`} examine the relationship between energy spending and household income [spatially]{color=`r edit_color`} for [most households]{color=`r edit_color`} in the [US at a census tract scale]{color=`r edit_color`}, with particular emphasis on how disparate household NERs signal economic disparities across [socio-demographic characteristics such as]{color=`r edit_color`} race and ethnicity, income, and housing tenure. This empirical analysis will fill a gap in the current discussion about energy equity by providing a framework to evaluate the disparities among household net energy outcomes [that is aligned with the assessment of energy flows through biological, physical, and economic systems[@hallEnergyWealthNations2018]]{color=`r edit_color`}.

#### Applying [NER]{color=`r edit_color`} to Energy Equity  {#ratios}

Previous work defines the [NER]{color=`r edit_color`} of a process as a relationship between the gross amount of energy extracted and the amount of embodied energy directed toward extraction[@brandtCalculatingSystemsscaleEnergy2013]. [For households extracting income from the economy, these ratios can be composed of gross income (G) and spending on energy (S)]{color=`r edit_color`}.

NER represents the net earnings a household receives for every expenditure on secondary energy, defined according to Equation 2.

\begin{align}
Net\ Energy\ Return\ (NER) = \frac{G - S}{S}
\end{align}

The NER is the standard metric of NEA because it reflects the role of energy as an input to a value-generating process in ecosystems[@brandtHowDoesEnergy2017]. EB is the metric of choice in the energy insecurity literature due to its interpretability as a percentage[@rossHighCostEnergy2018]^,^ [@bednarIntersectionEnergyJustice2017]^,^ [@drehoblUSLowIncomeEnergy2016]^,^ [@kawaiSpendingHouseholdEnergy2021]

```{r metric-comparison-data}
eb_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% 
                                            mutate(energy_burden = round(100*energy_burden,digits=1)),
                                          group_columns = c("energy_burden","income_bracket"), 
                                          metric_name="net_income", 
                                          metric_cutoff_level = .1) %>% 
  mutate(metric_name="Energy Burden (%)") %>% 
  rename(energy_metric=energy_burden) #%>% 
  # mutate(energy_metric=100*energy_metric)

ner_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% mutate(ner = round(ner,digits=0)), 
                                     group_columns = c("ner","income_bracket"), 
                                     metric_name="net_income", 
                                     metric_cutoff_level = 9) %>% 
  mutate(metric_name="Net Energy Return ($/$)") %>% rename(energy_metric=ner)

comparison_chart_data <- rbind(eb_chart_data,ner_chart_data)

metric_comparison_net_income_lbound <- -1000
metric_comparison_net_income_ubound <- 6*10^4
metric_comparison_x_axis_lbound <- -10
metric_comparison_x_axis_ubound <- 400
metric_comparison_pct <- sum(comparison_chart_data$household_count[
  comparison_chart_data$energy_metric <= metric_comparison_x_axis_ubound & 
    comparison_chart_data$energy_metric >= metric_comparison_x_axis_lbound & 
    comparison_chart_data$metric_mean <= metric_comparison_net_income_ubound & 
    comparison_chart_data$metric_mean >= metric_comparison_net_income_lbound & 
    !is.na(comparison_chart_data$metric_mean) & 
    is.finite(comparison_chart_data$metric_mean)]) / 
  sum(comparison_chart_data$household_count)

comparison_chart <- comparison_chart_data %>% 
  ggplot(aes(x=energy_metric, y=metric_mean, fill=income_bracket, color=income_bracket)) +
  # scale_x_continuous(trans=scales::pseudo_log_trans(base = 10)) +
  scale_y_continuous(labels=scales::dollar_format()) + 
  ggrastr::rasterise(geom_point(aes(size=household_count), 
                                alpha=0.25, 
                                position="jitter")) + 
  scale_fill_discrete(name="Income Bracket") + 
  scale_color_discrete(name="Income Bracket") + 
  scale_size_continuous(name="Households", labels=scales::label_comma()) + 
  # geom_hline(yintercept = .1) + 
  # geom_vline(xintercept = 9) + 
  # geom_smooth(method="lm",#NULL,#
  #             mapping=aes(weight=household_count),
  #             # formula=y~,
  #             se=FALSE,
  #             fullrange=TRUE,
  #             linetype="solid",
  #             alpha=0.75
  #             ) + 
  facet_grid(cols=vars(metric_name), switch="x", scales="free_x") +#, space="free_x") + 
  theme_bw() +
  labs(title = "Energy Burden and Net Energy Return in US Households", 
       x="Energy Metric", 
       y="Household Annual Net Income ($)") + 
  theme(legend.position = c(.3,.6),
        legend.background = element_rect(fill = "#ffffffaa", colour = NA), 
        legend.key.size = unit(10, "points")#,
        # legend.justification = c(0, 0)
        )+
  coord_cartesian(#xlim=c(0,120),
               ylim=c(metric_comparison_net_income_lbound,
                      metric_comparison_net_income_ubound),
               xlim=c(metric_comparison_x_axis_lbound,
                      metric_comparison_x_axis_ubound),
               # default=FALSE,
               expand=TRUE)
```


While most [ERRs]{color=`r edit_color`}, including NER, are hyperbolic paraboloids, NER has several useful mathematical properties: it can smoothly handle systems with negative incomes and energy costs, accept households with zero income, and emphasize extreme incomes and energy costs in an interpretable fashion as shown in Figure \@ref(fig:metric-comparison). [While EB appears inversely correlated to income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the EB equation (Equation 1), the EB of these households approaches infinity [and cannot be captured on the standard 0-100% scale the metric is intended to be interpreted within]{color=`r edit_color`}. Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. NER provides a framing of the same dataset that allows for exploration of most households on a similar scale without the long tail. NER appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing NER avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, NER offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent. Many households with moderate-to-high EBs are actually higher-income households with high energy expenditures, making their NERs quite high (e.g., >\$100 of income per \$1 of energy spending). Almost `r to_percent(metric_comparison_pct)` of the households in the dataset have net incomes between `r to_dollar(metric_comparison_net_income_lbound)` and `r to_dollar(metric_comparison_net_income_ubound)` with NERs (or EBs) of between `r metric_comparison_x_axis_lbound` (`r to_percent(metric_comparison_x_axis_lbound/100)`) and `r metric_comparison_x_axis_ubound` (`r to_percent(metric_comparison_x_axis_ubound/100)`).]{color=`r edit_color`} Only households with no energy costs are excluded from the analysis, whereas households with no energy costs or incomes must be excluded from an analysis utilizing EB.

```{r metric-comparison, include=TRUE, results='asis', fig.cap=metric_comparison_fig_cap}
metric_comparison_fig_cap <- paste0("Display of the relationship between ",colorize("EB",edit_color)," and ",colorize("NER",edit_color)," with net income (gross income - energy expenditures) for US households. While EB appears inversely correlated to net income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the EB equation (Equation 1), the EB of these households approaches infinity ",colorize("and cannot be captured on the standard 0-100\\% scale the metric is intended to be interpreted within",edit_color),". Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. NER provides a framing of the same dataset that allows for exploration of most households on a similar scale without the long tail. NER appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing NER avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, NER offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent: many households with moderate-to-high EBs are actually higher-income households with high energy expenditures, making their NERs quite high (e.g., >\\$100 of income per \\$1 of energy spending)",colorize(", which is only visible on a NER scale",edit_color),".")

comparison_chart
```

For the discussion of household energy poverty, we are primarily interested in how households of different characteristics are distributed according to their [NER]{color=`r edit_color`}s, representing how many net dollars are earned by a household for every dollar it spends on energy. Since the NER is unitless but is a ratio of return on investment, we present it below interchangeably with no units or in units of $\$/\$$ depending on context. Other proposed indicators of energy poverty may be similarly examined in this manner. 


#### Application to Energy Poverty  {#poverty-line}

[While a range of thresholds have been developed and explored, energy poor households in the US are]{color=`r edit_color`} commonly defined in terms of EB as [those with]{color=`r edit_color`} an expenditure of greater than [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} of household income on energy [based on the logic that energy expenditures should not be greater than 20% of housing expenses, which themselves should not exceed 30% of household income[@brownLowincomeEnergyAffordability2020]]{color=`r edit_color`}. Calibrating our [NER]{color=`r edit_color`} analysis to this level will help gauge different thresholds of energy poverty and benchmark the results of this paper to the energy poverty literature while acknowledging the continuum of experiences across household energy consumption. Translated into its relative level for [NER]{color=`r edit_color`}, the energy poverty line NER* is defined according to Equation 3 as `r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r round(ner_poverty_line,0)`.

\begin{gather}
\nonumber EB^{*} = \frac{S}{G} = `r colorize(100*energy_burden_poverty_line, edit_color)`\%\\
NER^{*} = \frac{G-S}{S}\ such\ that \ \frac{S}{G} = `r colorize(100*energy_burden_poverty_line,edit_color)`\%\\
\nonumber NER^{*} `r ner_nice_text`\Rightarrow Household\ at\ Energy\ Poverty\ Line
\end{gather}

This means that a household that earns less than [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r to_dollar(ner_poverty_line)`]{color=`r edit_color`} of income for every dollar it spends on secondary energy will be considered to be in energy poverty by the traditional EB accounting method. A NER of [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r round(ner_poverty_line,0)`]{color=`r edit_color`} or lower is equivalent to an EB of [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} or higher. This threshold is arbitrary and may not be suitable in situations where households fall very close to this line or where the number of family members or measures of certain building characteristics vary widely. Simply, it is presented as a benchmark. We examine the [NER]{color=`r edit_color`} at a community scale across the [US]{color=`r edit_color`} in Table 1.


#### The US Household Net Energy Landscape  {#landscape}


```{r comparison-table, include=TRUE, results="asis"}
# table with states'/groups' median annual household energy expenditures, incomes, net incomes, NER, and EB
compare_metrics <- function(metric_name="ner"){
  gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami,c("income_bracket"),metric_name),
                           c("income_bracket"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)
  gwm$metric_name <- metric_name
  return(gwm)
}

compare_table <- rbindlist(lapply(c("income",
                                    "energy_cost",
                                    # "energy_burden",
                                    "net_income"#,
                                    # "ner"
                                    ), compare_metrics))

compare_table_totals <- compare_table %>% 
  filter(metric_name=="income") %>% 
  pivot_wider(id_cols=income_bracket,
              names_from=metric_name,
              values_from=household_count,
              ) %>% 
  rename(households=income) %>% pivot_longer(cols="households")

compare_table <- compare_table %>% 
  pivot_wider(id_cols=income_bracket,
              names_from=metric_name,
              values_from=metric_mean) %>% 
  mutate(energy_burden = energy_burden_func(g=income, s=energy_cost),
         ner = ner_func(g=income, s=energy_cost)) %>% 
  pivot_longer(cols=c("income","energy_cost","energy_burden","net_income","ner"))

compare_table <- rbind(compare_table_totals, compare_table)

#format the metrics accordingly
# income = 0 decimal place $
# energy_cost = 0 decimal place $
# energy_burden = 0 decimal place %
# net_income = 0 decimal place $
# ner = 1 decimal place number

which_metric <- "value" #"metric_mean" #"metric_median"

compare_table$print_value <- ifelse(compare_table$name %in% c("income",
                                                                     "energy_cost",
                                                                     "net_income"),
                                    to_dollar(compare_table[[which_metric]]),
                                    ifelse(compare_table$name %in% c("energy_burden"),
                                           to_percent(compare_table[[which_metric]]),
                                           ifelse(compare_table$name %in% c("ner"),
                                                  round(compare_table[[which_metric]],1),
                                                  ifelse(compare_table$name %in% c("households"),
                                                         to_million(compare_table[[which_metric]]),
                                                  to_big(compare_table[[which_metric]])))))

compare_table$display_income_bracket <- dplyr::recode_factor(compare_table$income_bracket, 
                                       very_low="0-30% AMI",
                                       low_mod="30-80% AMI", 
                                       mid_high="Above 80% AMI",
                                       All="All",
                                       .ordered=TRUE)


compare_table[,"Metric Name"] <- dplyr::recode(compare_table$name,
                                               households="Households in Sample",
                                    income="Annual Income (G)",
                                    energy_cost="Annual Energy Expenditures (S)",
                                    energy_burden="EB (S/G)",
                                    net_income="Net Income (G-S)",
                                    ner="NER ([G-S]/S)")

print_table <- compare_table[,c("Metric Name","display_income_bracket","print_value")] %>% 
  arrange(display_income_bracket) %>% 
  pivot_wider(names_from=display_income_bracket,values_from=print_value)

write_csv(print_table, "comparison_table.csv")

highlight_metrics <- rbindlist(lapply(c(
                                    "energy_burden",
                                    "ner"
                                    ), compare_metrics))

highlight_energy_burden <- as.numeric(highlight_metrics[metric_name=="energy_burden" & income_bracket=="very_low","metric_mean"])

highlight_ner <- as.numeric(highlight_metrics[metric_name=="ner" & income_bracket=="very_low","metric_mean"])

num_one <- paste0(to_big(highlight_energy_burden*100),"\\%")
num_two <- round(highlight_ner,1)
# glue::glue(

print_caption <- paste0("Average annual household energy expenditures, incomes, net incomes, NERs, and EBs portrayed for different income groups based on their relationship to ",colorize("AMI",edit_color),". Note that the statistics for EB and ",colorize("NER",edit_color)," are calculated per cohort after averaging the income and expenditure statistics to avoid the effect of extreme values skewing the interpretability of these metrics as described in the text. For example, the actual weighted average EB for households from 0-30\\% AMI is ",num_one,", and the average ",colorize("NER",edit_color)," for this cohort is ", num_two," due to subsets of the dataset with very low incomes or low energy expenditures. ",colorize("NER",edit_color)," is not as susceptible to this skewing effect.")

# print_caption <- "caption \\% caption"


final_table <- subset(print_table, select=-All) %>%  knitr::kable(booktabs=T,
               caption=print_caption) %>% 
  kableExtra::kable_styling() %>% 
  kableExtra::row_spec(c(2,3,4,6), bold=T)
  # kableExtra::kable_styling(latex_options = c("striped"), #,"hold_position"
                            # position="center")
final_table
```


```{r}
total_homes <- tidycensus::get_acs(geography = "us",
                    variables = c(households="B25002_002"),
                    year = acs_version)
# head(total_homes)
estimated_homes <- compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","value"]
min_homes <- total_homes$estimate - total_homes$moe
max_homes <- total_homes$estimate + total_homes$moe
```


[We use LEAD[@maLowIncomeEnergyAffordability2019] (n=`r compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","print_value"]` households), to evaluate the NER dynamics across the US. The average US home in the dataset]{color=`r edit_color`} has an income of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="income","print_value"]` and an annual energy expenditure of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","print_value"]` (`r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","value"])/12)`/month), which equates to an average EB of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_burden","print_value"]` or an average [NER]{color=`r edit_color`} of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="ner","print_value"]`. While the dataset slightly overrepresents households below the median income due to the limitations of the statistical methods used to compile them, it represents estimates for approximately `r to_percent(as.numeric(estimated_homes/(max_homes)))`-`r to_percent(as.numeric(estimated_homes/(min_homes)))` of the `r to_million(min_homes, suffix="")`-`r to_million(max_homes)` family-occupied households evaluated by the American Community Survey. Table 1 shows a summary of these data for households and their average statistics [delineated by their]{color=`r edit_color`} incomes relative to [the median income of similar size families in the same metropolitan area or non-metropolitan county, known as]{color=`r edit_color`} Area Median Income (AMI). We can see that high burdens are found mostly in the very low income group, with an average EB of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` or [NER]{color=`r edit_color`} of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="ner","print_value"]`. Income drives the escape from energy poverty: middle and high-income groups do not spend drastically different amounts on energy (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` and `r to_percent(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` more, respectively) but earn `r to_big(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` and `r to_big(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` times that of the very low-income group, respectively. An EB of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` means that `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month is spent on energy, which is quite high on a monthly income of `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"])/12)`. The additional `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month that the next rung of moderate-income groups spends on energy represents a minuscule proportion of their income (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"]))`).

Displayed geospatially in Figure \@ref(fig:continental-map), the Black Belt in the American Southeast is visibly perceptible [as an area of high burden]{color=`r edit_color`}, indicating that low-NER follows racial lines. Likewise, border populations and immigrant populated areas in the Southwest have higher burdens, as do Native American lands. [High burdens can also be seen in rural Northeast states where heating burdens are high]{color=`r edit_color`}. Urban inequity results in lower NER populations not showing up in many dense or gentrified urban areas such as the San Francisco Bay Area, New York City, and New Orleans as shown in Figure \@ref(fig:inset-map). A notable exception to this trend is Detroit, in which the pervasiveness of urban energy poverty has been studied extensively and shown to have distinct geographic boundaries[@bednarIntersectionEnergyJustice2017]. While some of these conclusions are supported by existing evidence and literature, they should be confirmed with a rigorous analysis of this dataset using the NER metric for reasons explained in [Applying NER to Energy Equity](#ratios). Additional analyses should incorporate additional demographic and household dimensions due to potential disparities within census tracts since diverse neighborhoods may not be represented accurately by aggregate census tract metrics.

```{r}
# show some pie / bar charts of the breakdown between fuels
```


```{r continental-map, include=TRUE, results='asis', fig.cap=continental_map_fig_cap}

continental_map_fig_cap <- paste0("Map of the average net earned income per secondary energy expenditure for each census tract in the continental ",colorize("US",edit_color),". Shades of yellow and red indicate communities at or below the energy poverty line as defined by earning 9 dollars or less in income per dollar of energy expenditures. This corresponds to the traditional definition of energy poverty as spending ",to_percent(energy_burden_poverty_line)," or more of income on energy. Low ",colorize("NER",edit_color),"s can be starkly observed in the Black Belt across the Southeastern US, Hispanic communities near the US-Mexico border, Native American lands, and rural New England.")

continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))
# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

# full_map_data <- left_join(tract_shp, gwm, by=c("geoid"))

map_data <- left_join(continental_shp, gwm, by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(graph_data %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens Across the US"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = TRUE,
    metric_long_name = "Net\nEnergy Return")

choropleth_chart
```


```{r inset-map, include=TRUE, results='asis', fig.cap=inset_map_fig_cap}

inset_map_fig_cap <- "An inset focused on the city of New Orleans, Louisiana (Orleans Parish), showing an example of the dynamics of energy poverty in an urban area where the presence of energy inequity is harder to see compared to rural areas for which census tracts are a larger physical area."

nola_msa_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish")

nola_csa_parishes <- c(nola_msa_parishes, 
                       "Tangipahoa Parish",
                       "Washington Parish")

nola_rpc_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   # "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish",
                   "Tangipahoa Parish")

orleans_and_neighbors <- c("Orleans Parish",
                           "St. Tammany Parish",
                           "Jefferson Parish",
                           "Plaquemines Parish", 
                   "St. Bernard Parish"
                           )

inset_map_data <- map_data %>% filter(county_name=="Orleans Parish"
                                     & state_abbr=="LA")

inset_bb <- st_buffer(st_as_sfc(st_bbox(inset_map_data)) %>% st_transform(3857), dist=10)

choropleth_chart_highlight <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    legend_position = "none"
    ) + 
  geom_sf(data = inset_bb, fill = NA, color = "blue", size = 0.2)

# https://en.wikipedia.org/wiki/New_Orleans_metropolitan_area
choropleth_chart_inset <- choropleth_map(
    clean_data=inset_map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="Inset of Energy Burdens In New Orleans, Louisiana",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    legend_position = c(.85,.4),
    include_compass = TRUE,
    metric_long_name = "Net\nEnergy Return")

gg_inset_map = ggdraw() +
  draw_plot(choropleth_chart_inset) +
  draw_plot(choropleth_chart_highlight, x = 0.1, y = 0.65, width = 0.35, height = 0.35)

gg_inset_map
# ggsave2("national_map.pdf",plot=choropleth_chart)
# ggsave2("inset_map.pdf",plot=gg_inset_map)

# grid.arrange(choropleth_chart,gg_inset_map, nrow=2)
# cowplot::plot_grid(choropleth_chart,gg_inset_map, align = "v", nrow=2)
```


```{r places_of_interest, eval=FALSE}
# remove HI and AK
continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))
# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

map_data <- left_join(continental_shp, gwm, by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(graph_data %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)
# head(clean_top_metrics)

```

```{r maps_of_interest, eval=FALSE, out.width="100%", fig.cap="Some selections of interesting areas on the map"}
# figure_name <- "choropleth_map"
# figure_file <- paste0("figures/",figure_name,".png")
# if(!file.exists(figure_file) || refresh){
choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title,
    chart_subtitle,
    weighted_metrics=clean_top_metrics)
  # ggsave(figure_file, plot=choropleth_chart)
# }
choropleth_chart
```

From this high level, we can see in Figure \@ref(fig:density-charts)[.a]{color=`r edit_color`} that approximately `r scales::percent(energy_poverty_rate, accuracy=1)` of households in the [US]{color=`r edit_color`} experience energy poverty. Displaying by those communities defined by their relationship to the Federal Poverty line [Figure \@ref(fig:density-charts).b]{color=`r edit_color`} provides a stark picture. While `r scales::percent(in_both_poverty, accuracy=1)` of households below the federal poverty line also face energy poverty, [more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` of those households]{color=`r edit_color`} above the federal poverty line face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap [and the inadequacy of FPL as an indicator of energy poverty in particular]{color=`r edit_color`}. When we break the group of relatively prosperous households into subsets[ as outlined in Table 1]{color=`r edit_color`}, we find that `r scales::percent(as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","households_below_cutoff"])/as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","household_count"]),accuracy=1)` of households living at 30-80% of their [AMI]{color=`r edit_color`} are experiencing energy poverty. This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in [NER]{color=`r edit_color`} on the households’ energy investments is surprising.

Examining these dynamics by the status of homeownership [in Figure \@ref(fig:density-charts).d]{color=`r edit_color`} reveals further disparities. Though renters and homeowners are similarly distributed below the energy poverty line, there appears to be a clear advantage of homeownership from a net energy perspective for most of the population. Only at a relatively high [NER]{color=`r edit_color`} do renters seem to have an advantage. Tenure matters for more than just equity itself: renters are less likely to take actions to improve their [NER]{color=`r edit_color`}s due to a lack of property rights and [split incentives]{color=`r edit_color`}. Even when action is taken to improve the energy efficiency of a rental building, tenants are less likely to see any economic benefits from it.

[Figure \@ref(fig:density-charts).c shows that h]{color=`r edit_color`}ouseholds with solar as a primary heating fuel have a higher [NER]{color=`r edit_color`} than those with other fuel sources, [even]{color=`r edit_color`} households far below the energy poverty line. [The slope of the NER density lines in Figure \@ref(fig:density-charts).c indicates that these lower-income households seem to experience a different rate of return on NER from the benefits of increased energy adoption than higher-income households.]{color=`r edit_color`} Why are [certain]{color=`r edit_color`} households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households' low consumption, meaning that the potential savings from [implementing energy efficiency measures]{color=`r edit_color`} are lower than for high-income households [according to the prebound effect identified by Sunikka-Blank and Galvin [@sunikka-blankIntroducingPreboundEffect2012]]{color=`r edit_color`}.

```{r}
clean_data_fpl$simplified_primary_heating_fuel <- as.factor(ifelse(clean_data_fpl$primary_heating_fuel=="ELECTRICITY",
                                                              "Electricity", 
                                                               ifelse(clean_data_fpl$primary_heating_fuel %in% 
                                                                        c("UTILITY GAS","BOTTLED GAS"),
                                                                      "Gas",
                                                    ifelse(clean_data_fpl$primary_heating_fuel=="SOLAR",
                                                           "Solar",
                                                                      "Other"))))


clean_data_ami$all <- as.factor("all")

clean_data_ami <- dplyr::left_join(clean_data_ami, replica_sup[c("geoid","company_ty","locale")], by=c("geoid"))

clean_data_ami$simplified_utility_type <- ifelse(clean_data_ami$company_ty %in% c("Coop","DistCoop"),
                                                 "Cooperatively Owned",
                                                 ifelse(clean_data_ami$company_ty %in% c("Federal",
                                                                                         "Muni",
                                                                                         "State"),
                                                        "Government Owned",
                                                        ifelse(clean_data_ami$company_ty %in% 
                                                                 c("Private","PSubdiv"),
                                                               "Privately Held",
                                                               ifelse(clean_data_ami$company_ty=="IOU",
                                                                      "Publicly Held",
                                                                      "Other")
                                                               )
                                                        ))

clean_data_ami$simplified_locale <- sub(" .*", "", clean_data_ami$locale)
```

```{r eval=FALSE}
chart_groups <- list(c(NULL),
                     federal poverty line
                     fuel type?
                       rent+mf
- utility types
- locale types
                  )
```


```{r}
top_line_group <- NULL

p1 <-   density_chart(graph_data, 
                                 metric_name, 
                                 metric_label="", 
                                 group_columns=top_line_group, 
                                 metric_cutoff_level, 
                                 metric_cutoff_label, 
                                 chart_title=NULL, 
                                 chart_subtitle=NULL,
                                 x_label="a")
```

```{r}
top_line_group <- "income_bracket"

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="b")
p2=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="c")
p3=top_line_charts[["density"]]
```


```{r}
top_line_group <- c("number_of_units")
# c("number_of_units", "occupancy_type"),
#                           c("occupancy_type", "income_bracket"),
#                           c("number_of_units", "occupancy_type", "income_bracket"),

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="d")
p4=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("housing_tenure")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="d")
p5=top_line_charts[["density"]]
```


```{r}
top_line_group <- c("simplified_utility_type")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="f")
p6=top_line_charts[["density"]]
```


```{r}
# "pop_hispanic"                               
# [35] "pop_african_american"                        "pop_asian"                                  
# [37] "pop_native_american"                         "pop_caucasian" 
# "pop_total"

minority_races <- c("hispanic","african_american","asian","native_american")
races <- c(minority_races,"caucasian")

pct_races <- replica_sup[,paste0("pop_",races)] / rowSums(replica_sup[,paste0("pop_",races)])
names(pct_races) <- paste0("pct_",races)

plurality_race <- races[max.col(pct_races,ties.method = "first")]

plurality_race <- ifelse(plurality_race=="african_american","black",
                                   ifelse(plurality_race=="native_american","indian",
                                          ifelse(plurality_race=="caucasian","white",
                                          plurality_race)))

race_data <- data.frame("geoid"=replica_sup$geoid,
                        "race"=plurality_race)

top_line_group <- c("race")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(race_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="e")
p7=top_line_charts[["density"]]
```

```{r}
# "pop25_some_college_plus"                     "pop25_high_school"                          
# [41] "pop25_no_high_school"
# "pop_total"

# minority_races <- c("african_american","hispanic","asian","native_american")
# races <- c(minority_races,"caucasian")

education_levels <- c("some_college_plus","high_school", "no_high_school")

pct_education_levels <- replica_sup[,paste0("pop25_",education_levels)] / 
  rowSums(replica_sup[,paste0("pop25_",education_levels)])
names(pct_education_levels) <- paste0("pct_",education_levels)

plurality_education_level <- education_levels[max.col(pct_education_levels,ties.method = "first")]

plurality_education_level <- ifelse(plurality_education_level %in% 
                                      c("high_school","no_high_school"),
                                    "high school or less",
                                    ifelse(plurality_education_level=="some_college_plus",
                                           "college or more",
                                          plurality_education_level))

education_data <- data.frame("geoid"=replica_sup$geoid,
                        "simplified_education"=plurality_education_level)


top_line_group <- c("simplified_education")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(education_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="f")
p8=top_line_charts[["density"]]
```

```{r}
# "climate_zone"                               
# [75] "climate_zone_description"

simplified_climate <- ifelse(replica_sup$climate_zone_description %in% c("Hot","Very Hot"), "Hot",
                             ifelse(replica_sup$climate_zone_description %in% c("Cold",
                                                                                "Very Cold",
                                                                                "Subarctic"),"Cold","Moderate")
                             )

climate_data <- data.frame("geoid"=replica_sup$geoid,
                           "simplified_climate"=simplified_climate)

top_line_group <- c("simplified_climate")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(climate_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="i")
p9=top_line_charts[["density"]]
```



```{r density-charts, include=TRUE, results='asis', fig.cap=density_charts_fig_cap}

density_charts_fig_cap <- paste0("The distribution of ",colorize("NER",edit_color),"s across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure b shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure c shows the difference among groups of households identified by their primary heating fuel. Subfigure d shows the difference based on whether they are renters or owners. Subfigure e shows the difference based on the most prominent race in the census tract of each cohort. Subfigure f shows the difference based on the most prominent education history in the census tract of each cohort.")

grid.arrange(p1,
             p2,
             p3,
             # p4,
             p5,
             # p6,
             p7,
             p8,
             # p9, 
             nrow=2,
             # top=chart_title,
             # subtitle
             bottom="Proportion of Households",
             left=paste0("NER (",metric_label,")"))

# multi_plot <- cowplot::plot_grid(p1,p2,p3,p4,p5,p6,p7,p8,p9,
#                    nrow=3, align="none",rel_heights = c(2,2,2))
# 
# #create common x and y labels
# 
# y.grob <- textGrob(paste0(str_to_upper(metric_name)," (",metric_label,")"), 
#                    gp=gpar(fontface="bold", col="black", fontsize=12), rot=90)
# 
# x.grob <- textGrob("Proportion of Households", 
#                    gp=gpar(fontface="bold", col="black", fontsize=12))
# 
# #add to plot
# 
# grid.arrange(arrangeGrob(multi_plot, left = y.grob, bottom = x.grob))
```

Assessing the [NERs]{color=`r edit_color`} among different states in Figure \@ref(fig:state-violin) presents a counterintuitive picture of how states address energy poverty and energy equity. NER can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as Connecticut and Vermont, where higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi and Alabama, which have significant low-income populations and low per-unit energy prices. Not only are households falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood may suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on new metrics.

Although they are the states with the highest NER, California and Colorado are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely, this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation are a common thread [among the top performing states on an NER basis]{color=`r edit_color`}, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure \@ref(fig:state-violin) shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high [NER]{color=`r edit_color`}s than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.

```{r eval=FALSE}
weighted_medians <- clean_data %>%
   group_by(housing_tenure) %>% 
   summarise(median_electricity_spend = if( sum(!is.na(households))<3 ){NA} else { weighted.median(electricity_spend, households, na.rm=TRUE)},
             median_eroi = if( sum(!is.na(households))<3 ){NA} else { weighted.median(mean_eroi, households, na.rm=TRUE)},
            median_income = if( sum(!is.na(households))<3 ){NA} else { weighted.median(annual_income, households, na.rm=TRUE)},
            median_electricity_price = if( sum(!is.na(households))<3 ){NA} else { weighted.median(implied_price_kWh, households, na.rm=TRUE)},
            median_electricity_use = if( sum(!is.na(households))<3 ){NA} else { weighted.median(implied_electricity_use, households, na.rm=TRUE)},
            median_energy_burden = if( sum(!is.na(households))<3 ){NA} else { weighted.median(mean_energy_burden, households, na.rm=TRUE)},
            median_energy_cost = if( sum(!is.na(households))<3 ){NA} else { weighted.median(mean_energy_cost, households, na.rm=TRUE)}
            )
```


```{r eval=FALSE}
gwm <- grouped_weighted_metrics(graph_data=graph_data, 
                                  group_columns=group_columns, 
                                  metric_name=metric_name, 
                                  metric_cutoff_level=metric_cutoff_level, 
                                  upper_quantile_view=upper_quantile_view, 
                                  lower_quantile_view=lower_quantile_view)
gwm <- gwm %>% {if(!is.null(group_columns)) unite(., "group_name", all_of(group_columns), remove=FALSE, sep="+", na.rm=FALSE) else (mutate(., group_name="all"))}

mean_eroi <- graph_data %>%
  ggplot(aes_string(x=metric_name, 
             weight="group_household_weights", 
             fill="group_name", 
             color="group_name")) + 
  geom_density(alpha=0.1) + 
  ggtitle("Household Energy Return on Investment By Utility Ownership Type") + 
  scale_x_continuous(labels = scales::unit_format(unit = "x", scale = 1, accuracy = 1),
                     breaks=seq(from=0,to=100,by=10), 
                     minor_breaks=seq(from=0,to=100,by=1),
                     limits=c(0,100), name="Household Energy Return on Investment\n(Income Earned for each Dollar Spent on Energy)") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.05), name="Proportion of Households") + 
  theme_minimal() + 
  theme(legend.justification = c(1, 1), legend.position = c(1, 1), legend.title=element_blank()) + 
  geom_vline(data=gwm, aes(xintercept=metric_median,  color=group_name),
               linetype="solid", size=0.5, alpha=0.75) + 
  geom_vline(xintercept = 10, linetype="dotted", 
                color = "red", size=1.0, alpha=0.75)

mean_eroi + annotate("text", x = 10, y = 0.0075/3, angle = 90, color="red", label = "Energy Poverty Line", 
    vjust = -0.5, parse = FALSE, alpha=0.75) + 
  annotate("text", x = min(weighted_medians$median_eroi), y = 0.005/3, angle = 90, color="gray25", label = "Median", 
    vjust = -0.5, parse = FALSE, alpha=0.75)
```


```{r eval=FALSE}
independent_variable <- "replica_mwh"
electricity_v_eroi_contour_plot <- graph_data %>% 
  ggplot(aes_string(x=independent_variable,
                    y=metric_name,
             weight="group_household_weights", 
             fill="group_name", 
             color="group_name")) +
  stat_density_2d(aes(alpha = ..piece..), geom="polygon", na.rm=TRUE) +
  guides(alpha = FALSE) +
  stat_smooth(method = "lm", fullrange = TRUE) +
  # geom_rug() + 
  scale_x_continuous(name = "Monthly Electricity Cost", 
                     labels = scales::dollar_format(),
                     limits = c(0, 1000), expand = c(0, 0)) + 
  scale_y_continuous(name = "EROI", 
                     labels = scales::unit_format(unit = "x", scale = 1, accuracy = 1),
                     limits = c(0, 100), expand = c(0, 0)) + 
  theme_pubr() + #   theme(plot.margin = margin()) + 
  theme(legend.position = "bottom")
electricity_v_eroi_contour_plot
```


```{r eval=FALSE}
electricity_spend + theme_void() + theme(legend.position = "none") + labs(title = NULL, x=NULL, y=NULL) + 
  ggtitle("Monthly Electricity Cost vs. EROI") + 
  plot_spacer() + 
  electricity_v_eroi_contour_plot + theme(legend.justification = c(1, 1), legend.position = c(1, 1), legend.title=element_blank()) + 
  mean_eroi + coord_flip() + theme_void() + theme(legend.position = "none") + labs(title = NULL, x=NULL, y=NULL) + 
  plot_layout(ncol = 2, nrow = 2, widths = c(4, 1), heights = c(1, 4))
```


```{r eval=FALSE}
# Monthly Electricity Expenditures
electricity_spend <- clean_data %>%
  ggplot(aes(x=electricity_spend, weight=ownership_type_household_weights/3, fill=ownership_type, color=ownership_type)) + 
  geom_density(alpha=0.1) + 
  ggtitle("Household Monthly Electricity Spending By Utility Ownership Type") + 
  scale_x_continuous(labels = scales::dollar_format(), limits=c(0,300), name="Energy Spend",
                     breaks=seq(from=0,to=300,by=50), 
                     minor_breaks=seq(from=0,to=300,by=10)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.0005), name="Proportion of Households") + 
  theme_minimal() + 
  theme(legend.justification = c(1, 1), legend.position = c(1, 1), legend.title=element_blank()) + 
  geom_vline(data=weighted_medians, aes(xintercept=median_electricity_spend,  color=ownership_type),
               linetype="solid", size=0.5, alpha=0.75)

electricity_spend + annotate("text", x = min(weighted_medians$median_electricity_spend), y = 0.0025/3, angle = 90, color="gray25", label = "Median",vjust = -0.5, parse = FALSE, alpha=0.75)
```



```{r eval=FALSE}
s1 <- scatter_chart(graph_data, 
                          metric_name, 
                          metric_label,
                          group_columns, 
                          metric_cutoff_level, 
                          metric_cutoff_label, 
                          chart_title, 
                          chart_subtitle,
                          independent_variable="group_households")
s1
```


```{r eval=FALSE}
# Compare maps of energy burden vs. solar rooftop potential
```

```{r eval=FALSE}
From an equity perspective, the Gini coefficient of NERs among US households is `r print("X")`. This means that the NERs are distributed `r print("Y")` by household compared to a uniform distribution. Even this perspective is limited given that we would expect the productivity of energy usage by each household would be similar, even if the absolute values of energy consumption vary. In other words: there is no reason that NERs should differ among households at all.
```

```{r}
group_columns <- c("state_abbr")
# utility type? see chartbook
graph_data <- filter_graph_data(clean_data=clean_data_ami[clean_data_ami$state_abbr!="DC",], 
                                group_columns=group_columns, 
                                metric_name=metric_name)
```

```{r}
# percent of "other" fuel expenditures toward fossil fuel combustion
# want to make this more precise by state, county, and/or balancing authority eventually
other_gwm <- grouped_weighted_metrics(clean_data_fpl[clean_data_fpl$state_abbr!="DC",], 
                                      c("primary_heating_fuel"),
                                      "other_spend",
                                      0)

other_fuels <- c("COAL","FUEL OIL","NONE","OTHER","SOLAR","WOOD","BOTTLED GAS")
non_fossil_other_fuels <- c("NONE","SOLAR","WOOD")
fossil_other_fuels <- other_fuels[!(other_fuels %in% non_fossil_other_fuels)]

other_fossil <- other_gwm[other_gwm$primary_heating_fuel %in% fossil_other_fuels,
                              c("household_count","metric_mean")]

pct_other_fossil <- sum(other_fossil$household_count*other_fossil$metric_mean)/
  sum(other_gwm$household_count*other_gwm$metric_mean)

graph_data$pct_other_fossil <- pct_other_fossil
```

```{r}
# percent of each state's electric grid decidated to fossil fuel combustion
# can refine by balancing authority based on REPLICA dataset
egrid <- get_state_egrid()

egrid$pct_electricity_fossil <- egrid$STCLPR + #coal
  egrid$STOLPR + #oil
  egrid$STGSPR + #gas
  egrid$STOFPR #+ #other fossil
  # egrid$STNCPR #+ #nuclear
  # egrid$STHYPR #+ #hydro
  # egrid$STOPPR #unknown/purchased

graph_data <- left_join(graph_data, egrid, by=c("state_fips"="FIPSST"))

# graph_data <- graph_data[graph_data$state_abbr!="DC",]
```

```{r}
# percent of natural gas expenditures dedicateed to fossil fuel combustion...
pct_gas_fossil <- 1.0

graph_data$pct_gas_fossil <- pct_gas_fossil
```


```{r}
graph_data$pct_fossil_tract <- (graph_data$pct_gas_fossil * graph_data$gas_spend + 
  graph_data$pct_electricity_fossil * graph_data$electricity_spend + 
  graph_data$pct_other_fossil * graph_data$other_spend) / 
  (graph_data$gas_spend + graph_data$electricity_spend + graph_data$other_spend)


pct_fossil_gwm <- grouped_weighted_metrics(graph_data, "state_fips","pct_fossil_tract",0) %>% 
  dplyr::rename(pct_fossil=metric_mean)

graph_data <- left_join(graph_data, 
                        pct_fossil_gwm[,c("state_fips","pct_fossil")], 
                        by="state_fips")
```



```{r state-violin, include=TRUE, eval=TRUE, results='asis', fig.cap=state_violin_fig_cap}

state_violin_fig_cap <- paste0("A comparison of ",colorize("NER",edit_color),"s among each state in the ",colorize("US",edit_color),". The bars are sorted by median household NER and represent the interquartile range (25%-75% percentiles) of household NERs colored by the percent of household energy expenditures in each state that go to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's ",colorize("(EPA)",edit_color)," ",colorize("Emissions and Generation Resource Integrated Database (",edit_color),"eGRID",colorize(")",edit_color)," for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users.")
# violin plot
y <- make_violin_chart(graph_data=graph_data,
                      group_columns=group_columns,
                      metric_name=metric_name,
                      metric_label=metric_label,
                      metric_cutoff_level=metric_cutoff_level,
                      fill_metric="pct_fossil",#"STCYPR",#"STSOPR",
                      fill_label="% of Energy Expenditures on \nFossil Fuel Combustion",#Combustion",#Solar",
                      group_name="State",
                      x_label="NER")
print(y)
```

```{r}
group_variable <- "eia_id"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(left_join(clean_data_ami, replica_sup, by=c("geoid")), group_columns, metric_name)

util_group <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)

member_minumum <- 10000
lowest_ner_utility <- filter(arrange(util_group,metric_mean),household_count>=member_minumum)[1,]

unique_utils <- distinct(replica_sup[c("eia_id","company_na","state_name","dlrs_kwh")])

lowest_ner_utility_specs <- filter(unique_utils,eia_id==as.numeric(lowest_ner_utility["eia_id"]))

lowest_ner_utility_name <- lowest_ner_utility_specs$company_na
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Corp","Corporation")
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Member","Membership")
```

#### Discussion  {#discussion}

A sensible prior hypothesis is that everyone experiences the same efficiency from the energy system as measured by return on energy investment. Differences in absolute outcomes may be related to the quantity of energy investment, but the marginal unit of energy consumed by one household should lead to as much benefit for that household as any other. However, here we see that [NER]{color=`r edit_color`}s are different among different groups of households in the US. This difference is often correlated to factors out of the households’ control and even those related to persistent social inequalities, such as race and education. These striking disparities suggest the existence of deeply structural barriers to prosperity in the US. Energy is central to equity and economic prosperity, but the energy system appears to be regressive in that costs accrue disproportionately to those of lower-income levels.

`r to_insert="[Add more with demographic data once have queries for this: e.g., Households in communities of color experience energy poverty at ?x the average rate. Renters of multi-family apartments earn half as much as owners of single-family homes when normalized by energy expenditures.]. "`

Furthermore, we demonstrate that owning a home and consuming solar power are associated with increased income multipliers for energy expenditures. This advantage leads to gains that are not being realized by many communities. When households adopt solar power, their NER increases as a result of decreasing their energy expenditures, which creates a disparity between those with access to renewable energy and those reliant on fossil-fuel-based energy sources. This helps explain why there has been a disparity in how the benefits of the energy transition are accruing among socioeconomic groups [@vaishnavWasItWorthwhile2017]. There is the potential for electrification and the transition to clean fuels to exacerbate this division if appropriate policies are not implemented[@cullenwardDynamicallyEstimatingDistributional2016].

Indeed, there are clear, mutually synergistic, positive reinforcement mechanisms to alleviate health and environmental disparities in air pollution exposure by reducing household energy burdens and improving economic mobility across low-income households. Combustion of biofuels and hydrocarbons is a significant source of air pollution and exacerbates other household costs like healthcare and maintenance[, yet we find that utilization of these sources is not associated with increased NERs at a state or household scale]{color=`r edit_color`}. [Not only are h]{color=`r edit_color`}ouseholds living in more poverty and closer proximity to highly polluted areas [at greater risk of adverse health impacts; they]{color=`r edit_color`} must [also]{color=`r edit_color`} consume more energy to overcome the particulate emissions [which, themselves, reduce the efficiency of clean sources such as solar panels[@heIncreaseDomesticElectricity2020]]{color=`r edit_color`}.

The inherent benefits of solar electricity must be accessible to all populations in the [US]{color=`r edit_color`} to promote sustainability, but communities of color [are not]{color=`r edit_color`} receiving a similar benefit to white and wealthier households [from their energy expenditures]{color=`r edit_color`}. Net energy metrics exhibit this income multiplier effect and the resulting divide. Designing solar policies to benefit those facing low [NER]{color=`r edit_color`}s may substantially improve net energy income ratios and raise households out of energy poverty in the [US]{color=`r edit_color`}.

Pachauri et al. distinguish between affordability and cost of supply, implying that more focus should be applied toward how energy burdens vary among customers of different energy suppliers than on how per-unit costs of energy vary[@pachauriAdvancingEnergyPoverty2020]. For instance, `r lowest_ner_utility_name` is the electric utility with more than `r to_big(member_minumum)` customers whose members have the lowest average [NER]{color=`r edit_color`} (`r to_big(lowest_ner_utility$metric_mean)`) [according to LEAD]{color=`r edit_color`}. At the same time, the per-unit cost of electricity in this service territory is only more expensive than `r to_percent(ecdf(unique_utils$dlrs_kwh)(lowest_ner_utility_specs$dlrs_kwh))` of utilities at `r to_dollar(lowest_ner_utility_specs$dlrs_kwh)`/kWh. [Is an exceptionally high burden acceptable because the per-unit costs are not exceptional?]{color=`r edit_color`}

This relevance especially holds for electricity because it is a commodity delivered via a stationary, centralized grid system and households retain little control over their own energy choices. In vertically integrated energy markets, the monopoly utility is the only option available to all consumers. In organized energy markets, the public utility is designated as the last resort provider for those unable or unwilling to participate in the competitive procurement of energy. Even in organized markets, local utilities retain monopolistic control of the transmission and distribution systems. 

Consumers are price takers with relatively inelastic demand. Changes in the unit price of energy or slight differences in consumption patterns matter more to those with low incomes than those with higher incomes. Furthermore, the current lack of storage infrastructure on the grid and behind each meter means that households are bound to electricity providers at the time of use. The "forward-looking" or "reactive" tendencies of these public electric utilities have implications for the energy transition in their jurisdictions and beyond[@wolakFutureElectricityRetailing2020]. A more in-depth examination of the energy system’s underlying regulatory structures and robust assessments of energy burden could provide a path forward and track how the benefits of the energy transition are being accrued.

In some markets, specialized rates or programs are available for Low and Moderate Income (LMI) consumers, who may have higher energy burdens. We find it notable that more than half of all funding to address high energy burdens in the US is from utility ratepayer-funded bill and energy efficiency assistance[@rossHighCostEnergy2018]. At a national scale, the Low Income Home Energy Assistance Program (LIHEAP) and the Weatherization Assistance Program (WAP) in the US seek to address aspects of energy poverty through bill payment assistance and energy efficiency measures, but the efficacy of these programs has been mixed in addressing distributional equity in energy burdens and receiving benefits from energy efficiency programs[@bednarRecognitionResponseEnergy2020]. [In part, this may be because these programs rely on income-based poverty lines such as the Federal Poverty Line (FPL) to determine eligibility for benefits.

The [US]{color=`r edit_color`} benchmarks its FPL to the food requirements of the average household[@coferFamilyFoodPlans1962] and uses this threshold as is an eligibility criterion for more than 40 federal programs across ten agencies (in addition to state, charitable, and private enterprises that also do so)[@divisiondcdProgramsThatUse2015]. Practitioners have posited that the standard policy of “using the ‘economy food plan’ to determine who can afford to hire an attorney” may be depriving citizens of their basic rights[@grossTooPoorHire2013]. In some cases, food assistance programs are more inclusive than energy assistance programs. We show that more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` households above the FPL experience energy poverty.]{color=`r edit_color`}  A significant insight from [NEA]{color=`r edit_color`} that should be incorporated into future work is that embodied energy takes many forms across the household budget (food, goods, services, housing, etc.), and these can all be compared using the same units of measure (e.g., joules) to address such inconsistencies.

The [Coronavirus Disease 2019 (]{color=`r edit_color`}COVID-19[)]{color=`r edit_color`} pandemic and associated recovery measures may be a critical opportunity to provide relief payments related to energy expenditures and to invest in more efficient residential[@RecoveringFastSlow2020a] and commercial energy infrastructure that enables newer and cleaner systems[@chapmanImpactsCOVID19Transitioning2020]. We show that US households are already spending excessive amounts on energy, notwithstanding more families staying at home for longer periods of time during pandemic lockdowns. The ongoing crisis offers a chance to address inequity with a focus on residential energy burdens[@graffCOVID19AssistanceNeeds2020]. [The EU is in the process of defining how communities can participate in the energy transition[@jointresearchcentreeuropeancommissionEnergyCommunitiesOverview2020], and how burdens can be alleviated through this process using proactive policy tools and business models such as One Stop Shops (OSS) for energy efficiency and renewable energy upgrades[@bertoldiRoleOnestopShops2021].]{color=`r edit_color`} Adopting energy criteria for energy and other programs could expand access for those underserved populations in need of assistance independent of their needs in other consumption categories.

Creating a federal energy poverty line would be a critical step in identifying families that face large disparities in access to affordable electricity and energy in the [US]{color=`r edit_color`} and improve programs’ abilities to address energy burdens. A toolkit based on this analysis enables neighborhood-level outreach where burdens are highest and identify opportunities where households could benefit from emerging technologies.

## Methods  {#methods}

#### Data  {#data}
To estimate the Net Energy Return (NER) of American households, we primarily utilize the Low Income Energy Affordability Data (LEAD)[@maLowIncomeEnergyAffordability2019] and Rooftop Energy Potential of Low-Income Communities in America (REPLICA)[@sigrinRooftopSolarTechnical2018] datasets, which the DOE assembled to help “stakeholders make data-driven decisions on energy goal setting and program planning by providing them information on low-income household populations and associated energy use characteristics”[@maLowIncomeEnergyAffordability2019]. These datasets encompass estimates of household energy expenditures (S), income (G), and demographic characteristics for most households at the census tract scale in all states and most territories of the [US]{color=`r edit_color`}.  

LEAD: The LEAD portrays the average income, electricity expenditures, gas expenditures, and other fuel expenditures for cohorts of households segmented by location (census tract, county, state) and household characteristics (whether the unit is rented or owned, the building’s year of first construction, the number of units in the building, whether the units are attached, and the unit’s primary heating fuel type). The dataset is assembled by applying an iterative proportional fitting (IPF) algorithm to cross-tabulations of household responses from the 2016 5-year American Community Survey (conducted by the US Census Bureau), which provides the samples for each cohort as Public Use Microdata Samples. IPF is a widely used spatial microsimulation method to allocate individuals (i.e., households) to zones (i.e., census tracts and utility service territories) while calibrating each zone's characteristics to known quantities. Using IPF, the microdata samples are scaled to match aggregate annual values from utility sales and revenues reported in Energy Information Administration forms 861 and 176.

REPLICA: The Renewable Energy Potential of Low-Income Communities in America (REPLICA) dataset includes [the racial and education-level composition of each census tract]{color=`r edit_color`} used in the ultimate analysis[@sigrinRooftopSolarTechnical2018]. [In addition to providing a simpler designation of cohorts for each census tract as described below in [Methods-Treatment](#treatment), it also includes]{color=`r edit_color`} technical potential of rooftop solar and additional techno-economic variables (e.g. demographics and electricity rates) [that will be useful for future research.]{color=`r edit_color`}

eGRID: We use the [EPA]{color=`r edit_color`}'s eGRID[@usepaEmissionsGenerationResource2020] to calculate the proportion of household energy expenditures that support fossil fuel combustion through the purchase of electricity. 100% of natural gas purchases are considered to support fossil fuel combustion. Electricity purchases are divided into their respective sources according to the state proportions indicated by the "STCLPR" (coal), "STOLPR" (oil), "STGSPR" (gas), and "STOFPR" (other fossil) fields in the 2018 eGRID dataset. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately `r scales::percent(pct_other_fossil, accuracy=1)` fossil fuel combustion.

#### Treatment  {#treatment}
The LEAD data represents the unit’s ownership status (OWNER vs. RENTER) and income bracket as a fraction of [AMI]{color=`r edit_color`} (0-30%, 30-60%, 60-80%, 80-100%, or 100%+) or [FPL]{color=`r edit_color`} (0-100%, 100-150%, etc.). These categorical variables are saved as factors. Then we create min_units from BLD INDEX, a variable which represents a non-uniformly distributed set of buckets for the range of the number of units in the building, and whether single-unit households are attached or detached from neighboring households (1 ATTACHED, 1 DETACHED, 2 UNIT, 3-4 UNIT, 5-9 UNIT, 10-19 UNIT, 20-49 UNIT, 50+ UNIT, MOBILE_TRAILER, BOAT_RV_VAN, OTHER UNIT). We extract the minimum number of units from the range and whether the building is detached. Those households labeled OTHER UNIT, MOBILE_TRAILER, or BOAT_RV_VAN are given values of Not Applicable (NA) for this characteristic. Finally, we calculate S and G of which each metric is composed: 

S = annual expenditures on electricity (ELEP CAL) + natural gas (GASP CAL) + and other fuels (FULP)  

G = the cohort’s average annual income (HINCP) 

The metric formulas outlined in [Applying NER to Energy Equity](#ratios) are then used to calculate each cohort’s energy poverty metrics. Since we are examining homes’ relationships with the energy system, we ignore any homes that do not use energy as denoted by rows where S==0. The estimation procedure used by the DOE results in an estimated number of occupied housing units for each cohort (UNITS, renamed as households). It displays the number of American Community Survey responses that contribute to the estimate of energy expenditures (COUNT, renamed as acs_responses). We then remove any categories with fewer than 1 unit represented since this is not physically possible. `r removed_households = "This results in removing X% of the available rows (gross: X rows of X). This is a total of X housing units or X% of the estimated total X units in the sample. We have separated any cohorts with incomes or energy costs equal to 0 into another dataset for analysis. This represents approximately X% of the housing units and X% of the examined cohorts, so it will be important to make sure that this subset does not contain systematic bias. However, these data are excluded from the current analysis under the assumption that energy costs equal to 0 are not relevant to this analysis."`

We then combine this dataset with the REPLICA dataset. To do so, we must aggregate the income levels of the LEAD dataset to the simpler schema used by REPLICA for summarizing households’ income relative to the area’s median income (AMI):

- 0-30% AMI: Very Low Income
- 30-80% AMI: Low-to-Moderate Income
- $\geq$ 80% AMI: Middle-to-High Income

Also, we create an indicator of whether a particular cohort is in income poverty as defined by the relevant standards for its characteristics. For the AMI version of LEAD, this is defined as being “Very Low Income” or $\leq$ 30% of AMI. For the Federal Poverty Line (FPL) version of LEAD, we translate directly from the designation of the income bracket as follows:

- 0-100% FPL: In Poverty
- $\geq$ 100% FPL: Not In Poverty

The REPLICA dataset also simplifies any households with only one unit per building into “Single Family” homes and any households with more than one unit per building as “Multi-family.” Non-stationary and non-traditional homes are not included in the REPLICA analysis. We match these simplifications in the LEAD dataset by aggregating by the number of units:

- 1 Unit: Single-Family
- $>$ 1 Unit: Multi-Family
- Other Unit: NA (excluded from analysis)

After simplifying these characteristics in the LEAD [AMI]{color=`r edit_color`} data, we merge the AMI dataset with the REPLICA dataset along the census tract, simplified income bracket, simplified number of units, and housing tenure variables to achieve the primary dataset used in the analysis. Merging with the REPLICA dataset provides additional demographic and geospatial data not available in the LEAD dataset only[@sigrinRooftopSolarTechnical2018]. Characteristics such as the utility type and locale description are sourced from REPLICA and unavailable in LEAD. Similarly, the REPLICA dataset contains only electrical expenditure estimates without natural gas or other fuel costs to households and could not be used to perform this analysis alone.

The FPL version of LEAD is not merged with all of the REPLICA data because of incompatibility between the FPL and [AMI]{color=`r edit_color`} bracket definitions. However, demographic data associated with each census tract as a whole can be merged with the FPL dataset. Both AMI and FPL versions of LEAD are combined with demographic data from the REPLICA dataset and geospatial shapefiles from the Census to produce the final datasets used in the analysis. [Since the FPL version of LEAD is not aggregated to the simpler categories found in REPLICA, more granular variables such as Primary Heating Fuel remain available for assessment across the entire population.]{color=`r edit_color`}

#### Considerations  {#considerations}
Iterative proportional fitting has limitations as an estimation procedure that constrain the strength of conclusions that can be drawn from the simulated LEAD and REPLICA datasets. The relationship between constraint variables such as total energy spending by utility service territory and number of households per census tract will tend toward the average of the initializing dataset and depress variations among otherwise similar regions. This may explain the large quantities of households that are estimated to have very low incomes. Validating these estimated data would require randomized surveys of households along the dimensions of interest.

The meaning of the “primary heating fuel” category comes from the answer to the question “Which fuel is used most for heating this house, apartment, or mobile home?” on the American Community Survey. This question’s power to predict energy expenditures or fuel sources is unknown, and further analysis is required to understand the implications of this survey question for drawing broader conclusions about household energy use. However, the US Census Bureau has been asking this question since 1940. It states that these data are collected to help communities "provide assistance with utilities", "estimate future energy demand", and "measure environmental impacts"[@bureauWhyWeAsk].

Though the REPLICA dataset relies on a different vintage of the LEAD dataset (assembled in 2017[@sigrinRooftopSolarTechnical2018]) than this analysis (assembled in 2019[@maLowIncomeEnergyAffordability2019]), inferring differences among annual estimates is not meaningful due to the standard error of the data [@maLowIncomeEnergyAffordability2019]. A rigorous treatment of these metrics over time is an area for future research.

The results inferred from eGRID are only as good as the eGRID methodology itself. We choose to outline the proportion of combusted fuels rather than emissions data due to the limitations outlined by proponents of marginal emissions attribution in electric power system models[@vonwaldAnalyzingCaliforniaFramework2020] [@siler-evansMarginalEmissionsFactors2012] and limitations in estimating regional electricity transfers[@vonwaldAccountingGreenhouseGas2021].

## Code Availability {#code-availability}

The code and data to fully reproduce this paper are available on Github at [https://github.com/ericscheier/net_energy_equity](https://github.com/ericscheier/net_energy_equity) under the GNU Affero General Public License v3.0.

## Data Availability  {#data-availability}

All data necessary for the composition of the source datasets used in this analysis are freely available from [US]{color=`r edit_color`} government sources as open data. All functions to automatically retrieve and assemble these data, and compiled versions of these data are made available to the user as part of the software referred to in [Code Availability](#code-availability).

## References  {#references}

::: {#refs}
:::

```{r eval=FALSE}
# # Works Not Yet Cited  {#uncited}
# 
# ---
# nocite: |
#   @*
# ...
# 
# # Software Used  {#software}
# 
# List of R packages used to be entered here automatically
# 
# # Acknowledgements  {#acknowledgements}
#
```

## Author Contributions  {#author-contributions}

ES and NK conceived of and designed the project. ES created the software used for data acquisition and analysis and created the figures. NK contributed the introduction of the topic and interpretation of the results.

## Competing Interests  {#competing-interests}

The authors declare no competing interests.


```{r eval=FALSE}
# 
# # Additional Information  {#additional-information}
# 
# # (APPENDIX) Appendix {-}  {#appendix}
# 
# # Charts for All Variables {#charts}
```

```{r eval=FALSE}
# ---Template / Style Examples After This---
# 
# # Introduction {#intro}
# 
# Your text comes here. Separate text sections with \cite{R-rmarkdown}. 
# 
# # Section title {#sec:1}
# 
# Text with citations by \cite{Galyardt14mmm}.
# 
# # References 1
# 
# 
# 
# ## Subsection title {#sec:2}
# 
# as required. Don't forget to give each section
# and subsection a unique label (see Sect. \ref{sec:1}).
# 
# #### Paragraph headings 
# 
# Use paragraph headings as needed.
# 
# \begin{align}
# a^2+b^2=c^2
# \end{align}
```

```{r, include = FALSE, eval=FALSE}
r_packages_used <- c("rmarkdown", "knitr")
knitr::write_bib(x = r_packages_used, file = "bibliography.bib")
```

```{r}
# 
# # Figure Legends
# 
# Figure \@ref(fig:metric-comparison) (`metric-comparison-1.pdf`): `r metric_comparison_fig_cap`
# 
# Figure \@ref(fig:continental-map) (`continental-map-1.pdf`): `r continental_map_fig_cap`
# 
# Figure \@ref(fig:inset-map) (`inset-map-1.pdf`): `r inset_map_fig_cap`
# 
# Figure \@ref(fig:density-charts) (`density-charts-1.pdf`): `r density_charts_fig_cap`
# 
# Figure \@ref(fig:state-violin) (`state-violin-1.pdf`): `r state_violin_fig_cap`
# 
# 
# # Tables
# 
# ```{r comparison-table-display, include=TRUE, results="asis"}
# final_table
# ```
```


```{r}
# merge data together
write.csv(x=clean_data_fpl,file="CohortData_FederalPovertyLine.csv")
write.csv(x=clean_data_ami,file="CohortData_AreaMedianIncome.csv")
write.csv(x=replica_sup,file="CensusTractData.csv")
# save as csv

```


<!--chapter:end:net_energy_equity.Rmd-->

---
title: Net energy metrics reveal striking disparities across United States household energy burdens
subtitle: 
titlerunning: Net Energy Equity
keywords:
  - energy burden
  - net energy
  - macro-energy systems
  - energy inequality
bibliography: references.bib
bibstyle: spphys
csl: nature-no-et-al.csl
journalname: Nature Energy
date: "`r format(Sys.time(), '%d %B %Y')`"
toc: false
output:
  bookdown::pdf_document2:
    number_sections: false
    keep_tex: true
    documentclass: article
  bookdown::html_document2:
    number_sections: false
  bookdown::word_document2:
    number_sections: false
  bookdown::pdf_book:
    base_format: rticles::springer_article
    keep_tex: true
tables: true
fig_caption: true
always_allow_html: true
header-includes:
- \usepackage{booktabs}
- \usepackage[left]{lineno}
- \linenumbers
- \usepackage{setspace}
# - \doublespacing
---

```{r setup, include=FALSE}
is_final=FALSE #TRUE
is_preview= TRUE #FALSE
is_draft= TRUE
set.seed(456)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','asis')),
                      fig.keep='all', #'last'
                      dev='cairo_pdf',#'pdf',
                      fig.show='hold',#'hide
                      # fig.pos = "!H",
                      # out.extra = "",
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=TRUE, #ifelse(is_draft, TRUE, ifelse(is_preview, TRUE, !is_final)),
                      cache.lazy=FALSE,
                      fig.margin=FALSE,
                      fig.fullwidth=TRUE, #FALSE
                      eval.after = "fig.cap"#,
                      # cache.path = 'net_energy_equity_cache/', 
                      # fig.path = 'net_energy_equity_files/'
                      )

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 
    "latex" else "pipe"
})
```

```{r option-view, include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)

# knitr::opts_current$get(c(
#   "cache",
#   "cache.path",
#   "cache.rebuild",
#   "dependson",
#   "autodep"
# ))

kable(knitr::opts_chunk$get() %>% enframe())
```


```{r sources, cache=FALSE}
source("sources.R")
```

```{r parameters}
states <- "all" #c("ca","nc","sc") #
refresh <- FALSE
acs_version <- 2018
# geographic_scope <- "tract" #statecitycounty
```

```{r run-methods, cache=TRUE}
paper_methods(states=states,
              acs_version=acs_version,
              refresh=refresh)
```


```{r load-data}
income_metric <- "AMI" #"AMI" #"fpl15" #
geographic_scope <- "Census Tracts" #statecitycounty

version_text <- as.character(acs_version)
if(acs_version==2016){
  version_text <- "sh"
}

base_file_name <- tolower(paste(income_metric,
                                geographic_scope,
                                version_text,
                                paste(states,collapse="_",sep=""), sep = "_"))

clean_data_ami <- read_csv(paste0("data/very_clean_data_",base_file_name,".csv"), guess_max = 10^6)

income_metric <- "FPL"
base_file_name <- tolower(paste(income_metric,
                                geographic_scope,
                                version_text,
                                paste(states,collapse="_",sep=""), sep = "_"))
clean_data_fpl <- read_csv(paste0("data/very_clean_data_",base_file_name,".csv"), guess_max = 10^6)

tract_file_name <- paste0("data/",paste(states,collapse="_",sep=""),"_census_tracts.geojson")

census_tracts_shp <- st_read(tract_file_name)
replica_sup <- get_replica_supplemental_dataset()
tract_shp <- st_sf(left_join(census_tracts_shp, replica_sup, by=c("gisjoin")))
```

```{r}
# Things in here should probably be moved further up the data processing pipeline
# clean_data_ami$number_of_units <- as.factor(ifelse(clean_data_ami$min_units > 1, "mf", "sf"))
# clean_data_fpl$number_of_units <- as.factor(ifelse(clean_data_fpl$min_units > 1, "mf", "sf"))
```


```{r poverty-lines, eval=TRUE}


energy_burden_poverty_line <- 0.10

eroi_poverty_line <- eroi_func(g=1,
                               s=energy_burden_poverty_line)

average_energy_cost <- weighted.mean(clean_data_ami$energy_cost, 
                                     clean_data_ami$total_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.mean(clean_data_ami$total_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)

median_energy_cost <- weighted.median(clean_data_ami$energy_cost, 
                                     clean_data_ami$total_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$total_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)
# 12*(clean_data_ami$electricity_spend + 
#       clean_data_ami$gas_spend + 
#       clean_data_ami$other_spend)
# clean_data_ami$total_kWh <- clean_data_ami$gas_kWh + clean_data_ami$electricity_kWh
median_electricity_cost <- weighted.median(clean_data_ami$electricity_spend,
                              clean_data_ami$electricity_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$electricity_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)

median_gas_cost <- weighted.median(clean_data_ami$gas_spend, 
                                     clean_data_ami$gas_kWh*clean_data_ami$households, 
                                     na.rm = 
                                    T)/weighted.median(clean_data_ami$gas_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)
median_gas_cost_Mcf <- weighted.median(clean_data_ami$gas_spend, 
                                     clean_data_ami$gas_Mcf*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$gas_Mcf,
                                                              clean_data_ami$households,
                                                              na.rm = T)


ner_poverty_line_dlrs <- ner_func(g=1,
                                  s=energy_burden_poverty_line)

ner_poverty_line_mean <- ner_func(g=1,
                             s=energy_burden_poverty_line,
                             se=energy_burden_poverty_line/(average_energy_cost))

ner_poverty_line_median <- ner_func(g=1,
                             s=energy_burden_poverty_line,
                             se=median_energy_cost/energy_burden_poverty_line)

ner_poverty_line <- ner_poverty_line_dlrs #ner_poverty_line_median


dear_poverty_line <- dear_func(g=1,
                               s=energy_burden_poverty_line)

ner_dear_poverty_line <- dear_func(g=1+median_energy_cost*ner_poverty_line_median,
                               s=1)


```

```{r figure-parameters}
#chart_title <- "Household Economic Return on Energy Spending"
chart_title <- "Community Net Energy Return"
chart_subtitle <- "Net Earnings per Dollar of Energy Consumed"

group_columns <- NULL#"income_bracket")#in_poverty
                   #"primary_heating_fuel"

metric_name <- "ner" #"energy_burden" #"ner" #"dear" #"eroi"
metric_label <- "$/$"
metric_cutoff_level <- ner_poverty_line
metric_cutoff_label <- "Energy Poverty Line"

upper_quantile_view <- 1.0
lower_quantile_view <- 0.0
```

```{r top_metrics}
group_variable <- NULL# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

top_metrics <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.99, 
                         lower_quantile_view=0.00)
# head(top_metrics)
```


```{r grouped_weighted_metrics}
#data$GEOID <- sub('.', '', data$gisjoin)
group_variable <- "geoid"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

gwm <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)
# head(gwm)
```

```{r eval=TRUE}
fpl_graph_data <- filter_graph_data(clean_data_fpl, group_columns="in_poverty", metric_name)

fpl_top_metrics <- grouped_weighted_metrics(fpl_graph_data, 
                         group_columns="in_poverty", 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)

fpl_ep_data <- filter_graph_data(clean_data_fpl,
                                 group_columns=c("in_poverty",
                                                 "energy_burden_poverty"), 
                                 metric_name)

fpl_ep_top_metrics <- grouped_weighted_metrics(fpl_ep_data, 
                         group_columns=c("in_poverty",
                                                 "energy_burden_poverty"), 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)


# should replace this with weighted metrics data
# How many households are below the poverty line in this data?
total_households <- fpl_top_metrics$household_count

number_in_poverty <- fpl_top_metrics$households_below_cutoff

pct_in_poverty <- number_in_poverty / total_households

pct_of_ep_below_fpl <- fpl_top_metrics$households_below_cutoff[fpl_top_metrics$in_poverty=="Below Federal Poverty Line"] / sum(number_in_poverty)

# number_above_poverty <- sum((data$income_bracket!=poverty_cutoff) * (data$households))

pct_above_poverty <- 1 - pct_in_poverty

in_both_poverty <- pct_in_poverty[2]

in_only_energy_poverty <- pct_in_poverty[1]

energy_poverty_rate <- sum(number_in_poverty) / sum(total_households)

ami_graph_data <- filter_graph_data(clean_data_ami,
                                    group_columns=c("in_poverty",
                                                    "income_bracket"),
                                    metric_name)
ami_top_metrics <- grouped_weighted_metrics(ami_graph_data, 
                         group_columns=c("in_poverty",
                                         "income_bracket"), 
                         metric_name, 
                         metric_cutoff_level,
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)
```

<!-- \newpage -->

**Abstract: Energy poverty in the United States is an issue of increasing urgency, exacerbated by rising inequality. Few policy-relevant datasets evaluate the energy burden of typical American households. Here, we develop a framework using net energy analysis and socioeconomic data at the census tract-level to observe systematic energy inequity across the United States among critical groups that heed policy attention. We find substantial instances of energy poverty in the United States -- `r scales::percent(energy_poverty_rate, accuracy=1)` of households experience energy poverty as presently defined as spending more than 10% of household income on energy expenditures. While `r scales::percent(in_both_poverty, accuracy=1)` of households below the federal poverty line also face energy poverty, fewer than `r scales::percent(in_only_energy_poverty, accuracy=0.01)` of those above the federal poverty line face this scarcity. The federal poverty line is not enough to capture the experience and disparity in energy poverty across the United States and excludes households that would benefit immensely from programs available to support low-income communities. We identify that energy expenditures across census tracts disproportionately burden Black, Hispanic, and Native American communities. For solar, wind, and energy efficiency to address socioeconomic mobility, programs must reduce relative energy expenditures by expanding eligibility requirements for support and access to improved conservation measures, efficiency upgrades, and distributed renewables. We recommend the United States  develop a more inclusive federal energy poverty categorization that provides greater assistance for household energy costs.**

Main Text: Energy is becoming increasingly unaffordable for American households. In the United States (US), energy poverty is now a significant challenge as families struggle to meet monthly bills and live paycheck to paycheck[@bednarRecognitionResponseEnergy2020]. Despite technological progress and rapid declines in technology costs and availability for cleaner, renewable electricity generation options such as solar photovoltaics and energy storage, many households cannot take advantage. Most households do not have access to advancements such as low-cost rooftop solar or energy efficiency upgrades that improve air quality, lower greenhouse gas emissions, and save money[@castellanosRooftopSolarPhotovoltaic2017]. Rooftop solar may be capital intensive, although the investments may recoup costs. Similarly, for households living in older buildings, the ability improve building ventilation systems and energy efficiency may require awareness and resources left out from current policies. Renters face systemic disadvantages in the energy transition; they typically pay the home's energy costs while the landlord controls infrastructure upgrades, commonly understood as a principal-agent dilemma.

It is becoming increasingly clear that there is a growing disparity between wealthier and lower-income households based on their abilities to meet basic energy needs[@brownLowincomeEnergyAffordability2020]. While per-unit residential energy costs for energy have increased below the rate of inflation in the United States since the 1980s[@ShortTermEnergyOutlook2021], many households still struggle to make utility bill payments and are especially vulnerable to economic shocks[@kawaiSpendingHouseholdEnergy2021]. This gap is not just a financial issue - many of the households living in poverty lack the agency to perform efficiency upgrades or technology enhancements that could decrease the gap between wealthy and poor households. Even though low-interest loans may be available for solar or efficiency upgrades in some communities, the bureaucracy and institutional inertia hold back a more rapid transition. In other examples, such as Property Assessed Clean Energy (PACE) programs implemented in Missouri, loans intended to support low-income homes with energy efficiency improvements allowed predatory lenders to charge high-interest rates (9-10%) and claim first lien on property taxes, leading to a spate of foreclosures [@coryneStateSupportedCleanEnergy].

The United States benchmarks its Federal Poverty Level (FPL) to the food requirements of the average household[@coferFamilyFoodPlans1962]. The FPL is an eligibility criterion for more than 40 federal programs across ten agencies (in addition to state, charitable, and private enterprises that also do so)[@divisiondcdProgramsThatUse2015]. Food and energy are interlinked in crises. Household energy use for services such as heating, cooling[@limaReviewRelationHousehold2020] and cooking[@mobarakLowDemandNontraditional2012] is crucial for decent living conditions[@raoEnergyRequirementsDecent2019]. By definition, the implications of a limited estimate of poverty used for public policy decisions stretch far beyond direct connections to food. Practitioners have posited that the standard policy of “using the ‘economy food plan’ to determine who can afford to hire an attorney” may be depriving citizens of their basic rights[@grossTooPoorHire2013]. In some cases, food assistance programs are more inclusive than energy assistance programs.

Prior research of household prosperity in limited global jurisdictions has found that gender, age, housing age[@rossHighCostEnergy2018], tenure type[@mayerTwoFacesEnergy2014], energy inefficiency[@drehoblUSLowIncomeEnergy2016], education, employment[@linAffordabilityAccessFocus2018], geography[@linDoesEnergyPoverty2020], socioeconomic status[@bednarIntersectionEnergyJustice2017], race/ethnicity[@tongMeasuringSocialEquity2021], and macroeconomic conditions[@kawaiSpendingHouseholdEnergy2021] are associated with high energy burdens in various geographical areas. Unaffordable energy is a persistent trend[@brownPersistenceHighEnergy2020] that is negatively related to social cohesion, climate change responses, and disproportionate environmental impacts on low-income populations and minority groups [@carleyJusticeEquityImplications2020]. These connections could have significant implications for navigating sustainable development and meeting societal goals around decarbonization and energy use. Adopting energy criteria for energy and other programs could expand access to services for those underserved populations in need of assistance independent of their needs in other consumption categories.

Here, we examine the relationship between energy spending and household income for all census tracts in the United States, with particular emphasis on how disparate household net energy ratios signal economic disparities across communities, racial and ethnic groups, and levels of income. This empirical analysis will fill a gap in the current discussion about energy equity by providing a biophysical framework to evaluate the disparities among household net energy outcomes.

Energy poverty is not just a lack of money to meet basic energy needs - it is a lack of the capability to enable a sustainable and prosperous society built on equity and justice principles.


#### Household Energy Burdens Across the United States  {#burdens}

Net energy refers to the newly released potential to do work as a result of some external activity. Previous studies estimate the net energy return (NER) of a process as a relationship between the gross amount of energy extracted and the amount of embodied energy directed toward extraction[@brandtCalculatingSystemsscaleEnergy2013]: 

\[
G = Gross\ Resource\ Extracted
\]

\[
S = Spending\ on\ Extraction\ Process
\]

\begin{align}
Net\ Energy\ Return\ (NER) = \frac{G - S}{S}
\end{align}


For households extracting income from the economy, these ratios can be composed of:

\[
G_{income} = Gross\ Income
\]

\[
S_{energy} = Spending\ on\ Energy
\]


From these metrics, we can create a version of net energy return for households:

\begin{align}
NER_{household} = \frac{G_{income} - S_{energy}}{S_{energy}}
\end{align}

This metric represents the net earnings a household receives for every expenditure on secondary energy.

#### Applying Net Energy Ratios to Energy Equity  {#ratios}

From these concepts, we can summarize relevant energy ratios. Energy burden is the proportion of income spent on energy:

\begin{align}
Energy\ Burden = \frac{S_{energy}}{G_{income}}
\end{align}

Net Energy Ratio (or Net Energy Return) (NER) prevents the double counting of energy expenditures found in Energy Burden:

\begin{align}
Net\ Energy\ Return = \frac{G_{income}-S_{energy}}{S_{energy}}
\end{align}

```{r metric-comparison, include=TRUE, results='asis', fig.cap=metric_comparison_fig_cap}


eb_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% 
                                            mutate(energy_burden = round(100*energy_burden,digits=1)),
                                          group_columns = c("energy_burden","income_bracket"), 
                                          metric_name="net_income", 
                                          metric_cutoff_level = .1) %>% 
  mutate(metric_name="Energy Burden (%)") %>% 
  rename(energy_metric=energy_burden) #%>% 
  # mutate(energy_metric=100*energy_metric)

ner_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% mutate(ner = round(ner,digits=0)), 
                                     group_columns = c("ner","income_bracket"), 
                                     metric_name="net_income", 
                                     metric_cutoff_level = 9) %>% 
  mutate(metric_name="Net Energy Return ($/$)") %>% rename(energy_metric=ner)

comparison_chart_data <- rbind(eb_chart_data,ner_chart_data)

metric_comparison_net_income_lbound <- -1000
metric_comparison_net_income_ubound <- 6*10^4
metric_comparison_x_axis_lbound <- -10
metric_comparison_x_axis_ubound <- 400
metric_comparison_pct <- sum(comparison_chart_data$household_count[
  comparison_chart_data$energy_metric <= metric_comparison_x_axis_ubound & 
    comparison_chart_data$energy_metric >= metric_comparison_x_axis_lbound & 
    comparison_chart_data$metric_mean <= metric_comparison_net_income_ubound & 
    comparison_chart_data$metric_mean >= metric_comparison_net_income_lbound & 
    !is.na(comparison_chart_data$metric_mean) & 
    is.finite(comparison_chart_data$metric_mean)]) / 
  sum(comparison_chart_data$household_count)

comparison_chart <- comparison_chart_data %>% 
  ggplot(aes(x=energy_metric, y=metric_mean, fill=income_bracket, color=income_bracket)) +
  # scale_x_continuous(trans=scales::pseudo_log_trans(base = 10)) +
  scale_y_continuous(labels=scales::dollar_format()) + 
  ggrastr::rasterise(geom_point(aes(size=household_count), 
                                alpha=0.25, 
                                position="jitter")) + 
  scale_fill_discrete(name="Income Bracket") + 
  scale_color_discrete(name="Income Bracket") + 
  scale_size_continuous(name="Households", labels=scales::label_comma()) + 
  # geom_hline(yintercept = .1) + 
  # geom_vline(xintercept = 9) + 
  # geom_smooth(method="lm",#NULL,#
  #             mapping=aes(weight=household_count),
  #             # formula=y~,
  #             se=FALSE,
  #             fullrange=TRUE,
  #             linetype="solid",
  #             alpha=0.75
  #             ) + 
  facet_grid(cols=vars(metric_name), switch="x", scales="free_x") +#, space="free_x") + 
  theme_bw() +
  labs(title = "Energy Burden and Net Energy Return in US Households", 
       x="Energy Metric", 
       y="Household Annual Net Income ($)") + 
  theme(legend.position = c(.3,.6),
        legend.background = element_rect(fill = "#ffffffaa", colour = NA), 
        legend.key.size = unit(10, "points")#,
        # legend.justification = c(0, 0)
        )+
  coord_cartesian(#xlim=c(0,120),
               ylim=c(metric_comparison_net_income_lbound,
                      metric_comparison_net_income_ubound),
               xlim=c(metric_comparison_x_axis_lbound,
                      metric_comparison_x_axis_ubound),
               # default=FALSE,
               expand=TRUE)

metric_comparison_fig_cap <- paste0("Display of the relationship between energy burden and net energy return with income for US households. While energy burden appears inversely correlated to income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the energy burden equation, the energy burden of these households approaches infinity. Since the data is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. Net energy return provides a framing of the same dataset that allows for exploration of most households on a similar scale without the long tail. Net energy return appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing net energy return avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, net energy return offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent. Many households with moderate-to-high energy burdens are actually higher-income households with high energy expenditures, making their net energy returns quite high (e.g., >\\$100 of income per \\$1 of energy spending). Almost ",to_percent(metric_comparison_pct)," of the households in the dataset have net incomes between ",to_dollar(metric_comparison_net_income_lbound)," and ",to_dollar(metric_comparison_net_income_ubound)," with net energy returns (or energy burdens) of between ",metric_comparison_x_axis_lbound," (",to_percent(metric_comparison_x_axis_lbound/100),") and ",metric_comparison_x_axis_ubound," (",to_percent(metric_comparison_x_axis_ubound/100),").")

comparison_chart
```

The NER is the standard metric of Net Energy Analysis because it reflects the role of energy as an input to a value-generating process in ecosystems[@brandtHowDoesEnergy2017]. Energy Burden is the metric of choice in the energy insecurity literature[@rossHighCostEnergy2018]^,^ [@bednarIntersectionEnergyJustice2017]^,^ [@drehoblUSLowIncomeEnergy2016]^,^ [@kawaiSpendingHouseholdEnergy2021]. As a percentage, it is an easily interpretable metric that helps policymakers and researchers understand the distribution and impacts of energy poverty throughout communities.

We will primarily examine the Net Energy Return, as it is the primary indicator in the study of macro-energy systems[@leviMacroEnergySystemsNew2019] like the US residential housing stock. While most Energy Return Ratios, including NER, are hyperbolic paraboloids, NER has several useful mathematical properties: it can smoothly handle systems with negative incomes and energy costs, accept households with zero income, and emphasize extreme incomes and energy costs in an interpretable fashion as shown in Figure \@ref(fig:metric-comparison). Only households with no energy costs are excluded from the analysis, whereas households with no energy costs or incomes must be excluded from an analysis utilizing energy burden.

For the discussion of household energy poverty, we are primarily interested in how households of different characteristics are distributed according to their Net Energy Returns, representing how many net dollars are earned by a household for every dollar it spends on energy. Since the NER is unitless but is a ratio of return on investment, we present it below interchangeably with no units or in units of $\$/\$$ depending on context. In this context, we may refer to NER as the Community Net Energy Return due to the community-wide scope of the underlying data used for this analysis. Other proposed indicators of energy poverty may be similarly examined in this manner. 


#### Application to energy poverty  {#poverty-line}

Energy poverty is commonly defined in terms of energy burden as an expenditure of greater than 10% of household income on energy[@bednarRecognitionResponseEnergy2020]:

\begin{align}
Energy\ Burden^{*} = \frac{S_{energy}}{G_{income}} > 10\%
\end{align}

. Calibrating our net energy return analysis to this level will help gauge different thresholds of energy poverty and benchmark the results of this paper to the energy poverty literature while acknowledging the continuum of experiences across household energy consumption. Translated into its relative level for net energy return, the energy poverty line NER* is defined as:

\begin{align}
NER^{*} = \frac{G_{income}-S_{energy}}{S_{energy}}\ 
such\ that \ \frac{S_{energy}}{G_{income}} > 10\%
\end{align}

\begin{align}
NER^{*} < 9: Household\ at\ Energy\ Poverty\ Line
\end{align}

This means that a household that earns less than $9 of income for every dollar it spends on secondary energy will be considered to be in energy poverty by the traditional energy burden accounting method. A NER of 9 or lower is equivalent to an energy burden of 10% or higher. This threshold is arbitrary and may not be suitable in situations where households fall very close to this line or where the number of family members or measures of certain building characteristics vary widely. Simply, it is presented as a benchmark. We examine the net energy return at a community scale across the United States in Table 1.


#### The Household Net Energy Landscape  {#landscape}


```{r comparison-table, include=TRUE, results="asis"}
# table with states'/groups' median annual household energy expenditures, incomes, net incomes, NER, and EB
compare_metrics <- function(metric_name="ner"){
  gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami,c("income_bracket"),metric_name),
                           c("income_bracket"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)
  gwm$metric_name <- metric_name
  return(gwm)
}

compare_table <- rbindlist(lapply(c("income",
                                    "energy_cost",
                                    # "energy_burden",
                                    "net_income"#,
                                    # "ner"
                                    ), compare_metrics))

compare_table_totals <- compare_table %>% 
  filter(metric_name=="income") %>% 
  pivot_wider(id_cols=income_bracket,
              names_from=metric_name,
              values_from=household_count,
              ) %>% 
  rename(households=income) %>% pivot_longer(cols="households")

compare_table <- compare_table %>% 
  pivot_wider(id_cols=income_bracket,
              names_from=metric_name,
              values_from=metric_mean) %>% 
  mutate(energy_burden = energy_burden_func(g=income, s=energy_cost),
         ner = ner_func(g=income, s=energy_cost)) %>% 
  pivot_longer(cols=c("income","energy_cost","energy_burden","net_income","ner"))

compare_table <- rbind(compare_table_totals, compare_table)

#format the metrics accordingly
# income = 0 decimal place $
# energy_cost = 0 decimal place $
# energy_burden = 0 decimal place %
# net_income = 0 decimal place $
# ner = 1 decimal place number

which_metric <- "value" #"metric_mean" #"metric_median"

compare_table$print_value <- ifelse(compare_table$name %in% c("income",
                                                                     "energy_cost",
                                                                     "net_income"),
                                    to_dollar(compare_table[[which_metric]]),
                                    ifelse(compare_table$name %in% c("energy_burden"),
                                           to_percent(compare_table[[which_metric]]),
                                           ifelse(compare_table$name %in% c("ner"),
                                                  round(compare_table[[which_metric]],1),
                                                  ifelse(compare_table$name %in% c("households"),
                                                         to_million(compare_table[[which_metric]]),
                                                  to_big(compare_table[[which_metric]])))))

compare_table$display_income_bracket <- dplyr::recode_factor(compare_table$income_bracket, 
                                       very_low="0-30% AMI",
                                       low_mod="30-80% AMI", 
                                       mid_high="Above 80% AMI",
                                       All="All",
                                       .ordered=TRUE)


compare_table[,"Metric Name"] <- dplyr::recode(compare_table$name,
                                               households="Households in Sample",
                                    income="Annual Income (G)",
                                    energy_cost="Annual Energy Expenditures (S)",
                                    energy_burden="Energy Burden (S/G)",
                                    net_income="Net Income (G-S)",
                                    ner="Net Energy Return ([G-S]/S)")

print_table <- compare_table[,c("Metric Name","display_income_bracket","print_value")] %>% 
  arrange(display_income_bracket) %>% 
  pivot_wider(names_from=display_income_bracket,values_from=print_value)

write_csv(print_table, "comparison_table.csv")

highlight_metrics <- rbindlist(lapply(c(
                                    "energy_burden",
                                    "ner"
                                    ), compare_metrics))

highlight_energy_burden <- as.numeric(highlight_metrics[metric_name=="energy_burden" & income_bracket=="very_low","metric_mean"])

highlight_ner <- as.numeric(highlight_metrics[metric_name=="ner" & income_bracket=="very_low","metric_mean"])

num_one <- paste0(to_big(highlight_energy_burden*100),"\\%")
num_two <- round(highlight_ner,1)
# glue::glue(

print_caption <- paste0("Average annual household energy expenditures, incomes, net incomes, net energy returns, and energy burdens portrayed for different income groups based on their relationship to Area Median Income. Note that the statistics for energy burden and net energy return are calculated per cohort after averaging the income and expenditure statistics to avoid the effect of extreme values skewing the interpretability of these metrics as described in the text. For example, the actual weighted average energy burden for households from 0-30\\% AMI is ",num_one,", and the average net energy return for this cohort is ", num_two," due to subsets of the dataset with very low incomes or low energy expenditures. Net energy return is not as susceptible to this skewing effect.")

# print_caption <- "caption \\% caption"


final_table <- subset(print_table, select=-All) %>%  knitr::kable(booktabs=T,
               caption=print_caption) %>% 
  kableExtra::kable_styling() %>% 
  kableExtra::row_spec(c(2,3,4,6), bold=T)
  # kableExtra::kable_styling(latex_options = c("striped"), #,"hold_position"
                            # position="center")
final_table
```


```{r}
total_homes <- tidycensus::get_acs(geography = "us",
                    variables = c(households="B25002_002"),
                    year = acs_version)
# head(total_homes)
estimated_homes <- compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","value"]
min_homes <- total_homes$estimate - total_homes$moe
max_homes <- total_homes$estimate + total_homes$moe
```


The average American home in the Low-Income Energy Affordability Data (LEAD)[@maLowIncomeEnergyAffordability2019] (n=`r compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","print_value"]` households) has an income of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="income","print_value"]` and an annual energy expenditure of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","print_value"]` (`r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","value"])/12)`/month), which equates to an average energy burden of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_burden","print_value"]` or an average net energy return of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="ner","print_value"]`. While the dataset slightly overrepresents households below the median income due to the limitations of the statistical methods used to compile them, it represents estimates for approximately `r to_percent(as.numeric(estimated_homes/(max_homes)))`-`r to_percent(as.numeric(estimated_homes/(min_homes)))` of the `r to_million(min_homes, suffix="")`-`r to_million(max_homes)` family-occupied households evaluated by the American Community Survey. Table 1 shows a summary of these data for households and their average statistics broken down based on household incomes relative to Area Median Income (AMI). We can see that high energy burdens are found mostly in the very low income group, with an average energy burden of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` or net energy return of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="ner","print_value"]`. Income drives the escape from energy poverty: middle and high-income groups do not spend drastically different amounts on energy (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` and `r to_percent(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` more, respectively) but earn `r to_big(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` and `r to_big(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` times that of the very low-income group, respectively. An energy burden of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` means that `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month is spent on energy, which is quite high on a monthly income of `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"])/12)`. The additional `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month that the next rung of moderate-income groups spends on energy represents a minuscule proportion of their income (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"]))`).

Because cleaner investments could lower costs over time, we can immediately see a disproportionate burden for those making low income to shifting expenditures to other forms of fuel if any upfront investment is required. Fossil fuel costs are not internalized, so it seems like lower-income cohorts are paying less monetarily. Still, they are paying the costs in other ways, such as through health and environmental externalities. Even without these externalities priced in, the burden of energy for low-income groups is already very high.


```{r}
# show some pie / bar charts of the breakdown between fuels
```


```{r continental-map, include=TRUE, results='asis', fig.cap=continental_map_fig_cap}

continental_map_fig_cap <- "Map of the average net earned income per secondary energy expenditure for each census tract in the continental United States. Shades of yellow and red indicate communities at or below the energy poverty line as defined by earning 9 dollars or less in income per dollar of energy expenditures. This corresponds to the traditional definition of energy poverty as spending 10 percent or more of income on energy. Low net energy returns can be starkly observed in the Black Belt across the Southeastern US, Hispanic communities near the US-Mexico border, Native American lands, and rural New England."

continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))
# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

# full_map_data <- left_join(tract_shp, gwm, by=c("geoid"))

map_data <- left_join(continental_shp, gwm, by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(graph_data %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="Energy Burdens Across the United States",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = TRUE,
    metric_long_name = "Net\nEnergy Return")

choropleth_chart
```


```{r inset-map, include=TRUE, results='asis', fig.cap=inset_map_fig_cap}

inset_map_fig_cap <- "An inset focused on the city of New Orleans, Louisiana (Orleans Parish), showing an example of the dynamics of energy poverty in an urban area where the presence of energy inequity is harder to see compared to rural areas for which census tracts are a larger physical area."

nola_msa_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish")

nola_csa_parishes <- c(nola_msa_parishes, 
                       "Tangipahoa Parish",
                       "Washington Parish")

nola_rpc_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   # "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish",
                   "Tangipahoa Parish")

orleans_and_neighbors <- c("Orleans Parish",
                           "St. Tammany Parish",
                           "Jefferson Parish",
                           "Plaquemines Parish", 
                   "St. Bernard Parish"
                           )

inset_map_data <- map_data %>% filter(county_name=="Orleans Parish"
                                     & state_abbr=="LA")

inset_bb <- st_buffer(st_as_sfc(st_bbox(inset_map_data)) %>% st_transform(3857), dist=10)

choropleth_chart_highlight <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    legend_position = "none"
    ) + 
  geom_sf(data = inset_bb, fill = NA, color = "blue", size = 0.2)

# https://en.wikipedia.org/wiki/New_Orleans_metropolitan_area
choropleth_chart_inset <- choropleth_map(
    clean_data=inset_map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="Inset of Energy Burdens In New Orleans, Louisiana",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    legend_position = c(.85,.4),
    include_compass = TRUE,
    metric_long_name = "Net\nEnergy Return")

gg_inset_map = ggdraw() +
  draw_plot(choropleth_chart_inset) +
  draw_plot(choropleth_chart_highlight, x = 0.1, y = 0.65, width = 0.35, height = 0.35)

gg_inset_map
# ggsave2("national_map.pdf",plot=choropleth_chart)
# ggsave2("inset_map.pdf",plot=gg_inset_map)

# grid.arrange(choropleth_chart,gg_inset_map, nrow=2)
# cowplot::plot_grid(choropleth_chart,gg_inset_map, align = "v", nrow=2)
```


```{r places_of_interest, eval=FALSE}
# remove HI and AK
continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))
# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

map_data <- left_join(continental_shp, gwm, by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(graph_data %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)
# head(clean_top_metrics)

```

```{r maps_of_interest, eval=FALSE, out.width="100%", fig.cap="Some selections of interesting areas on the map"}
# figure_name <- "choropleth_map"
# figure_file <- paste0("figures/",figure_name,".png")
# if(!file.exists(figure_file) || refresh){
choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title,
    chart_subtitle,
    weighted_metrics=clean_top_metrics)
  # ggsave(figure_file, plot=choropleth_chart)
# }
choropleth_chart
```

Displayed geospatially in Figure \@ref(fig:continental-map), it is clear that the Black Belt in the American Southeast is visibly perceptible, indicating that low-NER follows racial lines in areas where inexpensive energy is available, and energy burdens are more dependent on housing quality and patterns of consumption than they are dependent on price. Likewise, border populations and immigrant populated areas in the Southwest have higher burdens, as do Native American lands. The use of heating oil in the Northeast states such as Maine can be seen through the prevalance of low-NER communities in this area since heating oil is a notably expensive and inefficient source of heating commonly used in this region. Urban inequity results in lower NER populations not showing up in many dense or gentrified urban areas such as the San Francisco Bay Area, New York City, and New Orleans as shown in Figure \@ref(fig:inset-map). A notable exception to this trend is Detroit, in which the pervasiveness of urban energy poverty has been studied extensively and shown to have distinct geographic boundaries. While some of these conclusions are supported by existing evidence and literature, they should be confirmed with a rigorous analysis of this dataset using the NER metric for reasons explained in Section \ref{ratios}. Additional analyses should incorporate additional demographic and household dimensions due to potential disparities within census tracts since diverse neighborhoods may not be represented accurately by aggregate census tract metrics.

```{r}
clean_data_fpl$simplified_primary_heating_fuel <- as.factor(ifelse(clean_data_fpl$primary_heating_fuel=="ELECTRICITY",
                                                              "Electricity", 
                                                               ifelse(clean_data_fpl$primary_heating_fuel %in% 
                                                                        c("UTILITY GAS","BOTTLED GAS"),
                                                                      "Gas",
                                                    ifelse(clean_data_fpl$primary_heating_fuel=="SOLAR",
                                                           "Solar",
                                                                      "Other"))))


clean_data_ami$all <- as.factor("all")

clean_data_ami <- dplyr::left_join(clean_data_ami, replica_sup[c("geoid","company_ty","locale")], by=c("geoid"))

clean_data_ami$simplified_utility_type <- ifelse(clean_data_ami$company_ty %in% c("Coop","DistCoop"),
                                                 "Cooperatively Owned",
                                                 ifelse(clean_data_ami$company_ty %in% c("Federal",
                                                                                         "Muni",
                                                                                         "State"),
                                                        "Government Owned",
                                                        ifelse(clean_data_ami$company_ty %in% 
                                                                 c("Private","PSubdiv"),
                                                               "Privately Held",
                                                               ifelse(clean_data_ami$company_ty=="IOU",
                                                                      "Publicly Held",
                                                                      "Other")
                                                               )
                                                        ))

clean_data_ami$simplified_locale <- sub(" .*", "", clean_data_ami$locale)
```

```{r eval=FALSE}
chart_groups <- list(c(NULL),
                     federal poverty line
                     fuel type?
                       rent+mf
- utility types
- locale types
                  )
```


```{r}
top_line_group <- NULL

p1 <-   density_chart(graph_data, 
                                 metric_name, 
                                 metric_label="", 
                                 group_columns=top_line_group, 
                                 metric_cutoff_level, 
                                 metric_cutoff_label, 
                                 chart_title=NULL, 
                                 chart_subtitle=NULL,
                                 x_label="a")
```

```{r}
top_line_group <- "income_bracket"

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="b")
p2=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="c")
p3=top_line_charts[["density"]]
```


```{r}
top_line_group <- c("number_of_units")
# c("number_of_units", "occupancy_type"),
#                           c("occupancy_type", "income_bracket"),
#                           c("number_of_units", "occupancy_type", "income_bracket"),

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="d")
p4=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("housing_tenure")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="d")
p5=top_line_charts[["density"]]
```


```{r}
top_line_group <- c("simplified_utility_type")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="f")
p6=top_line_charts[["density"]]
```


```{r}
# "pop_hispanic"                               
# [35] "pop_african_american"                        "pop_asian"                                  
# [37] "pop_native_american"                         "pop_caucasian" 
# "pop_total"

minority_races <- c("hispanic","african_american","asian","native_american")
races <- c(minority_races,"caucasian")

pct_races <- replica_sup[,paste0("pop_",races)] / rowSums(replica_sup[,paste0("pop_",races)])
names(pct_races) <- paste0("pct_",races)

plurality_race <- races[max.col(pct_races,ties.method = "first")]

plurality_race <- ifelse(plurality_race=="african_american","black",
                                   ifelse(plurality_race=="native_american","indian",
                                          ifelse(plurality_race=="caucasian","white",
                                          plurality_race)))

race_data <- data.frame("geoid"=replica_sup$geoid,
                        "race"=plurality_race)

top_line_group <- c("race")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(race_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="e")
p7=top_line_charts[["density"]]
```

```{r}
# "pop25_some_college_plus"                     "pop25_high_school"                          
# [41] "pop25_no_high_school"
# "pop_total"

# minority_races <- c("african_american","hispanic","asian","native_american")
# races <- c(minority_races,"caucasian")

education_levels <- c("some_college_plus","high_school", "no_high_school")

pct_education_levels <- replica_sup[,paste0("pop25_",education_levels)] / 
  rowSums(replica_sup[,paste0("pop25_",education_levels)])
names(pct_education_levels) <- paste0("pct_",education_levels)

plurality_education_level <- education_levels[max.col(pct_education_levels,ties.method = "first")]

plurality_education_level <- ifelse(plurality_education_level %in% 
                                      c("high_school","no_high_school"),
                                    "high school or less",
                                    ifelse(plurality_education_level=="some_college_plus",
                                           "college or more",
                                          plurality_education_level))

education_data <- data.frame("geoid"=replica_sup$geoid,
                        "simplified_education"=plurality_education_level)


top_line_group <- c("simplified_education")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(education_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="f")
p8=top_line_charts[["density"]]
```

```{r}
# "climate_zone"                               
# [75] "climate_zone_description"

simplified_climate <- ifelse(replica_sup$climate_zone_description %in% c("Hot","Very Hot"), "Hot",
                             ifelse(replica_sup$climate_zone_description %in% c("Cold",
                                                                                "Very Cold",
                                                                                "Subarctic"),"Cold","Moderate")
                             )

climate_data <- data.frame("geoid"=replica_sup$geoid,
                           "simplified_climate"=simplified_climate)

top_line_group <- c("simplified_climate")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(climate_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="i")
p9=top_line_charts[["density"]]
```



```{r density-charts, include=TRUE, results='asis', fig.cap=density_charts_fig_cap}

density_charts_fig_cap <- "The distribution of net energy returns across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure b shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure c shows the difference among groups of households identified by their primary heating fuel. Subfigure d shows the difference based on whether they are renters or owners. Subfigure e shows the difference based on the most prominent race in the census tract of each cohort. Subfigure f shows the difference based on the most prominent education history in the census tract of each cohort."

grid.arrange(p1,
             p2,
             p3,
             # p4,
             p5,
             # p6,
             p7,
             p8,
             # p9, 
             nrow=2,
             # top=chart_title,
             # subtitle
             bottom="Proportion of Households",
             left=paste0("Net Energy Return (",metric_label,")"))

# multi_plot <- cowplot::plot_grid(p1,p2,p3,p4,p5,p6,p7,p8,p9,
#                    nrow=3, align="none",rel_heights = c(2,2,2))
# 
# #create common x and y labels
# 
# y.grob <- textGrob(paste0(str_to_upper(metric_name)," (",metric_label,")"), 
#                    gp=gpar(fontface="bold", col="black", fontsize=12), rot=90)
# 
# x.grob <- textGrob("Proportion of Households", 
#                    gp=gpar(fontface="bold", col="black", fontsize=12))
# 
# #add to plot
# 
# grid.arrange(arrangeGrob(multi_plot, left = y.grob, bottom = x.grob))
```

From this high level, we can see in Figure \@ref(fig:density-charts) that approximately `r scales::percent(energy_poverty_rate, accuracy=1)` of households in the United States experience energy poverty. Displaying by those communities defined by their relationship to the Federal Poverty line provides a stark picture. While `r scales::percent(in_both_poverty, accuracy=1)` of households below the federal poverty line also face energy poverty, fewer than `r scales::percent(in_only_energy_poverty, accuracy=0.01)` of those above the federal poverty line face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap. When we break the group of relatively prosperous households into subsets, we find that `r scales::percent(as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","households_below_cutoff"])/as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","household_count"]),accuracy=1)` of households living at 30-80% of their Area Median Income are experiencing energy poverty. This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in net energy return on the households’ energy investments is surprising.

Examining these dynamics by the status of homeownership reveals further disparities. Though renters and homeowners are similarly distributed below the energy poverty line, there appears to be a clear advantage of homeownership from a net energy perspective for most of the population. Only at a relatively high return on investment do renters seem to have a net energy advantage, presumably due to these tenants living in relatively new and efficient urban rentals. Tenure matters for more than just equity itself: renters are less likely to take actions to improve their net energy returns due to a lack of property rights and misaligned incentives (the principal-agent issue). Even when action is taken to improve the energy efficiency of a rental building, tenants are less likely to see any economic benefits from it.

Households with solar as a primary heating fuel have a higher net energy income ratio than those with other fuel sources, except for households far below the energy poverty line. Why are solar households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households' low consumption, meaning that the potential savings from installing a renewable energy system are lower than for high-income households.

```{r eval=FALSE}
weighted_medians <- clean_data %>%
   group_by(housing_tenure) %>% 
   summarise(median_electricity_spend = if( sum(!is.na(households))<3 ){NA} else { weighted.median(electricity_spend, households, na.rm=TRUE)},
             median_eroi = if( sum(!is.na(households))<3 ){NA} else { weighted.median(mean_eroi, households, na.rm=TRUE)},
            median_income = if( sum(!is.na(households))<3 ){NA} else { weighted.median(annual_income, households, na.rm=TRUE)},
            median_electricity_price = if( sum(!is.na(households))<3 ){NA} else { weighted.median(implied_price_kWh, households, na.rm=TRUE)},
            median_electricity_use = if( sum(!is.na(households))<3 ){NA} else { weighted.median(implied_electricity_use, households, na.rm=TRUE)},
            median_energy_burden = if( sum(!is.na(households))<3 ){NA} else { weighted.median(mean_energy_burden, households, na.rm=TRUE)},
            median_energy_cost = if( sum(!is.na(households))<3 ){NA} else { weighted.median(mean_energy_cost, households, na.rm=TRUE)}
            )
```


```{r eval=FALSE}
gwm <- grouped_weighted_metrics(graph_data=graph_data, 
                                  group_columns=group_columns, 
                                  metric_name=metric_name, 
                                  metric_cutoff_level=metric_cutoff_level, 
                                  upper_quantile_view=upper_quantile_view, 
                                  lower_quantile_view=lower_quantile_view)
gwm <- gwm %>% {if(!is.null(group_columns)) unite(., "group_name", all_of(group_columns), remove=FALSE, sep="+", na.rm=FALSE) else (mutate(., group_name="all"))}

mean_eroi <- graph_data %>%
  ggplot(aes_string(x=metric_name, 
             weight="group_household_weights", 
             fill="group_name", 
             color="group_name")) + 
  geom_density(alpha=0.1) + 
  ggtitle("Household Energy Return on Investment By Utility Ownership Type") + 
  scale_x_continuous(labels = scales::unit_format(unit = "x", scale = 1, accuracy = 1),
                     breaks=seq(from=0,to=100,by=10), 
                     minor_breaks=seq(from=0,to=100,by=1),
                     limits=c(0,100), name="Household Energy Return on Investment\n(Income Earned for each Dollar Spent on Energy)") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.05), name="Proportion of Households") + 
  theme_minimal() + 
  theme(legend.justification = c(1, 1), legend.position = c(1, 1), legend.title=element_blank()) + 
  geom_vline(data=gwm, aes(xintercept=metric_median,  color=group_name),
               linetype="solid", size=0.5, alpha=0.75) + 
  geom_vline(xintercept = 10, linetype="dotted", 
                color = "red", size=1.0, alpha=0.75)

mean_eroi + annotate("text", x = 10, y = 0.0075/3, angle = 90, color="red", label = "Energy Poverty Line", 
    vjust = -0.5, parse = FALSE, alpha=0.75) + 
  annotate("text", x = min(weighted_medians$median_eroi), y = 0.005/3, angle = 90, color="gray25", label = "Median", 
    vjust = -0.5, parse = FALSE, alpha=0.75)
```


```{r eval=FALSE}
independent_variable <- "replica_mwh"
electricity_v_eroi_contour_plot <- graph_data %>% 
  ggplot(aes_string(x=independent_variable,
                    y=metric_name,
             weight="group_household_weights", 
             fill="group_name", 
             color="group_name")) +
  stat_density_2d(aes(alpha = ..piece..), geom="polygon", na.rm=TRUE) +
  guides(alpha = FALSE) +
  stat_smooth(method = "lm", fullrange = TRUE) +
  # geom_rug() + 
  scale_x_continuous(name = "Monthly Electricity Cost", 
                     labels = scales::dollar_format(),
                     limits = c(0, 1000), expand = c(0, 0)) + 
  scale_y_continuous(name = "EROI", 
                     labels = scales::unit_format(unit = "x", scale = 1, accuracy = 1),
                     limits = c(0, 100), expand = c(0, 0)) + 
  theme_pubr() + #   theme(plot.margin = margin()) + 
  theme(legend.position = "bottom")
electricity_v_eroi_contour_plot
```


```{r eval=FALSE}
electricity_spend + theme_void() + theme(legend.position = "none") + labs(title = NULL, x=NULL, y=NULL) + 
  ggtitle("Monthly Electricity Cost vs. EROI") + 
  plot_spacer() + 
  electricity_v_eroi_contour_plot + theme(legend.justification = c(1, 1), legend.position = c(1, 1), legend.title=element_blank()) + 
  mean_eroi + coord_flip() + theme_void() + theme(legend.position = "none") + labs(title = NULL, x=NULL, y=NULL) + 
  plot_layout(ncol = 2, nrow = 2, widths = c(4, 1), heights = c(1, 4))
```


```{r eval=FALSE}
# Monthly Electricity Expenditures
electricity_spend <- clean_data %>%
  ggplot(aes(x=electricity_spend, weight=ownership_type_household_weights/3, fill=ownership_type, color=ownership_type)) + 
  geom_density(alpha=0.1) + 
  ggtitle("Household Monthly Electricity Spending By Utility Ownership Type") + 
  scale_x_continuous(labels = scales::dollar_format(), limits=c(0,300), name="Energy Spend",
                     breaks=seq(from=0,to=300,by=50), 
                     minor_breaks=seq(from=0,to=300,by=10)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.0005), name="Proportion of Households") + 
  theme_minimal() + 
  theme(legend.justification = c(1, 1), legend.position = c(1, 1), legend.title=element_blank()) + 
  geom_vline(data=weighted_medians, aes(xintercept=median_electricity_spend,  color=ownership_type),
               linetype="solid", size=0.5, alpha=0.75)

electricity_spend + annotate("text", x = min(weighted_medians$median_electricity_spend), y = 0.0025/3, angle = 90, color="gray25", label = "Median",vjust = -0.5, parse = FALSE, alpha=0.75)
```



```{r eval=FALSE}
s1 <- scatter_chart(graph_data, 
                          metric_name, 
                          metric_label,
                          group_columns, 
                          metric_cutoff_level, 
                          metric_cutoff_label, 
                          chart_title, 
                          chart_subtitle,
                          independent_variable="group_households")
s1
```


```{r eval=FALSE}
# Compare maps of energy burden vs. solar rooftop potential
```

```{r eval=FALSE}
From an equity perspective, the Gini coefficient of net energy returns among US households is `r print("X")`. This means that the net energy returns are distributed `r print("Y")` by household compared to a uniform distribution. Even this perspective is limited given that we would expect the productivity of energy usage by each household would be similar, even if the absolute values of energy consumption vary. In other words: there is no reason that net energy returns should differ among households at all.
```

```{r}
group_columns <- c("state_abbr")
# utility type? see chartbook
graph_data <- filter_graph_data(clean_data=clean_data_ami[clean_data_ami$state_abbr!="DC",], 
                                group_columns=group_columns, 
                                metric_name=metric_name)
```

```{r}
# percent of "other" fuel expenditures toward fossil fuel combustion
# want to make this more precise by state, county, and/or balancing authority eventually
other_gwm <- grouped_weighted_metrics(clean_data_fpl[clean_data_fpl$state_abbr!="DC",], 
                                      c("primary_heating_fuel"),
                                      "other_spend",
                                      0)

other_fuels <- c("COAL","FUEL OIL","NONE","OTHER","SOLAR","WOOD","BOTTLED GAS")
non_fossil_other_fuels <- c("NONE","SOLAR","WOOD")
fossil_other_fuels <- other_fuels[!(other_fuels %in% non_fossil_other_fuels)]

other_fossil <- other_gwm[other_gwm$primary_heating_fuel %in% fossil_other_fuels,
                              c("household_count","metric_mean")]

pct_other_fossil <- sum(other_fossil$household_count*other_fossil$metric_mean)/
  sum(other_gwm$household_count*other_gwm$metric_mean)

graph_data$pct_other_fossil <- pct_other_fossil
```

```{r}
# percent of each state's electric grid decidated to fossil fuel combustion
# can refine by balancing authority based on REPLICA dataset
egrid <- get_state_egrid()

egrid$pct_electricity_fossil <- egrid$STCLPR + #coal
  egrid$STOLPR + #oil
  egrid$STGSPR + #gas
  egrid$STOFPR #+ #other fossil
  # egrid$STNCPR #+ #nuclear
  # egrid$STHYPR #+ #hydro
  # egrid$STOPPR #unknown/purchased

graph_data <- left_join(graph_data, egrid, by=c("state_fips"="FIPSST"))

# graph_data <- graph_data[graph_data$state_abbr!="DC",]
```

```{r}
# percent of natural gas expenditures dedicateed to fossil fuel combustion...
pct_gas_fossil <- 1.0

graph_data$pct_gas_fossil <- pct_gas_fossil
```


```{r}
graph_data$pct_fossil_tract <- (graph_data$pct_gas_fossil * graph_data$gas_spend + 
  graph_data$pct_electricity_fossil * graph_data$electricity_spend + 
  graph_data$pct_other_fossil * graph_data$other_spend) / 
  (graph_data$gas_spend + graph_data$electricity_spend + graph_data$other_spend)


pct_fossil_gwm <- grouped_weighted_metrics(graph_data, "state_fips","pct_fossil_tract",0) %>% 
  dplyr::rename(pct_fossil=metric_mean)

graph_data <- left_join(graph_data, 
                        pct_fossil_gwm[,c("state_fips","pct_fossil")], 
                        by="state_fips")
```



```{r state-violin, include=TRUE, eval=TRUE, results='asis', fig.cap=state_violin_fig_cap}

state_violin_fig_cap <- "A comparison of net energy returns among each state in the United States. The bars are sorted by median household NER and represent the interquartile range (25%-75% percentiles) of household NERs colored by the percent of household energy expenditures in each state that go to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's eGRID dataset for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users."
# violin plot
y <- make_violin_chart(graph_data=graph_data,
                      group_columns=group_columns,
                      metric_name=metric_name,
                      metric_label=metric_label,
                      metric_cutoff_level=metric_cutoff_level,
                      fill_metric="pct_fossil",#"STCYPR",#"STSOPR",
                      fill_label="% of Energy Expenditures on \nFossil Fuel Combustion",#Combustion",#Solar",
                      group_name="State",
                      x_label="Net Energy Return ($ of net income per $ of energy expenditure)")
print(y)
```

Assessing the Net Energy Return metric among different states in Figure \@ref(fig:state-violin) presents a counterintuitive picture of how states address energy poverty and energy equity. 

The nature of the metric is that it can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as Connecticut and Vermont, where higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi and Alabama, which have significant low-income populations. Not only are households falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood will suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on new metrics.

Although they are the states with the highest NER (California and Colorado) are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely, this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation in states such as California, Colorado, Hawaii, and Washington are a common thread, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure \@ref(fig:state-violin) shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high net energy returns than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.

```{r}
group_variable <- "eia_id"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(left_join(clean_data_ami, replica_sup, by=c("geoid")), group_columns, metric_name)

util_group <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)

member_minumum <- 10000
lowest_ner_utility <- filter(arrange(util_group,metric_mean),household_count>=member_minumum)[1,]

unique_utils <- distinct(replica_sup[c("eia_id","company_na","state_name","dlrs_kwh")])

lowest_ner_utility_specs <- filter(unique_utils,eia_id==as.numeric(lowest_ner_utility["eia_id"]))

lowest_ner_utility_name <- lowest_ner_utility_specs$company_na
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Corp","Corporation")
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Member","Membership")
```

#### Discussion  {#discussion}

Net energy returns are different among different groups of households in America. These striking disparities suggest the existence of deeply structural barriers to prosperity in American society, ones which may not be alleviated and may even be exacerbated by electrification and the transition to clean fuels. How can our energy system be operated and improved to provide equitable access? Are there ways that clean electrification can be used to better benefit currently underserved communities?

A sensible prior hypothesis is that everyone experiences the same efficiency from the energy system as measured by return on energy investment. The marginal unit of energy consumed by one household should lead to as much benefit for that household as any other. Differences in absolute outcomes may be related to the quantity of energy investment. However, here we see that system efficiency is different for different households on a relative basis. This difference is often correlated to factors out of the households’ control and even those related to persistent social inequalities. High burdens may be associated with intermittent grid access when extreme weather events interrupt energy supply chains. The same households are often at greater risk of energy service disconnection due to non-payment. Re-connection fees can compound to increase burdens in ways not captured by our analysis.

Energy is central to equity and economic prosperity, but the odds are stacked against many people. The energy system appears to be regressive in that costs accrue disproportionately to those of lower-income levels and the most energy-efficient homes belong to wealthier families. As a result, there has been a disparity in how the benefits of the energy transition are accruing among socioeconomic groups [@vaishnavWasItWorthwhile2017]. There is the potential for further division if appropriate policies are not implemented[@cullenwardDynamicallyEstimatingDistributional2016]. Typically, households using solar are higher-income with access to upfront capital to invest in new technology. When they do so, their NER increases as a result of decreasing their energy expenditures. This creates a disparity between those with access to renewable energy and those reliant on fossil-fuel-based energy sources, which does not have to be the case. A more comprehensive approach to poverty alleviation in the US would also consider the energy situation of each household and the options available to improve its efficiency. Then, it would make those options accessible to the stakeholders who could benefit.

Instead, a negative feedback loop results: in-home combustion of biofuels and hydrocarbons is a significant source of air pollution and exacerbates other household costs like healthcare and maintenance. High energy burdens have already been linked to local and global air pollution, and we can connect these impacts directly to the full scope of household prosperity via net energy. Energy is essential to deal with other inequities in society. There must be a way to design a structure that addresses this disparity more equitably. While well-intended programs such as PACE or solar loans have reached few people, community-oriented programs focusing on peer-mentorship could improve programmatic outcomes. Building support for community-led programs can also reduce the burden on individuals to expand access to the benefits of solar and efficiency. A more in-depth examination of the energy system’s underlying regulatory structures and robust assessments of energy burden could provide a path forward and track how the benefits of the energy transition are being accrued through such programs.

The vastness of the modern electric grid eludes affordability for everyday households because of the relationships between the utility companies and the users. Secondary energy is unique among residential consumption categories because a single service provider is usually the authority for determining energy costs for each of its customers. In vertically integrated energy markets, the monopoly utility is the only option available to all consumers. In restructured energy markets, the public utility is designated as the last resort provider for those unable or unwilling to participate in the competitive procurement of energy. Pachauri et al.[@pachauriAdvancingEnergyPoverty2020] distinguish between affordability and cost of supply, implying that more focus should be applied toward how energy burdens vary among customers of different energy suppliers than on how per-unit costs of energy vary. For instance, `r lowest_ner_utility_name` is the electric utility with more than `r to_big(member_minumum)` customers whose members have the lowest average net energy return (`r to_big(lowest_ner_utility$metric_mean)`). At the same time, the per-unit cost of electricity in this service territory is only more expensive than `r to_percent(ecdf(unique_utils$dlrs_kwh)(lowest_ner_utility_specs$dlrs_kwh))` of utilities at `r to_dollar(lowest_ner_utility_specs$dlrs_kwh)`/kWh. In some markets, specialized rates or programs are available for Low and Moderate Income (LMI) consumers, who may have higher energy burdens. We find it notable that more than half of all funding to address high energy burdens in the US is from utility ratepayer-funded bill and energy efficiency assistance[@rossHighCostEnergy2018].

In addition to these relatively local measures, the Low Income Home Energy Assistance Program (LIHEAP) and the Weatherization Assistance Program (WAP) seek to address aspects of energy poverty through bill payment assistance and energy efficiency measures. The efficacy of these programs has been mixed in addressing distributional equity in energy burdens and receiving benefits from energy efficiency programs. The COVID-19 pandemic and associated economic downturn may be a critical opportunity to provide relief payments related to energy expenditures and to invest in more efficient residential[@RecoveringFastSlow2020a] and commercial energy infrastructure that enables newer and cleaner systems[@chapmanImpactsCOVID19Transitioning2020]. US households are already spending excessive amounts on energy, especially with more families staying at home for longer periods of time. The ongoing crisis offers a chance to address the lack of infrastructure and employment opportunities with a focus on residential energy burdens[@graffCOVID19AssistanceNeeds2020a].

Even for energy assistance programs that do exist, many households reliant on inefficient fuels such as kerosene for heating must pay upfront costs to fill a tank for the winter season. These subsidy programs are largely ineffective as the cost of kerosene can be expensive, and pressure remains on households to offset existing gaps. Better opportunities to convert to alternative fuels would also provide households the opportunity to take advantage of the efficiency gains in better technology. In this way, broader programs need to be designed to provide households more options.

This relevance especially holds for electricity because it is a commodity delivered via a stationary, centralized grid system. Even in organized markets, local utilities retain control of the transmission and distribution systems. Households retain little control over their own energy choices. Consumers are price takers with relatively inelastic demand. Changes in the unit price of energy or slight differences in consumption patterns matter more to those with low incomes than those with higher incomes. Furthermore, the current lack of storage infrastructure on the grid and behind each meter means that households are bound to electricity providers for the time of use. The "forward-looking" or "reactive" tendencies of these public electric utilities have implications for the energy transition in their jurisdictions and beyond[@wolakFutureElectricityRetailing2020].

#### Conclusion  {#conclusion}

Policymakers have not systematically deployed interventions based on net energy analysis across American households. Creating a federal energy poverty line would be a critical step in identifying families that face large disparities in access to affordable electricity and energy in the United States and improve programs’ abilities to address energy burdens. A toolkit based on this analysis enables neighborhood-level outreach where energy burdens are highest.  

Furthermore, this type of dataset can identify opportunities where households could benefit from emerging technologies that have disproportionately benefited wealthy families. We demonstrate that owning a home and consuming solar power is associated with increased income multipliers for energy expenditures. This advantage leads to gains that are not being realized by many neglected or oppressed communities. 

Energy burden also overlaps with health disparities and environmental justice efforts. Households living in more poverty and closer proximity to highly polluted areas must consume more energy to overcome the particulate emissions. There are clear, mutually synergistic, positive reinforcement mechanisms to alleviate health and environmental disparities in air pollution exposure by reducing household energy burdens and improving economic mobility across low-income households. 

Net energy income is holding back socioeconomic mobility in the US Renters of multi-family apartments earn half as much as owners of single-family homes when normalized by energy expenditures.`r to_insert="[Add more with demographic data once have queries for this: e.g., Households in communities of color experience energy poverty at ?x the average rate]. "` The inherent benefits of solar electricity must be accessible to all populations in the United States to promote sustainability, but barriers such as high capital investment, lack of financing, and inability to take advantage of existing business models continue to hold back communities of color from receiving a similar benefit to white and wealthier households. Net energy metrics exhibit this income multiplier effect and the resulting divide. Designing solar policies to benefit those facing low net energy ratios will substantially improve net energy income ratios and raise households out of energy poverty in the United States. 

However, concerted attention to technology and policy details matter to implement a national scheme. The data demonstrate a need for quantitative methodologies to support equitable energy infrastructure investments. 

## Methods  {#methods}

#### Data  {#data}
To estimate the Net Energy Income Ratio of American households, we primarily utilize the Low Income Energy Affordability Data (LEAD)[@maLowIncomeEnergyAffordability2019] and Rooftop Energy Potential of Low-Income Communities in America (REPLICA)[@sigrinRooftopSolarTechnical2018] datasets, which the US Department of Energy assembled to help “stakeholders make data-driven decisions on energy goal setting and program planning by providing them information on low-income household populations and associated energy use characteristics”[@maLowIncomeEnergyAffordability2019]. These datasets encompass estimates of household energy consumption, income, solar generation potential, and demographic characteristic for all states and most territories in the United States at the census tract scale.  

LEAD: The Low-Income Energy Affordability Data (LEAD) portrays the average income, electricity expenditures, gas expenditures, and other fuel expenditures for cohorts of households segmented by location (census tract, county, state) and household characteristics (whether the unit is rented or owned, the building’s year of first construction, the number of units in the building, whether the units are attached, and the unit’s primary heating fuel type). The dataset is assembled by applying an iterative proportional fitting (IPF) algorithm to cross-tabulations of household responses from the 2016 5-year American Community Survey (conducted by the US Census Bureau), which provides the samples for each cohort as Public Use Microdata Samples. IPF is a widely used spatial microsimulation method to allocate individuals (i.e., households) to zones (i.e., census tracts and utility service territories) while calibrating each zone's characteristics to known quantities. Using IPF, the microdata samples are scaled to match aggregate annual values from utility sales and revenues reported in Energy Information Administration forms 861 and 176.

REPLICA: The Renewable Energy Potential of Low-Income Communities in America (REPLICA) dataset adds the technical potential of rooftop solar and additional techno-economic variables (e.g., demographics and electricity rates) used in the ultimate analysis[@sigrinRooftopSolarTechnical2018]. 

eGRID: We use the Environmental Protection Agency's (EPA) Emissions & Generation Resource Integrated Database (eGRID)[@usepaEmissionsGenerationResource2020] to calculate the proportion of household energy expenditures that support fossil fuel combustion through the purchase of electricity. 100% of natural gas purchases are considered to support fossil fuel combustion. Electricity purchases are divided into their respective sources according to the state proportions indicated by the "STCLPR" (coal), "STOLPR" (oil), "STGSPR" (gas), and "STOFPR" (other fossil) fields in the 2018 eGRID dataset. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately `r scales::percent(pct_other_fossil, accuracy=1)` fossil fuel combustion.

#### Treatment  {#treatment}
The LEAD data represents the unit’s ownership status (OWNER vs. RENTER) and income bracket as a fraction of Area Median Income (0-30%, 30-60%, 60-80%, 80-100%, or 100%+) or Federal Poverty Level (0-100%, 100-150%, etc.). These categorical variables are saved as factors. Then we create min_units from BLD INDEX. The variable BLD INDEX represents a non-uniformly distributed set of buckets for the range of the number of units in the building, and whether single-unit households are attached or detached from neighboring households. We extract the minimum number of units from the range and whether the building is detached. Those households labeled OTHER UNIT are given values of Not Applicable (NA) for this characteristic. Finally, we create Energy Burden Indicators by creating the metrics s & g of which each indicator is composed: 

s = annual expenditures on electricity (ELEP CAL) + natural gas (GASP CAL) + and other fuels (FULP)  

g = the cohort’s average annual income (HINCP) 

The metric formulas outlined in Section \ref{ratios} are then used to calculate each cohort’s energy poverty metrics. Since we are examining homes’ relationships with the energy system, we ignore any homes that do not use energy as denoted by rows where s==0. The estimation procedure used by the DOE results in an estimated number of occupied housing units meeting the subset characteristics (UNITS, renamed as households). It displays the number of American Community Survey responses that contribute to the estimate of energy expenditures (COUNT, renamed as acs_responses). We then remove any categories with fewer than 1 unit represented since this is not physically possible. `r removed_households = "This results in removing X% of the available rows (gross: X rows of X). This is a total of X housing units or X% of the estimated total X units in the sample. We have separated any cohorts with incomes or energy costs equal to 0 into another dataset for analysis. This represents approximately X% of the housing units and X% of the examined cohorts, so it will be important to make sure that this subset does not contain systematic bias. However, these data are excluded from the current analysis under the assumption that energy costs equal to 0 are not relevant to this analysis."`

We then combine this dataset with the REPLICA dataset. To do so, we must aggregate the income levels of the LEAD dataset to the simpler schema used by REPLICA for summarizing households’ income relative to the area’s median income (AMI):

- 0-30% AMI: Very Low Income
- 30-80% AMI: Low-to-Moderate Income
- \>=80% AMI: Middle-to-High Income

Also, we create an indicator of whether a particular cohort is in income poverty as defined by the relevant standards for its characteristics. For the AMI data, this is defined as being “Very Low Income” or <=30% of AMI. For the Federal Poverty Line (FPL) version of the LEAD dataset, we translate directly from the designation of the income bracket as follows:

- 0-100% FPL: In Poverty
- \>= 100% FPL: Not In Poverty

The REPLICA dataset also simplifies any households with only one unit per building into “Single Family” homes and any households with more than one unit per building as “Multi-family.” Non-stationary and non-traditional homes are not included in the REPLICA analysis. We match these simplifications in the LEAD dataset by aggregating by the number of units:

- 1 Unit: Single-Family
- \>1 Unit: Multi-Family
- Other Unit: NA (excluded from analysis)

After simplifying these characteristics in the LEAD Area Median Income data, we merge the AMI dataset with the REPLICA dataset along the census tract, simplified income bracket, simplified number of units, and housing tenure to achieve the primary dataset used in the analysis. Merging with the REPLICA dataset provides additional demographic and geospatial data not available in the LEAD dataset only[@sigrinRooftopSolarTechnical2018] (See Appendix for a full table of the available variables from each dataset). Characteristics such as the utility type and locale description are sourced from REPLICA and unavailable in LEAD. Similarly, the REPLICA dataset contains only electrical expenditure estimates without natural gas or other fuel costs to households and could not be used to perform this analysis alone.

The FPL dataset The FPL version of the LEAD dataset is not merged with all of the REPLICA data because of incompatibility between the poverty line and area median income bracket definitions. However, demographic data associated with each census tract as a whole can be merged with the FPL dataset. Both AMI and FPL datasets are combined with demographic data from the REPLICA dataset and geospatial shapefiles from the Census to produce the final datasets used in the analysis.

#### Considerations  {#considerations}
Iterative proportional fitting has limitations as an estimation procedure that constrain the strength of conclusions that can be drawn from the simulated LEAD and REPLICA datasets. The relationship between constraint variables such as total energy spending by utility service territory and number of households per census tract will tend toward the average of the initializing dataset and depress variations among otherwise similar regions. This may explain the large quantities of households that are estimated to have very low incomes. Validating these estimated data would require randomized surveys of households along the dimensions of interest.


The meaning of the “primary heating fuel” category comes from the answer to the question “Which fuel is used most for heating this house, apartment, or mobile home?” on the American Community Survey. This question’s power to predict energy expenditures or fuel sources is unknown, and further analysis is required to understand the implications of this survey question for drawing broader conclusions about household energy use. However, the US Census Bureau has been asking this question since 1940. It states that these data are collected to help communities "provide assistance with utilities", "estimate future energy demand", and "measure environmental impacts"[@bureauWhyWeAsk].

Though the REPLICA dataset relies on a different vintage of the LEAD dataset (assembled in 2017[@sigrinRooftopSolarTechnical2018]) than this analysis (assembled in 2019[@maLowIncomeEnergyAffordability2019]), inferring differences among annual estimates is not meaningful due to the standard error of the data [@maLowIncomeEnergyAffordability2019]. A rigorous treatment of these metrics over time is an area for future research.

The results inferred from eGRID are only as good as the eGRID methodology itself. We choose to outline the proportion of combusted fuels rather than emissions data due to the limitations outlined by proponents of marginal emissions attribution in electric power system models[@vonwaldAnalyzingCaliforniaFramework2020] [@siler-evansMarginalEmissionsFactors2012] and limitations in estimating regional electricity transfers[@vonwaldAccountingGreenhouseGas2021].

Expanding quantitative analysis of energy affordability can offer additional context, including the use of ratios to identify populations that could be particularly vulnerable to energy shocks or absolute energy burdens. Developing such metrics can elucidate the scale on which American households must save for energy consumption. Frequently used metrics in this category do not tell the whole story. For instance, the simple proportion of a household’s income spent on energy bills (a.k.a. energy burden) does not capture the underlying monthly cash flow patterns that may stress household budgets. More significantly, a simple proportion does not account for the fact that money spent on energy cannot be spent elsewhere and is therefore not useful income to the household for the purposes of measuring prosperity. Including gross income in the energy burden metric has the effect of depressing the average energy burden, by definition.

Furthermore, because energy expenditures are a small proportion of even the most impoverished households' total income, energy burdens are almost always very small percentages (<10%). This leads to issues with interpretability in public discourse and policy settings and may even affect program outcomes that are based on this metric if these small numbers are rounded to even the nearest hundredth of a percent.  If the household is above an energy poverty line defined by such a metric for public policy purposes, the family may not receive critical support, or energy may be sidelined by other basic needs. Because such a small proportion of expenditures can impact different income groups so differently, ratios of this type can be a useful metric when separating across income quantiles or other categories - particularly for vulnerable populations where the absolute energy burden poses a significant difficulty or affordability threshold. However, energy burden is typically portrayed at a population scale (e.g., the average energy burden of the population is X%). Household metrics and surveys are important for further understanding of and policy development around issues of energy burden. Finally, presenting the relationship between household income and energy expenditures as a proportion with income in the denominator suggests that improvements can only be made by decreasing energy expenditures or increasing incomes. However, in reality, there is a positive relationship between energy expenditures and incomes because energy is an input in wealth-creating processes, and the unit costs of energy decrease as absolute consumption increases. Therefore, stakeholders relying solely on energy burden have limited knowledge of which historical interventions have effectively promoted the energy system's success and a limited ability to design new interventions to promote community growth and address inequity in the energy system.

Net energy analysis (NEA) offers potential support to understanding energy poverty through the use of formally defined Energy Return Ratios (ERR's) that articulate the relationship between the energy flows within complex systems[@carbajales-daleBetterCurrencyInvesting2014]. The implications of numerous metrics of systems-scale efficiency and net energy returns have been explored through this lens to date[@brandtGeneralMathematicalFramework2011] and are recommended as a framework for future analysis[@carbajales-daleBetterCurrencyInvesting2014]. This research's primary insight into the energy burden conversation is to treat the income remaining after energy expenditures (i.e., net income) as the focus of analysis to avoid the double-counting of energy expenditures. Furthermore, net income is a result of energy consumption rather than the inverse: households consume energy to unlock the utility that energy services provide to them as participants in society, whether to cook food or connect to the internet. This relationship is generally accepted when understanding individual household behavior[@thomasEstimatingDirectIndirect2013] and macro-economic effects of energy consumption[@saundersKhazzoomBrookesPostulateNeoclassical1992]. Therefore, a metric describing the efficiency of household wealth creation may be more intuitive with net income in the numerator. These insights are incorporated into the new metric presented in this article. A final significant insight from net energy analysis that should be incorporated into future work is that embodied energy takes many forms across the household budget (food, goods, services, housing, etc.), and these can all be compared using the same units of measure (e.g., joules).

## Code Availability {#code-availability}

The code and data to fully reproduce this paper are available on Github at **[redacted for anonymity - copies of data and code have been submitted as part of peer-review]** under the GNU Affero General Public License v3.0.


## Data Availability  {#data-availability}

All data necessary for the composition of the source datasets used in this analysis are freely available from United States government sources as open data. All functions to automatically retrieve and assemble these data, and compiled versions of these data are made available to the user as part of the software referred to in Section \ref{code-availability}.

## References  {#references}

::: {#refs}
:::

```{r eval=FALSE}
# # Works Not Yet Cited  {#uncited}
# 
# ---
# nocite: |
#   @*
# ...
# 
# # Software Used  {#software}
# 
# List of R packages used to be entered here automatically
# 
# # Acknowledgements  {#acknowledgements}
#
```

## Author Contributions  {#author-contributions}

X and Y conceived of and designed the project. X created the software used for data acquisition and analysis and created the figures. Y contributed the introduction of the topic and interpretation of the results.

## Competing Interests  {#competing-interests}

The authors declare no competing interests.


```{r eval=FALSE}
# 
# # Additional Information  {#additional-information}
# 
# # (APPENDIX) Appendix {-}  {#appendix}
# 
# # Charts for All Variables {#charts}
```

```{r eval=FALSE}
# ---Template / Style Examples After This---
# 
# # Introduction {#intro}
# 
# Your text comes here. Separate text sections with \cite{R-rmarkdown}. 
# 
# # Section title {#sec:1}
# 
# Text with citations by \cite{Galyardt14mmm}.
# 
# # References 1
# 
# 
# 
# ## Subsection title {#sec:2}
# 
# as required. Don't forget to give each section
# and subsection a unique label (see Sect. \ref{sec:1}).
# 
# #### Paragraph headings 
# 
# Use paragraph headings as needed.
# 
# \begin{align}
# a^2+b^2=c^2
# \end{align}
```

```{r, include = FALSE, eval=FALSE}
r_packages_used <- c("rmarkdown", "knitr")
knitr::write_bib(x = r_packages_used, file = "bibliography.bib")
```

```{r}
# 
# # Figure Legends
# 
# Figure \@ref(fig:metric-comparison) (`metric-comparison-1.pdf`): `r metric_comparison_fig_cap`
# 
# Figure \@ref(fig:continental-map) (`continental-map-1.pdf`): `r continental_map_fig_cap`
# 
# Figure \@ref(fig:inset-map) (`inset-map-1.pdf`): `r inset_map_fig_cap`
# 
# Figure \@ref(fig:density-charts) (`density-charts-1.pdf`): `r density_charts_fig_cap`
# 
# Figure \@ref(fig:state-violin) (`state-violin-1.pdf`): `r state_violin_fig_cap`
# 
# 
# # Tables
# 
# ```{r comparison-table-display, include=TRUE, results="asis"}
# final_table
# ```
```


```{r}
# merge data together
write.csv(x=clean_data_fpl,file="CohortData_FederalPovertyLine.csv")
write.csv(x=clean_data_ami,file="CohortData_AreaMedianIncome.csv")
write.csv(x=replica_sup,file="CensusTractData.csv")
# save as csv

```


<!--chapter:end:net_energy_equity_anonymized.Rmd-->

---
title: A measurement strategy to address disparities across household energy burdens
subtitle: 
titlerunning: Net Energy Equity
authorrunning: Scheier & Kittner
# thanks:
author:
 - Eric Scheier:
     institute: [emergi, e3p]
 - name: Noah Kittner
   email: kittner@unc.edu
   institute: [e3p, gillings, planning]
   correspondence: true
institute:
 - emergi: Emergi Foundation, Carrboro, NC, USA
 - e3p: Environment, Ecology, and Energy Program, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
 - gillings: Department of Environmental Sciences and Engineering, Gillings School of Global Public Health, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
 - planning: Department of City and Regional Planning, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
keywords:
  - energy burden
  - net energy
  - macro-energy systems
  - energy inequality
bibliography: references.bib
bibstyle: spphys
csl: nature-no-et-al.csl
journalname: Nature Energy
date: "`r format(Sys.time(), '%d %B %Y')`"
toc: false
output:
  bookdown::pdf_document2:
    number_sections: false
    keep_tex: true
    documentclass: article
    pandoc_args:
      - '--lua-filter=color-text.lua'
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
    includes:  
      in_header: preamble-latex.tex
  bookdown::html_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=color-text.lua'
  bookdown::word_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=color-text.lua'
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
  bookdown::pdf_book:
    base_format: rticles::springer_article
    keep_tex: true
tables: true
fig_caption: true
always_allow_html: true
header-includes:
- \usepackage{booktabs}
# - \usepackage[left]{lineno}
# - \linenumbers
- \usepackage{setspace}
- \usepackage{xcolor}
- \usepackage{mathtools}
- \usepackage[normalem]{ulem}
- \usepackage{float}
# - \doublespacing
- \usepackage{color}
- \usepackage{soul}
- \definecolor{lightblue}{rgb}{0.90, 0.95, 1}
- \definecolor{fancycolor}{rgb}{0.258, 0.517, 0.960}
- \sethlcolor{fancycolor}
- \usepackage{caption}
---

```{r setup, include=FALSE}
is_final=FALSE #TRUE
is_preview= TRUE #FALSE
is_draft= TRUE
set.seed(456)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','asis')),
                      fig.keep='all', #'last'
                      dev='cairo_pdf',#'pdf',
                      fig.show='hold',#'hide
                      # fig.pos = "!H",
                      # out.extra = "",
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=TRUE, #ifelse(is_draft, TRUE, ifelse(is_preview, TRUE, !is_final)),
                      cache.lazy=FALSE,
                      fig.margin=FALSE,
                      fig.fullwidth=TRUE, #FALSE
                      eval.after = "fig.cap"#,
                      # cache.path = 'net_energy_equity_cache/', 
                      # fig.path = 'net_energy_equity_files/'
                      )

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 
    "latex" else "pipe"
})

edit_color = "black" #"red" #"black
strike_show = "hide" #"show" #"hide"
hide = "FALSE" #"TRUE" #
highlight = "FALSE" #"TRUE" #"FALSE"
```

```{r option-view, include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)

# knitr::opts_current$get(c(
#   "cache",
#   "cache.path",
#   "cache.rebuild",
#   "dependson",
#   "autodep"
# ))

kable(knitr::opts_chunk$get() %>% enframe())
```


```{r sources, cache=FALSE}
source("sources.R")
```

```{r parameters}
states <- "all" #c("ca","nc","sc") #
refresh <- FALSE
acs_version <- 2018
energy_burden_poverty_line <- 0.06
# geographic_scope <- "tract" #statecitycounty
```

```{r run-methods, cache=TRUE}
paper_methods(states=states,
              acs_version=acs_version,
              energy_burden_poverty_line=energy_burden_poverty_line,
              refresh=refresh)
```


```{r preprocessing}
source("paper_source.R")
```

```{r}
# Things in here should probably be moved further up the data processing pipeline
# clean_data_ami$number_of_units <- as.factor(ifelse(clean_data_ami$min_units > 1, "mf", "sf"))
# clean_data_fpl$number_of_units <- as.factor(ifelse(clean_data_fpl$min_units > 1, "mf", "sf"))
```




\newpage

**Abstract: [Energy inequity is an issue of increasing urgency. Few policy-relevant datasets evaluate the energy burden of typical American households. Here, we develop a framework using Net Energy Analysis and household socioeconomic data to measure systematic energy inequity among critical groups that need policy attention. We find substantial instances of energy poverty in the United States -- `r scales::percent(energy_poverty_rate, accuracy=1)` of households experience energy poverty as presently defined as spending more than `r to_percent(energy_burden_poverty_line)` of household income on energy expenditures and more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` households above the Federal Poverty Line face energy poverty, disproportionately burdening Black, Hispanic, and Native American communities. For solar, wind, and energy efficiency to address socioeconomic mobility, programs must reduce energy expenditures by expanding eligibility requirements for support and access to improved conservation measures, efficiency upgrades, and distributed renewables. We recommend the United States develop a more inclusive federal energy poverty categorization that increases assistance for household energy costs.]{highlight=`r highlight`}**

## [Introduction]{highlight=`r highlight`}

Household energy use for services such as cooking[@mobarakLowDemandNontraditional2012] or space heating and cooling[@limaReviewRelationHousehold2020] is crucial for decent living conditions[@raoEnergyRequirementsDecent2019]. Unaffordable energy is a persistent trend[@brownPersistenceHighEnergy2020] that is negatively related to social cohesion, climate change responses, and disproportionate environmental impacts on low-income populations and minority groups [@carleyJusticeEquityImplications2020]. [Furthermore, e]{color=`r edit_color`}nergy inequity is not just a lack of money to meet basic energy needs - it is a lack of [access to the capabilities[@dayConceptualisingEnergyUse2016] that]{color=`r edit_color`} enable a sustainable and prosperous society built on just principles[[@sovacoolEnergyJusticeConceptual2015]]{color=`r edit_color`}. Energy inequity could have significant implications for navigating sustainable development and meeting societal goals around decarbonization and energy use. [In this study, we demonstrate the magnitude of energy inequity in the United States (US) using a metric informed by Net Energy Analysis (NEA). Without a set of inclusive indicators and data tools to examine energy inequity, many households that are at risk of energy poverty and injustice may remain unidentified. This analysis applies lessons from NEA to address energy poverty in the US.]{color=`r edit_color`}

[Many frameworks are currently being explored to understand energy poverty and equity, while differentiating between related concepts. In a thematic exploration of energy equity, Brown et al. identify energy access, energy poverty, energy insecurity, and energy burden as key concepts for understanding the issue[@brownLowincomeEnergyAffordability2020], but quantitative measurement of these concepts has been limited. Pachauri & Rao establish measures for the sustainable development context that incorporate periods when energy is available, the quality of voltage supplied, the reliability in terms of the number of disruptions, the capacity in terms of power available, the consumption levels allowed per day, and affordability of the standard consumption package as a percentage of household income[@pachauriAdvancingEnergyPoverty2020]. Energy metrics have been assessed quantitatively across several countries. Though some aspects, such as formal disconnections from energy service[@graffWhichHouseholdsAre2021], are translatable to the US context, these methods require normalizing many variables amongst different types of data and are overly broad for applications in areas where electricity access is relatively high and reliable.]{color=`r edit_color`}

[Of such areas, the United Kingdom (UK) has a richer history of incorporating energy poverty formally into its government programs: since 2000, the UK has used some form of an energy burden metric to assess whether households are facing energy poverty and determine the level of support that they require as a result[@bednarRecognitionResponseEnergy2020]. This metric has evolved from a simple ratio of household income and energy expenditures to one that incorporates building efficiency ratings and average incomes in the community. While the European Union (EU) currently lacks a unified metric for energy poverty, similar metrics have been developed in member countries, such as a metric which compares incomes and expenditures to local averages and absolute heating needs to determine energy poverty levels in Italy[@faiellaEnergyPovertyHow2021] or a multidimensional index of building quality and ability to pay bills in Poland[@sokolowskiMultidimensionalIndexMeasure2020].]{color=`r edit_color`}

Prior research of household prosperity in limited global jurisdictions [using these sorts of measures]{color=`r edit_color`} has found that gender, age, housing age[@rossHighCostEnergy2018], tenure type[@mayerTwoFacesEnergy2014], energy inefficiency[@drehoblUSLowIncomeEnergy2016], education, employment[@linAffordabilityAccessFocus2018], geography[@linDoesEnergyPoverty2020], socioeconomic status[@bednarIntersectionEnergyJustice2017], race/ethnicity[@tongMeasuringSocialEquity2021], and macroeconomic conditions[@kawaiSpendingHouseholdEnergy2021] are associated with high energy burdens in various geographical areas. [The US lags in part due to a lack of metrics and tracking, and this paper develops a tool to show how net energy is a valuable resource to evaluate energy burden and inequality.]{color=`r edit_color`}

In the US, energy inequity is a significant challenge as families struggle to meet monthly bills and live paycheck to paycheck[@bednarRecognitionResponseEnergy2020]. There is a growing disparity between wealthier and lower-income households based on their abilities to meet basic energy needs[@brownLowincomeEnergyAffordability2020]. While per-unit residential energy prices have increased below the rate of inflation in the [US]{color=`r edit_color`} since the 1980s[@unitedstatesenergyinformationadministrationShortTermEnergyOutlook2021], many households still struggle to make utility bill payments and are especially vulnerable to economic shocks[@kawaiSpendingHouseholdEnergy2021].

[Ross and Drehobl performed distinct urban[@drehoblUSLowIncomeEnergy2016] and rural[@rossHighCostEnergy2018] analyses to describe energy inequity in the US. While limited by geographic and demographic focus and a lack of peer-review, these studies have established the proportion of income (*G*) spent on energy expenditures (*S*), or energy burden (*E~b~*), as the standard benchmark for energy poverty in the US today (Equation 1).]{color=`r edit_color`} [The US Department of Energy (DOE) significantly improved upon Ross and Drehobl's underlying methodology by assembling its Low-Income Energy Affordability Dataset (LEAD)[@maLowIncomeEnergyAffordability2019], which estimates incomes and energy expenditures for most households in the US at a census tract scale.]{color=`r edit_color`}

\begin{align}
Energy\ Burden\ (E_{b})= \frac{S}{G}
\end{align}

[[Therefore, stakeholders relying solely on energy burden have limited knowledge of which historical interventions have effectively promoted the energy system's success and a limited ability to design new interventions to promote community growth and address inequity in the energy system. ]{strike=`r strike_show`}]{color=`r edit_color`}NEA offers potential support to understanding energy equity through the use of formally defined Energy Return Ratios (ERRs) like *E~b~* that articulate the relationships among energy flows within complex systems[[[@carbajales-daleBetterCurrencyInvesting2014]. The properties of numerous metrics have been explored through this lens to date]{strike=`r strike_show`}]{color=`r edit_color`}[@brandtGeneralMathematicalFramework2011]. Net Energy Return (NER), which describes the newly released potential to do work as a result of some activity, is recommended as a basis for future analysis[@carbajales-daleBetterCurrencyInvesting2014], especially in the study of macro-energy systems like the US residential housing stock[@leviMacroEnergySystemsNew2019]. [[Treating the income remaining after energy expenditures (i.e., net income) as the focus of analysis to avoid the double-counting of energy expenditures, and portray net income as a result of energy consumption rather than a cause.]{strike=`r strike_show`}]{color="red"}

Here, we examine the relationship between energy spending and household energy income and observe spatial disparities across a census-tract scale—particularly across race and ethnicity, income, housing tenure, and educational attainment. A difference of $500 in annual energy expenditures dramatically improves many middle and high-income households’ ability to enjoy benefits from energy services for low cost (2-5% of annual income), but basic energy expenditures comprise approximately 14% of annual earnings for low-income households. The categorizations for federal assistance programs that are based on poverty line indices fail to capture at least 5.3 million households that would benefit from energy support and assistance. Households in communities of color experience energy poverty at a rate 60% greater than those in white communities based on this study. Additionally, state-level analysis demonstrates wider spatial disparities across states such as Maine, where residential heating oil and fuelwood remain common heat energy sources and states such as Alabama and Mississippi which have among the lowest net energy returns on average. This empirical analysis fills a gap in the current discussion about energy equity by providing a framework to evaluate disparities and include more households in energy poverty metrics that are aligned with the assessment of energy flows through biological, physical, and economic systems.

## [Results]{highlight=`r highlight`}

#### Applying Net Energy Return to Energy Equity  {#ratios}

```{r metric-comparison-data}
eb_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% 
                                            mutate(energy_burden = round(100*energy_burden,digits=1)),
                                          group_columns = c("energy_burden","income_bracket"), 
                                          metric_name="net_income", 
                                          metric_cutoff_level = energy_burden_poverty_line) %>% 
  mutate(metric_name="Energy Burden (%)") %>% 
  rename(energy_metric=energy_burden) #%>% 
  # mutate(energy_metric=100*energy_metric)

ner_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% mutate(ner = round(ner,digits=0)), 
                                     group_columns = c("ner","income_bracket"), 
                                     metric_name="net_income", 
                                     metric_cutoff_level = ner_poverty_line) %>% 
  mutate(metric_name="Net Energy Return ($/$)") %>% rename(energy_metric=ner)

comparison_chart_data <- rbind(eb_chart_data,ner_chart_data)

metric_comparison_net_income_lbound <- -1000
metric_comparison_net_income_ubound <- 6*10^4
metric_comparison_x_axis_lbound <- -10
metric_comparison_x_axis_ubound <- 400
metric_comparison_pct <- sum(comparison_chart_data$household_count[
  comparison_chart_data$energy_metric <= metric_comparison_x_axis_ubound & 
    comparison_chart_data$energy_metric >= metric_comparison_x_axis_lbound & 
    comparison_chart_data$metric_mean <= metric_comparison_net_income_ubound & 
    comparison_chart_data$metric_mean >= metric_comparison_net_income_lbound & 
    !is.na(comparison_chart_data$metric_mean) & 
    is.finite(comparison_chart_data$metric_mean)]) / 
  sum(comparison_chart_data$household_count)

comparison_chart <- comparison_chart_data %>% 
  ggplot(aes(x=energy_metric, y=metric_mean, fill=income_bracket, color=income_bracket)) +
  # scale_x_continuous(trans=scales::pseudo_log_trans(base = 10)) +
  scale_y_continuous(labels=scales::dollar_format()) + 
  ggrastr::rasterise(geom_point(aes(size=household_count), 
                                alpha=0.25, 
                                position="jitter")) + 
  scale_fill_discrete(name="Income Bracket") + 
  scale_color_discrete(name="Income Bracket") + 
  scale_size_continuous(name="Households", labels=scales::label_comma()) + 
  # geom_hline(yintercept = .1) + 
  # geom_vline(xintercept = 9) + 
  # geom_smooth(method="lm",#NULL,#
  #             mapping=aes(weight=household_count),
  #             # formula=y~,
  #             se=FALSE,
  #             fullrange=TRUE,
  #             linetype="solid",
  #             alpha=0.75
  #             ) + 
  facet_grid(cols=vars(metric_name), switch="x", scales="free_x") +#, space="free_x") + 
  theme_bw() +
  labs(title = "Energy Burden and Net Energy Return in United States Households", 
       x="Energy Metric", 
       y="Household Annual Net Income ($)") + 
  theme(legend.position = c(.3,.6),
        legend.background = element_rect(fill = "#ffffffaa", colour = NA), 
        legend.key.size = unit(10, "points")#,
        # legend.justification = c(0, 0)
        )+
  coord_cartesian(#xlim=c(0,120),
               ylim=c(metric_comparison_net_income_lbound,
                      metric_comparison_net_income_ubound),
               xlim=c(metric_comparison_x_axis_lbound,
                      metric_comparison_x_axis_ubound),
               # default=FALSE,
               expand=TRUE)
```

[The main contribution of the study is the application of NER as an indicator of household energy poverty by utilizing a set of energy burden metrics based on NER to represent the disparity across those who face significant energy burdens in the US with those who do not. NER displays critical thresholds where more households face energy and income challenges.]{highlight=`r highlight`}

The [NER]{color=`r edit_color`} of a process is a relationship between the gross amount of energy extracted and the amount of embodied energy directed toward extraction[@brandtCalculatingSystemsscaleEnergy2013]. [For households extracting income from the economy, these ratios can be composed of gross income (*G*) and spending on energy (*S*)]{color=`r edit_color`}.

[Household NER (*N~h~*)]{color=`r edit_color`} represents the net earnings a household receives for every expenditure on secondary energy, defined according to Equation 2.

\begin{align}
Household\ Net\ Energy\ Return\ (N_{h}) = \frac{G - S}{S}
\end{align}

The NER is the standard metric of NEA because it reflects the role of energy as an input to a value-generating process in ecosystems[@brandtHowDoesEnergy2017]. *E~b~* is the metric of choice in the energy insecurity literature due to its [presumed]{color=`r edit_color`} interpretability as a percentage[@rossHighCostEnergy2018]^,^ [@bednarIntersectionEnergyJustice2017]^,^ [@drehoblUSLowIncomeEnergy2016]^,^ [@kawaiSpendingHouseholdEnergy2021]

While most [ERRs]{color=`r edit_color`}, including NER, are hyperbolic paraboloids, NER has several useful mathematical properties: it can smoothly handle systems with negative incomes and energy costs, accept households with zero income, and emphasize extreme incomes and energy costs in an interpretable fashion, as shown in Figure \@ref(fig:metric-comparison). [While *E~b~* appears inversely correlated to income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes (approximately n=`r to_big(round(clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum(),-3))` households in the dataset have *E~b~*>100% or *E~b~*<0%). Due to the structure of the *E~b~* equation (Equation 1), the *E~b~* of these households approaches infinity and cannot be captured on the standard 0-100% scale the metric is intended to be interpreted within: around `r to_big(round(clean_data_fpl$households[!is.finite(clean_data_fpl$energy_burden)] %>% sum(),-3))` homes have an infinite energy burden. Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. *N~h~* provides a framing of the same dataset that allows for exploration of most households on a similar scale without the long tail. *N~h~* appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing *N~h~* avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, *N~h~* offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent. Many households with moderate-to-high *E~b~*s are actually higher-income households with high energy expenditures, making their *N~h~*s quite high (e.g., >\$100 of income per \$1 of energy spending). Almost `r to_percent(metric_comparison_pct)` of the households in the dataset have net incomes between `r to_dollar(metric_comparison_net_income_lbound)` and `r to_dollar(metric_comparison_net_income_ubound)`, with *N~h~*s (or *E~b~*s) of between `r metric_comparison_x_axis_lbound` (`r to_percent(metric_comparison_x_axis_lbound/100)`) and `r metric_comparison_x_axis_ubound` (`r to_percent(metric_comparison_x_axis_ubound/100)`).]{color=`r edit_color`} Only households with no energy costs are excluded from the analysis, whereas households with no energy costs or incomes must be excluded from an analysis utilizing *E~b~*.

(ref:metric-comparison-fig-cap) Display of the relationship between [*E~b~*]{color=`r edit_color`} and [*N~h~*]{color=`r edit_color`} with net income (gross income - energy expenditures) for US households. While [*E~b~*]{color=`r edit_color`} appears inversely correlated to net income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the [*E~b~*]{color=`r edit_color`} equation (Equation 1), the [*E~b~*]{color=`r edit_color`} of these households approaches infinity [and cannot be captured on the standard 0-100% scale the metric is intended to be interpreted within]{color=`r edit_color`}. Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. [*N~h~*]{color=`r edit_color`} frames the same dataset on a scale without the long tail. [*N~h~*]{color=`r edit_color`} appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing [*N~h~*]{color=`r edit_color`} avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, [*N~h~*]{color=`r edit_color`} offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent: many households with moderate-to-high *E~b~*s are actually higher-income households with high energy expenditures, making their [*N~h~*]{color=`r edit_color`}s quite high (e.g., >\$100 of income per \$1 of energy spending)[, which is only visible on an *N~h~* scale]{color=`r edit_color`}.

```{r metric-comparison, include=TRUE, results='asis', fig.cap='(ref:metric-comparison-fig-cap)', fig.width=8.0,fig.height=5.5}
metric_comparison_fig_cap_old <- paste0("Display of the relationship between ",colorize("*E~b~*",edit_color)," and ",colorize("*N~h~*",edit_color)," with net income (gross income - energy expenditures) for US households. While *E~b~* appears inversely correlated to net income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the *E~b~* equation (Equation 1), the *E~b~* of these households approaches infinity ",colorize("and cannot be captured on the standard 0-100\\% scale the metric is intended to be interpreted within",edit_color),". Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. *N~h~* frames the same dataset on a scale without the long tail. *N~h~* appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing *N~h~* avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, *N~h~* offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent: many households with moderate-to-high *E~b~*s are actually higher-income households with high energy expenditures, making their *N~h~*s quite high (e.g., >\\$100 of income per \\$1 of energy spending)",colorize(", which is only visible on an *N~h~* scale",edit_color),".")

comparison_chart
```

For the discussion of household energy poverty, we are primarily interested in how households of different characteristics are distributed according to their [*N~h~*]{color=`r edit_color`}s, representing how many net dollars are earned by a household for every dollar it spends on energy. Since the *N~h~* is unitless but is a ratio of return on investment, we present it below interchangeably with no units or in units of $\$/\$$ depending on context. Other proposed indicators of energy poverty may be similarly examined in this manner. 


#### Application to Energy Poverty  {#poverty-line}

[While a variety of thresholds have been developed and explored, energy-poor households in the US are]{color=`r edit_color`} commonly defined in terms of *E~b~* as [those with]{color=`r edit_color`} an expenditure of greater than [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} of household income on energy [based on the logic that energy expenditures should not be greater than 20% of housing expenses, which themselves should not exceed 30% of household income[@brownLowincomeEnergyAffordability2020]]{color=`r edit_color`}. Calibrating our [*N~h~*]{color=`r edit_color`} analysis to this level will help gauge different thresholds of energy poverty and benchmark the results of this paper to the energy poverty literature while acknowledging the continuum of experiences across household energy consumption. Translated into its relative level for [*N~h~*]{color=`r edit_color`}, the energy poverty line *N~h~* is defined according to Equation 3 as `r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r round(ner_poverty_line,0)`.

\begin{gather}
\nonumber E_{B}^{*} = \frac{S}{G} = `r colorize(100*energy_burden_poverty_line, edit_color)`\%\\
N_{h}^{*} = \frac{G-S}{S}\ such\ that \ \frac{S}{G} = `r colorize(100*energy_burden_poverty_line,edit_color)`\%\\
\nonumber N_{h}^{*} `r ner_nice_text`\Rightarrow Household\ at\ Energy\ Poverty\ Line
\end{gather}

This means that a household that earns less than [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r to_dollar(ner_poverty_line)`]{color=`r edit_color`} of income for every dollar it spends on secondary energy will be considered to be in energy poverty by the traditional *E~b~* accounting method. An *N~h~* of [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r round(ner_poverty_line,0)`]{color=`r edit_color`} or lower is equivalent to an *E~b~* of [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} or higher. This threshold is arbitrary and may not be suitable in situations where households fall very close to this line or where the numbers of family members or measures of certain building characteristics vary widely. Simply, it is presented as a benchmark. We examine the [*N~h~*]{color=`r edit_color`} at a community scale across the [US]{color=`r edit_color`} in Table \@ref(tab:comparison-table).


#### The US Household Net Energy Landscape  {#landscape}


```{r comparison-table-math}
# table with states'/groups' median annual household energy expenditures, incomes, net incomes, *N~h~*, and *E~b~*
compare_metrics <- function(metric_name="ner",
                            dataset=NULL
                            ){
  gwm <- calculate_weighted_metrics(filter_graph_data(dataset,c("income_bracket"),metric_name),
                           c("income_bracket"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)
  gwm$metric_name <- metric_name
  return(gwm)
}

create_comparison_table <- function(
    metrics_to_compare=c("income",
                         "energy_cost",
                         # "energy_burden",
                         "net_income"#,
                         # "ner"
                                    ),
    dataset=NULL,
    include_totals=TRUE
){
  minimum_metrics_to_compare <- c("income","energy_cost","net_income")
  
  metrics_to_compare <- unique(c(metrics_to_compare,minimum_metrics_to_compare))
  
  compare_table <- data.table::rbindlist(lapply(metrics_to_compare, 
                                                compare_metrics,
                                      dataset=clean_data_ami))
  
  
  compare_table <- compare_table %>% 
    pivot_wider(id_cols=income_bracket,
                names_from=metric_name,
                values_from=metric_mean) %>% 
    mutate(energy_burden = energy_burden_func(g=income, s=energy_cost),
           ner = ner_func(g=income, s=energy_cost)) %>% 
    pivot_longer(cols=unique(c("income","energy_cost","energy_burden","net_income","ner"), 
                             minimum_metrics_to_compare))
  
  if(include_totals){
    compare_table_totals <- compare_table %>% 
    filter(metric_name=="income") %>% 
    pivot_wider(id_cols=income_bracket,
                names_from=metric_name,
                values_from=household_count,
                ) %>% 
    rename(households=income) %>% pivot_longer(cols="households")
    
    compare_table <- rbind(compare_table_totals, compare_table)
  }
  
  #format the metrics accordingly
  # income = 0 decimal place $
  # energy_cost = 0 decimal place $
  # energy_burden = 0 decimal place %
  # net_income = 0 decimal place $
  # ner = 1 decimal place number
  
  which_metric <- "value" #"metric_mean" #"metric_median"
  
  compare_table$print_value <- ifelse(compare_table$name %in% c("income",
                                                                       "energy_cost",
                                                                       "net_income"),
                                      to_dollar(compare_table[[which_metric]],latex=TRUE),
                                      ifelse(compare_table$name %in% c("energy_burden"),
                                             to_percent(compare_table[[which_metric]],latex=TRUE),
                                             ifelse(compare_table$name %in% c("ner"),
                                                    round(compare_table[[which_metric]],1),
                                                    ifelse(compare_table$name %in% c("households"),
                                                           to_million(compare_table[[which_metric]]),
                                                    to_big(compare_table[[which_metric]])))))
  
  compare_table$display_income_bracket <- dplyr::recode_factor(compare_table$income_bracket, 
                                         very_low="0-30\\% AMI",
                                         low_mod="30-80\\% AMI", 
                                         mid_high="Above 80\\% AMI",
                                         All="All",
                                         .ordered=TRUE)
  
  energy_burden_label <- "\\textit{E\\textsubscript{b}} (\\textit{S}/\\textit{G})" #if html etc. <- "*E~b~* (S/G)"
  ner_label <- "\\textit{N\\textsubscript{h}} ([\\textit{G}-\\textit{S}]/\\textit{S})" #if html etc. <- "*N~h~* ([G-S]/S)"
  
  compare_table[,"Metric Name"] <- dplyr::recode(compare_table$name,
                                                 households="Households in Sample",
                                      income="Annual Income (\\textit{G})",
                                      energy_cost="Annual Energy Expenditures (\\textit{S})",
                                      energy_burden=energy_burden_label,
                                      net_income="Net Income (\\textit{G}-\\textit{S})",
                                      ner=ner_label)
  
  print_table <- compare_table[,c("Metric Name","display_income_bracket","print_value")] %>% 
    arrange(display_income_bracket) %>% 
    pivot_wider(names_from=display_income_bracket,values_from=print_value)
  
  return(print_table)
}

print_table <- create_comparison_table <- function(
    metrics_to_compare=NULL,
    dataset=NULL,
    include_totals=TRUE
)
  
write_csv(print_table, "comparison_table.csv")

highlight_metrics <- rbindlist(lapply(c(
                                    "energy_burden",
                                    "ner"
                                    ), compare_metrics,
                                    dataset=clean_data_ami))

highlight_energy_burden <- as.numeric(highlight_metrics[metric_name=="energy_burden" & income_bracket=="very_low","metric_mean"])

highlight_ner <- as.numeric(highlight_metrics[metric_name=="ner" & income_bracket=="very_low","metric_mean"])

num_one <- paste0(to_big(highlight_energy_burden*100),"\\%")
num_two <- round(highlight_ner,1)
# glue::glue(
```


```{r}
total_homes <- tidycensus::get_acs(geography = "us",
                    variables = c(households="B25002_002"),
                    year = acs_version)
# head(total_homes)
estimated_homes <- compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","value"]
min_homes <- total_homes$estimate - total_homes$moe
max_homes <- total_homes$estimate + total_homes$moe
```


[We use LEAD[@maLowIncomeEnergyAffordability2019] (n=`r compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","print_value"]` households) to evaluate the *N~h~* dynamics across the US. The average US home in the dataset]{color=`r edit_color`} has an income of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="income","print_value"]` and an annual energy expenditure of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","print_value"]` (`r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","value"])/12)`/month), which equates to an average *E~b~* of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_burden","print_value"]` or an average [*N~h~*]{color=`r edit_color`} of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="ner","print_value"]`. While the dataset slightly overrepresents households below the median income due to the limitations of the statistical methods used to compile them, it represents estimates for approximately `r to_percent(as.numeric(estimated_homes/(max_homes)))`-`r to_percent(as.numeric(estimated_homes/(min_homes)))` of the `r to_million(min_homes, suffix="")`-`r to_million(max_homes)` family-occupied households evaluated by the American Community Survey. Table \@ref(tab:comparison-table) shows a summary of these data for households and their average statistics [delineated by their]{color=`r edit_color`} incomes relative to [the median income of similar size families in the same metropolitan area or non-metropolitan county, known as]{color=`r edit_color`} Area Median Income (AMI). We can see that high burdens are found mostly in the very-low-income group, with an average *E~b~* of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` or [*N~h~*]{color=`r edit_color`} of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="ner","print_value"]`. Income drives the escape from energy poverty: middle and high-income groups do not spend drastically different amounts on energy (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` and `r to_percent(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` more, respectively) but earn `r to_big(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` and `r to_big(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` times that of the very low-income group, respectively. An *E~b~* of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` means that `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month is spent on energy, which is quite high on a monthly income of `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"])/12)`. The additional `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month that the next rung of moderate-income groups spends on energy represents a minuscule proportion of their income (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"]))`).


(ref:comparison-table-caption) Average annual household energy expenditures, incomes, net incomes, [*N~h~*]{color=`r edit_color`}s, and [*E~b~*]{color=`r edit_color`}s portrayed for different income groups based on their relationship to [AMI]{color=`r edit_color`}. Note that the statistics for [*E~b~*]{color=`r edit_color`} and [*N~h~*]{color=`r edit_color`} are calculated per cohort after averaging the income and expenditure statistics to avoid the effect of extreme values skewing the interpretability of these metrics as described in the text. For example, the actual weighted average [*E~b~*]{color=`r edit_color`} for households from 0-30% AMI is `r num_one`, and the average [*N~h~*]{color=`r edit_color`} for this cohort is `r num_two` due to subsets of the dataset with very low incomes or low energy expenditures. [*N~h~*]{color=`r edit_color`} is not as susceptible to this skewing effect.

```{r comparison-table, include=TRUE, results="asis"}
final_table <- subset(print_table, select=-All) %>%  
  knitr::kable(booktabs=T,
               escape = F,
               caption='(ref:comparison-table-caption)') %>% 
  kableExtra::kable_styling(latex_options = "H") %>% 
  kableExtra::add_footnote(
    # input,
    label = c(
      "AMI: Area Median Income",
      #"*E~b~*: Energy Burden",
      #"*N~h~*: Net Energy Return",
      "\\textit{N\\textsubscript{h}}: Household Net Energy Return",
      "\\textit{E\\textsubscript{b}}: Household Energy Burden"
              ),
    notation = "none", #number, alphabet, symbol and none
    threeparttable = FALSE,
    escape = FALSE
    )
  # kableExtra::row_spec(c(2,3,4,6), bold=T)
  # kableExtra::kable_styling(latex_options = c("striped"), #,"hold_position"
                            # position="center")
final_table
```

[[Because cleaner investments could lower costs over time, we can immediately see a disproportionate burden for those making low income to shifting expenditures to other forms of fuel if any upfront investment is required. Fossil fuel costs are not internalized, so it seems like lower-income cohorts are paying less monetarily. Still, they are paying the costs in other ways, such as through health and environmental externalities. Even without these externalities priced in, the burden of energy for low-income groups is already very high.]{strike=`r strike_show`}]{color=`r edit_color`}

[Another contribution of this work is that by using *N~h~*, we can display these data spatially across the US to explore how different communities are experiencing energy outcomes as in Figure \@ref(fig:continental-map) and investigate specific communities at multiple scales such as census tract, county, state, and regional as in Figure \@ref(fig:inset-map). Furthermore, we can break down the data among meaningful subsets as in Figure \@ref(fig:density-charts) and examine state-by-state trends as in Figure \@ref(fig:state-violin). This is useful because the presence of energy inequity is harder to see in urban areas compared to rural areas for which census tracts are a larger physical area or when certain household characteristics such as primary heating fuel are related to widely differing energy outcomes in the same area. Additionally, it shows a spatial variation of energy poverty that includes `r to_million(number_in_poverty[1]+clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum())` more households that would not be captured by traditional poverty metrics because their incomes are too low (*E~b~*>100%) or too high (above the FPL). By processing disparate data sources into a coherent structure and providing a convenient open-source tool for others to do the same, these data can be used in urban planning, public policy, and other relevant contexts.]{color=`r edit_color`}

Displayed geospatially in Figure \@ref(fig:continental-map), the Black Belt in the American Southeast is visibly perceptible [as an area of high burden]{color=`r edit_color`}, indicating that low-*N~h~* follows racial lines[[in areas where inexpensive energy is available, and burdens are more dependent on housing quality and patterns of consumption than they are dependent on price]{strike=`r strike_show`}]{color=`r edit_color`}. Likewise, border populations and immigrant populated areas in the Southwest have higher burdens, as do Native American lands. [[The use of heating oil in the Northeast states such as Maine can be seen through the prevalance of low-*N~h~* communities in this area since heating oil is a notably expensive and inefficient source of heating commonly used in this region]{strike=`r strike_show`} High burdens can also be seen in rural Northeast states where heating burdens are high]{color=`r edit_color`}. [*N~h~* allows a nuanced view of these widely ranging income dynamics by portraying them on a scale that matches the scope of the issues: areas of high energy burden (close to *N~h~*=0) are visible in orange while highly affluent areas are also visually perceptible as dark blue even though these groups' average metrics are multiple orders of magnitude apart.]{color=`r edit_color`}

(ref:continental-map-fig-cap) Map of the average net earned income per secondary energy expenditure for each census tract in the continental [US]{color=`r edit_color`}. Shades of yellow and red[, respectively,]{color=`r edit_color`} indicate communities at or below the energy poverty line as defined by earning [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately ")` `r round(ner_poverty_line,0)`]{color=`r edit_color`} dollars or less in income per dollar of energy expenditures. This corresponds to the traditional definition of energy poverty as spending [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} or more of income on energy. Low [*N~h~*]{color=`r edit_color`}s can be starkly observed in the Black Belt across the Southeastern US, Hispanic communities near the US-Mexico border, Native American lands, and rural New England.

```{r continental-map, include=TRUE, results='asis', fig.cap='(ref:continental-map-fig-cap)', fig.width=8.0,fig.height=5.5}

old_continental_map_fig_cap <- paste0("Map of the average net earned income per secondary energy expenditure for each census tract in the continental ",
                                  colorize("US",edit_color),
                                  ". Shades of yellow and red",
                                  colorize(",respectively,",edit_color),
                                  " indicate communities at or below the energy poverty line as defined by earning ",
                                  ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately "),
                                  round(ner_poverty_line,0),
                                  " dollars or less in income per dollar of energy expenditures. This corresponds to the traditional definition of energy poverty as spending ",
                                  to_percent(energy_burden_poverty_line),
                                  " or more of income on energy. Low ",
                                  colorize("*N~h~*",edit_color),
                                  "s can be starkly observed in the Black Belt across the Southeastern US, Hispanic communities near the US-Mexico border, Native American lands, and rural New England.")

group_variable <- "geoid"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))
# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

# full_map_data <- left_join(tract_shp, gwm, by=c("geoid"))

gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami,c("income_bracket"),metric_name),
                           c("income_bracket"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)

gwm$metric_name <- metric_name

map_data <- left_join(continental_shp, gwm, by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(graph_data %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens Across the United States"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = TRUE,
    metric_long_name = bquote(N[h]) #"Net\nEnergy Return"
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)

# print(choropleth_chart_footnote)
```

Urban inequity results in lower *N~h~* populations not showing up in many dense or gentrified urban areas such as the San Francisco Bay Area, New York City, and New Orleans, as shown in Figure \@ref(fig:inset-map). [[A notable exception to this trend is Detroit, in which t]{strike=`r strike_show`}T]{color=`r edit_color`}he pervasiveness of urban energy poverty [in Detroit]{color=`r edit_color`} has been studied extensively and shown to have distinct geographic boundaries [down to the street level]{color=`r edit_color`}[@bednarIntersectionEnergyJustice2017]. While some of these conclusions are supported by existing evidence and literature, they should be confirmed with a rigorous analysis of this dataset using the *N~h~* metric for the reasons explained in [Applying NER to Energy Equity](#ratios)[: extremely low-income households are not visible on a 0-100% scale, and households with no income are often discarded as outliers.]{color=`r edit_color`} Additional analyses should incorporate additional demographic and household dimensions due to potential disparities within census tracts since diverse neighborhoods may not be represented accurately by aggregate census tract metrics.

(ref:inset-map-fig-cap) An inset focused on the city of New Orleans, Louisiana (Orleans Parish). This view shows an example of the dynamics of energy poverty in an urban area where the presence of energy inequity is harder to see compared to rural areas for which census tracts are a larger physical area.

```{r inset-map, include=TRUE, results='asis', fig.cap='(ref:inset-map-fig-cap)', fig.width=8.0,fig.height=5.5}

old_inset_map_fig_cap <- "An inset focused on the city of New Orleans, Louisiana (Orleans Parish), showing an example of the dynamics of energy poverty in an urban area where the presence of energy inequity is harder to see compared to rural areas for which census tracts are a larger physical area."

nola_msa_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish")

nola_csa_parishes <- c(nola_msa_parishes, 
                       "Tangipahoa Parish",
                       "Washington Parish")

nola_rpc_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   # "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish",
                   "Tangipahoa Parish")

orleans_and_neighbors <- c("Orleans Parish",
                           "St. Tammany Parish",
                           "Jefferson Parish",
                           "Plaquemines Parish", 
                   "St. Bernard Parish"
                           )

inset_map_data <- map_data %>% filter(county_name=="Orleans Parish"
                                     & state_abbr=="LA")

inset_bb <- st_buffer(st_as_sfc(st_bbox(inset_map_data)) %>% st_transform(3857), dist=100000)

choropleth_chart_highlight <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    legend_position = "none"
    ) + 
  geom_sf(data = inset_bb, fill = NA, color = "green", size = 0.25) + 
  theme_void() + 
  theme(
      legend.position = "none")

# https://en.wikipedia.org/wiki/New_Orleans_metropolitan_area
choropleth_chart_inset <- choropleth_map(
    clean_data=inset_map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="Inset of Energy Burdens in New Orleans, Louisiana",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    legend_position = c(.85,.4),
    include_compass = TRUE,
    metric_long_name = bquote(N[h]))

gg_inset_map = ggdraw() +
  draw_plot(choropleth_chart_inset) +
  draw_plot(choropleth_chart_highlight, x = 0.150, y = 0.625, width = 0.35, height = 0.35)

# gg_inset_map

gg_inset_map_footnote <- gridExtra::grid.arrange(
  gg_inset_map,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
# ggsave2("national_map.pdf",plot=choropleth_chart)
# ggsave2("inset_map.pdf",plot=gg_inset_map)

# grid.arrange(choropleth_chart,gg_inset_map, nrow=2)
# cowplot::plot_grid(choropleth_chart,gg_inset_map, align = "v", nrow=2)
```

From this high level, we can see in Figure \@ref(fig:density-charts)[.a]{color=`r edit_color`} that approximately `r scales::percent(energy_poverty_rate, accuracy=1)` of households in the [US]{color=`r edit_color`} experience energy poverty. Displaying these communities defined by their relationship to the US Federal Poverty Line (FPL), which indicates income poverty status according to government policy, in [Figure \@ref(fig:density-charts).b]{color=`r edit_color`} provides a stark picture. While `r scales::percent(in_both_poverty, accuracy=1)` of households below the FPL also face energy poverty, [more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` of those households]{color=`r edit_color`} above the FPL face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap [and the inadequacy of FPL as an indicator of energy poverty in particular]{color=`r edit_color`}. When we break the group of relatively prosperous households into subsets [as outlined in Table \@ref(tab:comparison-table)]{color=`r edit_color`}, we find that `r scales::percent(as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","households_below_cutoff"])/as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","household_count"]),accuracy=1)` of households living at 30-80% of their [AMI]{color=`r edit_color`} are experiencing energy poverty. This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in [*N~h~*]{color=`r edit_color`} on the households’ energy investments is surprising.

```{r}
clean_data_fpl$simplified_primary_heating_fuel <- as.factor(ifelse(clean_data_fpl$primary_heating_fuel=="ELECTRICITY",
                                                              "Electricity", 
                                                               ifelse(clean_data_fpl$primary_heating_fuel %in% 
                                                                        c("UTILITY GAS","BOTTLED GAS"),
                                                                      "Gas",
                                                    ifelse(clean_data_fpl$primary_heating_fuel=="SOLAR",
                                                           "Solar",
                                                                      "Other"))))

clean_data_fpl$super_simplified_primary_heating_fuel <- 
  as.factor(ifelse(clean_data_fpl$primary_heating_fuel=="SOLAR",
                                                           "Solar",
                                                                      "Other"))


clean_data_ami$all <- as.factor("all")

clean_data_ami <- dplyr::left_join(clean_data_ami, replica_sup[c("geoid","company_ty","locale")], by=c("geoid"))

clean_data_ami$simplified_utility_type <- ifelse(clean_data_ami$company_ty %in% c("Coop","DistCoop"),
                                                 "Cooperatively Owned",
                                                 ifelse(clean_data_ami$company_ty %in% c("Federal",
                                                                                         "Muni",
                                                                                         "State"),
                                                        "Government Owned",
                                                        ifelse(clean_data_ami$company_ty %in% 
                                                                 c("Private","PSubdiv"),
                                                               "Privately Held",
                                                               ifelse(clean_data_ami$company_ty=="IOU",
                                                                      "Publicly Held",
                                                                      "Other")
                                                               )
                                                        ))

clean_data_ami$simplified_locale <- sub(" .*", "", clean_data_ami$locale)
```


```{r}
top_line_group <- NULL

p1 <-   density_chart(graph_data, 
                                 metric_name, 
                                 metric_label="", 
                                 group_columns=top_line_group, 
                                 metric_cutoff_level, 
                                 metric_cutoff_label, 
                                 chart_title=NULL, 
                                 chart_subtitle=NULL,
                                 x_label="")
```

```{r}
top_line_group <- "income_bracket"

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p2=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p3=top_line_charts[["density"]]
p3_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("super_simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")

fuel_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("super_simplified_primary_heating_fuel",
                    "income_bracket")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")

fuel_income_stats=top_line_charts[["metrics"]]
```


[Figure \@ref(fig:density-charts).c shows that h]{color=`r edit_color`}ouseholds with solar as a primary heating fuel have a higher [*N~h~* (*N~h~*=`r round(fuel_stats$metric_mean[fuel_stats$super_simplified_primary_heating_fuel=="Solar"],0)`)]{color=`r edit_color`} than those which rely on other fuel sources [(*N~h~*=`r round(fuel_stats$metric_mean[fuel_stats$super_simplified_primary_heating_fuel=="Other"],0)`)]{color=`r edit_color`}, [even for]{color=`r edit_color`} households far below the poverty line[: the average *N~h~* for income-impoverished households utilizing solar power is `r round(fuel_income_stats$metric_mean[fuel_income_stats$super_simplified_primary_heating_fuel=="Solar" & fuel_income_stats$income_bracket=="Below Federal Poverty Line"],0)`, compared to `r round(fuel_income_stats$metric_mean[fuel_income_stats$super_simplified_primary_heating_fuel=="Other" & fuel_income_stats$income_bracket=="Below Federal Poverty Line"],0)` for those relying on any other fuel source]{color=`r edit_color`}. [The slope of the *N~h~* density lines in Figure \@ref(fig:density-charts).c indicates that these lower-income households seem to experience a different rate of return on *N~h~* from the benefits of increased energy adoption than higher-income households.]{color=`r edit_color`} Why are [certain]{color=`r edit_color`} households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households' low consumption, meaning that the potential savings from [implementing energy efficiency measures]{color=`r edit_color`} are lower than for high-income households [according to the prebound effect identified by Sunikka-Blank and Galvin [@sunikka-blankIntroducingPreboundEffect2012] and Cong et al.[@congEnergyEquityGap2021]]{color=`r edit_color`}. Despite technological progress and rapid declines in technology costs and availability for cleaner, renewable electricity generation options such as solar photovoltaics and energy storage, many households cannot take advantage. Most households do not have access to advancements such as low-cost rooftop solar or energy efficiency upgrades that improve air quality, lower greenhouse gas emissions, and save money[@castellanosRooftopSolarPhotovoltaic2017][: only 18% of households that have adopted rooftop solar have been below the median household income in the US [@barboseIncomeTrendsResidential2020]]{color=`r edit_color`}.

```{r}
top_line_group <- c("number_of_units")
# c("number_of_units", "occupancy_type"),
#                           c("occupancy_type", "income_bracket"),
#                           c("number_of_units", "occupancy_type", "income_bracket"),

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p4=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("housing_tenure")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p5=top_line_charts[["density"]]
p5_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("housing_tenure",
                    "number_of_units")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
multifam_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("housing_tenure",
                    "income_bracket")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
housing_income_stats=top_line_charts[["metrics"]]
```


Examining these dynamics by the status of homeownership [in Figure \@ref(fig:density-charts).d]{color=`r edit_color`} reveals further disparities. Though renters and homeowners are similarly distributed below the energy poverty line [(`r to_percent(p5_stats$pct_in_group_below_cutoff[p5_stats$housing_tenure=="rented"])` of renters and `r to_percent(p5_stats$pct_in_group_below_cutoff[p5_stats$housing_tenure=="owned"])` of homeowners are in energy poverty)]{color=`r edit_color`}, there appears to be an advantage of homeownership from a net energy perspective for lower-income households [(*N~h~*=`r round(p5_stats$metric_mean[p5_stats$housing_tenure=="owned"],0)` for homeowners versus *N~h~*=`r round(p5_stats$metric_mean[p5_stats$housing_tenure=="rented"],0)` for renters)]{color=`r edit_color`}. Only at a relatively high [*N~h~*]{color=`r edit_color`} do renters seem to have an advantage[[, due to these tenants living in relatively new and efficient urban rentals]{strike=`r strike_show`}]{color=`r edit_color`}: owners of multi-family apartments earn `r round(multifam_stats$metric_mean[multifam_stats$housing_tenure=="owned" & multifam_stats$number_of_units=="multi-family"]/multifam_stats$metric_mean[multifam_stats$housing_tenure=="rented" & multifam_stats$number_of_units=="single-family"],1)` times as much as renters of single-family homes when normalized by energy expenditures. Renters face systemic disadvantages in the energy transition; they typically pay the home's energy costs while the landlord controls infrastructure upgrades, commonly understood as the split incentive problem[@birdPolicyOptionsSplit2012]. Tenure matters for more than just equity itself: renters are less likely to take actions to improve their [*N~h~*]{color=`r edit_color`}s due to a lack of property rights and [split incentives]{color=`r edit_color`}. Even when action is taken to improve the energy efficiency of a rental building, tenants are less likely to see any economic benefits from it.

```{r}
top_line_group <- c("simplified_utility_type")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p6=top_line_charts[["density"]]
```

```{r}
# "pop_hispanic"                               
# [35] "pop_african_american"                        "pop_asian"                                  
# [37] "pop_native_american"                         "pop_caucasian" 
# "pop_total"

minority_races <- c("hispanic","african_american","asian","native_american")
races <- c(minority_races,"caucasian")

pct_races <- replica_sup[,paste0("pop_",races)] / rowSums(replica_sup[,paste0("pop_",races)])
names(pct_races) <- paste0("pct_",races)

plurality_race <- races[max.col(pct_races,ties.method = "first")]

plurality_race <- ifelse(plurality_race=="african_american","black",
                                   ifelse(plurality_race=="native_american","indian",
                                          ifelse(plurality_race=="caucasian","white",
                                          plurality_race)))

race_data <- data.frame("geoid"=replica_sup$geoid,
                        "race"=plurality_race)

data_with_race <- inner_join(x=clean_data_ami, 
                             y=na.omit(race_data), by = "geoid")

top_line_group <- c("race")

top_line_charts <- make_all_charts(data_with_race,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p7=top_line_charts[["density"]]
p7_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("simplified_race")

data_with_race$simplified_race <- ifelse(data_with_race$race=="white",
                                         "white",
                                         "non-white")

top_line_charts <- make_all_charts(data_with_race,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")

simplified_race_stats=top_line_charts[["metrics"]]
```


```{r}
# "pop25_some_college_plus"                     "pop25_high_school"                          
# [41] "pop25_no_high_school"
# "pop_total"

# minority_races <- c("african_american","hispanic","asian","native_american")
# races <- c(minority_races,"caucasian")

education_levels <- c("some_college_plus","high_school", "no_high_school")

pct_education_levels <- replica_sup[,paste0("pop25_",education_levels)] / 
  rowSums(replica_sup[,paste0("pop25_",education_levels)])
names(pct_education_levels) <- paste0("pct_",education_levels)

plurality_education_level <- education_levels[max.col(pct_education_levels,ties.method = "first")]

plurality_education_level <- ifelse(plurality_education_level %in% 
                                      c("high_school","no_high_school"),
                                    "high school or less",
                                    ifelse(plurality_education_level=="some_college_plus",
                                           "college or more",
                                          plurality_education_level))

education_data <- data.frame("geoid"=replica_sup$geoid,
                        "simplified_education"=plurality_education_level)


top_line_group <- c("simplified_education")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(education_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p8=top_line_charts[["density"]]
p8_stats=top_line_charts[["metrics"]]

color_poverty_frequency <- (simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="non-white"] - 
                              simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="white"]) / 
  simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="white"]

color_poverty_frequency_modifier <- ifelse(color_poverty_frequency>0,"greater","less")

color_poverty_frequency_pct <- to_percent(abs(color_poverty_frequency))
```

[Furthermore, Figure \@ref(fig:density-charts).e shows that *N~h~* varies widely by racial demography. `r str_to_title(p7_stats$race[p7_stats$metric_mean==max(p7_stats$metric_mean)])` households have the highest *N~h~* across the entire population distribution (*N~h~*=`r round(sort(p7_stats$metric_mean, TRUE)[1],0)`), and `r str_to_title(p7_stats$race[p7_stats$metric_mean==sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)]])` households have the lowest (*N~h~*=`r round(sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)],0)`), with `r str_to_title(p7_stats$race[p7_stats$metric_mean==sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)-1]])` households a close second from the lowest (*N~h~*=`r round(sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)-1],0)`). These relative positions are the same across the entire population distribution, with only White (*N~h~*=`r round(p7_stats$metric_mean[p7_stats$race=="white"],0)`) and Hispanic (*N~h~*=`r round(p7_stats$metric_mean[p7_stats$race=="hispanic"],0)`) populations showing different relative *N~h~*s across the population. Households in communities of color experience energy poverty at a rate `r color_poverty_frequency_pct` `r color_poverty_frequency_modifier` than those in white communities. Education level also seems to be correlated with disparate *N~h~* outcomes according to Figure \@ref(fig:density-charts).f, with a wide gap between those households in areas with mostly high-school (*N~h~*=`r round(p8_stats$metric_mean[p8_stats$simplified_education=="high school or less"],0)`) or college-educated (*N~h~*=`r round(p8_stats$metric_mean[p8_stats$simplified_education=="college or more"],0)`) populations.]{color=`r edit_color`}


```{r}
# "climate_zone"                               
# [75] "climate_zone_description"

simplified_climate <- ifelse(replica_sup$climate_zone_description %in% c("Hot","Very Hot"), "Hot",
                             ifelse(replica_sup$climate_zone_description %in% c("Cold",
                                                                                "Very Cold",
                                                                                "Subarctic"),"Cold","Moderate")
                             )

climate_data <- data.frame("geoid"=replica_sup$geoid,
                           "simplified_climate"=simplified_climate)

top_line_group <- c("simplified_climate")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(climate_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p9=top_line_charts[["density"]]
```

(ref:density-charts-fig-cap) The distribution of [*N~h~*]{color=`r edit_color`}s across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure **b** shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure **c** shows the difference among groups of households identified by their primary heating fuel. Subfigure **d** shows the difference based on whether they are renters or owners. Subfigure **e** shows the difference based on the most prominent race in the census tract of each cohort. Subfigure **f** shows the difference based on the most prominent education history in the census tract of each cohort.

```{r density-charts, include=TRUE, results='asis', fig.cap='(ref:density-charts-fig-cap)', fig.width=8.0,fig.height=5.5}

old_density_charts_fig_cap <- paste0("The distribution of ",colorize("*N~h~*",edit_color),"s across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure b shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure c shows the difference among groups of households identified by their primary heating fuel. Subfigure d shows the difference based on whether they are renters or owners. Subfigure e shows the difference based on the most prominent race in the census tract of each cohort. Subfigure f shows the difference based on the most prominent education history in the census tract of each cohort.")

# grid.arrange(p1,
#              p2,
#              p3,
#              # p4,
#              p5,
#              # p6,
#              p7,
#              p8,
#              # p9,
#              nrow=2,
#              # top=chart_title,
#              # subtitle
#              bottom="Proportion of Households",
#              left=grid.text(label=
#                as.expression(
#                bquote(
#                  N[h]
#                  )
#                ),
#                draw=FALSE
#              )
# )  + 
#   plot_annotation(tag_levels = 'a') &
#   theme(plot.tag = element_text(face = 'bold'))
# 
# 
# facetted_plot <- patchwork::wrap_plots(p1,p2,p3,p5,p7,p8,
#                                        nrow=2) + 
#   plot_annotation(tag_levels = 'a') &
#   theme(plot.tag = element_text(face = 'bold'))
# 
# density_final <- arrangeGrob(grobs=facetted_plot,
#              bottom="Proportion of Households",
#              left=grid.text(label=
#                as.expression(
#                bquote(
#                  N[h]
#                  )
#                ),
#                draw=FALSE
#              )
# )

# result <- (p1+p2+p3)/(p5+p7+p8)
gt <- patchwork::patchworkGrob((p1+p2+p3)/(p5+p7+p8)  + 
                                 plot_layout(heights = c(1,1)) +
  plot_annotation(tag_levels = 'a') &
  theme(plot.tag = element_text(face = 'bold')))
# gridExtra::grid.arrange(gt, left = "Disp", bottom = "Hp // Cyl")
gt_all <- gridExtra::arrangeGrob(gt, 
                        top="Distribution of Energy Burdens Across Household Characteristics",
                        bottom="Proportion of Households",
                        left=grid.text(label=
                                         as.expression(
                                           bquote(~italic(
                                             N[h]
                                             ))
                                           ),
                                       draw=FALSE
                                       ))

gt_all_footnote <- gridExtra::grid.arrange(
  gt_all,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)

# multi_plot <- cowplot::plot_grid(p1,p2,p3,p4,p5,p6,p7,p8,p9,
#                    nrow=3, align="none",rel_heights = c(2,2,2))
# 
# #create common x and y labels
# 
# y.grob <- textGrob(paste0(str_to_upper(metric_name)," (",metric_label,")"), 
#                    gp=gpar(fontface="bold", col="black", fontsize=12), rot=90)
# 
# x.grob <- textGrob("Proportion of Households", 
#                    gp=gpar(fontface="bold", col="black", fontsize=12))
# 
# #add to plot
# 
# grid.arrange(arrangeGrob(multi_plot, left = y.grob, bottom = x.grob))
```

```{r}
group_columns <- c("state_abbr")
# utility type? see chartbook
graph_data <- filter_graph_data(clean_data=clean_data_ami[clean_data_ami$state_abbr!="DC",], 
                                group_columns=group_columns, 
                                metric_name=metric_name)

# percent of "other" fuel expenditures toward fossil fuel combustion
# want to make this more precise by state, county, and/or balancing authority eventually
other_gwm <- grouped_weighted_metrics(clean_data_fpl[clean_data_fpl$state_abbr!="DC",], 
                                      c("primary_heating_fuel"),
                                      "other_spend",
                                      0)

other_fuels <- c("COAL","FUEL OIL","NONE","OTHER","SOLAR","WOOD","BOTTLED GAS")
non_fossil_other_fuels <- c("NONE","SOLAR","WOOD")
fossil_other_fuels <- other_fuels[!(other_fuels %in% non_fossil_other_fuels)]

other_fossil <- other_gwm[other_gwm$primary_heating_fuel %in% fossil_other_fuels,
                              c("household_count","metric_mean")]

pct_other_fossil <- sum(other_fossil$household_count*other_fossil$metric_mean)/
  sum(other_gwm$household_count*other_gwm$metric_mean)

graph_data$pct_other_fossil <- pct_other_fossil

# percent of each state's electric grid decidated to fossil fuel combustion
# can refine by balancing authority based on REPLICA dataset
egrid <- get_state_egrid()

egrid$pct_electricity_fossil <- egrid$STCLPR + #coal
  egrid$STOLPR + #oil
  egrid$STGSPR + #gas
  egrid$STOFPR #+ #other fossil
  # egrid$STNCPR #+ #nuclear
  # egrid$STHYPR #+ #hydro
  # egrid$STOPPR #unknown/purchased

graph_data <- left_join(graph_data, egrid, by=c("state_fips"="FIPSST"))

# graph_data <- graph_data[graph_data$state_abbr!="DC",]

# percent of natural gas expenditures dedicateed to fossil fuel combustion...
pct_gas_fossil <- 1.0

graph_data$pct_gas_fossil <- pct_gas_fossil

graph_data$pct_fossil_tract <- (graph_data$pct_gas_fossil * graph_data$gas_spend + 
  graph_data$pct_electricity_fossil * graph_data$electricity_spend + 
  graph_data$pct_other_fossil * graph_data$other_spend) / 
  (graph_data$gas_spend + graph_data$electricity_spend + graph_data$other_spend)


pct_fossil_gwm <- grouped_weighted_metrics(graph_data, "state_fips","pct_fossil_tract",0) %>% 
  dplyr::rename(pct_fossil=metric_mean)

graph_data <- left_join(graph_data, 
                        pct_fossil_gwm[,c("state_fips","pct_fossil")], 
                        by="state_fips")

top_line_charts <- make_all_charts(graph_data,
                            group_columns="state_abbr",
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL)

state_by_state <- top_line_charts[["metrics"]]

electricity_prices_summary <- calculate_weighted_metrics(graph_data, 
                                                         c("state_abbr"), 
                                                         "dlrs_kwh", 
                                                         metric_cutoff_level = 
                                                           ner_poverty_line)
```


Assessing the [*N~h~*]{color=`r edit_color`}s among different states in Figure \@ref(fig:state-violin) presents a counterintuitive picture of how states address energy poverty and energy equity. [*N~h~*]{color=`r edit_color`} can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as Connecticut [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CT"],0)`)]{color=`r edit_color`} and Vermont [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="VT"],0)`)]{color=`r edit_color`}, where [`r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="CT"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` and `r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="VT"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])`]{color=`r edit_color`} higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="MS"],0)`)]{color=`r edit_color`} and Alabama [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="AL"],0)`)]{color=`r edit_color`}, which have significant low-income populations and low per-unit energy prices [(`r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="MS"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` and `r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="AL"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` lower than average, respectively)]{color=`r edit_color`}. Not only are households in these states falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood may suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on a diverse selection of metrics.

Although they are the states with the highest [*N~h~*]{color=`r edit_color`}, California [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CA"],0)`)]{color=`r edit_color`} and Colorado [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CO"],0)`)]{color=`r edit_color`} are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely, this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation are a common thread [among the top-performing states on an *N~h~* basis]{color=`r edit_color`}, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure \@ref(fig:state-violin) shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high [*N~h~*]{color=`r edit_color`}s than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.

(ref:state-violin-fig-cap) A comparison of [*N~h~*]{color=`r edit_color`}s among each state in the [US]{color=`r edit_color`}. The bars are sorted by median household [*N~h~*]{color=`r edit_color`} and represent the interquartile range (25%-75% percentiles) of household [*N~h~*]{color=`r edit_color`}s colored by the percent of household energy expenditures in each state that goes to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's [(EPA)]{color=`r edit_color`} [Emissions and Generation Resource Integrated Database (]{color=`r edit_color`}eGRID[)]{color=`r edit_color`} for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users.

```{r state-violin, include=TRUE, eval=TRUE, results='asis', fig.cap='(ref:state-violin-fig-cap)', fig.width=8.0,fig.height=5.5}

old_state_violin_fig_cap <- paste0("A comparison of ",colorize("*N~h~*",edit_color),"s among each state in the ",colorize("US",edit_color),". The bars are sorted by median household *N~h~* and represent the interquartile range (25%-75% percentiles) of household *N~h~*s colored by the percent of household energy expenditures in each state that go to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's ",colorize("(EPA)",edit_color)," ",colorize("Emissions and Generation Resource Integrated Database (",edit_color),"eGRID",colorize(")",edit_color)," for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users.")
# violin plot
# x_label <- bquote(~italic(N[h]))
x_label <- as.expression(bquote(~italic(N[h])~": Household Net Energy Return"))


y <- make_violin_chart(graph_data=graph_data,
                      group_columns=group_columns,
                      metric_name=metric_name,
                      metric_label=metric_label,
                      metric_cutoff_level=metric_cutoff_level,
                      fill_metric="pct_fossil",#"STCYPR",#"STSOPR",
                      fill_label="% of Energy Expenditures on \nFossil Fuel Combustion",#Combustion",#Solar",
                      group_name="State",
                      chart_title="Comparison of Energy Burdens Among the United States",
                      x_label=x_label)
print(y)
```

```{r}
group_variable <- "eia_id"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(left_join(clean_data_ami, replica_sup, by=c("geoid")), group_columns, metric_name)

util_group <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)

member_minumum <- 10000
lowest_ner_utility <- filter(arrange(util_group,metric_mean),household_count>=member_minumum)[1,]

unique_utils <- distinct(replica_sup[c("eia_id","company_na","state_name","dlrs_kwh")])

lowest_ner_utility_specs <- filter(unique_utils,eia_id==as.numeric(lowest_ner_utility["eia_id"]))

lowest_ner_utility_name <- lowest_ner_utility_specs$company_na
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Corp","Corporation")
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Member","Membership")
```

#### Discussion  {#discussion}

A sensible prior hypothesis is that everyone experiences the same efficiency from the energy system as measured by return on energy investment. Differences in absolute outcomes may be related to the quantity of energy investment, but the marginal unit of energy consumed by one household should lead to as much benefit for that household as any other. However, here we see that [*N~h~*]{color=`r edit_color`}s are different among different groups of households in the US. This difference is often correlated to factors out of the households’ control and even those related to persistent social inequalities, such as race and education. These striking disparities suggest the existence of deeply structural barriers to prosperity in the US. Energy is central to equity and economic prosperity, but the[[odds are stacked against many people. The]{strike=`r strike_show`}]{color=`r edit_color`} energy system appears to be regressive in that costs accrue disproportionately to those of lower-income levels[[and the most energy-efficient homes belong to wealthier families]{strike=`r strike_show`}]{color=`r edit_color`}.

Furthermore, we demonstrate that owning a home and consuming solar power are associated with increased income multipliers for energy expenditures. This advantage leads to gains that are not being realized by many communities. When households adopt solar power, their *N~h~* increases as a result of decreasing their energy expenditures, which creates a disparity between those with access to renewable energy and those reliant on fossil-fuel-based energy sources. This helps explain why there has been a disparity in how the benefits of the energy transition are accruing among socioeconomic groups [@vaishnavWasItWorthwhile2017]. There is the potential for electrification and the transition to clean fuels to exacerbate this division if appropriate policies are not implemented[@cullenwardDynamicallyEstimatingDistributional2016].

Indeed, there are clear, mutually synergistic, positive reinforcement mechanisms to alleviate health and environmental disparities in air pollution exposure by reducing household energy burdens and improving economic mobility across low-income households. Combustion of biofuels and hydrocarbons is a significant source of air pollution and exacerbates other household costs like healthcare and maintenance[, yet we find that utilization of these sources is not associated with increased *N~h~*s at a state or household scale]{color=`r edit_color`}. [Not only are h]{color=`r edit_color`}ouseholds living in more poverty and closer proximity to highly polluted areas [at greater risk of adverse health impacts; they]{color=`r edit_color`} must [also]{color=`r edit_color`} consume more energy to overcome the particulate emissions[, which, themselves, reduce the efficiency of clean sources such as solar panels[@heIncreaseDomesticElectricity2020]]{color=`r edit_color`}.

The inherent benefits of solar electricity must be accessible to all populations in the [US]{color=`r edit_color`} to promote sustainability, but [[barriers such as high capital investment, lack of financing, and inability to take advantage of existing business models continue to hold back]{strike=`r strike_show`}]{color=`r edit_color`} communities of color [[from]{strike=`r strike_show`}are not]{color=`r edit_color`} receiving a similar benefit to white and wealthier households [from their energy expenditures]{color=`r edit_color`}. Net energy metrics exhibit this income multiplier effect and the resulting divide. Designing solar policies to benefit those facing low [*N~h~*]{color=`r edit_color`}s may substantially improve net energy income ratios and raise households out of energy poverty in the [US]{color=`r edit_color`}.

Pachauri et al. distinguish between affordability and cost of supply, implying that more focus should be applied toward how energy burdens vary among customers of different energy suppliers than on how per-unit costs of energy vary[@pachauriAdvancingEnergyPoverty2020]. For instance, `r lowest_ner_utility_name` is the electric utility with more than `r to_big(member_minumum)` customers whose members have the lowest average [*N~h~*]{color=`r edit_color`} (`r to_big(lowest_ner_utility$metric_mean)`)[, according to LEAD]{color=`r edit_color`}. At the same time, the per-unit cost of electricity in this service territory is only more expensive than `r to_percent(ecdf(unique_utils$dlrs_kwh)(lowest_ner_utility_specs$dlrs_kwh))` of utilities at `r to_dollar(lowest_ner_utility_specs$dlrs_kwh)`/kWh. [Is an exceptionally high burden acceptable because the per-unit costs are not exceptional?]{color=`r edit_color`}

This relevance especially holds for electricity because it is a commodity delivered via a stationary, centralized grid system, and households retain little control over their own energy choices. [[The vastness of the modern electric grid eludes affordability for everyday households because of the relationships between the utility companies and the users. Secondary energy is unique among residential consumption categories because a single service provider is usually the authority for determining energy costs for each of its customers.]{strike=`r strike_show`}]{color=`r edit_color`} In vertically integrated energy markets, the monopoly utility is the only option available to all consumers. In organized energy markets, the public utility is designated as the last resort provider for those unable or unwilling to participate in the competitive procurement of energy. Even in organized markets, local utilities retain monopolistic control of the transmission and distribution systems. 

Consumers are price takers with relatively inelastic demand. Changes in the unit price of energy or slight differences in consumption patterns matter more to those with low incomes than those with higher incomes. Furthermore, the current lack of storage infrastructure on the grid and behind each meter means that households are bound to electricity providers at the time of use. The "forward-looking" or "reactive" tendencies of these public electric utilities have implications for the energy transition in their jurisdictions and beyond[@wolakFutureElectricityRetailing2020]. A more in-depth examination of the energy system’s underlying regulatory structures and robust assessments of energy burden could provide a path forward and track how the benefits of the energy transition are being accrued.

In some markets, specialized rates or programs are available for Low and Moderate Income (LMI) consumers, who may have higher energy burdens. We find it notable that more than half of all funding to address high energy burdens in the US is from utility ratepayer-funded bill and energy efficiency assistance[@rossHighCostEnergy2018]. At a national scale, the Low Income Home Energy Assistance Program (LIHEAP) and the Weatherization Assistance Program (WAP) in the US seek to address aspects of energy poverty through bill payment assistance and energy efficiency measures, but the efficacy of these programs has been mixed in addressing distributional equity in energy burdens and receiving benefits from energy efficiency programs[@bednarRecognitionResponseEnergy2020]. [In part, this may be because these programs rely on income-based poverty lines such as the FPL to determine eligibility for benefits.]{color=`r edit_color`}

The [US]{color=`r edit_color`} benchmarks its FPL to the food requirements of the average household[@coferFamilyFoodPlans1962] and uses this threshold as is an eligibility criterion for more than 40 federal programs across ten agencies (in addition to state, charitable, and private enterprises that also do so)[@unitedstatesdepartmentofhealthandhumanservicesProgramsThatUse2015]. Practitioners have posited that the standard policy of “using the ‘economy food plan’ to determine who can afford to hire an attorney” may be depriving citizens of their basic rights[@grossTooPoorHire2013]. In some cases, food assistance programs are more inclusive than energy assistance programs[: we show that more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` households above the FPL experience energy poverty.]{color=`r edit_color`}

[Research using detailed qualitative sociological and public health interview data links energy burden with housing and energy policy[@hernandezEnergyBurdenNeed2010]. Other articles have linked technology adoption barriers to low-income communities of color[@hsuPublicElectricVehicle2021]^,^[@tidwellDecarbonizingDisparitiesProblematizing2021]^,^[@brockwayInequitableAccessDistributed2021a] and identified that households that are in the same peer social network often adopt technologies such as solar[@bollingerPeerEffectsDiffusion2012]. While some studies already acknowledge the benefits of improving energy efficiency and equity outcomes through surveys and interviews[@hernandezBenefitBurdenPerceptions2015], this study adds to the literature by building a comprehensive quantitative framework and empirical result based on a large dataset. This toolkit adds more quantitative backing to this body of qualitative work and can be used in future analysis with technology adoption data to identify strategic opportunities to improve energy efficiency and access to clean technology in a more equitable manner.]{color=`r edit_color`}

[Previous work provided theoretical frameworks for understanding energy poverty beyond a simple income-based measure[@sovacoolEnergyJusticeConceptual2015], and limited examples of applications to empirical data that rely on building-specific efficiency characteristics[@faiellaEnergyPovertyHow2021] or subjective self-assessments[@sokolowskiMultidimensionalIndexMeasure2020]. Applying *N~h~* to a nationwide dataset for the US builds on this work by providing a tangible tool that includes `r to_million(number_in_poverty[1]+clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum())` households with energy expenditures greater than their incomes or with incomes above the FPL that are left out by other measures, and is a way to visualize the disparities between groups that may allow for further investigation around different household characteristics. *N~h~* highlights inequality better than a simple linear metric while allowing the assessment of a wide variety of households, such as those with no income or for which efficiency data is not available.]{color=`r edit_color`} A significant insight from [NEA]{color=`r edit_color`} that should be incorporated into future work is that embodied energy takes many forms across the household budget (food, goods, services, transportation, housing, etc.), and these can all be compared using the same units of measure (e.g., joules) to scale the *N~h~* framework across multiple expenditure categories.

The [Coronavirus Disease 2019 (]{color=`r edit_color`}COVID-19[)]{color=`r edit_color`} pandemic and associated recovery measures may be a critical opportunity to provide relief payments related to energy expenditures and to invest in more efficient residential[@RecoveringFastSlow2020a] and commercial energy infrastructure that enables newer and cleaner systems[@chapmanImpactsCOVID19Transitioning2020]. We show that US households are already spending excessive amounts on energy, notwithstanding more families staying at home for longer periods of time during pandemic lockdowns. The ongoing crisis offers a chance to address inequity with a focus on residential energy burdens[@graffCOVID19AssistanceNeeds2020]. [The EU is in the process of defining how communities can participate in the energy transition[@uihleinEnergyCommunitiesOverview2020] and how burdens can be alleviated through this process using proactive policy tools and business models such as One Stop Shops (OSS) for energy efficiency and renewable energy upgrades[@bertoldiRoleOnestopShops2021].]{color=`r edit_color`} Adopting energy criteria for energy and other programs [like these]{color=`r edit_color`} could expand access for those underserved populations in need of assistance independent of their needs in other consumption categories.

Creating a federal energy poverty line would be a critical step in identifying families that face large disparities in access to affordable electricity and energy in the [US]{color=`r edit_color`} and improve programs’ abilities to address energy burdens. A toolkit based on this analysis enables neighborhood level outreach where burdens are highest and identifies opportunities where households could benefit from emerging technologies.
[[A more comprehensive approach to poverty alleviation in the US would also consider the energy situation of each household and the options available to improve its efficiency. Then, it would make those options accessible to the stakeholders who could benefit.]{strike=`r strike_show`}]{color=`r edit_color`}
[[Even for energy assistance programs that do exist, many households reliant on inefficient fuels such as kerosene for heating must pay upfront costs to fill a tank for the winter season. These subsidy programs are largely ineffective as the cost of kerosene can be expensive, and pressure remains on households to offset existing gaps. Better opportunities to convert to alternative fuels would also provide households the opportunity to take advantage of the efficiency gains in better technology. In this way, broader programs need to be designed to provide households more options.]{strike=`r strike_show`}]{color=`r edit_color`}
[[How can our energy system be operated and improved to provide equitable access? Are there ways that clean electrification can be used to better benefit currently underserved communities?]{strike=`r strike_show`}]{color=`r edit_color`}
[[High burdens may be associated with intermittent grid access when extreme weather events interrupt energy supply chains. The same households are often at greater risk of energy service disconnection due to non-payment. Re-connection fees can compound to increase burdens in ways not captured by our analysis.]{strike=`r strike_show`}]{color=`r edit_color`} 
[[High energy burdens have already been linked to local and global air pollution, and we can connect these impacts directly to the full scope of household prosperity via net energy.]{strike=`r strike_show`}]{color=`r edit_color`}
[[Energy is essential to deal with other inequities in society. There must be a way to design a structure that addresses this disparity more equitably.]{strike=`r strike_show`}]{color=`r edit_color`}
[[While well-intended programs such as PACE or solar loans have reached few people, community-oriented programs focusing on peer-mentorship could improve programmatic outcomes. Building support for community-led programs can also reduce the burden on individuals to expand access to the benefits of solar and efficiency.]{strike=`r strike_show`}]{color=`r edit_color`}
[[Policymakers have not systematically deployed interventions based on [NEA]{color=`r edit_color`} across American households.]{strike=`r strike_show`}]{color=`r edit_color`} 
[[Net energy income is holding back socioeconomic mobility in the US.]{strike=`r strike_show`}]{color=`r edit_color`}
[[However, concerted attention to technology and policy details matter to implement a national scheme.]{strike=`r strike_show`}]{color=`r edit_color`}
[[The data demonstrate a need for quantitative methodologies to support equitable energy infrastructure investments.]{strike=`r strike_show`}]{color=`r edit_color`}

## Methods  {#methods}

#### Data  {#data}
To estimate the Net Energy Return (*N~h~*) of American households, we primarily utilize the Low Income Energy Affordability Data (LEAD)[@maLowIncomeEnergyAffordability2019] and Rooftop Energy Potential of Low-Income Communities in America (REPLICA)[@sigrinRooftopSolarTechnical2018] datasets, which the DOE assembled to help “stakeholders make data-driven decisions on energy goal setting and program planning by providing them information on low-income household populations and associated energy use characteristics”[@maLowIncomeEnergyAffordability2019]. These datasets encompass estimates of household energy expenditures (*S*), income (*G*), and demographic characteristics for most households at the census tract scale in all states and most territories of the [US]{color=`r edit_color`}.  

LEAD: The LEAD portrays the average income, electricity expenditures, gas expenditures, and other fuel expenditures for cohorts of households segmented by location (census tract, county, state) and household characteristics (whether the unit is rented or owned, the building’s year of first construction, the number of units in the building, whether the units are attached, and the unit’s primary heating fuel type). The dataset is assembled by applying an iterative proportional fitting (IPF) algorithm to cross-tabulations of household responses from the 2016 5-year American Community Survey (conducted by the US Census Bureau), which provides the samples for each cohort as Public Use Microdata Samples. IPF is a widely used spatial microsimulation method to allocate individuals (i.e., households) to zones (i.e., census tracts and utility service territories) while calibrating each zone's characteristics to known quantities. Using IPF, the microdata samples are scaled to match aggregate annual values from utility sales and revenues reported in Energy Information Administration forms 861 and 176.

REPLICA: The Renewable Energy Potential of Low-Income Communities in America (REPLICA) dataset includes [the racial and education level composition of each census tract]{color=`r edit_color`} used in the ultimate analysis[@sigrinRooftopSolarTechnical2018]. [In addition to providing a simpler designation of cohorts for each census tract, REPLICA also includes]{color=`r edit_color`} estimates of the technical potential of rooftop solar and additional techno-economic variables (e.g., demographics and electricity rates) [that will be useful for future research.]{color=`r edit_color`}

eGRID: We use the [EPA]{color=`r edit_color`}'s eGRID[@unitedstatesenvironmentalprotectionagencyepaEmissionsGenerationResource2020] to calculate the proportion of household energy expenditures that support fossil fuel combustion through the purchase of electricity. 100% of natural gas purchases are considered to support fossil fuel combustion. Electricity purchases are divided into their respective sources according to the state proportions indicated by the "STCLPR" (coal), "STOLPR" (oil), "STGSPR" (gas), and "STOFPR" (other fossil) fields in the 2018 eGRID dataset. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately `r scales::percent(pct_other_fossil, accuracy=1)` fossil fuel combustion.

#### Treatment  {#treatment}
The LEAD data represents the unit’s ownership status (OWNER vs. RENTER) and income bracket as a fraction of [AMI]{color=`r edit_color`} (0-30%, 30-60%, 60-80%, 80-100%, or 100%+) or [FPL]{color=`r edit_color`} (0-100%, 100-150%, etc.). These categorical variables are saved as factors. Then we create min_units from BLD INDEX, a variable which represents a non-uniformly distributed set of buckets for the range of the number of units in the building and whether single-unit households are attached or detached from neighboring households (1 ATTACHED, 1 DETACHED, 2 UNIT, 3-4 UNIT, 5-9 UNIT, 10-19 UNIT, 20-49 UNIT, 50+ UNIT, MOBILE_TRAILER, BOAT_RV_VAN, OTHER UNIT). We extract the minimum number of units from the range and whether the building is detached. Those households labeled OTHER UNIT, MOBILE_TRAILER, or BOAT_RV_VAN are given values of Not Applicable (NA) for this characteristic. Finally, we calculate *S* and *G* of which each metric is composed: 

*S* = annual expenditures on electricity (ELEP CAL) + natural gas (GASP CAL) + and other fuels (FULP)  

*G* = the cohort’s average annual income (HINCP) 

The metric formulas outlined in [Applying NER to Energy Equity](#ratios) are then used to calculate each cohort’s energy poverty metrics. Since we are examining homes’ relationships with the energy system, we ignore any homes that do not use energy as denoted by rows where *S*==0. The estimation procedure used by the DOE results in an estimated number of occupied housing units for each cohort (UNITS, renamed as households). It displays the number of American Community Survey responses that contribute to the estimate of energy expenditures (COUNT, renamed as acs_responses). We then remove any categories with fewer than 1 unit represented since this is not physically possible. `r removed_households = "This results in removing X% of the available rows (gross: X rows of X). This is a total of X housing units or X% of the estimated total X units in the sample. We have separated any cohorts with incomes or energy costs equal to 0 into another dataset for analysis. This represents approximately X% of the housing units and X% of the examined cohorts, so it will be important to make sure that this subset does not contain systematic bias. However, these data are excluded from the current analysis under the assumption that energy costs equal to 0 are not relevant to this analysis."`

We then combine this dataset with the REPLICA dataset. To do so, we must aggregate the income levels of the LEAD dataset to the simpler schema used by REPLICA for summarizing households’ income relative to the area’s median income (AMI):

- 0-30% AMI: Very-Low-Income
- 30-80% AMI: Low-to-Moderate-Income
- $\geq$ 80% AMI: Middle-to-High-Income

Also, we create an indicator of whether a particular cohort is in income poverty as defined by the relevant standards for its characteristics. For the AMI version of LEAD, this is defined as being “Very-Low-Income” or $\leq$ 30% of AMI. For the FPL version of LEAD, we translate directly from the designation of the income bracket as follows:

- 0-100% FPL: In Poverty
- $\geq$ 100% FPL: Not In Poverty

The REPLICA dataset also simplifies any households with only one unit per building into “Single Family” homes and any households with more than one unit per building as “Multi-family.” Non-stationary and non-traditional homes are not included in the REPLICA analysis. We match these simplifications in the LEAD dataset by aggregating by the number of units:

- 1 Unit: Single-Family
- $>$ 1 Unit: Multi-Family
- Other Unit: NA (excluded from analysis)

After simplifying these characteristics in the LEAD [AMI]{color=`r edit_color`} data, we merge the AMI dataset with the REPLICA dataset along the census tract, simplified income bracket, simplified number of units, and housing tenure variables to achieve the primary dataset used in the analysis. Merging with the REPLICA dataset provides additional demographic and geospatial data not available in the LEAD dataset only[@sigrinRooftopSolarTechnical2018]. Characteristics such as the utility type and locale description are sourced from REPLICA and unavailable in LEAD[, and we source the cost of electricity, racial composition, and education levels of census tracts from REPLICA for this analysis]{color=`r edit_color`}. Similarly, the REPLICA dataset contains only electrical expenditure estimates without natural gas or other fuel costs to households and could not be used to perform this analysis alone.

The FPL version of LEAD is not merged with all of the REPLICA data because of incompatibility between the FPL and [AMI]{color=`r edit_color`} bracket definitions. However, demographic data associated with each census tract as a whole can be merged with the FPL dataset. Both AMI and FPL versions of LEAD are combined with demographic data from the REPLICA dataset and geospatial shapefiles from the Census to produce the final datasets used in the analysis. [Since the FPL version of LEAD is not aggregated to the simpler categories found in REPLICA, more granular variables such as Primary Heating Fuel remain available for assessment across the entire population.]{color=`r edit_color`}

#### Considerations  {#considerations}
[While a helpful place to start, *E~b~* has certain drawbacks.]{color=`r edit_color`} Significantly, a simple proportion does not account for the fact that money spent on energy cannot be spent elsewhere and is therefore not useful income to the household for the purposes of measuring prosperity. Including gross income in *E~b~* has the effect of depressing the average *E~b~*, by definition.

Furthermore, because energy expenditures are a small proportion of even the most impoverished households' total income, *E~b~* is almost always a very small percentage (<10%). This leads to issues with interpretability in public discourse and policy settings and may even affect program outcomes that are based on *E~b~* if small numbers are rounded to even the nearest hundredth of a percent. [As the UK experienced when using *E~b~*, i]{color=`r edit_color`}f the household is above an energy poverty line defined by such a metric for public policy purposes, the family may not receive critical support[[@bednarRecognitionResponseEnergy2020].[, or energy may be sidelined by other basic needs.]{strike=`r strike_show`}]{color=`r edit_color`}

Because such a small proportion of expenditures can impact different income groups so differently, ratios of this type can be useful when delineating across income quantiles or other categories - particularly for vulnerable populations where energy poverty poses a significant difficulty or affordability threshold not captured by measures of absolute poverty. However, *E~b~* is often portrayed at a population scale (e.g., the average energy burden of the population is X%)[, which can be skewed by outliers within the population]{color=`r edit_color`}. Household metrics and surveys are important for further understanding of and policy development around issues of energy poverty. 

Finally, presenting the relationship between household income and energy expenditures as a proportion with income in the denominator suggests that improvements can only be made by decreasing energy expenditures or increasing incomes. However, in reality, there is a positive relationship between energy expenditures and incomes because energy is an input to wealth-creating processes[[and the unit costs of energy decrease as absolute consumption increases]{strike=`r strike_show`}]{color=`r edit_color`}. Households consume energy to unlock the utility that energy services provide to them as participants in society, whether to cook food or connect to the internet. This relationship is generally accepted when understanding individual household behavior[@thomasEstimatingDirectIndirect2013] and macro-economic effects of energy consumption[@saundersKhazzoomBrookesPostulateNeoclassical1992]. Therefore, a metric describing the efficiency of household wealth creation may be more intuitive with income in the numerator.

The iterative proportional fitting method has limitations as an estimation procedure that constrain the strength of conclusions that can be drawn from the simulated LEAD and REPLICA datasets. The relationship between constraint variables such as total energy spending by utility service territory and number of households per census tract will tend toward the average of the initializing dataset and depress variations among otherwise similar regions. This may explain the large quantities of households that are estimated to have very low incomes. Validating these estimated data would require randomized surveys of households along the dimensions of interest.

The meaning of the “primary heating fuel” category comes from the answer to the question “Which fuel is used most for heating this house, apartment, or mobile home?” on the American Community Survey. This question’s power to predict energy expenditures or fuel sources is unknown, and further analysis is required to understand the implications of this survey question for drawing broader conclusions about household energy use. However, the US Census Bureau has been asking this question since 1940. It states that these data are collected to help communities "provide assistance with utilities," "estimate future energy demand," and "measure environmental impacts"[@unitedstatescensusbureauWhyWeAsk2021].

Though the REPLICA dataset relies on a different vintage of the LEAD dataset (assembled in 2017[@sigrinRooftopSolarTechnical2018]) than this analysis (assembled in 2019[@maLowIncomeEnergyAffordability2019]), inferring differences among annual estimates is not meaningful due to the standard error of the data [@maLowIncomeEnergyAffordability2019]. A rigorous treatment of these metrics over time is an area for future research.

The results inferred from eGRID are only as good as the eGRID methodology itself. We choose to outline the proportion of combusted fuels rather than emissions data due to the limitations outlined by proponents of marginal emissions attribution in electric power system models[@vonwaldAnalyzingCaliforniaFramework2020]^,^[@siler-evansMarginalEmissionsFactors2012] and limitations in estimating regional electricity transfers[@vonwaldAccountingGreenhouseGas2021].
[[Expanding quantitative analysis of energy affordability can offer additional context, including the use of ratios to identify populations that could be particularly vulnerable to energy shocks or absolute energy burdens. Developing such metrics can elucidate the scale on which American households must save for energy consumption. Frequently used metrics in this category do not tell the whole story. For instance, the simple proportion of a household’s income spent on energy bills (a.k.a. energy burden) does not capture the underlying monthly cash flow patterns that may stress household budgets.]{strike=`r strike_show`}]{color=`r edit_color`}

## Code Availability {#code-availability}

The code and data to fully reproduce this paper are available on GitHub at [[https://github.com/ericscheier/net_energy_equity](https://github.com/ericscheier/net_energy_equity)]{hide=`r hide`} under the GNU Affero General Public License v3.0. [The most recent release of the software can be found at [DOI: 10.5281/zenodo.5676225](https://doi.org/10.5281/zenodo.5676225)[@scheierMeasurementStrategyAddress2021].]{highlight=`r highlight`}

## Data Availability  {#data-availability}

[The data generated in this study have been deposited in the the Zenodo database under [DOI: 10.5281/zenodo.5676225](https://doi.org/10.5281/zenodo.5676225)[@scheierMeasurementStrategyAddress2021].]{highlight=`r highlight`}

All data necessary for the composition of the source datasets used in this analysis are freely available from [US]{color=`r edit_color`} government sources as open data. All functions to automatically retrieve and assemble these data and compiled versions of these data are made available to the user as part of the software [available at [DOI: 10.5281/zenodo.5676225](https://doi.org/10.5281/zenodo.5676225)[@scheierMeasurementStrategyAddress2021].]{highlight=`r highlight`}.

## References  {#references}

::: {#refs}
:::

```{r eval=FALSE}
# # Works Not Yet Cited  {#uncited}
# 
# ---
# nocite: |
#   @*
# ...
# 
# # Software Used  {#software}
# 
# List of R packages used to be entered here automatically
#
```

## Acknowledgements  {#acknowledgements}
[The authors wish to thank Nikhil Kaza and Andy Yates for insightful conversations, review, comments, feedback, and advice on this study.]{highlight=`r highlight`}

## Author Contributions  {#author-contributions}

ES and NK conceived of and designed the project. ES created the software used for data acquisition and analysis and created the figures. NK contributed the introduction of the topic and interpretation of the results.

## Competing Interests  {#competing-interests}

The authors declare no competing interests.


```{r eval=FALSE}
# 
# # Additional Information  {#additional-information}
# 
# # (APPENDIX) Appendix {-}  {#appendix}
# 
# # Charts for All Variables {#charts}
```

```{r, include = FALSE, eval=FALSE}
r_packages_used <- c("rmarkdown", "knitr")
knitr::write_bib(x = r_packages_used, file = "bibliography.bib")
#https://stackoverflow.com/questions/60026015/use-citation-in-r-markdown-to-automatically-generate-a-bibliography-of-r-packa
```

## Tables

\captionsetup[table]{labelformat=empty}
Table \@ref(tab:comparison-table): 
```{r comparison-table-display, include=TRUE, results="asis"}
final_table
```
\captionsetup[table]{labelformat=default}

## Figure Legends/Captions

Figure \@ref(fig:metric-comparison): (ref:metric-comparison-fig-cap)

Figure \@ref(fig:continental-map): (ref:continental-map-fig-cap)

Figure \@ref(fig:inset-map): (ref:inset-map-fig-cap)

Figure \@ref(fig:density-charts): (ref:density-charts-fig-cap)

Figure \@ref(fig:state-violin): (ref:state-violin-fig-cap)


```{r}
# merge data together
if(!is_preview){
  write.csv(x=clean_data_fpl,file="CohortData_FederalPovertyLine.csv")
  write.csv(x=clean_data_ami,file="CohortData_AreaMedianIncome.csv")
  write.csv(x=replica_sup,file="CensusTractData.csv")
}
# save as csv

```


<!--chapter:end:net_energy_equity_final_review.Rmd-->

---
title: Net energy metrics reveal striking disparities across United States household energy burdens
subtitle: 
titlerunning: Net Energy Equity
# authorrunning: Scheier & Kittner
# thanks:
# author:
#  - Eric Scheier:
#      institute: e3p
#  - name: Noah Kittner
#    email: kittner@unc.edu
#    institute: [gillings, planning, e3p]
#    correspondence: true
# institute:
#  - e3p: Environment, Ecology, and Energy Program, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
#  - gillings: Department of Environmental Sciences and Engineering, Gillings School of Global Public Health, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
#  - planning: Department of City and Regional Planning, The University of North Carolina at Chapel Hill, Chapel Hill, NC, USA
keywords:
  - energy burden
  - net energy
  - macro-energy systems
  - energy inequality
bibliography: references.bib
bibstyle: spphys
csl: nature-no-et-al.csl
journalname: Nature Energy
date: "`r format(Sys.time(), '%d %B %Y')`"
toc: false
output:
  bookdown::pdf_document2:
    number_sections: false
    keep_tex: true
    documentclass: article
    pandoc_args:
      - '--lua-filter=color-text.lua'
      # - '--lua-filter=scholarly-metadata.lua'
      # - '--lua-filter=author-info-blocks.lua'
    includes:  
      in_header: preamble-latex.tex
  bookdown::html_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=color-text.lua'
  bookdown::word_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=color-text.lua'
      # - '--lua-filter=scholarly-metadata.lua'
      # - '--lua-filter=author-info-blocks.lua'
  bookdown::pdf_book:
    base_format: rticles::springer_article
    keep_tex: true
tables: true
fig_caption: true
always_allow_html: true
header-includes:
- \usepackage{booktabs}
- \usepackage[left]{lineno}
- \linenumbers
- \usepackage{setspace}
- \usepackage{xcolor}
- \usepackage{mathtools}
- \usepackage[normalem]{ulem}
- \usepackage{float}
# - \doublespacing
---

```{r setup, include=FALSE}
is_final=FALSE #TRUE
is_preview= TRUE #FALSE
is_draft= TRUE
set.seed(456)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','asis')),
                      fig.keep='all', #'last'
                      dev='cairo_pdf',#'pdf',
                      fig.show='hold',#'hide
                      # fig.pos = "!H",
                      # out.extra = "",
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=TRUE, #ifelse(is_draft, TRUE, ifelse(is_preview, TRUE, !is_final)),
                      cache.lazy=FALSE,
                      fig.margin=FALSE,
                      fig.fullwidth=TRUE, #FALSE
                      eval.after = "fig.cap"#,
                      # cache.path = 'net_energy_equity_cache/', 
                      # fig.path = 'net_energy_equity_files/'
                      )

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 
    "latex" else "pipe"
})

edit_color = "red" #"red" #"black
strike_show = "show" #"show" #"hide"
hide = "TRUE" #"FALSE"
```

```{r option-view, include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)

# knitr::opts_current$get(c(
#   "cache",
#   "cache.path",
#   "cache.rebuild",
#   "dependson",
#   "autodep"
# ))

kable(knitr::opts_chunk$get() %>% enframe())
```


```{r sources, cache=FALSE}
source("sources.R")
```

```{r parameters}
states <- "all" #c("ca","nc","sc") #
refresh <- FALSE
acs_version <- 2018
energy_burden_poverty_line <- 0.06
# geographic_scope <- "tract" #statecitycounty
```

```{r run-methods, cache=TRUE}
paper_methods(states=states,
              acs_version=acs_version,
              energy_burden_poverty_line=energy_burden_poverty_line,
              refresh=refresh)
```


```{r load-data}
income_metric <- "AMI" #"AMI" #"fpl15" #
geographic_scope <- "Census Tracts" #statecitycounty

version_text <- as.character(acs_version)
if(acs_version==2016){
  version_text <- "sh"
}

base_file_name <- tolower(paste(income_metric,
                                geographic_scope,
                                version_text,
                                paste(states,collapse="_",sep=""), sep = "_"))

clean_data_ami <- read_csv(paste0("data/very_clean_data_",base_file_name,".csv"), guess_max = 10^6)

income_metric <- "FPL"
base_file_name <- tolower(paste(income_metric,
                                geographic_scope,
                                version_text,
                                paste(states,collapse="_",sep=""), sep = "_"))
clean_data_fpl <- read_csv(paste0("data/very_clean_data_",base_file_name,".csv"), guess_max = 10^6)

tract_file_name <- paste0("data/",paste(states,collapse="_",sep=""),"_census_tracts.geojson")

census_tracts_shp <- st_read(tract_file_name)
replica_sup <- get_replica_supplemental_dataset()
tract_shp <- st_sf(left_join(census_tracts_shp, replica_sup, by=c("gisjoin")))
```

```{r}
# Things in here should probably be moved further up the data processing pipeline
# clean_data_ami$number_of_units <- as.factor(ifelse(clean_data_ami$min_units > 1, "mf", "sf"))
# clean_data_fpl$number_of_units <- as.factor(ifelse(clean_data_fpl$min_units > 1, "mf", "sf"))
```


```{r poverty-lines, eval=TRUE}

eroi_poverty_line <- eroi_func(g=1,
                               s=energy_burden_poverty_line)

average_energy_cost <- weighted.mean(clean_data_ami$energy_cost, 
                                     clean_data_ami$total_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.mean(clean_data_ami$total_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)

median_energy_cost <- weighted.median(clean_data_ami$energy_cost, 
                                     clean_data_ami$total_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$total_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)
# 12*(clean_data_ami$electricity_spend + 
#       clean_data_ami$gas_spend + 
#       clean_data_ami$other_spend)
# clean_data_ami$total_kWh <- clean_data_ami$gas_kWh + clean_data_ami$electricity_kWh
median_electricity_cost <- weighted.median(clean_data_ami$electricity_spend,
                              clean_data_ami$electricity_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$electricity_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)

median_gas_cost <- weighted.median(clean_data_ami$gas_spend, 
                                     clean_data_ami$gas_kWh*clean_data_ami$households, 
                                     na.rm = 
                                    T)/weighted.median(clean_data_ami$gas_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)
median_gas_cost_Mcf <- weighted.median(clean_data_ami$gas_spend, 
                                     clean_data_ami$gas_Mcf*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$gas_Mcf,
                                                              clean_data_ami$households,
                                                              na.rm = T)


ner_poverty_line_dlrs <- ner_func(g=1,
                                  s=energy_burden_poverty_line)

ner_poverty_line_mean <- ner_func(g=1,
                             s=energy_burden_poverty_line,
                             se=energy_burden_poverty_line/(average_energy_cost))

ner_poverty_line_median <- ner_func(g=1,
                             s=energy_burden_poverty_line,
                             se=median_energy_cost/energy_burden_poverty_line)

ner_poverty_line <- ner_poverty_line_dlrs #ner_poverty_line_median


dear_poverty_line <- dear_func(g=1,
                               s=energy_burden_poverty_line)

ner_dear_poverty_line <- dear_func(g=1+median_energy_cost*ner_poverty_line_median,
                               s=1)

ner_nice_fraction <- paste0(floor(ner_poverty_line),ifelse(floor(ner_poverty_line)==ner_poverty_line,"",paste0("\\ \\frac{",numerators(fractional(ner_poverty_line-floor(ner_poverty_line))),"}{",denominators(fractional(ner_poverty_line-floor(ner_poverty_line))),"}")))

ner_nice_text <- paste0(ifelse(ner_poverty_line==round(ner_poverty_line,0),"","\\approx"),round(ner_poverty_line))
```

```{r figure-parameters}
#chart_title <- "Household Economic Return on Energy Spending"
chart_title <- "Community Net Energy Return"
chart_subtitle <- "Net Earnings per Dollar of Energy Consumed"

group_columns <- NULL#"income_bracket")#in_poverty
                   #"primary_heating_fuel"

metric_name <- "ner" #"energy_burden" #"ner" #"dear" #"eroi"
metric_label <- "$/$"
metric_cutoff_level <- ner_poverty_line
metric_cutoff_label <- "Energy Poverty Line"

upper_quantile_view <- 1.0
lower_quantile_view <- 0.0
```

```{r top_metrics}
group_variable <- NULL# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

top_metrics <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.99, 
                         lower_quantile_view=0.00)
# head(top_metrics)
```


```{r grouped_weighted_metrics}
#data$GEOID <- sub('.', '', data$gisjoin)
group_variable <- "geoid"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

gwm <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)
# head(gwm)
```

```{r eval=TRUE}
fpl_graph_data <- filter_graph_data(clean_data_fpl, group_columns="in_poverty", metric_name)

fpl_top_metrics <- grouped_weighted_metrics(fpl_graph_data, 
                         group_columns="in_poverty", 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)

fpl_ep_data <- filter_graph_data(clean_data_fpl,
                                 group_columns=c("in_poverty",
                                                 "energy_burden_poverty"), 
                                 metric_name)

fpl_ep_top_metrics <- grouped_weighted_metrics(fpl_ep_data, 
                         group_columns=c("in_poverty",
                                                 "energy_burden_poverty"), 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)


# should replace this with weighted metrics data
# How many households are below the poverty line in this data?
total_households <- fpl_top_metrics$household_count

number_in_poverty <- fpl_top_metrics$households_below_cutoff

pct_in_poverty <- number_in_poverty / total_households

pct_of_ep_below_fpl <- fpl_top_metrics$households_below_cutoff[fpl_top_metrics$in_poverty=="Below Federal Poverty Line"] / sum(number_in_poverty)

# number_above_poverty <- sum((data$income_bracket!=poverty_cutoff) * (data$households))

pct_above_poverty <- 1 - pct_in_poverty

in_both_poverty <- pct_in_poverty[2]

in_only_energy_poverty <- pct_in_poverty[1]

energy_poverty_rate <- sum(number_in_poverty) / sum(total_households)

ami_graph_data <- filter_graph_data(clean_data_ami,
                                    group_columns=c("in_poverty",
                                                    "income_bracket"),
                                    metric_name)
ami_top_metrics <- grouped_weighted_metrics(ami_graph_data, 
                         group_columns=c("in_poverty",
                                         "income_bracket"), 
                         metric_name, 
                         metric_cutoff_level,
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)
```

<!-- \newpage -->

[Substantive edits based on peer-review are [`r edit_color`]{color=`r edit_color`}, with major standalone deletions denoted by [[`r edit_color` strikethrough]{strike=`r strike_show`}]{color=`r edit_color`}. Rearrangements of existing text order are not necessarily noted in this document.]{hide="FALSE"}

**Abstract: Energy inequity in the United States is an issue of increasing urgency. Few policy-relevant datasets evaluate the energy burden of typical American households. Here, we develop a framework using Net Energy Analysis and socioeconomic data at the household level to observe systematic energy inequity across the United States among critical groups that need policy attention. We find substantial instances of energy poverty in the United States -- `r scales::percent(energy_poverty_rate, accuracy=1)` of households experience energy poverty as presently defined as spending more than [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} of household income on energy expenditures. The Federal Poverty Line is not enough to capture the experience of energy inequity across the United States and excludes households that would benefit immensely from programs available to support low-income communities. While [`r scales::percent(in_both_poverty, accuracy=1)`]{color=`r edit_color`} of households below the Federal Poverty Line also face energy poverty, [more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` households]{color=`r edit_color`} above the Federal Poverty Line face this scarcity. We identify that energy expenditures across census tracts disproportionately burden Black, Hispanic, and Native American communities. For solar, wind, and energy efficiency to address socioeconomic mobility, programs must reduce relative energy expenditures by expanding eligibility requirements for support and access to improved conservation measures, efficiency upgrades, and distributed renewables. We recommend the United States  develop a more inclusive federal energy poverty categorization that provides greater assistance for household energy costs.**

Main Text:

Household energy use for services such as cooking[@mobarakLowDemandNontraditional2012] or space heating and cooling[@limaReviewRelationHousehold2020] is crucial for decent living conditions[@raoEnergyRequirementsDecent2019]. Unaffordable energy is a persistent trend[@brownPersistenceHighEnergy2020] that is negatively related to social cohesion, climate change responses, and disproportionate environmental impacts on low-income populations and minority groups [@carleyJusticeEquityImplications2020]. [Furthermore, e]{color=`r edit_color`}nergy inequity is not just a lack of money to meet basic energy needs - it is a lack of [access to the capabilities[@dayConceptualisingEnergyUse2016] that]{color=`r edit_color`} enable a sustainable and prosperous society built on just principles[[@sovacoolEnergyJusticeConceptual2015]]{color=`r edit_color`}. Energy inequity could have significant implications for navigating sustainable development and meeting societal goals around decarbonization and energy use. [In this study, we demonstrate the magnitude of energy inequity in the United States (US) using a novel metric informed by Net Energy Analysis (NEA). Without a set of inclusive indicators and data tools to examine energy inequity, many households that are at risk of energy poverty and injustice may remain unidentified. This analysis applies lessons from NEA to address energy poverty in the US.]{color=`r edit_color`}

[Many frameworks are currently being explored to understand energy poverty and equity, while differentiating between related concepts. In a thematic exploration of energy equity, Brown et al. identify energy access, energy poverty, energy insecurity, and energy burden as key concepts for understanding the issue[@brownLowincomeEnergyAffordability2020], but quantitative measurement of these concepts has been limited. Pachauri & Rao establish measures for the sustainable development context that incorporate periods when energy is available, the quality of voltage supplied, the reliability in terms of the number of disruptions, the capacity in terms of power available, the consumption levels allowed per day, and affordability of the standard consumption package as a percentage of household income[@pachauriAdvancingEnergyPoverty2020]. Energy metrics have been assessed quantitatively across several countries. Though some aspects, such as formal disconnections from energy service[@graffWhichHouseholdsAre2021], are translatable to the US context, these methods require normalizing many variables amongst different types of data and are overly broad for applications in areas where electricity access is relatively high and reliable.]{color=`r edit_color`}

[Of such areas, the United Kingdom (UK) has a richer history of incorporating energy poverty formally into its government programs: since 2000, the UK has used some form of an energy burden metric to assess whether households are facing energy poverty and determine the level of support that they require as a result[@bednarRecognitionResponseEnergy2020]. This metric has evolved from a simple ratio of household income and energy expenditures to one that incorporates building efficiency ratings and average incomes in the community. While the European Union (EU) currently lacks a unified metric for energy poverty, similar metrics have been developed in member countries, such as a metric which compares incomes and expenditures to local averages and absolute heating needs to determine energy poverty levels in Italy[@faiellaEnergyPovertyHow2021] or a multidimensional index of building quality and ability to pay bills in Poland[@sokolowskiMultidimensionalIndexMeasure2020].]{color=`r edit_color`}

[This study utilizes a new set of energy burden metrics based on net energy return to better represent the disparity across those who face significant energy burdens in the US with those who do not. Net energy helps display critical thresholds where more households face energy and income challenges.]{color=`r edit_color`} Prior research of household prosperity in limited global jurisdictions [using these sorts of measures]{color=`r edit_color`} has found that gender, age, housing age[@rossHighCostEnergy2018], tenure type[@mayerTwoFacesEnergy2014], energy inefficiency[@drehoblUSLowIncomeEnergy2016], education, employment[@linAffordabilityAccessFocus2018], geography[@linDoesEnergyPoverty2020], socioeconomic status[@bednarIntersectionEnergyJustice2017], race/ethnicity[@tongMeasuringSocialEquity2021], and macroeconomic conditions[@kawaiSpendingHouseholdEnergy2021] are associated with high energy burdens in various geographical areas. [The US lags in part due to a lack of metrics and tracking, and this paper develops a tool to show how net energy is a valuable resource to evaluate energy burden and inequality.]{color=`r edit_color`}

In the US, energy inequity is a significant challenge as families struggle to meet monthly bills and live paycheck to paycheck[@bednarRecognitionResponseEnergy2020]. There is a growing disparity between wealthier and lower-income households based on their abilities to meet basic energy needs[@brownLowincomeEnergyAffordability2020]. While per-unit residential energy prices have increased below the rate of inflation in the [US]{color=`r edit_color`} since the 1980s[@ShortTermEnergyOutlook2021], many households still struggle to make utility bill payments and are especially vulnerable to economic shocks[@kawaiSpendingHouseholdEnergy2021].

[Ross and Drehobl performed distinct urban[@drehoblUSLowIncomeEnergy2016] and rural[@rossHighCostEnergy2018] analyses to describe energy inequity in the US. While limited by geographic and demographic focus and a lack of peer-review, these studies have established the proportion of income (G) spent on energy expenditures (S), or energy burden (E~b~), as the standard benchmark for energy poverty in the US today (Equation 1).]{color=`r edit_color`} [The US Department of Energy (DOE) significantly improved upon Ross and Drehobl's underlying methodology by assembling its Low-Income Energy Affordability Dataset (LEAD)[@maLowIncomeEnergyAffordability2019], which estimates incomes and energy expenditures for most households in the US at a census tract scale.]{color=`r edit_color`}

\begin{align}
Energy\ Burden\ (E_{b})= \frac{S}{G}
\end{align}

[While a helpful place to start, E~B~ has certain drawbacks.]{color=`r edit_color`} Significantly, a simple proportion does not account for the fact that money spent on energy cannot be spent elsewhere and is therefore not useful income to the household for the purposes of measuring prosperity. Including gross income in E~b~ has the effect of depressing the average E~B~, by definition.

Furthermore, because energy expenditures are a small proportion of even the most impoverished households' total income, E~b~ is almost always a very small percentage (<10%). This leads to issues with interpretability in public discourse and policy settings and may even affect program outcomes that are based on E~b~ if small numbers are rounded to even the nearest hundredth of a percent. [As the UK experienced when using E~b~, i]{color=`r edit_color`}f the household is above an energy poverty line defined by such a metric for public policy purposes, the family may not receive critical support[[@bednarRecognitionResponseEnergy2020].[, or energy may be sidelined by other basic needs.]{strike=`r strike_show`}]{color=`r edit_color`}

Because such a small proportion of expenditures can impact different income groups so differently, ratios of this type can be useful when delineating across income quantiles or other categories - particularly for vulnerable populations where energy poverty poses a significant difficulty or affordability threshold not captured by measures of absolute poverty. However, E~b~ is often portrayed at a population scale (e.g., the average energy burden of the population is X%)[, which can be skewed by outliers within the population]{color=`r edit_color`}. Household metrics and surveys are important for further understanding of and policy development around issues of energy poverty. 

Finally, presenting the relationship between household income and energy expenditures as a proportion with income in the denominator suggests that improvements can only be made by decreasing energy expenditures or increasing incomes. However, in reality, there is a positive relationship between energy expenditures and incomes because energy is an input to wealth-creating processes[[and the unit costs of energy decrease as absolute consumption increases]{strike=`r strike_show`}]{color=`r edit_color`}. Households consume energy to unlock the utility that energy services provide to them as participants in society, whether to cook food or connect to the internet. This relationship is generally accepted when understanding individual household behavior[@thomasEstimatingDirectIndirect2013] and macro-economic effects of energy consumption[@saundersKhazzoomBrookesPostulateNeoclassical1992]. Therefore, a metric describing the efficiency of household wealth creation may be more intuitive with income in the numerator.

[[Therefore, stakeholders relying solely on energy burden have limited knowledge of which historical interventions have effectively promoted the energy system's success and a limited ability to design new interventions to promote community growth and address inequity in the energy system.]{strike=`r strike_show`}]{color=`r edit_color`}

NEA offers potential support to understanding energy equity through the use of formally defined Energy Return Ratios (ERRs) that articulate the relationships among energy flows within complex systems[[[@carbajales-daleBetterCurrencyInvesting2014]. The properties of numerous metrics have been explored through this lens to date]{strike=`r strike_show`}]{color=`r edit_color`}[@brandtGeneralMathematicalFramework2011]. Net Energy Return (NER), which describes the newly released potential to do work as a result of some activity, is recommended as a basis for future analysis[@carbajales-daleBetterCurrencyInvesting2014], especially in the study of macro-energy systems like the US residential housing stock[@leviMacroEnergySystemsNew2019]. [The main contribution of the study is the application of NER as an indicator of household energy poverty.]{color=`r edit_color`} [[Treating the income remaining after energy expenditures (i.e., net income) as the focus of analysis to avoid the double-counting of energy expenditures, and portray net income as a result of energy consumption rather than a cause.]{strike=`r strike_show`}]{color="red"}

Here, we [use LEAD to]{color=`r edit_color`} examine the relationship between energy spending and household income [spatially]{color=`r edit_color`} for [most households]{color=`r edit_color`} in the [US at a census tract scale]{color=`r edit_color`}, with particular emphasis on how disparate household NERs signal economic disparities across [socio-demographic characteristics such as]{color=`r edit_color`} race and ethnicity, income, and housing tenure. This empirical analysis fills a gap in the current discussion about energy equity by providing a [[biophysical]{strike=`r strike_show`}]{color=`r edit_color`} framework to evaluate the disparities among household net energy outcomes [that is aligned with the assessment of energy flows through biological, physical, and economic systems[@hallEnergyWealthNations2018]]{color=`r edit_color`}.

[[This gap is not just a financial issue - many of the households living in poverty lack the agency to perform efficiency upgrades or technology enhancements that could decrease the gap between wealthy and poor households[@tbd].]{strike=`r strike_show`}]{color=`r edit_color`}

[[Rooftop solar may be capital intensive, although the investments may recoup costs[@tbd]. Similarly, for households living in older buildings, the ability improve building ventilation systems and energy efficiency may require awareness and resources left out from current policies[@].]{strike=`r strike_show`}]{color=`r edit_color`}

[[Even though low-interest loans may be available for solar or efficiency upgrades in some communities, the bureaucracy and institutional inertia hold back a more rapid transition. In other examples, such as Property Assessed Clean Energy (PACE) programs implemented in Missouri, loans intended to support low-income homes with energy efficiency improvements allowed predatory lenders to charge high-interest rates (9-10%) and claim first lien on property taxes, leading to a spate of foreclosures [@coryneStateSupportedCleanEnergy].]{strike=`r strike_show`}]{color=`r edit_color`}

#### Applying Net Energy Return to Energy Equity  {#ratios}

Previous work defines the [NER]{color=`r edit_color`} of a process as a relationship between the gross amount of energy extracted and the amount of embodied energy directed toward extraction[@brandtCalculatingSystemsscaleEnergy2013]. [For households extracting income from the economy, these ratios can be composed of gross income (G) and spending on energy (S)]{color=`r edit_color`}.

[Household NER (N~h~)]{color=`r edit_color`} represents the net earnings a household receives for every expenditure on secondary energy, defined according to Equation 2.

\begin{align}
Household\ Net\ Energy\ Return\ (N_{h}) = \frac{G - S}{S}
\end{align}

The NER is the standard metric of NEA because it reflects the role of energy as an input to a value-generating process in ecosystems[@brandtHowDoesEnergy2017]. E~b~ is the metric of choice in the energy insecurity literature due to its [presumed]{color=`r edit_color`} interpretability as a percentage[@rossHighCostEnergy2018]^,^ [@bednarIntersectionEnergyJustice2017]^,^ [@drehoblUSLowIncomeEnergy2016]^,^ [@kawaiSpendingHouseholdEnergy2021]

```{r metric-comparison-data}
eb_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% 
                                            mutate(energy_burden = round(100*energy_burden,digits=1)),
                                          group_columns = c("energy_burden","income_bracket"), 
                                          metric_name="net_income", 
                                          metric_cutoff_level = energy_burden_poverty_line) %>% 
  mutate(metric_name="Energy Burden (%)") %>% 
  rename(energy_metric=energy_burden) #%>% 
  # mutate(energy_metric=100*energy_metric)

ner_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% mutate(ner = round(ner,digits=0)), 
                                     group_columns = c("ner","income_bracket"), 
                                     metric_name="net_income", 
                                     metric_cutoff_level = ner_poverty_line) %>% 
  mutate(metric_name="Net Energy Return ($/$)") %>% rename(energy_metric=ner)

comparison_chart_data <- rbind(eb_chart_data,ner_chart_data)

metric_comparison_net_income_lbound <- -1000
metric_comparison_net_income_ubound <- 6*10^4
metric_comparison_x_axis_lbound <- -10
metric_comparison_x_axis_ubound <- 400
metric_comparison_pct <- sum(comparison_chart_data$household_count[
  comparison_chart_data$energy_metric <= metric_comparison_x_axis_ubound & 
    comparison_chart_data$energy_metric >= metric_comparison_x_axis_lbound & 
    comparison_chart_data$metric_mean <= metric_comparison_net_income_ubound & 
    comparison_chart_data$metric_mean >= metric_comparison_net_income_lbound & 
    !is.na(comparison_chart_data$metric_mean) & 
    is.finite(comparison_chart_data$metric_mean)]) / 
  sum(comparison_chart_data$household_count)

comparison_chart <- comparison_chart_data %>% 
  ggplot(aes(x=energy_metric, y=metric_mean, fill=income_bracket, color=income_bracket)) +
  # scale_x_continuous(trans=scales::pseudo_log_trans(base = 10)) +
  scale_y_continuous(labels=scales::dollar_format()) + 
  ggrastr::rasterise(geom_point(aes(size=household_count), 
                                alpha=0.25, 
                                position="jitter")) + 
  scale_fill_discrete(name="Income Bracket") + 
  scale_color_discrete(name="Income Bracket") + 
  scale_size_continuous(name="Households", labels=scales::label_comma()) + 
  # geom_hline(yintercept = .1) + 
  # geom_vline(xintercept = 9) + 
  # geom_smooth(method="lm",#NULL,#
  #             mapping=aes(weight=household_count),
  #             # formula=y~,
  #             se=FALSE,
  #             fullrange=TRUE,
  #             linetype="solid",
  #             alpha=0.75
  #             ) + 
  facet_grid(cols=vars(metric_name), switch="x", scales="free_x") +#, space="free_x") + 
  theme_bw() +
  labs(title = "Energy Burden and Net Energy Return in US Households", 
       x="Energy Metric", 
       y="Household Annual Net Income ($)") + 
  theme(legend.position = c(.3,.6),
        legend.background = element_rect(fill = "#ffffffaa", colour = NA), 
        legend.key.size = unit(10, "points")#,
        # legend.justification = c(0, 0)
        )+
  coord_cartesian(#xlim=c(0,120),
               ylim=c(metric_comparison_net_income_lbound,
                      metric_comparison_net_income_ubound),
               xlim=c(metric_comparison_x_axis_lbound,
                      metric_comparison_x_axis_ubound),
               # default=FALSE,
               expand=TRUE)
```


While most [ERRs]{color=`r edit_color`}, including NER, are hyperbolic paraboloids, NER has several useful mathematical properties: it can smoothly handle systems with negative incomes and energy costs, accept households with zero income, and emphasize extreme incomes and energy costs in an interpretable fashion, as shown in Figure \@ref(fig:metric-comparison). [While E~b~ appears inversely correlated to income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes (approximately n=`r to_big(round(clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum(),-3))` households in the dataset have E~b~>100% or E~b~<0%). Due to the structure of the E~b~ equation (Equation 1), the E~b~ of these households approaches infinity and cannot be captured on the standard 0-100% scale the metric is intended to be interpreted within: around `r to_big(round(clean_data_fpl$households[!is.finite(clean_data_fpl$energy_burden)] %>% sum(),-3))` homes have an infinite energy burden. Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. N~h~ provides a framing of the same dataset that allows for exploration of most households on a similar scale without the long tail. N~h~ appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing N~h~ avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, N~h~ offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent. Many households with moderate-to-high E~b~s are actually higher-income households with high energy expenditures, making their N~h~s quite high (e.g., >\$100 of income per \$1 of energy spending). Almost `r to_percent(metric_comparison_pct)` of the households in the dataset have net incomes between `r to_dollar(metric_comparison_net_income_lbound)` and `r to_dollar(metric_comparison_net_income_ubound)`, with N~h~s (or E~b~s) of between `r metric_comparison_x_axis_lbound` (`r to_percent(metric_comparison_x_axis_lbound/100)`) and `r metric_comparison_x_axis_ubound` (`r to_percent(metric_comparison_x_axis_ubound/100)`).]{color=`r edit_color`} Only households with no energy costs are excluded from the analysis, whereas households with no energy costs or incomes must be excluded from an analysis utilizing E~b~.

(ref:metric-comparison-fig-cap) Display of the relationship between [E~b~]{color=`r edit_color`} and [N~h~]{color=`r edit_color`} with net income (gross income - energy expenditures) for US households. While [E~b~]{color=`r edit_color`} appears inversely correlated to net income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the [E~b~]{color=`r edit_color`} equation (Equation 1), the [E~b~]{color=`r edit_color`} of these households approaches infinity [and cannot be captured on the standard 0-100% scale the metric is intended to be interpreted within]{color=`r edit_color`}. Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. [N~h~]{color=`r edit_color`} frames the same dataset on a scale without the long tail. [N~h~]{color=`r edit_color`} appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing [N~h~]{color=`r edit_color`} avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, [N~h~]{color=`r edit_color`} offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent: many households with moderate-to-high E~b~s are actually higher-income households with high energy expenditures, making their [N~h~]{color=`r edit_color`}s quite high (e.g., >\$100 of income per \$1 of energy spending)[, which is only visible on an N~h~ scale]{color=`r edit_color`}.

```{r metric-comparison, include=TRUE, results='asis', fig.cap='(ref:metric-comparison-fig-cap)'}
metric_comparison_fig_cap_old <- paste0("Display of the relationship between ",colorize("E~b~",edit_color)," and ",colorize("N~h~",edit_color)," with net income (gross income - energy expenditures) for US households. While E~b~ appears inversely correlated to net income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the E~b~ equation (Equation 1), the E~b~ of these households approaches infinity ",colorize("and cannot be captured on the standard 0-100\\% scale the metric is intended to be interpreted within",edit_color),". Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. N~h~ frames the same dataset on a scale without the long tail. N~h~ appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing N~h~ avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, N~h~ offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent: many households with moderate-to-high E~b~s are actually higher-income households with high energy expenditures, making their N~h~s quite high (e.g., >\\$100 of income per \\$1 of energy spending)",colorize(", which is only visible on an N~h~ scale",edit_color),".")

comparison_chart
```

For the discussion of household energy poverty, we are primarily interested in how households of different characteristics are distributed according to their [N~h~]{color=`r edit_color`}s, representing how many net dollars are earned by a household for every dollar it spends on energy. Since the N~h~ is unitless but is a ratio of return on investment, we present it below interchangeably with no units or in units of $\$/\$$ depending on context. Other proposed indicators of energy poverty may be similarly examined in this manner. 


#### Application to Energy Poverty  {#poverty-line}

[While a variety of thresholds have been developed and explored, energy-poor households in the US are]{color=`r edit_color`} commonly defined in terms of E~b~ as [those with]{color=`r edit_color`} an expenditure of greater than [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} of household income on energy [based on the logic that energy expenditures should not be greater than 20% of housing expenses, which themselves should not exceed 30% of household income[@brownLowincomeEnergyAffordability2020]]{color=`r edit_color`}. Calibrating our [N~h~]{color=`r edit_color`} analysis to this level will help gauge different thresholds of energy poverty and benchmark the results of this paper to the energy poverty literature while acknowledging the continuum of experiences across household energy consumption. Translated into its relative level for [N~h~]{color=`r edit_color`}, the energy poverty line N~h~* is defined according to Equation 3 as `r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r round(ner_poverty_line,0)`.

\begin{gather}
\nonumber E_{B}^{*} = \frac{S}{G} = `r colorize(100*energy_burden_poverty_line, edit_color)`\%\\
N_{h}^{*} = \frac{G-S}{S}\ such\ that \ \frac{S}{G} = `r colorize(100*energy_burden_poverty_line,edit_color)`\%\\
\nonumber N_{h}^{*} `r ner_nice_text`\Rightarrow Household\ at\ Energy\ Poverty\ Line
\end{gather}

This means that a household that earns less than [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r to_dollar(ner_poverty_line)`]{color=`r edit_color`} of income for every dollar it spends on secondary energy will be considered to be in energy poverty by the traditional E~b~ accounting method. An N~h~ of [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r round(ner_poverty_line,0)`]{color=`r edit_color`} or lower is equivalent to an E~b~ of [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} or higher. This threshold is arbitrary and may not be suitable in situations where households fall very close to this line or where the numbers of family members or measures of certain building characteristics vary widely. Simply, it is presented as a benchmark. We examine the [N~h~]{color=`r edit_color`} at a community scale across the [US]{color=`r edit_color`} in Table 1.


#### The US Household Net Energy Landscape  {#landscape}


```{r comparison-table-math}
# table with states'/groups' median annual household energy expenditures, incomes, net incomes, N~h~, and E~b~
compare_metrics <- function(metric_name="ner"){
  gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami,c("income_bracket"),metric_name),
                           c("income_bracket"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)
  gwm$metric_name <- metric_name
  return(gwm)
}

compare_table <- rbindlist(lapply(c("income",
                                    "energy_cost",
                                    # "energy_burden",
                                    "net_income"#,
                                    # "ner"
                                    ), compare_metrics))

compare_table_totals <- compare_table %>% 
  filter(metric_name=="income") %>% 
  pivot_wider(id_cols=income_bracket,
              names_from=metric_name,
              values_from=household_count,
              ) %>% 
  rename(households=income) %>% pivot_longer(cols="households")

compare_table <- compare_table %>% 
  pivot_wider(id_cols=income_bracket,
              names_from=metric_name,
              values_from=metric_mean) %>% 
  mutate(energy_burden = energy_burden_func(g=income, s=energy_cost),
         ner = ner_func(g=income, s=energy_cost)) %>% 
  pivot_longer(cols=c("income","energy_cost","energy_burden","net_income","ner"))

compare_table <- rbind(compare_table_totals, compare_table)

#format the metrics accordingly
# income = 0 decimal place $
# energy_cost = 0 decimal place $
# energy_burden = 0 decimal place %
# net_income = 0 decimal place $
# ner = 1 decimal place number

which_metric <- "value" #"metric_mean" #"metric_median"

compare_table$print_value <- ifelse(compare_table$name %in% c("income",
                                                                     "energy_cost",
                                                                     "net_income"),
                                    to_dollar(compare_table[[which_metric]],latex=TRUE),
                                    ifelse(compare_table$name %in% c("energy_burden"),
                                           to_percent(compare_table[[which_metric]],latex=TRUE),
                                           ifelse(compare_table$name %in% c("ner"),
                                                  round(compare_table[[which_metric]],1),
                                                  ifelse(compare_table$name %in% c("households"),
                                                         to_million(compare_table[[which_metric]]),
                                                  to_big(compare_table[[which_metric]])))))

compare_table$display_income_bracket <- dplyr::recode_factor(compare_table$income_bracket, 
                                       very_low="0-30\\% AMI",
                                       low_mod="30-80\\% AMI", 
                                       mid_high="Above 80\\% AMI",
                                       All="All",
                                       .ordered=TRUE)

energy_burden_label <- "E\\textsubscript{b} (S/G)" #if html etc. <- "E~b~ (S/G)"
ner_label <- "N\\textsubscript{h} ([G-S]/S)" #if html etc. <- "N~h~ ([G-S]/S)"

compare_table[,"Metric Name"] <- dplyr::recode(compare_table$name,
                                               households="Households in Sample",
                                    income="Annual Income (G)",
                                    energy_cost="Annual Energy Expenditures (S)",
                                    energy_burden=energy_burden_label,
                                    net_income="Net Income (G-S)",
                                    ner=ner_label)

print_table <- compare_table[,c("Metric Name","display_income_bracket","print_value")] %>% 
  arrange(display_income_bracket) %>% 
  pivot_wider(names_from=display_income_bracket,values_from=print_value)

write_csv(print_table, "comparison_table.csv")

highlight_metrics <- rbindlist(lapply(c(
                                    "energy_burden",
                                    "ner"
                                    ), compare_metrics))

highlight_energy_burden <- as.numeric(highlight_metrics[metric_name=="energy_burden" & income_bracket=="very_low","metric_mean"])

highlight_ner <- as.numeric(highlight_metrics[metric_name=="ner" & income_bracket=="very_low","metric_mean"])

num_one <- paste0(to_big(highlight_energy_burden*100),"\\%")
num_two <- round(highlight_ner,1)
# glue::glue(
```


```{r}
total_homes <- tidycensus::get_acs(geography = "us",
                    variables = c(households="B25002_002"),
                    year = acs_version)
# head(total_homes)
estimated_homes <- compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","value"]
min_homes <- total_homes$estimate - total_homes$moe
max_homes <- total_homes$estimate + total_homes$moe
```


[We use LEAD[@maLowIncomeEnergyAffordability2019] (n=`r compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","print_value"]` households) to evaluate the N~h~ dynamics across the US. The average US home in the dataset]{color=`r edit_color`} has an income of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="income","print_value"]` and an annual energy expenditure of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","print_value"]` (`r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","value"])/12)`/month), which equates to an average E~b~ of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_burden","print_value"]` or an average [N~h~]{color=`r edit_color`} of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="ner","print_value"]`. While the dataset slightly overrepresents households below the median income due to the limitations of the statistical methods used to compile them, it represents estimates for approximately `r to_percent(as.numeric(estimated_homes/(max_homes)))`-`r to_percent(as.numeric(estimated_homes/(min_homes)))` of the `r to_million(min_homes, suffix="")`-`r to_million(max_homes)` family-occupied households evaluated by the American Community Survey. Table 1 shows a summary of these data for households and their average statistics [delineated by their]{color=`r edit_color`} incomes relative to [the median income of similar size families in the same metropolitan area or non-metropolitan county, known as]{color=`r edit_color`} Area Median Income (AMI). We can see that high burdens are found mostly in the very-low-income group, with an average E~b~ of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` or [N~h~]{color=`r edit_color`} of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="ner","print_value"]`. Income drives the escape from energy poverty: middle and high-income groups do not spend drastically different amounts on energy (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` and `r to_percent(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` more, respectively) but earn `r to_big(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` and `r to_big(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` times that of the very low-income group, respectively. An E~b~ of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` means that `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month is spent on energy, which is quite high on a monthly income of `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"])/12)`. The additional `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month that the next rung of moderate-income groups spends on energy represents a minuscule proportion of their income (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"]))`).


(ref:comparison-table-caption) Average annual household energy expenditures, incomes, net incomes, [N~h~]{color=`r edit_color`}s, and [E~b~]{color=`r edit_color`}s portrayed for different income groups based on their relationship to [AMI]{color=`r edit_color`}. Note that the statistics for [E~b~]{color=`r edit_color`} and [N~h~]{color=`r edit_color`} are calculated per cohort after averaging the income and expenditure statistics to avoid the effect of extreme values skewing the interpretability of these metrics as described in the text. For example, the actual weighted average [E~b~]{color=`r edit_color`} for households from 0-30% AMI is `r num_one`, and the average [N~h~]{color=`r edit_color`} for this cohort is `r num_two` due to subsets of the dataset with very low incomes or low energy expenditures. [N~h~]{color=`r edit_color`} is not as susceptible to this skewing effect.

```{r comparison-table, include=TRUE, results="asis"}
final_table <- subset(print_table, select=-All) %>%  
  knitr::kable(booktabs=T,
               escape = F,
               caption='(ref:comparison-table-caption)') %>% 
  kableExtra::kable_styling(latex_options = "H") %>% 
  kableExtra::row_spec(c(2,3,4,6), bold=T)
  # kableExtra::kable_styling(latex_options = c("striped"), #,"hold_position"
                            # position="center")
final_table
```

[[Because cleaner investments could lower costs over time, we can immediately see a disproportionate burden for those making low income to shifting expenditures to other forms of fuel if any upfront investment is required. Fossil fuel costs are not internalized, so it seems like lower-income cohorts are paying less monetarily. Still, they are paying the costs in other ways, such as through health and environmental externalities. Even without these externalities priced in, the burden of energy for low-income groups is already very high.]{strike=`r strike_show`}]{color=`r edit_color`}

[Another contribution of this work is that by using N~h~, we can display these data spatially across the US to explore how different communities are experiencing energy outcomes as in Figure \@ref(fig:continental-map) and investigate specific communities at multiple scales such as census tract, county, state, and regional as in Figure \@ref(fig:inset-map). Furthermore, we can break down the data among meaningful subsets as in Figure \@ref(fig:density-charts) and examine state-by-state trends as in Figure \@ref(fig:state-violin). This is useful because the presence of energy inequity is harder to see in urban areas compared to rural areas for which census tracts are a larger physical area or when certain household characteristics such as primary heating fuel are related to widely differing energy outcomes in the same area. Additionally, it shows a spatial variation of energy poverty that includes `r to_million(number_in_poverty[1]+clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum())` more households that would not be captured by traditional poverty metrics because their incomes are too low (E~b~>100%) or too high (above the FPL). By processing disparate data sources into a coherent structure and providing a convenient open-source tool for others to do the same, these data can be used in urban planning, public policy, and other relevant contexts.]{color=`r edit_color`}

Displayed geospatially in Figure \@ref(fig:continental-map), the Black Belt in the American Southeast is visibly perceptible [as an area of high burden]{color=`r edit_color`}, indicating that low-N~h~ follows racial lines[[in areas where inexpensive energy is available, and burdens are more dependent on housing quality and patterns of consumption than they are dependent on price]{strike=`r strike_show`}]{color=`r edit_color`}. Likewise, border populations and immigrant populated areas in the Southwest have higher burdens, as do Native American lands. [[The use of heating oil in the Northeast states such as Maine can be seen through the prevalance of low-N~h~ communities in this area since heating oil is a notably expensive and inefficient source of heating commonly used in this region]{strike=`r strike_show`} High burdens can also be seen in rural Northeast states where heating burdens are high]{color=`r edit_color`}. [N~h~ allows a nuanced view of these widely ranging income dynamics by portraying them on a scale that matches the scope of the issues: areas of high energy burden (close to N~h~=0) are visible in orange while highly affluent areas are also visually perceptible as dark blue even though these groups' average metrics are multiple orders of magnitude apart.]{color=`r edit_color`}

(ref:continental-map-fig-cap) Map of the average net earned income per secondary energy expenditure for each census tract in the continental [US]{color=`r edit_color`}. Shades of yellow and red[, respectively,]{color=`r edit_color`} indicate communities at or below the energy poverty line as defined by earning [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately ")` `r round(ner_poverty_line,0)`]{color=`r edit_color`} dollars or less in income per dollar of energy expenditures. This corresponds to the traditional definition of energy poverty as spending [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} or more of income on energy. Low [N~h~]{color=`r edit_color`}s can be starkly observed in the Black Belt across the Southeastern US, Hispanic communities near the US-Mexico border, Native American lands, and rural New England.

```{r continental-map, include=TRUE, results='asis', fig.cap='(ref:continental-map-fig-cap)'}

old_continental_map_fig_cap <- paste0("Map of the average net earned income per secondary energy expenditure for each census tract in the continental ",
                                  colorize("US",edit_color),
                                  ". Shades of yellow and red",
                                  colorize(",respectively,",edit_color),
                                  " indicate communities at or below the energy poverty line as defined by earning ",
                                  ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately "),
                                  round(ner_poverty_line,0),
                                  " dollars or less in income per dollar of energy expenditures. This corresponds to the traditional definition of energy poverty as spending ",
                                  to_percent(energy_burden_poverty_line),
                                  " or more of income on energy. Low ",
                                  colorize("N~h~",edit_color),
                                  "s can be starkly observed in the Black Belt across the Southeastern US, Hispanic communities near the US-Mexico border, Native American lands, and rural New England.")

continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))
# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

# full_map_data <- left_join(tract_shp, gwm, by=c("geoid"))

map_data <- left_join(continental_shp, gwm, by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(graph_data %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens Across the US"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = TRUE,
    metric_long_name = bquote(N[h]) #"Net\nEnergy Return"
      )

choropleth_chart
```

Urban inequity results in lower N~h~ populations not showing up in many dense or gentrified urban areas such as the San Francisco Bay Area, New York City, and New Orleans, as shown in Figure \@ref(fig:inset-map). [[A notable exception to this trend is Detroit, in which t]{strike=`r strike_show`}T]{color=`r edit_color`}he pervasiveness of urban energy poverty [in Detroit]{color=`r edit_color`} has been studied extensively and shown to have distinct geographic boundaries [down to the street level]{color=`r edit_color`}[@bednarIntersectionEnergyJustice2017]. While some of these conclusions are supported by existing evidence and literature, they should be confirmed with a rigorous analysis of this dataset using the N~h~ metric for the reasons explained in [Applying NER to Energy Equity](#ratios)[: extremely low-income households are not visible on a 0-100% scale, and households with no income are often discarded as outliers.]{color=`r edit_color`} Additional analyses should incorporate additional demographic and household dimensions due to potential disparities within census tracts since diverse neighborhoods may not be represented accurately by aggregate census tract metrics.

(ref:inset-map-fig-cap) An inset focused on the city of New Orleans, Louisiana (Orleans Parish), showing an example of the dynamics of energy poverty in an urban area where the presence of energy inequity is harder to see compared to rural areas for which census tracts are a larger physical area.

```{r inset-map, include=TRUE, results='asis', fig.cap='(ref:inset-map-fig-cap)'}

old_inset_map_fig_cap <- "An inset focused on the city of New Orleans, Louisiana (Orleans Parish), showing an example of the dynamics of energy poverty in an urban area where the presence of energy inequity is harder to see compared to rural areas for which census tracts are a larger physical area."

nola_msa_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish")

nola_csa_parishes <- c(nola_msa_parishes, 
                       "Tangipahoa Parish",
                       "Washington Parish")

nola_rpc_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   # "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish",
                   "Tangipahoa Parish")

orleans_and_neighbors <- c("Orleans Parish",
                           "St. Tammany Parish",
                           "Jefferson Parish",
                           "Plaquemines Parish", 
                   "St. Bernard Parish"
                           )

inset_map_data <- map_data %>% filter(county_name=="Orleans Parish"
                                     & state_abbr=="LA")

inset_bb <- st_buffer(st_as_sfc(st_bbox(inset_map_data)) %>% st_transform(3857), dist=10)

choropleth_chart_highlight <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    legend_position = "none"
    ) + 
  geom_sf(data = inset_bb, fill = NA, color = "blue", size = 0.2)

# https://en.wikipedia.org/wiki/New_Orleans_metropolitan_area
choropleth_chart_inset <- choropleth_map(
    clean_data=inset_map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="Inset of Energy Burdens in New Orleans, Louisiana",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    legend_position = c(.85,.4),
    include_compass = TRUE,
    metric_long_name = bquote(N[h]))

gg_inset_map = ggdraw() +
  draw_plot(choropleth_chart_inset) +
  draw_plot(choropleth_chart_highlight, x = 0.1, y = 0.65, width = 0.35, height = 0.35)

gg_inset_map
# ggsave2("national_map.pdf",plot=choropleth_chart)
# ggsave2("inset_map.pdf",plot=gg_inset_map)

# grid.arrange(choropleth_chart,gg_inset_map, nrow=2)
# cowplot::plot_grid(choropleth_chart,gg_inset_map, align = "v", nrow=2)
```

From this high level, we can see in Figure \@ref(fig:density-charts)[.a]{color=`r edit_color`} that approximately `r scales::percent(energy_poverty_rate, accuracy=1)` of households in the [US]{color=`r edit_color`} experience energy poverty. Displaying these communities defined by their relationship to the US Federal Poverty Line (FPL), which indicates income poverty status according to government policy, in [Figure \@ref(fig:density-charts).b]{color=`r edit_color`} provides a stark picture. While `r scales::percent(in_both_poverty, accuracy=1)` of households below the FPL also face energy poverty, [more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` of those households]{color=`r edit_color`} above the FPL face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap [and the inadequacy of FPL as an indicator of energy poverty in particular]{color=`r edit_color`}. When we break the group of relatively prosperous households into subsets [as outlined in Table 1]{color=`r edit_color`}, we find that `r scales::percent(as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","households_below_cutoff"])/as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","household_count"]),accuracy=1)` of households living at 30-80% of their [AMI]{color=`r edit_color`} are experiencing energy poverty. This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in [N~h~]{color=`r edit_color`} on the households’ energy investments is surprising.

```{r}
clean_data_fpl$simplified_primary_heating_fuel <- as.factor(ifelse(clean_data_fpl$primary_heating_fuel=="ELECTRICITY",
                                                              "Electricity", 
                                                               ifelse(clean_data_fpl$primary_heating_fuel %in% 
                                                                        c("UTILITY GAS","BOTTLED GAS"),
                                                                      "Gas",
                                                    ifelse(clean_data_fpl$primary_heating_fuel=="SOLAR",
                                                           "Solar",
                                                                      "Other"))))

clean_data_fpl$super_simplified_primary_heating_fuel <- 
  as.factor(ifelse(clean_data_fpl$primary_heating_fuel=="SOLAR",
                                                           "Solar",
                                                                      "Other"))


clean_data_ami$all <- as.factor("all")

clean_data_ami <- dplyr::left_join(clean_data_ami, replica_sup[c("geoid","company_ty","locale")], by=c("geoid"))

clean_data_ami$simplified_utility_type <- ifelse(clean_data_ami$company_ty %in% c("Coop","DistCoop"),
                                                 "Cooperatively Owned",
                                                 ifelse(clean_data_ami$company_ty %in% c("Federal",
                                                                                         "Muni",
                                                                                         "State"),
                                                        "Government Owned",
                                                        ifelse(clean_data_ami$company_ty %in% 
                                                                 c("Private","PSubdiv"),
                                                               "Privately Held",
                                                               ifelse(clean_data_ami$company_ty=="IOU",
                                                                      "Publicly Held",
                                                                      "Other")
                                                               )
                                                        ))

clean_data_ami$simplified_locale <- sub(" .*", "", clean_data_ami$locale)
```


```{r}
top_line_group <- NULL

p1 <-   density_chart(graph_data, 
                                 metric_name, 
                                 metric_label="", 
                                 group_columns=top_line_group, 
                                 metric_cutoff_level, 
                                 metric_cutoff_label, 
                                 chart_title=NULL, 
                                 chart_subtitle=NULL,
                                 x_label="a")
```

```{r}
top_line_group <- "income_bracket"

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="b")
p2=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="c")
p3=top_line_charts[["density"]]
p3_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("super_simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="c")

fuel_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("super_simplified_primary_heating_fuel",
                    "income_bracket")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="c")

fuel_income_stats=top_line_charts[["metrics"]]
```


[Figure \@ref(fig:density-charts).c shows that h]{color=`r edit_color`}ouseholds with solar as a primary heating fuel have a higher [N~h~ (N~h~=`r round(fuel_stats$metric_mean[fuel_stats$super_simplified_primary_heating_fuel=="Solar"],0)`)]{color=`r edit_color`} than those which rely on other fuel sources [(N~h~=`r round(fuel_stats$metric_mean[fuel_stats$super_simplified_primary_heating_fuel=="Other"],0)`)]{color=`r edit_color`}, [even for]{color=`r edit_color`} households far below the energy poverty line[: the average N~h~ for energy-impoverished households utilizing solar power is `r round(fuel_income_stats$metric_mean[fuel_income_stats$super_simplified_primary_heating_fuel=="Solar" & fuel_income_stats$income_bracket=="Below Federal Poverty Line"],0)`, compared to `r round(fuel_income_stats$metric_mean[fuel_income_stats$super_simplified_primary_heating_fuel=="Other" & fuel_income_stats$income_bracket=="Below Federal Poverty Line"],0)` for those relying on any other fuel source]{color=`r edit_color`}. [The slope of the N~h~ density lines in Figure \@ref(fig:density-charts).c indicates that these lower-income households seem to experience a different rate of return on N~h~ from the benefits of increased energy adoption than higher-income households.]{color=`r edit_color`} Why are [certain]{color=`r edit_color`} households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households' low consumption, meaning that the potential savings from [implementing energy efficiency measures]{color=`r edit_color`} are lower than for high-income households [according to the prebound effect identified by Sunikka-Blank and Galvin [@sunikka-blankIntroducingPreboundEffect2012] and Cong et al.[@congEnergyEquityGap2021]]{color=`r edit_color`}. Despite technological progress and rapid declines in technology costs and availability for cleaner, renewable electricity generation options such as solar photovoltaics and energy storage, many households cannot take advantage. Most households do not have access to advancements such as low-cost rooftop solar or energy efficiency upgrades that improve air quality, lower greenhouse gas emissions, and save money[@castellanosRooftopSolarPhotovoltaic2017][: only 18% of households that have adopted rooftop solar have been below the median household income in the US [@barboseIncomeTrendsResidential2020]]{color=`r edit_color`}.

```{r}
top_line_group <- c("number_of_units")
# c("number_of_units", "occupancy_type"),
#                           c("occupancy_type", "income_bracket"),
#                           c("number_of_units", "occupancy_type", "income_bracket"),

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="d")
p4=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("housing_tenure")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="d")
p5=top_line_charts[["density"]]
p5_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("housing_tenure",
                    "number_of_units")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="d")
multifam_stats=top_line_charts[["metrics"]]
```

Examining these dynamics by the status of homeownership [in Figure \@ref(fig:density-charts).d]{color=`r edit_color`} reveals further disparities. Though renters and homeowners are similarly distributed below the energy poverty line [(`r to_percent(p5_stats$pct_in_group_below_cutoff[p5_stats$housing_tenure=="rented"])` of renters and `r to_percent(p5_stats$pct_in_group_below_cutoff[p5_stats$housing_tenure=="owned"])` of homeowners are in energy poverty)]{color=`r edit_color`}, there appears to be an advantage of homeownership from a net energy perspective [(N~h~=`r round(p5_stats$metric_mean[p5_stats$housing_tenure=="owned"],0)` for homeowners versus N~h~=`r round(p5_stats$metric_mean[p5_stats$housing_tenure=="rented"],0)` for renters)]{color=`r edit_color`}. Only at a relatively high [N~h~]{color=`r edit_color`} do renters seem to have an advantage[[, due to these tenants living in relatively new and efficient urban rentals]{strike=`r strike_show`}]{color=`r edit_color`}: owners of multi-family apartments earn `r round(multifam_stats$metric_mean[multifam_stats$housing_tenure=="owned" & multifam_stats$number_of_units=="multi-family"]/multifam_stats$metric_mean[multifam_stats$housing_tenure=="rented" & multifam_stats$number_of_units=="single-family"],1)` times as much as renters of single-family homes when normalized by energy expenditures. Renters face systemic disadvantages in the energy transition; they typically pay the home's energy costs while the landlord controls infrastructure upgrades, commonly understood as the split incentive problem[@birdPolicyOptionsSplit2012]. Tenure matters for more than just equity itself: renters are less likely to take actions to improve their [N~h~]{color=`r edit_color`}s due to a lack of property rights and [split incentives]{color=`r edit_color`}. Even when action is taken to improve the energy efficiency of a rental building, tenants are less likely to see any economic benefits from it.

```{r}
top_line_group <- c("simplified_utility_type")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="f")
p6=top_line_charts[["density"]]
```

```{r}
# "pop_hispanic"                               
# [35] "pop_african_american"                        "pop_asian"                                  
# [37] "pop_native_american"                         "pop_caucasian" 
# "pop_total"

minority_races <- c("hispanic","african_american","asian","native_american")
races <- c(minority_races,"caucasian")

pct_races <- replica_sup[,paste0("pop_",races)] / rowSums(replica_sup[,paste0("pop_",races)])
names(pct_races) <- paste0("pct_",races)

plurality_race <- races[max.col(pct_races,ties.method = "first")]

plurality_race <- ifelse(plurality_race=="african_american","black",
                                   ifelse(plurality_race=="native_american","indian",
                                          ifelse(plurality_race=="caucasian","white",
                                          plurality_race)))

race_data <- data.frame("geoid"=replica_sup$geoid,
                        "race"=plurality_race)

data_with_race <- inner_join(x=clean_data_ami, 
                             y=na.omit(race_data), by = "geoid")

top_line_group <- c("race")

top_line_charts <- make_all_charts(data_with_race,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="e")
p7=top_line_charts[["density"]]
p7_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("simplified_race")

data_with_race$simplified_race <- ifelse(data_with_race$race=="white",
                                         "white",
                                         "non-white")

top_line_charts <- make_all_charts(data_with_race,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="e")

simplified_race_stats=top_line_charts[["metrics"]]
```


```{r}
# "pop25_some_college_plus"                     "pop25_high_school"                          
# [41] "pop25_no_high_school"
# "pop_total"

# minority_races <- c("african_american","hispanic","asian","native_american")
# races <- c(minority_races,"caucasian")

education_levels <- c("some_college_plus","high_school", "no_high_school")

pct_education_levels <- replica_sup[,paste0("pop25_",education_levels)] / 
  rowSums(replica_sup[,paste0("pop25_",education_levels)])
names(pct_education_levels) <- paste0("pct_",education_levels)

plurality_education_level <- education_levels[max.col(pct_education_levels,ties.method = "first")]

plurality_education_level <- ifelse(plurality_education_level %in% 
                                      c("high_school","no_high_school"),
                                    "high school or less",
                                    ifelse(plurality_education_level=="some_college_plus",
                                           "college or more",
                                          plurality_education_level))

education_data <- data.frame("geoid"=replica_sup$geoid,
                        "simplified_education"=plurality_education_level)


top_line_group <- c("simplified_education")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(education_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="f")
p8=top_line_charts[["density"]]
p8_stats=top_line_charts[["metrics"]]

color_poverty_frequency <- (simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="non-white"] - 
                              simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="white"]) / 
  simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="white"]

color_poverty_frequency_modifier <- ifelse(color_poverty_frequency>0,"greater","less")

color_poverty_frequency_pct <- to_percent(abs(color_poverty_frequency))
```

[Furthermore, Figure \@ref(fig:density-charts).e shows that N~h~ varies widely by racial demography. `r str_to_title(p7_stats$race[p7_stats$metric_mean==max(p7_stats$metric_mean)])` households have the highest N~h~ across the entire population distribution (N~h~=`r round(sort(p7_stats$metric_mean, TRUE)[1],0)`), and `r str_to_title(p7_stats$race[p7_stats$metric_mean==sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)]])` households have the lowest (N~h~=`r round(sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)],0)`), with `r str_to_title(p7_stats$race[p7_stats$metric_mean==sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)-1]])` households a close second from the lowest (N~h~=`r round(sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)-1],0)`). These relative positions are the same across the entire population distribution, with only White (N~h~=`r round(p7_stats$metric_mean[p7_stats$race=="white"],0)`) and Hispanic (N~h~=`r round(p7_stats$metric_mean[p7_stats$race=="hispanic"],0)`) populations showing different relative N~h~s across the population. Households in communities of color experience energy poverty at a rate `r color_poverty_frequency_pct` `r color_poverty_frequency_modifier` than those in white communities. Education level also seems to be correlated with disparate N~h~ outcomes according to Figure \@ref(fig:density-charts).f, with a wide gap between those households in areas with mostly high-school (N~h~=`r round(p8_stats$metric_mean[p8_stats$simplified_education=="high school or less"],0)`) or college-educated (N~h~=`r round(p8_stats$metric_mean[p8_stats$simplified_education=="college or more"],0)`) populations.]{color=`r edit_color`}


```{r}
# "climate_zone"                               
# [75] "climate_zone_description"

simplified_climate <- ifelse(replica_sup$climate_zone_description %in% c("Hot","Very Hot"), "Hot",
                             ifelse(replica_sup$climate_zone_description %in% c("Cold",
                                                                                "Very Cold",
                                                                                "Subarctic"),"Cold","Moderate")
                             )

climate_data <- data.frame("geoid"=replica_sup$geoid,
                           "simplified_climate"=simplified_climate)

top_line_group <- c("simplified_climate")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(climate_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="i")
p9=top_line_charts[["density"]]
```

(ref:density-charts-fig-cap) The distribution of [N~h~]{color=`r edit_color`}s across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure **b** shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure **c** shows the difference among groups of households identified by their primary heating fuel. Subfigure **d** shows the difference based on whether they are renters or owners. Subfigure **e** shows the difference based on the most prominent race in the census tract of each cohort. Subfigure **f** shows the difference based on the most prominent education history in the census tract of each cohort.

```{r density-charts, include=TRUE, results='asis', fig.cap='(ref:density-charts-fig-cap)'}

old_density_charts_fig_cap <- paste0("The distribution of ",colorize("N~h~",edit_color),"s across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure b shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure c shows the difference among groups of households identified by their primary heating fuel. Subfigure d shows the difference based on whether they are renters or owners. Subfigure e shows the difference based on the most prominent race in the census tract of each cohort. Subfigure f shows the difference based on the most prominent education history in the census tract of each cohort.")

grid.arrange(p1,
             p2,
             p3,
             # p4,
             p5,
             # p6,
             p7,
             p8,
             # p9, 
             nrow=2,
             # top=chart_title,
             # subtitle
             bottom="Proportion of Households",
             left=grid.text(label=
               as.expression(
               bquote(
                 N[h]
                 )
               ),
               draw=FALSE
             )
)

# multi_plot <- cowplot::plot_grid(p1,p2,p3,p4,p5,p6,p7,p8,p9,
#                    nrow=3, align="none",rel_heights = c(2,2,2))
# 
# #create common x and y labels
# 
# y.grob <- textGrob(paste0(str_to_upper(metric_name)," (",metric_label,")"), 
#                    gp=gpar(fontface="bold", col="black", fontsize=12), rot=90)
# 
# x.grob <- textGrob("Proportion of Households", 
#                    gp=gpar(fontface="bold", col="black", fontsize=12))
# 
# #add to plot
# 
# grid.arrange(arrangeGrob(multi_plot, left = y.grob, bottom = x.grob))
```

```{r}
group_columns <- c("state_abbr")
# utility type? see chartbook
graph_data <- filter_graph_data(clean_data=clean_data_ami[clean_data_ami$state_abbr!="DC",], 
                                group_columns=group_columns, 
                                metric_name=metric_name)
```

```{r}
# percent of "other" fuel expenditures toward fossil fuel combustion
# want to make this more precise by state, county, and/or balancing authority eventually
other_gwm <- grouped_weighted_metrics(clean_data_fpl[clean_data_fpl$state_abbr!="DC",], 
                                      c("primary_heating_fuel"),
                                      "other_spend",
                                      0)

other_fuels <- c("COAL","FUEL OIL","NONE","OTHER","SOLAR","WOOD","BOTTLED GAS")
non_fossil_other_fuels <- c("NONE","SOLAR","WOOD")
fossil_other_fuels <- other_fuels[!(other_fuels %in% non_fossil_other_fuels)]

other_fossil <- other_gwm[other_gwm$primary_heating_fuel %in% fossil_other_fuels,
                              c("household_count","metric_mean")]

pct_other_fossil <- sum(other_fossil$household_count*other_fossil$metric_mean)/
  sum(other_gwm$household_count*other_gwm$metric_mean)

graph_data$pct_other_fossil <- pct_other_fossil
```

```{r}
# percent of each state's electric grid decidated to fossil fuel combustion
# can refine by balancing authority based on REPLICA dataset
egrid <- get_state_egrid()

egrid$pct_electricity_fossil <- egrid$STCLPR + #coal
  egrid$STOLPR + #oil
  egrid$STGSPR + #gas
  egrid$STOFPR #+ #other fossil
  # egrid$STNCPR #+ #nuclear
  # egrid$STHYPR #+ #hydro
  # egrid$STOPPR #unknown/purchased

graph_data <- left_join(graph_data, egrid, by=c("state_fips"="FIPSST"))

# graph_data <- graph_data[graph_data$state_abbr!="DC",]
```

```{r}
# percent of natural gas expenditures dedicateed to fossil fuel combustion...
pct_gas_fossil <- 1.0

graph_data$pct_gas_fossil <- pct_gas_fossil
```


```{r}
graph_data$pct_fossil_tract <- (graph_data$pct_gas_fossil * graph_data$gas_spend + 
  graph_data$pct_electricity_fossil * graph_data$electricity_spend + 
  graph_data$pct_other_fossil * graph_data$other_spend) / 
  (graph_data$gas_spend + graph_data$electricity_spend + graph_data$other_spend)


pct_fossil_gwm <- grouped_weighted_metrics(graph_data, "state_fips","pct_fossil_tract",0) %>% 
  dplyr::rename(pct_fossil=metric_mean)

graph_data <- left_join(graph_data, 
                        pct_fossil_gwm[,c("state_fips","pct_fossil")], 
                        by="state_fips")

top_line_charts <- make_all_charts(graph_data,
                            group_columns="state_abbr",
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL)

state_by_state <- top_line_charts[["metrics"]]
```

```{r}
electricity_prices_summary <- calculate_weighted_metrics(graph_data, 
                                                         c("state_abbr"), 
                                                         "dlrs_kwh", 
                                                         metric_cutoff_level = 
                                                           ner_poverty_line)
```


Assessing the [N~h~]{color=`r edit_color`}s among different states in Figure \@ref(fig:state-violin) presents a counterintuitive picture of how states address energy poverty and energy equity. [N~h~]{color=`r edit_color`} can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as Connecticut [(N~h~=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CT"],0)`)]{color=`r edit_color`} and Vermont [(N~h~=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="VT"],0)`)]{color=`r edit_color`}, where [`r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="CT"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` and `r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="VT"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])`]{color=`r edit_color`} higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi [(N~h~=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="MS"],0)`)]{color=`r edit_color`} and Alabama [(N~h~=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="AL"],0)`)]{color=`r edit_color`}, which have significant low-income populations and low per-unit energy prices [(`r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="MS"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` and `r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="AL"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` lower than average, respectively"`)]{color=`r edit_color`}. Not only are households in these states falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood may suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on new metrics.

Although they are the states with the highest [N~h~]{color=`r edit_color`}, California [(N~h~=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CA"],0)`)]{color=`r edit_color`} and Colorado [(N~h~=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CO"],0)`)]{color=`r edit_color`} are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely, this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation are a common thread [among the top-performing states on an N~h~ basis]{color=`r edit_color`}, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure \@ref(fig:state-violin) shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high [N~h~]{color=`r edit_color`}s than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.

(ref:state-violin-fig-cap) A comparison of [N~h~]{color=`r edit_color`}s among each state in the [US]{color=`r edit_color`}. The bars are sorted by median household [N~h~]{color=`r edit_color`} and represent the interquartile range (25%-75% percentiles) of household [N~h~]{color=`r edit_color`}s colored by the percent of household energy expenditures in each state that goes to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's [(EPA)]{color=`r edit_color`} [Emissions and Generation Resource Integrated Database (]{color=`r edit_color`}eGRID[)]{color=`r edit_color`} for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users.

```{r state-violin, include=TRUE, eval=TRUE, results='asis', fig.cap='(ref:state-violin-fig-cap)'}

old_state_violin_fig_cap <- paste0("A comparison of ",colorize("N~h~",edit_color),"s among each state in the ",colorize("US",edit_color),". The bars are sorted by median household N~h~ and represent the interquartile range (25%-75% percentiles) of household N~h~s colored by the percent of household energy expenditures in each state that go to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's ",colorize("(EPA)",edit_color)," ",colorize("Emissions and Generation Resource Integrated Database (",edit_color),"eGRID",colorize(")",edit_color)," for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users.")
# violin plot
y <- make_violin_chart(graph_data=graph_data,
                      group_columns=group_columns,
                      metric_name=metric_name,
                      metric_label=metric_label,
                      metric_cutoff_level=metric_cutoff_level,
                      fill_metric="pct_fossil",#"STCYPR",#"STSOPR",
                      fill_label="% of Energy Expenditures on \nFossil Fuel Combustion",#Combustion",#Solar",
                      group_name="State",
                      x_label=bquote(N[h]))
print(y)
```

```{r}
group_variable <- "eia_id"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(left_join(clean_data_ami, replica_sup, by=c("geoid")), group_columns, metric_name)

util_group <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)

member_minumum <- 10000
lowest_ner_utility <- filter(arrange(util_group,metric_mean),household_count>=member_minumum)[1,]

unique_utils <- distinct(replica_sup[c("eia_id","company_na","state_name","dlrs_kwh")])

lowest_ner_utility_specs <- filter(unique_utils,eia_id==as.numeric(lowest_ner_utility["eia_id"]))

lowest_ner_utility_name <- lowest_ner_utility_specs$company_na
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Corp","Corporation")
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Member","Membership")
```

#### Discussion  {#discussion}

A sensible prior hypothesis is that everyone experiences the same efficiency from the energy system as measured by return on energy investment. Differences in absolute outcomes may be related to the quantity of energy investment, but the marginal unit of energy consumed by one household should lead to as much benefit for that household as any other. However, here we see that [N~h~]{color=`r edit_color`}s are different among different groups of households in the US. This difference is often correlated to factors out of the households’ control and even those related to persistent social inequalities, such as race and education. These striking disparities suggest the existence of deeply structural barriers to prosperity in the US. Energy is central to equity and economic prosperity, but the[[odds are stacked against many people. The]{strike=`r strike_show`}]{color=`r edit_color`} energy system appears to be regressive in that costs accrue disproportionately to those of lower-income levels[[and the most energy-efficient homes belong to wealthier families]{strike=`r strike_show`}]{color=`r edit_color`}.

Furthermore, we demonstrate that owning a home and consuming solar power are associated with increased income multipliers for energy expenditures. This advantage leads to gains that are not being realized by many communities. When households adopt solar power, their N~h~ increases as a result of decreasing their energy expenditures, which creates a disparity between those with access to renewable energy and those reliant on fossil-fuel-based energy sources. This helps explain why there has been a disparity in how the benefits of the energy transition are accruing among socioeconomic groups [@vaishnavWasItWorthwhile2017]. There is the potential for electrification and the transition to clean fuels to exacerbate this division if appropriate policies are not implemented[@cullenwardDynamicallyEstimatingDistributional2016].

Indeed, there are clear, mutually synergistic, positive reinforcement mechanisms to alleviate health and environmental disparities in air pollution exposure by reducing household energy burdens and improving economic mobility across low-income households. Combustion of biofuels and hydrocarbons is a significant source of air pollution and exacerbates other household costs like healthcare and maintenance[, yet we find that utilization of these sources is not associated with increased N~h~s at a state or household scale]{color=`r edit_color`}. [Not only are h]{color=`r edit_color`}ouseholds living in more poverty and closer proximity to highly polluted areas [at greater risk of adverse health impacts; they]{color=`r edit_color`} must [also]{color=`r edit_color`} consume more energy to overcome the particulate emissions[, which, themselves, reduce the efficiency of clean sources such as solar panels[@heIncreaseDomesticElectricity2020]]{color=`r edit_color`}.

The inherent benefits of solar electricity must be accessible to all populations in the [US]{color=`r edit_color`} to promote sustainability, but [[barriers such as high capital investment, lack of financing, and inability to take advantage of existing business models continue to hold back]{strike=`r strike_show`}]{color=`r edit_color`} communities of color [[from]{strike=`r strike_show`}are not]{color=`r edit_color`} receiving a similar benefit to white and wealthier households [from their energy expenditures]{color=`r edit_color`}. Net energy metrics exhibit this income multiplier effect and the resulting divide. Designing solar policies to benefit those facing low [N~h~]{color=`r edit_color`}s may substantially improve net energy income ratios and raise households out of energy poverty in the [US]{color=`r edit_color`}.

Pachauri et al. distinguish between affordability and cost of supply, implying that more focus should be applied toward how energy burdens vary among customers of different energy suppliers than on how per-unit costs of energy vary[@pachauriAdvancingEnergyPoverty2020]. For instance, `r lowest_ner_utility_name` is the electric utility with more than `r to_big(member_minumum)` customers whose members have the lowest average [N~h~]{color=`r edit_color`} (`r to_big(lowest_ner_utility$metric_mean)`)[, according to LEAD]{color=`r edit_color`}. At the same time, the per-unit cost of electricity in this service territory is only more expensive than `r to_percent(ecdf(unique_utils$dlrs_kwh)(lowest_ner_utility_specs$dlrs_kwh))` of utilities at `r to_dollar(lowest_ner_utility_specs$dlrs_kwh)`/kWh. [Is an exceptionally high burden acceptable because the per-unit costs are not exceptional?]{color=`r edit_color`}

This relevance especially holds for electricity because it is a commodity delivered via a stationary, centralized grid system, and households retain little control over their own energy choices. [[The vastness of the modern electric grid eludes affordability for everyday households because of the relationships between the utility companies and the users. Secondary energy is unique among residential consumption categories because a single service provider is usually the authority for determining energy costs for each of its customers.]{strike=`r strike_show`}]{color=`r edit_color`} In vertically integrated energy markets, the monopoly utility is the only option available to all consumers. In organized energy markets, the public utility is designated as the last resort provider for those unable or unwilling to participate in the competitive procurement of energy. Even in organized markets, local utilities retain monopolistic control of the transmission and distribution systems. 

Consumers are price takers with relatively inelastic demand. Changes in the unit price of energy or slight differences in consumption patterns matter more to those with low incomes than those with higher incomes. Furthermore, the current lack of storage infrastructure on the grid and behind each meter means that households are bound to electricity providers at the time of use. The "forward-looking" or "reactive" tendencies of these public electric utilities have implications for the energy transition in their jurisdictions and beyond[@wolakFutureElectricityRetailing2020]. A more in-depth examination of the energy system’s underlying regulatory structures and robust assessments of energy burden could provide a path forward and track how the benefits of the energy transition are being accrued.

In some markets, specialized rates or programs are available for Low and Moderate Income (LMI) consumers, who may have higher energy burdens. We find it notable that more than half of all funding to address high energy burdens in the US is from utility ratepayer-funded bill and energy efficiency assistance[@rossHighCostEnergy2018]. At a national scale, the Low Income Home Energy Assistance Program (LIHEAP) and the Weatherization Assistance Program (WAP) in the US seek to address aspects of energy poverty through bill payment assistance and energy efficiency measures, but the efficacy of these programs has been mixed in addressing distributional equity in energy burdens and receiving benefits from energy efficiency programs[@bednarRecognitionResponseEnergy2020]. [In part, this may be because these programs rely on income-based poverty lines such as the FPL to determine eligibility for benefits.]{color=`r edit_color`}

The [US]{color=`r edit_color`} benchmarks its FPL to the food requirements of the average household[@coferFamilyFoodPlans1962] and uses this threshold as is an eligibility criterion for more than 40 federal programs across ten agencies (in addition to state, charitable, and private enterprises that also do so)[@divisiondcdProgramsThatUse2015]. Practitioners have posited that the standard policy of “using the ‘economy food plan’ to determine who can afford to hire an attorney” may be depriving citizens of their basic rights[@grossTooPoorHire2013]. In some cases, food assistance programs are more inclusive than energy assistance programs[: we show that more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` households above the FPL experience energy poverty.]{color=`r edit_color`}

[Research using detailed qualitative sociological and public health interview data links energy burden with housing and energy policy[@hernandezEnergyBurdenNeed2010]. Other articles have linked technology adoption barriers to low-income communities of color[@hsuPublicElectricVehicle2021]^,^[@tidwellDecarbonizingDisparitiesProblematizing2021]^,^[@brockwayInequitableAccessDistributed2021a] and identified that households that are in the same peer social network often adopt technologies such as solar[@bollingerPeerEffectsDiffusion2012]. While some studies already acknowledge the benefits of improving energy efficiency and equity outcomes through surveys and interviews[@hernandezBenefitBurdenPerceptions2015], this study adds to the literature by building a comprehensive quantitative framework and empirical result based on a large dataset. This toolkit adds more quantitative backing to this body of qualitative work and can be used in future analysis with technology adoption data to identify strategic opportunities to improve energy efficiency and access to clean technology in a more equitable manner.]{color=`r edit_color`}

[Previous work provided theoretical frameworks for understanding energy poverty beyond a simple income-based measure[@sovacoolEnergyJusticeConceptual2015], and limited examples of applications to empirical data that rely on building-specific efficiency characteristics[@faiellaEnergyPovertyHow2021] or subjective self-assessments[@sokolowskiMultidimensionalIndexMeasure2020]. Applying N~h~ to a nationwide dataset for the US builds on this work by providing a tangible tool that includes `r to_million(number_in_poverty[1]+clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum())` households with energy expenditures greater than their incomes or with incomes above the FPL that are left out by other measures, and is a way to visualize the disparities between groups that may allow for further investigation around different household characteristics. N~h~ highlights inequality better than a simple linear metric while allowing the assessment of a wide variety of households, such as those with no income or for which efficiency data is not available.]{color=`r edit_color`} A significant insight from [NEA]{color=`r edit_color`} that should be incorporated into future work is that embodied energy takes many forms across the household budget (food, goods, services, transportation, housing, etc.), and these can all be compared using the same units of measure (e.g., joules) to scale the N~h~ framework across multiple expenditure categories.

The [Coronavirus Disease 2019 (]{color=`r edit_color`}COVID-19[)]{color=`r edit_color`} pandemic and associated recovery measures may be a critical opportunity to provide relief payments related to energy expenditures and to invest in more efficient residential[@RecoveringFastSlow2020a] and commercial energy infrastructure that enables newer and cleaner systems[@chapmanImpactsCOVID19Transitioning2020]. We show that US households are already spending excessive amounts on energy, notwithstanding more families staying at home for longer periods of time during pandemic lockdowns. The ongoing crisis offers a chance to address inequity with a focus on residential energy burdens[@graffCOVID19AssistanceNeeds2020]. [The EU is in the process of defining how communities can participate in the energy transition[@uihleinEnergyCommunitiesOverview2020] and how burdens can be alleviated through this process using proactive policy tools and business models such as One Stop Shops (OSS) for energy efficiency and renewable energy upgrades[@bertoldiRoleOnestopShops2021].]{color=`r edit_color`} Adopting energy criteria for energy and other programs [like these]{color=`r edit_color`} could expand access for those underserved populations in need of assistance independent of their needs in other consumption categories.

Creating a federal energy poverty line would be a critical step in identifying families that face large disparities in access to affordable electricity and energy in the [US]{color=`r edit_color`} and improve programs’ abilities to address energy burdens. A toolkit based on this analysis enables neighborhood level outreach where burdens are highest and identifies opportunities where households could benefit from emerging technologies.

[[A more comprehensive approach to poverty alleviation in the US would also consider the energy situation of each household and the options available to improve its efficiency. Then, it would make those options accessible to the stakeholders who could benefit.]{strike=`r strike_show`}]{color=`r edit_color`}

[[Even for energy assistance programs that do exist, many households reliant on inefficient fuels such as kerosene for heating must pay upfront costs to fill a tank for the winter season. These subsidy programs are largely ineffective as the cost of kerosene can be expensive, and pressure remains on households to offset existing gaps. Better opportunities to convert to alternative fuels would also provide households the opportunity to take advantage of the efficiency gains in better technology. In this way, broader programs need to be designed to provide households more options.]{strike=`r strike_show`}]{color=`r edit_color`}

[[How can our energy system be operated and improved to provide equitable access? Are there ways that clean electrification can be used to better benefit currently underserved communities?]{strike=`r strike_show`}]{color=`r edit_color`}

[[High burdens may be associated with intermittent grid access when extreme weather events interrupt energy supply chains. The same households are often at greater risk of energy service disconnection due to non-payment. Re-connection fees can compound to increase burdens in ways not captured by our analysis.]{strike=`r strike_show`}]{color=`r edit_color`} 

[[High energy burdens have already been linked to local and global air pollution, and we can connect these impacts directly to the full scope of household prosperity via net energy.]{strike=`r strike_show`}]{color=`r edit_color`}

[[Energy is essential to deal with other inequities in society. There must be a way to design a structure that addresses this disparity more equitably.]{strike=`r strike_show`}]{color=`r edit_color`}

[[While well-intended programs such as PACE or solar loans have reached few people, community-oriented programs focusing on peer-mentorship could improve programmatic outcomes. Building support for community-led programs can also reduce the burden on individuals to expand access to the benefits of solar and efficiency.]{strike=`r strike_show`}]{color=`r edit_color`}

[[Policymakers have not systematically deployed interventions based on [NEA]{color=`r edit_color`} across American households.]{strike=`r strike_show`}]{color=`r edit_color`} 

[[Net energy income is holding back socioeconomic mobility in the US.]{strike=`r strike_show`}]{color=`r edit_color`}

[[However, concerted attention to technology and policy details matter to implement a national scheme.]{strike=`r strike_show`}]{color=`r edit_color`}

[[The data demonstrate a need for quantitative methodologies to support equitable energy infrastructure investments.]{strike=`r strike_show`}]{color=`r edit_color`}

## Methods  {#methods}

#### Data  {#data}
To estimate the Net Energy Return (N~h~) of American households, we primarily utilize the Low Income Energy Affordability Data (LEAD)[@maLowIncomeEnergyAffordability2019] and Rooftop Energy Potential of Low-Income Communities in America (REPLICA)[@sigrinRooftopSolarTechnical2018] datasets, which the DOE assembled to help “stakeholders make data-driven decisions on energy goal setting and program planning by providing them information on low-income household populations and associated energy use characteristics”[@maLowIncomeEnergyAffordability2019]. These datasets encompass estimates of household energy expenditures (S), income (G), and demographic characteristics for most households at the census tract scale in all states and most territories of the [US]{color=`r edit_color`}.  

LEAD: The LEAD portrays the average income, electricity expenditures, gas expenditures, and other fuel expenditures for cohorts of households segmented by location (census tract, county, state) and household characteristics (whether the unit is rented or owned, the building’s year of first construction, the number of units in the building, whether the units are attached, and the unit’s primary heating fuel type). The dataset is assembled by applying an iterative proportional fitting (IPF) algorithm to cross-tabulations of household responses from the 2016 5-year American Community Survey (conducted by the US Census Bureau), which provides the samples for each cohort as Public Use Microdata Samples. IPF is a widely used spatial microsimulation method to allocate individuals (i.e., households) to zones (i.e., census tracts and utility service territories) while calibrating each zone's characteristics to known quantities. Using IPF, the microdata samples are scaled to match aggregate annual values from utility sales and revenues reported in Energy Information Administration forms 861 and 176.

REPLICA: The Renewable Energy Potential of Low-Income Communities in America (REPLICA) dataset includes [the racial and education level composition of each census tract]{color=`r edit_color`} used in the ultimate analysis[@sigrinRooftopSolarTechnical2018]. [In addition to providing a simpler designation of cohorts for each census tract as described below in [Methods-Treatment](#treatment), REPLICA also includes]{color=`r edit_color`} estimates of the technical potential of rooftop solar and additional techno-economic variables (e.g., demographics and electricity rates) [that will be useful for future research.]{color=`r edit_color`}

eGRID: We use the [EPA]{color=`r edit_color`}'s eGRID[@usepaEmissionsGenerationResource2020] to calculate the proportion of household energy expenditures that support fossil fuel combustion through the purchase of electricity. 100% of natural gas purchases are considered to support fossil fuel combustion. Electricity purchases are divided into their respective sources according to the state proportions indicated by the "STCLPR" (coal), "STOLPR" (oil), "STGSPR" (gas), and "STOFPR" (other fossil) fields in the 2018 eGRID dataset. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately `r scales::percent(pct_other_fossil, accuracy=1)` fossil fuel combustion.

#### Treatment  {#treatment}
The LEAD data represents the unit’s ownership status (OWNER vs. RENTER) and income bracket as a fraction of [AMI]{color=`r edit_color`} (0-30%, 30-60%, 60-80%, 80-100%, or 100%+) or [FPL]{color=`r edit_color`} (0-100%, 100-150%, etc.). These categorical variables are saved as factors. Then we create min_units from BLD INDEX, a variable which represents a non-uniformly distributed set of buckets for the range of the number of units in the building and whether single-unit households are attached or detached from neighboring households (1 ATTACHED, 1 DETACHED, 2 UNIT, 3-4 UNIT, 5-9 UNIT, 10-19 UNIT, 20-49 UNIT, 50+ UNIT, MOBILE_TRAILER, BOAT_RV_VAN, OTHER UNIT). We extract the minimum number of units from the range and whether the building is detached. Those households labeled OTHER UNIT, MOBILE_TRAILER, or BOAT_RV_VAN are given values of Not Applicable (NA) for this characteristic. Finally, we calculate S and G of which each metric is composed: 

S = annual expenditures on electricity (ELEP CAL) + natural gas (GASP CAL) + and other fuels (FULP)  

G = the cohort’s average annual income (HINCP) 

The metric formulas outlined in [Applying NER to Energy Equity](#ratios) are then used to calculate each cohort’s energy poverty metrics. Since we are examining homes’ relationships with the energy system, we ignore any homes that do not use energy as denoted by rows where S==0. The estimation procedure used by the DOE results in an estimated number of occupied housing units for each cohort (UNITS, renamed as households). It displays the number of American Community Survey responses that contribute to the estimate of energy expenditures (COUNT, renamed as acs_responses). We then remove any categories with fewer than 1 unit represented since this is not physically possible. `r removed_households = "This results in removing X% of the available rows (gross: X rows of X). This is a total of X housing units or X% of the estimated total X units in the sample. We have separated any cohorts with incomes or energy costs equal to 0 into another dataset for analysis. This represents approximately X% of the housing units and X% of the examined cohorts, so it will be important to make sure that this subset does not contain systematic bias. However, these data are excluded from the current analysis under the assumption that energy costs equal to 0 are not relevant to this analysis."`

We then combine this dataset with the REPLICA dataset. To do so, we must aggregate the income levels of the LEAD dataset to the simpler schema used by REPLICA for summarizing households’ income relative to the area’s median income (AMI):

- 0-30% AMI: Very-Low-Income
- 30-80% AMI: Low-to-Moderate-Income
- $\geq$ 80% AMI: Middle-to-High-Income

Also, we create an indicator of whether a particular cohort is in income poverty as defined by the relevant standards for its characteristics. For the AMI version of LEAD, this is defined as being “Very-Low-Income” or $\leq$ 30% of AMI. For the FPL version of LEAD, we translate directly from the designation of the income bracket as follows:

- 0-100% FPL: In Poverty
- $\geq$ 100% FPL: Not In Poverty

The REPLICA dataset also simplifies any households with only one unit per building into “Single Family” homes and any households with more than one unit per building as “Multi-family.” Non-stationary and non-traditional homes are not included in the REPLICA analysis. We match these simplifications in the LEAD dataset by aggregating by the number of units:

- 1 Unit: Single-Family
- $>$ 1 Unit: Multi-Family
- Other Unit: NA (excluded from analysis)

After simplifying these characteristics in the LEAD [AMI]{color=`r edit_color`} data, we merge the AMI dataset with the REPLICA dataset along the census tract, simplified income bracket, simplified number of units, and housing tenure variables to achieve the primary dataset used in the analysis. Merging with the REPLICA dataset provides additional demographic and geospatial data not available in the LEAD dataset only[@sigrinRooftopSolarTechnical2018]. Characteristics such as the utility type and locale description are sourced from REPLICA and unavailable in LEAD[, and we source the cost of electricity, racial composition, and education levels of census tracts from REPLICA for this analysis]{color=`r edit_color`}. Similarly, the REPLICA dataset contains only electrical expenditure estimates without natural gas or other fuel costs to households and could not be used to perform this analysis alone.

The FPL version of LEAD is not merged with all of the REPLICA data because of incompatibility between the FPL and [AMI]{color=`r edit_color`} bracket definitions. However, demographic data associated with each census tract as a whole can be merged with the FPL dataset. Both AMI and FPL versions of LEAD are combined with demographic data from the REPLICA dataset and geospatial shapefiles from the Census to produce the final datasets used in the analysis. [Since the FPL version of LEAD is not aggregated to the simpler categories found in REPLICA, more granular variables such as Primary Heating Fuel remain available for assessment across the entire population.]{color=`r edit_color`}

#### Considerations  {#considerations}
The iterative proportional fitting method has limitations as an estimation procedure that constrain the strength of conclusions that can be drawn from the simulated LEAD and REPLICA datasets. The relationship between constraint variables such as total energy spending by utility service territory and number of households per census tract will tend toward the average of the initializing dataset and depress variations among otherwise similar regions. This may explain the large quantities of households that are estimated to have very low incomes. Validating these estimated data would require randomized surveys of households along the dimensions of interest.

The meaning of the “primary heating fuel” category comes from the answer to the question “Which fuel is used most for heating this house, apartment, or mobile home?” on the American Community Survey. This question’s power to predict energy expenditures or fuel sources is unknown, and further analysis is required to understand the implications of this survey question for drawing broader conclusions about household energy use. However, the US Census Bureau has been asking this question since 1940. It states that these data are collected to help communities "provide assistance with utilities," "estimate future energy demand," and "measure environmental impacts"[@bureauWhyWeAsk].

Though the REPLICA dataset relies on a different vintage of the LEAD dataset (assembled in 2017[@sigrinRooftopSolarTechnical2018]) than this analysis (assembled in 2019[@maLowIncomeEnergyAffordability2019]), inferring differences among annual estimates is not meaningful due to the standard error of the data [@maLowIncomeEnergyAffordability2019]. A rigorous treatment of these metrics over time is an area for future research.

The results inferred from eGRID are only as good as the eGRID methodology itself. We choose to outline the proportion of combusted fuels rather than emissions data due to the limitations outlined by proponents of marginal emissions attribution in electric power system models[@vonwaldAnalyzingCaliforniaFramework2020]^,^[@siler-evansMarginalEmissionsFactors2012] and limitations in estimating regional electricity transfers[@vonwaldAccountingGreenhouseGas2021].

[[Expanding quantitative analysis of energy affordability can offer additional context, including the use of ratios to identify populations that could be particularly vulnerable to energy shocks or absolute energy burdens. Developing such metrics can elucidate the scale on which American households must save for energy consumption. Frequently used metrics in this category do not tell the whole story. For instance, the simple proportion of a household’s income spent on energy bills (a.k.a. energy burden) does not capture the underlying monthly cash flow patterns that may stress household budgets.]{strike=`r strike_show`}]{color=`r edit_color`}

## Code Availability {#code-availability}

The code and data to fully reproduce this paper are available on GitHub at [[[[https://github.com/ericscheier/net_energy_equity](https://github.com/ericscheier/net_energy_equity)]{strike=`r strike_show`}]{hide=`r hide`} **redacted for anonymity - copies of data and code have been submitted as part of peer-review**]{color=`r edit_color`} under the GNU Affero General Public License v3.0.

## Data Availability  {#data-availability}

All data necessary for the composition of the source datasets used in this analysis are freely available from [US]{color=`r edit_color`} government sources as open data. All functions to automatically retrieve and assemble these data and compiled versions of these data are made available to the user as part of the software referred to in [Code Availability](#code-availability).

## References  {#references}

::: {#refs}
:::

```{r eval=FALSE}
# # Works Not Yet Cited  {#uncited}
# 
# ---
# nocite: |
#   @*
# ...
# 
# # Software Used  {#software}
# 
# List of R packages used to be entered here automatically
# 
# # Acknowledgements  {#acknowledgements}
#
```

## Author Contributions  {#author-contributions}

[[[ES]{strike=`strike_show`}]{hide=`r hide`} X]{color=`r edit_color`} and [[[NK]{strike=`strike_show`}]{hide=`r hide`} Y]{color=`r edit_color`} conceived of and designed the project. [[[ES]{strike=`r strike_show`}]{hide=`r hide`} X]{color=`r edit_color`} created the software used for data acquisition and analysis and created the figures. [[[NK]{strike=`r strike_show`}]{hide=`r hide`} Y]{color=`r edit_color`} contributed the introduction of the topic and interpretation of the results.

## Competing Interests  {#competing-interests}

The authors declare no competing interests.


```{r eval=FALSE}
# 
# # Additional Information  {#additional-information}
# 
# # (APPENDIX) Appendix {-}  {#appendix}
# 
# # Charts for All Variables {#charts}
```

```{r, include = FALSE, eval=FALSE}
r_packages_used <- c("rmarkdown", "knitr")
knitr::write_bib(x = r_packages_used, file = "bibliography.bib")
#https://stackoverflow.com/questions/60026015/use-citation-in-r-markdown-to-automatically-generate-a-bibliography-of-r-packa
```

```{r}
# 
# # Figure Legends
# 
# Figure \@ref(fig:metric-comparison) (`metric-comparison-1.pdf`): `r metric_comparison_fig_cap`
# 
# Figure \@ref(fig:continental-map) (`continental-map-1.pdf`): `r continental_map_fig_cap`
# 
# Figure \@ref(fig:inset-map) (`inset-map-1.pdf`): `r inset_map_fig_cap`
# 
# Figure \@ref(fig:density-charts) (`density-charts-1.pdf`): `r density_charts_fig_cap`
# 
# Figure \@ref(fig:state-violin) (`state-violin-1.pdf`): `r state_violin_fig_cap`
# 
# 
# # Tables
# 
# ```{r comparison-table-display, include=TRUE, results="asis"}
# final_table
# ```
```


```{r}
# merge data together
if(!is_preview){
  write.csv(x=clean_data_fpl,file="CohortData_FederalPovertyLine.csv")
  write.csv(x=clean_data_ami,file="CohortData_AreaMedianIncome.csv")
  write.csv(x=replica_sup,file="CensusTractData.csv")
}
# save as csv

```


<!--chapter:end:net_energy_equity_major_review.Rmd-->

---
title: Net Energy Equity Literature Review
subtitle: An overview of models that assess the relationship between income and energy expenditures
titlerunning: Energy Equity Review
authorrunning: Scheier
thanks:
authors:
- name: Eric Scheier
  address: Environment, Ecology, and Energy Program, The University of North Carolina at Chapel Hill
  email: eric@scheier.org
keywords:
  - energy burden
  - energy poverty
  - energy justice
  - net energy
bibliography: references.bib
bibstyle: spphys
csl: nature-no-et-al.csl
date: "`r format(Sys.time(), '%Y-%B-%d')`"
output:
  bookdown::pdf_book:
    base_format: rticles::springer_article
keep_tex: true
fig_caption: true
header-includes:
  - \usepackage{setspace}\doublespacing
# - \usepackage{lineno}
# - \linenumbers
---

```{r setup, include=FALSE}
is_final=TRUE
is_preview=FALSE
is_draft=FALSE
set.seed(123)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','asis')),
                      fig.keep='last',
                      dev='cairo_pdf',#'pdf',
                      fig.show='hold',
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=TRUE,#FALSE,
                      fig.margin=FALSE,
                      fig.fullwidth=TRUE #FALSE
                      )

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 
    "latex" else "pipe"
})
```

```{r option-view, include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
kable(knitr::opts_chunk$get() %>% enframe())
```



---
abstract: |
  Energy equity is an issue of increasing prevalence. While large datasets exist to analyze household incomes, expenditures, and energy options for households, few consistent metrics exist to evaluate the energy affordability of households. Here, we outline the existing perspectives on energy equity and examine existing models that incorporate incomes, expenditures, and energy options.
---
\doublespacing

# Energy Equity Review

Energy is becoming increasingly unaffordable for American households. In the United States, energy poverty is now a significant challenge as families struggle to meet monthly bills and live paycheck to paycheck[@bednarRecognitionResponseEnergy2020]. Even with rapid declines in technology costs for cleaner, renewable electricity generation options, many households cannot take advantage of technological innovations and advancements such as low-cost rooftop solar or energy efficiency upgrades that improve air quality, lower greenhouse gas emissions, and increase direct household savings[@castellanosRooftopSolarPhotovoltaic2017]. Rooftop solar may be capital intensive, and although the investments may recoup costs, many times a lack of knowledge and experience act as a barrier to implementation. Similarly, for households living in older buildings, the ability to make improvements to building HVAC systems and efficiency changes may require awareness and resources that are left out from current discussions. Renters face systemic disadvantages in the energy transition; they typically pay the energy costs of the home while the landlord controls infrastructure upgrades, leading to a principal agent dilemma.

Universal access to affordable, reliable, and modern energy is one of the core tenets of United Nations Sustainable Development Goal (SDG) 7[@pachauriAdvancingEnergyPoverty2020]. Despite efforts to evaluate and quantify energy poverty, few metrics are well-suited to understand the pervasiveness of energy poverty and systematic challenges that many households in the United States face. Access to useful energy is fundamental to ecosystem prosperity and is considered essential to the health and safety of prosperous human civilizations[@hallEnergyWealthNations2018]. The relationship between prosperity and available energy has been explored extensively at macro[@brandtHowDoesEnergy2017] and micro[@mayerTwoFacesEnergy2014] scales across production and consumption stages of the human socio-ecological system's energy life cycle. 

Pachauris & Rao examine this dynamic in the sustainable development context of SDG 7 by comparing a multi-tier framework and a simplified alternative framework for assessing electricity access in Ethiopia, India, and Rwanda[@pachauriAdvancingEnergyPoverty2020]. The multi-tier framework relies on assessments of the durations when energy is available, the quality of voltage supplied, the reliability in terms of number of disruptions, the capacity in terms of Watts available, the consumption levels allowed per day, and affordability of the stanard consumption package as a percentage of household income. These variables are rated in terms of up to five tiers. The simplified alternative framework measures availability as duration of availability, cost of supply depending on the specific context, service level from "minimal" to "affluent", and affordability as a share of the household budget. These frameworks both provide their results in terms of the proportion of the population which is experiencing "minimal", "basic", or "improved" energy access based on national annual survey data used as proxies for the tiers under examination. This method requires many veriables and the ability to normalize amongst different types of data, but it does provide a framework to compare countries that are at different stages of energy system development.

Different groups across society have different basic energy needs[@raoEnergyRequirementsDecent2019]. However, it is becoming increasingly clear that there are multiple standards in the United States: a growing disparity between wealthier and lower-income households, their difference in basic energy needs and extra energy consumption[@brownLowincomeEnergyAffordability2020]. The cost of meeting basic needs is increasingly becoming unaffordable. While per-unit costs are decreasing in the United States, many households struggle to make utility bill payments[@rossHighCostEnergy2018]. This is not just a poverty issue - many of the households living in poverty also lack the agency to perform efficiency upgrades or technology enhancements that could decrease the gap between wealthy and poor households. For instance, although solar electricity has declined in cost dramatically and been heavily incentivised over the 21st century, the upfront capital needed to take advantage of this technology eludes lower-income communities. Efficiency upgrades are similarly capital-intensive. Even though low-interest loans may be available for this purpose in some communities, the bureaucracy and institutional inertia hold back a more rapid transition.

Brown et al. took this query on to ask why does the U.S. have energy poverty in the first place[@brownLowincomeEnergyAffordability2020]? In a thematic exploration of issue's cause and effect, the authors provided a framework to break down energy equity into its constituent components and understand each's root cause. They identify energy access, energy poverty, energy insecurity, and energy burden as key metrics within the energy equity concept (Figure \@ref(fig:equity-framework)), and identify five categories of causes or correlates of high energy burdens in the United States: location & geography, housing characteristics, socio-economic situation, energy prices & policies, and behavioral factors (Figure \@ref(fig:causes-correlates)). While this framework is highly useful as a basis for research, it is conceptual in nature and only backed by empirical evidence to the extent of its sources.

```{r equity-framework, include=TRUE, results="asis", out.width="100%", fig.cap="Energy equity framework as articulated in Brown et al. (2020)."}
knitr::include_graphics("Brown_FlowChart.png")
```


```{r causes-correlates, include=TRUE, results="asis", out.width="100%", fig.cap="Causes and correlates of high energy burdens per Brown et al. (2020)."}
knitr::include_graphics("Brown_CausesCorrelates.png")
```


Historically, many attempts have been made to assess household prosperity based on energy metrics[@brownPersistenceHighEnergy2020],[@rossHighCostEnergy2018],[@bednarIntersectionEnergyJustice2017],[@kawaiSpendingHouseholdEnergy2021],[@linAffordabilityAccessFocus2018],[@drehoblUSLowIncomeEnergy2016], though few directly with the intent to understand energy inequity across census tracts and in relation to access and deployment of cleaner energy alternatives. In a paper simultaneous to the aforementioned concept paper, Brown et al. perform a bibliometric analysis of 183 studies of energy burden in the United States[@brownPersistenceHighEnergy2020]. Among a complex web of interconnected attributes (Figure \@ref(fig:network-diagram)) they identify six interconnected themes: energy efficiency, electricity, government programs, climate & energy insecurity, health, and sustainability. Time-of-use load management is identified as a key feature, but no metrics are identified that operate on an hourly timescale. The health implications of energy burden are a hot topic of study, with many researchers focusing on the implications of improved ventilation and weatherization on respiratory health.


```{r network-diagram, include=TRUE, results="asis", out.width="100%", fig.cap="Network diagram of a bibliometric analysis of literature regarding energy burden in the United States (Brown et al. 2020)."}
knitr::include_graphics("Brown_NetworkDiagram.png")
```


Most notably, the United States benchmarks its Federal Poverty Level (FPL) to the food requirements of the average household[@coferFamilyFoodPlans1962] and uses the FPL as an eligibility criterion for more than 40 federal programs across ten agencies (in addition to state, charitable, and private enterprises that also do so)[@divisiondcdProgramsThatUse2015]. Food and energy are interlinked in crises and household energy is a critical part of safe housing, heating, cooling, and cooking. Therefore, energy criteria could expand program access to those underserved populations in need of assistance.

Utilizing such a limited scope of household energy expenditures as food for such a wide array of public policy seems prone to error. The welfare of two households with the same food budget may be drastically different if one prepares the food on modern and efficient electric appliances while the other combusts natural gas in the home, thereby exposing the family members to harmful air pollutants such as particulate matter, NOx, and SOx. By definition, the implications of a limited estimate of poverty used for public policy decisions stretch far beyond direct connections to food. Practitioners have posited that the standard policy of “using the ‘economy food plan’ to determine who can afford to hire an attorney” may be depriving citizens of their basic rights insofar as hiring a lawyer is not the same as purchasing food in almost any respect[@grossTooPoorHire2013].

The United Kingdom has a richer history of incorporating energy burden and energy poverty formally into its government programs. Since 2000, the U.K. has used some form of an energy burden metric to assess whether households are facing energy poverty and determine the level of support that they require as a result. Bednar & Reames review this history in the context of the United States' lack of formalization on this front[@bednarRecognitionResponseEnergy2020]. The U.K. first began its program by identifying any household which spent more than 10% of its income on energy as energy impoverished. While formal recognition of the issue proved useful, the metric itself faced problems in implementation due to its high sensitivity to fuel costs and absolute cutoff level. These critiques led to to the establishment of a "Low Income High Cost" metric which identified a household as energy impoverished if its income was lower than average and its energy costs were higher than average. This solved for issues of absoluteness faced by the ten-percent indicator, but it still faced the limitation that households can move into and out of energy poverty with relative ease due to exogenous forces such as energy market dynamics or climate. Therefore, a Low Income Low Energy Efficiency metric has recently been established, which adds a home efficiency rating to the equation, making it a more absolute measure. If a household's net annual income after energy expenditures and housing costs would be below the poverty line, and the home itself is rated below a C per the national building efficiency scale, then the household is considered to be energy improverished. The addition of a net income measure and the absolute nature of the building efficiency rating promise to improve targeting of aid to those families whose limitations are most directly related to energy.  
    
It stands to reason that a household or community’s prosperity will be broadly related to its energy affordability. The lower the energy burden, the more discretionary income is available to the household for other necessary goods and services, for savings and investments that contribute to economic growth and community well-being. Inversely, high energy burdens constrict households’ participation in society, and contribute broadly to poverty. Researchers have found that gender, age, housing age, tenure type, energy inefficiency, education, employment, geography, socioeconomic status, and race/ethnicity are associated with high energy burdens[@drehoblUSLowIncomeEnergy2016],[@rossHighCostEnergy2018].
    
Ross and Drehobl performed distinct urban[@drehoblUSLowIncomeEnergy2016] and rural[@rossHighCostEnergy2018] analyses of energy burden on behalf of the American Council for an Energy-Efficient Economy to explore this dynamic in United States cities and rural areas. While these are limited by not being traditionally peer-reviewed works, they are cononical texts among energy equity practitioners, and have established the proportion of income spent on energy expenditures as the standard energy burden metric in the United States today. To examine energy burdens in metropolitan areas, the authors used the U.S. Census Bureau and U.S. Department of Housing and Urban Development (HUD)’s American Housing Survey (AHS) data set from 2011 and 2013 to estimate annual incomes and energy expenditures for different demographic groups in the 48 largest metropolian statistical areas in the United States. The demographic groups chosen were low-income, low-income multi-family, African American, Latino, and renters due to each's history of being disproportionately impacted by environmental and housing issues. While this makes sense, the geographic and demographic limitations of this study preclude broader conclusions from being drawn about the dynamics of energy burden in America. Therefore, the authors set out to perform another analysis of rural areas using similar methods and 2015 data to explore how energy burden varies among housing types, housing tenure, race, age, and incomes. While this is a step forward, the distinction between rural and urban households perpetuates a divide in American culture that may not exist in regard to energy burdens. These two studies are severly limited by their geographic scope and the attributes they choose to examine about American communities from the start of each analysis. The Department of Energy significantly improved upon the methodology used by Ross and Drehobl in creating its Low-Income Energy Affordability Dataset (LEAD) in 2016, expanding this analytical tool nationwide at a census tract scale by utilizing the American Community Survey instead. This dataset has not been examined in the same level of detail as Ross and Drehobl's work regarding energy burdens, but it does provide the opportunity to do so.

Even if one were to discount the direct adverse effects for those households experiencing high energy burdens, the societal cost of placing excessive negative pressures on these groups may be high[@brownLowincomeEnergyAffordability2020]. Unaffordable energy has been shown to be negatively related to social cohesion, climate change responses, and disproportionate environmental impacts on low-income populations and minority groups [@carleyJusticeEquityImplications2020]. These connections could have significant implications for navigating sustainable development and meeting societal goals around decarbonization and energy use.

Conversely, we seem to be at a potential inflection point for the promotion of equitable energy prosperity. Primarily this is due to the rapid cost decline and technological improvements in modular digital components for households (solar photovoltaics, battery storage, light-emitting diodes, heat pumps, cooking surfaces, and information technology). The energy system has little history of individual ownership of its assets or competition at the grid edge[@waraCompetitionGridEdge2016]. It is now possible to provide most of the necessary energy services to a household at a lower cost than the existing electric grid by assembling a technology stack with approximately the same size and cost of ownership as a motor vehicle from a combination of solar photovoltaic panels and chemical battery storage. This opportunity is not available equally to everyone. Lower-income households are at risk of paying more for energy if those ablest to pay the cost of defection from the existing grid do so[@barboseBenefitsCostsUtilityownership2020]. We need to understand the dynamics of energy burden and whether we face an opportunity to alleviate it.

Energy affordability has received increased attention especially over the past decade, creating an opportunity to develop a set of widely accepted metrics that can suitably describe all of these dimensions[@linDoesEnergyPoverty2020]. Expanding quantitative analysis in this area can offer additional context, including the use of ratios to identify populations that could be particularly vulnerable to energy shocks or absolute energy burdens. Developing such metrics can elucidate the scale on which American households must save for energy consumption. Frequently used metrics in this category do not tell the whole story. For instance, the simple proportion of a household’s income spent on energy bills (a.k.a. energy burden) does not capture the underlying monthly cash flow patterns that may stress household budgets. More significantly, a simple proportion does not account for the fact that money spent on energy cannot be spent elsewhere, and is therefore not useful income to the household for the purposes of measuring prosperity. Including gross income in the energy burden metric has the effect of depressing the average energy burden, by definition. Furthermore, because energy expenditures are a small proportion of even the most impoverished households' total income, energy burdens are almost always very small percentages (<10%). This leads to issues with interpretability in public discourse and policy settings, and may even affect program outcomes that are based on this metric if these small numbers are rounded to even the nearest hundreth of a percent.  If the household is above an energy poverty line defined by such a metric for public policy purposes, the family may not receive critical support. Because such a small proportion of expenditures can impact different income groups so differently, ratios of this type can be a useful metric when separating across income quantiles or other categories - particularly for vulnerable populations where the absolute energy burden poses a significant difficulty or affordability threshold. However, energy burden is typically portrayed at a population-scale (e.g. the average energy burden of the population is X%). Finally, presenting the relationship between household income and energy expenditures as a proportion with income in the denominator suggests that improvements can only be made by decreasing energy expenditures or increasing incomes. However, in reality there is a positive relationship between energy expenditures and incomes because energy is an input in wealth creating processes and the unit costs of energy decrease as absolute consumption increases. Therefore, stakeholders relying solely on energy burden have limited knowledge of which historical interventions have effectively promoted the energy system's success, and a likewise limited ability to design new interventions to promote community growth and address inequity in the energy system.

Net energy analysis (NEA) offers potential support to the understanding of energy poverty through the use of formally defined Energy Return Ratios (ERR's) that articulate the relationship between the energy flows within complex systems[@carbajales-daleBetterCurrencyInvesting2014]. The implications of numerous metrics of systems-scale efficiency and net energy returns have been explored through this lens to date[@brandtGeneralMathematicalFramework2011], and are recommended as a framework for future analysis[@carbajales-daleBetterCurrencyInvesting2014]. The primary insight that this research adds to the energy burden conversation is to treat the income remaining after energy expenditures (i.e. net income) as the focus of analysis because net income is meaningful to the household and failing to account for it will lead to double-counting of energy expenditures. Another insight is that net income is the result of the use of energy by the household, not the other way around. In other words, households pay for energy expenditures in order to unlock the value that energy services provide to them as participants in society, whether to cook food or connect to the internet. Therefore, the efficiency of a process like household wealth creation is best articulated by placing net income in the numerator of the metric. A final significant insight from net energy analysis that might be incorporated into future work is that embodied energy takes many forms across the household budget (food, goods, services, housing, etc.), and these can all be compared using the same units of measure (e.g. joules).

Finally, further research coalesces around an emerging interdisciplinary interrogation of energy through “macro-energy systems analysis", a class of systems defined by their scale, complexity, and particular suitability for net energy analysis[@leviMacroEnergySystemsNew2019]. Research associated with this macro-energy systems scale examines the net energy dynamics of communities, such as networks of homes connected by a shared electricity grid or geographic boundaries, yet does not explore the energy poverty dimensions through this lens. Nevertheless, different communities in the United States are experiencing energy poverty in different ways. Net energy analysis can be applied as a way to identify energy poverty and determine whether increasing household burdens are going to energy expenditures. This could suggest that the technology-level cost reductions occuring in energy system development are not necessarily accruing to everyday consumers.

The relationship between energy spending and household income in America has been examined at different scales to date, with particular emphasis on how disparate household net energy ratios signal economic disparities across communities, racial and ethnic groups, and levels of income. While there are numerous approaches to assessing energy affordability, a gap in the current discussion over energy equity exists. There is no appropriate biophysical framework to evaluate the disparities among household net energy outcomes, and no analysis of the entire country at a granular geographic scale.

# Code Availability

The code to fully reproduce this paper is available [here](https://github.com/ericscheier/net_energy_equity).

# References

::: {#refs}
:::

<!--chapter:end:net_energy_equity_review.Rmd-->

---
title: "Energy Poverty in the U.S."
author: "Eric Scheier"
institute: 
  - "ENVR 890"
date: "`r format(Sys.time(), '%Y-%B-%d')`"
output: 
  beamer_presentation:
    slide_level: 1
    toc: false #true
    theme: "Berkeley"
    colortheme: "seagull"
    fonttheme: "structurebold"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{makecell}
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)

knitr::opts_chunk$set(echo=FALSE)
```

# Why Energy Poverty?

\begin{columns}
\column{0.6\textwidth}
```{r sdgs}
knitr::include_graphics("Goal-7-infographic.png")
```

\column{0.4\textwidth}
[Source: United Nations]
\end{columns}


# Why the United States?

```{r insecurity}
knitr::include_graphics("texas_blackout_home.jpg")
# knitr::include_graphics("EIA_RECS_2015_insecurity.png")

# + 1 in 3 U.S. households report facing a challenge in meeting energy needs
# + 1 in 5 households report reducing or forgoing necessities such as food and medicine to pay an energy bill
# + 1 in 7 reporte receiving a disconnection notice for energy service
# + 1 in 10 report keeping their home at an unhealthy or unsafe temperature

# [Source: U.S. Energy Information Administration, Residential Energy Consumption Survey 2015]
```

# Urban Centers

```{r}
knitr::include_graphics("net_energy_equity_files/figure-latex/urban-map-1.pdf")
```

# Previous Analyses

+ Bednar & Reames - compares 3 energy poverty metrics used in UK
+ Petchari et al. - examines more sophisticated metrics in the context of SDG 7
+ Brown et al - Why does the U.S. have energy poverty in the first place?
+ Sergi et. al - How can decarbonization alleviate health and poverty?
+ ACEEE - Performed distinct urban and rural analysis of energy burden

# Energy Burden & Net Energy Return

\[
G_{income} = Gross\ Income
\]

\[
S_{energy} = Spending\ on\ Energy
\]


\[
Energy\ Burden = \frac{S_{energy}}{G_{income}}
\]

\[
NetEnergyReturn_{household} = \frac{G_{income} - S_{energy}}{S_{energy}}
\]

Energy Poverty = 10% or more of income toward energy

# Why Net?

```{r comparison}
knitr::include_graphics("net_energy_equity_files/figure-latex/metric-comparison-1.pdf")
```

# Summary

```{r load-table, include=FALSE}
print_table <- read_csv("comparison_table.csv")
```

```{r table, results="asis"}
print_table %>%  knitr::kable(booktabs=T, ) %>%
  kable_styling(latex_options="scale_down")
  #kableExtra::kable_styling(latex_options = c("striped","hold_position"))
```

# Geography

```{r pressure}
knitr::include_graphics("net_energy_equity_files/figure-latex/continental-map-1.pdf")
```

# Urban Centers

```{r}
knitr::include_graphics("net_energy_equity_files/figure-latex/urban-map-1.pdf")
```

# Household Breakdowns

```{r}
knitr::include_graphics("net_energy_equity_files/figure-latex/density-charts-1.pdf")
```

# State Comparison

```{r}
knitr::include_graphics("net_energy_equity_files/figure-latex/state-violin-1.pdf")
```

# Conclusions

+ 10% of households experience energy poverty as presently defined as spending more than 10% of household income on energy expenditures.
+ While 78% of households below the federal poverty line also face energy poverty, fewer than 1% of those above the federal poverty line face this scarcity. 
+ Energy Poverty presents an obstacle to debarbonization and wealth creation

# Conclusions

Energy expenditures in the US disproportionately burden those in:

+ The Black Belt across the Southeastern U.S.
+ Hispanic communities near the U.S.-Mexico border
+ Native American lands
+ Urban Centers

The United States should develop and implement a federal energy poverty line

# Future Research

+ Include additional demographic and techno-economic data found in Renewable Energy Potential of Low-Income Communities in America (REPLICA) Dataset
+ Focus on certain jurisdictions (cities, counties, utilities)
+ Examine unusual outcomes (e.g. 20% of those below poverty line who are not in energy poverty)
+ Formally compare different metrics to identify which are suited for what purposes

# Questions

Questions?

<!--chapter:end:net_energy_equity_review_slides.Rmd-->

---
title: "Net Energy Equity"
author: "Eric Scheier"
institute: 
  - "University of North Carolina - Chapel Hill"
  - "Environment, Ecology, and Energy Program (E3P)"
  - "Advising Committee: Noah Kittner (Chair), Nikhil Kaza, & Andy Yates"
  - "This Presentation Will Be Recorded"
date: "`r format(Sys.time(), '%Y-%B-%d')`"
output: 
  beamer_presentation:
    slide_level: 1
    toc: false #true
    theme: "Berkeley"
    colortheme: "seagull"
    fonttheme: "structurebold"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{makecell}
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)

knitr::opts_chunk$set(echo=FALSE)
```

# Why Energy Equity?

\begin{columns}
\column{0.8\textwidth}
```{r sdgs, out.width="80%", fig.cap=""}
knitr::include_graphics("Goal-7-infographic.png")
```
\column{0.2\textwidth}
[Source: United  
Nations]
\end{columns}

# Why the United States?

```{r insecurity, out.width="100%", fig.cap=""}
knitr::include_graphics("texas_blackout_home.jpg")
# knitr::include_graphics("EIA_RECS_2015_insecurity.png")

# + 1 in 3 U.S. households report facing a challenge in meeting energy needs
# + 1 in 5 households report reducing or forgoing necessities such as food and medicine to pay an energy bill
# + 1 in 7 reporte receiving a disconnection notice for energy service
# + 1 in 10 report keeping their home at an unhealthy or unsafe temperature

# [Source: U.S. Energy Information Administration, Residential Energy Consumption Survey 2015]
```

[Source: The Guardian]

# Previous Analyses

+ Pachauris & Rao: development context of SDG 7  
    + Multi-tier framework: duration, quality, reliability, capacity, levels, & affordability
    + Simplified alternative framework: availability, cost, level, & affordability
+ Bednar & Reames: follows UK policy history from 2000  
    + Energy Burden: energy spending > 10% of inome
    + Low Income High Cost: income/cost lower/higher than average
    + Low Income Low Efficiency: added home efficiency rating
+ Brown et al.: Why does the U.S. have energy poverty in the first place?
    + 2020a: bibliometric analysis of 183 papers
    + 2020b: thematic exploration of issue cause and effect
+ ACEEE: Distinct urban and rural analyses of energy burden
    + The High Cost of Energy in Rural America (Ross et al.)
    + The US Low-Income Energy Affordability Landscape (Drehobl and Ross)

# Limitations

+ Require many varaibles / data (e.g. efficiency standards)
+ Mix of energy access, insecurity, poverty, and affordability
+ Focus on highly specific geographies or aggregates
+ Depend on strict cutoffs
+ Annual timescale

# New Data

Low-Income Energy Affordability Data (LEAD)

**Purpose**: "to help state and local partners understand housing and energy characteristics for the low- and moderate-income (LMI) communities they serve"

  + **Source**: U.S. Department of Energy
  + **Method**: Iterative Proportional Fitting (IPF) of responses from the 5-year American Community Survey (ACS-5)
  + **Geography**: Census tracts for 50 states, D.C., & P.R.
  + **Provides**: Incomes and Energy Costs by Housing Characteristics
  + **Years**: 2016, 2018

# Cohort Attributes

+ Census Tract [n=~70,000]
+ Income Bracket (% of AMI or FPL) [5]
+ Housing Tenure (Rent / Own) [2]
+ Building Age (increments of 10-20 years from 1940) [6]
+ Number of Units (1, 2, 3-4, 5-9, etc.) [10]
+ Primary Heating Fuel (Electric, Gas, Solar, Wood, etc.) [9]

For each combination we have the average annual:  

+ Income
+ Electricity, Gas, & Other Fuel Spending

5,400 types of home *per census tract*  
~400 million cohorts (most with 0 households)  
~60 GB of data

# Simplified Cohort Attributes

Simplify:

+ Census Tract [~70,000]
+ Income Bracket (high/medium/low compared to AMI or above/below FPL) [2-3]
+ Housing Tenure (Rent / Own) [2]
+ ~~Building Age (increments of 10-20 years from 1939) [6]~~
+ Number of Units (Single vs. Multi-family) [2]
+ Primary Heating Fuel (Electric, Gas, Solar, Other) [4 - optional]

8-48 types of home  
~0.5-5 million cohorts  
~1 GB of data

# Complementary Data
+  Emissions & Generation Resource Integrated Database (eGRID)
    + Source: U.S. Environmental Protection Agency
    + Provides: Fuel sources for electricity generation
+ 5-Year American Community Survey (ACS)
    + Source: U.S. Census Bureau
    + Provides: Shapefiles by Census Tract
+ Renewable Energy Potential of Low-Income Communities in America (REPLICA) Dataset
    + Source: U.S. Department of Energy
    + Provides: Demographics, Rooftop Solar Potential, Climate
+ Energy Information Agency Form 861 (EIA=861)
    + Source: U.S. Energy Information Agency
    + Provides: Electricity Prices
+ Energy Information Agency Form 857 (EIA-857)
    + Source: U.S. Energy Information Agency
    + Provides: Natural Gas Prices

# Local Attributes Available

+ *Electric Utility Type (Publicly/Privately Held, Cooperative, Government-Owned)
+ *State Electricity Fuel Composition
+ Rooftop Solar Potential (MW, MWh, Rooftop Area)
+ Demographics (Age, Gender, Race, Education, Religion)
+ Climate (Heating/Cooling Degree Days, Climate Zone)

*Used in the present analysis

# Methods

Tasks

+ Aggregate state data into a national dataset
+ Merge LEAD and REPLICA
+ Incorporate EPA eGRID and other supplemental data
+ Clean, simplify, and make interpretable names
+ Performed for 2018 (most recent year of data available)

Infrastructure

+ Reproducible Research
    + Uses The R Project for Statistical Computing
    + Code is fully open source (GNU Affero GPL v3.0)
    + https://github.com/ericscheier/net_energy_equity
+ AWS m4.4xlarge EC2 instance
    + 16 vCPUs, 64 GB RAM, 256 GB EBS Storage
    + Linux Ubuntu 20.04 LTS (Focal Fossa)

# Energy Burden & Net Energy Return

\[
G_{income} = Gross\ Income
\]

\[
S_{energy} = Spending\ on\ Energy
\]

\[
Energy\ Burden = \frac{S_{energy}}{G_{income}}
\]
**"Energy poverty: spend >10% of income on energy."**
\[
Net\ Energy\ Return = \frac{G_{income} - S_{energy}}{S_{energy}}
\]
**"Energy poverty: earn <$9 for every \$1 spent on energy."**

# Why Net?

```{r comparison, fig.cap=""}
knitr::include_graphics("net_energy_equity_files/figure-latex/metric-comparison-1.pdf")
```

# Summary

```{r load-table, include=FALSE}
print_table <- read_csv("comparison_table.csv")
```


```{r table, results="asis"}
print_table %>%  knitr::kable(booktabs=T, ) %>%
  kable_styling(latex_options="scale_down")
  #kableExtra::kable_styling(latex_options = c("striped","hold_position"))
```

# Geography

```{r pressure, fig.cap=""}
knitr::include_graphics("net_energy_equity_files/figure-latex/continental-map-1.pdf")
```

# Urban Centers

```{r, fig.cap=""}
knitr::include_graphics("net_energy_equity_files/figure-latex/inset-map-1.pdf")
```


# Household Breakdowns

```{r breakdowns, fig.cap=""}
knitr::include_graphics("net_energy_equity_files/figure-latex/density-charts-1.pdf")
```

# State Comparison

```{r states, fig.cap=""}
knitr::include_graphics("net_energy_equity_files/figure-latex/state-violin-1.pdf")
```

# Conclusions

+ 10% of households experience energy poverty as presently defined (>10% of household income on energy expenditures)
+ 78% of households below the federal poverty line also face energy poverty
+ Fewer than 1% of those above the federal poverty line face this scarcity
+ Fossil fuel reliance does not lead to lower energy poverty rates at a state scale
+ Solar power is associated with decreased energy poverty at a household scale
+ Energy poverty presents an obstacle to decarbonization and wealth creation

# Conclusions

Energy expenditures in the US disproportionately burden those in:

+ The Black Belt across the Southeastern U.S.
+ Hispanic communities near the U.S.-Mexico border
+ Native American lands
+ The rural Northeast
+ Urban Centers

The United States should develop and implement a federal energy poverty line.

# Future Research

+ Include additional demographic and techno-economic data found in the REPLICA Dataset
+ Focus on certain jurisdictions (zip codes, cities, counties, utilities)
+ Examine unusual outcomes (e.g. 20% of those below poverty line who are not in energy poverty)
+ Formally compare different metrics to identify which are suited for what purposes

# Acknowledgements

- Noah Kittner
- Nikhil Kaza
- Andy Yates
- Paul Leslie
- Leda Van Doren
- Violet Anderson
- Karyn Miller
- Chuck, Sue, and Beau Scheier

# Thank You

Questions?

<!--chapter:end:net_energy_equity_slides.Rmd-->

---
title: Energy Burden Report for Sonoma Clean Power
subtitle: 
titlerunning: Net Energy Equity
authorrunning: Eric Scheier
# thanks:
author:
 - Eric Scheier:
     email: eric@scheier.org
     institute: [emergi]
     correspondence: true
institute:
 - emergi: Emergi Foundation, Carrboro, NC, USA
keywords:
  - energy burden
  - net energy
  - macro-energy systems
  - energy inequality
bibliography: references.bib
bibstyle: spphys
csl: nature-no-et-al.csl
journalname: Nature Energy
date: "`r format(Sys.time(), '%d %B %Y')`"
toc: false
output:
  bookdown::pdf_document2:
    number_sections: false
    keep_tex: true
    documentclass: article
    pandoc_args:
      - '--lua-filter=color-text.lua'
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
    includes:  
      in_header: preamble-latex.tex
  bookdown::html_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=color-text.lua'
  bookdown::word_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=color-text.lua'
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
  bookdown::pdf_book:
    base_format: rticles::springer_article
    keep_tex: true
tables: true
fig_caption: true
always_allow_html: true
header-includes:
- \usepackage{booktabs}
# - \usepackage[left]{lineno}
# - \linenumbers
- \usepackage{setspace}
- \usepackage{xcolor}
- \usepackage{mathtools}
- \usepackage[normalem]{ulem}
- \usepackage{float}
# - \doublespacing
- \usepackage{color}
- \usepackage{soul}
- \definecolor{lightblue}{rgb}{0.90, 0.95, 1}
- \definecolor{fancycolor}{rgb}{0.258, 0.517, 0.960}
- \sethlcolor{fancycolor}
- \usepackage{caption}
---

```{r setup, include=FALSE}
is_final=FALSE #TRUE
is_preview= TRUE #FALSE
is_draft= TRUE
set.seed(456)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','asis')),
                      fig.keep='all', #'last'
                      dev='cairo_pdf',#'pdf',
                      fig.show='hold',#'hide
                      # fig.pos = "!H",
                      # out.extra = "",
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=TRUE, #ifelse(is_draft, TRUE, ifelse(is_preview, TRUE, !is_final)),
                      cache.lazy=FALSE,
                      fig.margin=FALSE,
                      fig.fullwidth=TRUE, #FALSE
                      eval.after = "fig.cap"#,
                      # cache.path = 'net_energy_equity_cache/', 
                      # fig.path = 'net_energy_equity_files/'
                      )

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 
    "latex" else "pipe"
})

edit_color = "black" #"red" #"black
strike_show = "hide" #"show" #"hide"
hide = "FALSE" #"TRUE" #
highlight = "TRUE" #"TRUE" #"FALSE"
```

```{r option-view, include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)

# knitr::opts_current$get(c(
#   "cache",
#   "cache.path",
#   "cache.rebuild",
#   "dependson",
#   "autodep"
# ))

kable(knitr::opts_chunk$get() %>% enframe())
```


```{r sources, cache=FALSE}
source("sources.R")
```

```{r parameters}
states <- "all" #c("ca","nc","sc") #
refresh <- FALSE
acs_version <- 2018
energy_burden_poverty_line <- 0.06
# geographic_scope <- "tract" #statecitycounty
```

```{r auth}
tidycensus::census_api_key(
  key = config::get("census_api")$key,
  overwrite = TRUE, 
  install = FALSE
)
# readRenviron("~/.Renviron")
```


```{r run-methods, cache=TRUE, eval=FALSE}
paper_methods(states=states,
              acs_version=acs_version,
              energy_burden_poverty_line=energy_burden_poverty_line,
              refresh=refresh)
```


```{r preprocessing}

clean_data_ami_all <- read_csv("CohortData_AreaMedianIncome.csv")
clean_data_fpl_all <- read_csv("CohortData_FederalPovertyLine.csv")
replica_sup <- read_csv("CensusTractData.csv") #get_replica_supplemental_dataset()

clean_data_ami <- left_join(clean_data_ami_all, 
                            replica_sup[,c("geoid","company_na","county_name")], 
                            by=c("geoid")) %>%
                                  filter(state_abbr=="CA", 
                                         county_name %in% 
                                           c("Sonoma County",
                                             "Mendocino County"),
                                         company_na=="Pacific Gas & Electric Co"
                                         )

clean_data_fpl <- left_join(clean_data_fpl_all, 
                            replica_sup[,c("geoid","company_na","county_name")], 
                            by=c("geo_id"="geoid")) %>%
                                  filter(state_abbr=="CA", 
                                         county_name %in% 
                                           c("Sonoma County",
                                             "Mendocino County"),
                                         company_na=="Pacific Gas & Electric Co"
                                         )

# this is where geospatial and other filtering should happen

## define territory 
## define zoom scope/area - if NULL, use the most populous scale below the territory scale (e.g. largest city in the county)

source("paper_source.R")
# tract_file_name <- paste0("data/",paste(states,collapse="_",sep=""),"_census_tracts.geojson")

census_tracts_shp <- get_tract_shapefiles(
    states=states,
    acs_version=acs_version,
    refresh=refresh,
    return_files=TRUE,
    all_from_list=unique(replica_sup$state_abbr)
  )

tract_shp <- st_sf(left_join(census_tracts_shp, replica_sup, by=c("gisjoin")))

continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))

state_shp <- tract_shp %>% filter(state_abbr=="CA")

territory_shp <- tract_shp %>% filter(state_abbr=="CA", 
                                         county_name %in% 
                                           c("Sonoma County",
                                             "Mendocino County"),
                                         company_na=="Pacific Gas & Electric Co"
                                         )
```

```{r}
# Things in here should probably be moved further up the data processing pipeline
# clean_data_ami$number_of_units <- as.factor(ifelse(clean_data_ami$min_units > 1, "mf", "sf"))
# clean_data_fpl$number_of_units <- as.factor(ifelse(clean_data_fpl$min_units > 1, "mf", "sf"))
```




\newpage

**Abstract: In [the United States]{highlight=`r highlight`} -- `r scales::percent(energy_poverty_rate, accuracy=1)` of households experience energy poverty as presently defined as spending more than `r to_percent(energy_burden_poverty_line)` of household income on energy expenditures and more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` households above the Federal Poverty Line face energy poverty. Households in energy poverty are disproportionately located in primarily [Black, Hispanic, and Native American] communities.]{highlight=`r highlight`}**

## [Introduction]{highlight=`r highlight`}

\[G = Gross\ Income\ ;\ S = Spending\ on\ Energy\]
\[
Energy\ Burden\ (E_{b})= \frac{S}{G}
\]
\[
Household\ Net\ Energy\ Return\ (N_{h}) = \frac{G - S}{S}
\]
\[E_{B}^{*} = \frac{S}{G} = 6\%\ ;\ N_{h}^{*} \approx 16 \Rightarrow Household\ at\ Energy\ Poverty\ Line\]

Studies have established the proportion of income (*G*) spent on energy expenditures (*S*), or energy burden (*E~b~*), as the standard benchmark for energy poverty in the US today (Equation 1).

\begin{align}
Energy\ Burden\ (E_{b})= \frac{S}{G}
\end{align}

[Household NER (*N~h~*)]{color=`r edit_color`} represents the net earnings a household receives for every expenditure on secondary energy, defined according to Equation 2.

\begin{align}
Household\ Net\ Energy\ Return\ (N_{h}) = \frac{G - S}{S}
\end{align}

[While a variety of thresholds have been developed and explored, energy-poor households in the US are]{color=`r edit_color`} commonly defined in terms of *E~b~* as [those with]{color=`r edit_color`} an expenditure of greater than [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} of household income on energy [based on the logic that energy expenditures should not be greater than 20% of housing expenses, which themselves should not exceed 30% of household income[@brownLowincomeEnergyAffordability2020]]{color=`r edit_color`}. Calibrating our [*N~h~*]{color=`r edit_color`} analysis to this level will help gauge different thresholds of energy poverty and benchmark the results of this paper to the energy poverty literature while acknowledging the continuum of experiences across household energy consumption. Translated into its relative level for [*N~h~*]{color=`r edit_color`}, the energy poverty line *N~h~* is defined according to Equation 3 as `r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r round(ner_poverty_line,0)`.

\begin{gather}
\nonumber E_{B}^{*} = \frac{S}{G} = `r colorize(100*energy_burden_poverty_line, edit_color)`\%\\
N_{h}^{*} = \frac{G-S}{S}\ such\ that \ \frac{S}{G} = `r colorize(100*energy_burden_poverty_line,edit_color)`\%\\
\nonumber N_{h}^{*} `r ner_nice_text`\Rightarrow Household\ at\ Energy\ Poverty\ Line
\end{gather}

This means that a household that earns less than [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r to_dollar(ner_poverty_line)`]{color=`r edit_color`} of income for every dollar it spends on secondary energy will be considered to be in energy poverty by the traditional *E~b~* accounting method. An *N~h~* of [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately")` `r round(ner_poverty_line,0)`]{color=`r edit_color`} or lower is equivalent to an *E~b~* of [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} or higher. This threshold is arbitrary and may not be suitable in situations where households fall very close to this line or where the numbers of family members or measures of certain building characteristics vary widely. Simply, it is presented as a benchmark. We examine the [*N~h~*]{color=`r edit_color`} at a community scale across the [US]{color=`r edit_color`} in Table \@ref(tab:comparison-table).

[Here, we examine the relationship between energy spending and household energy income and observe spatial disparities across a census-tract scale—particularly across race and ethnicity, income, housing tenure, and educational attainment. A difference of $500 in annual energy expenditures dramatically improves many middle and high-income households’ ability to enjoy benefits from energy services for low cost (2-5% of annual income), but basic energy expenditures comprise approximately 14% of annual earnings for low-income households. The categorizations for federal assistance programs that are based on poverty line indices fail to capture at least 5.3 million households that would benefit from energy support and assistance. Households in communities of color experience energy poverty at a rate 60% greater than those in white communities based on this study. Additionally, state-level analysis demonstrates wider spatial disparities across states such as Maine, where residential heating oil and fuelwood remain common heat energy sources and states such as Alabama and Mississippi which have among the lowest net energy returns on average. This empirical analysis fills a gap in the current discussion about energy equity by providing a framework to evaluate disparities and include more households in energy poverty metrics that are aligned with the assessment of energy flows through biological, physical, and economic systems.]{highlight=`r highlight`}

## [Results]{highlight=`r highlight`}

For the discussion of household energy poverty, we are primarily interested in how households of different characteristics are distributed according to their [*N~h~*]{color=`r edit_color`}s, representing how many net dollars are earned by a household for every dollar it spends on energy. Since the *N~h~* is unitless but is a ratio of return on investment, we present it below interchangeably with no units or in units of $\$/\$$ depending on context. Other proposed indicators of energy poverty may be similarly examined in this manner. 


#### Application to Energy Poverty  {#poverty-line}




#### The Energy Poverty Landscape for [Territory] {#landscape}


```{r comparison-table-math}
# table with states'/groups' median annual household energy expenditures, incomes, net incomes, *N~h~*, and *E~b~*
compare_table <- create_comparison_table(
    metrics_to_compare=NULL,
    input_dataset=clean_data_ami,
    include_totals=TRUE
)
  
#write_csv(print_table, "comparison_table.csv")

highlight_metrics <- rbindlist(lapply(c(
                                    "energy_burden",
                                    "ner"
                                    ), compare_metrics,
                                    input_dataset=clean_data_ami))

highlight_energy_burden <- as.numeric(highlight_metrics[metric_name=="energy_burden" & income_bracket=="very_low","metric_mean"])

highlight_ner <- as.numeric(highlight_metrics[metric_name=="ner" & income_bracket=="very_low","metric_mean"])

num_one <- paste0(to_big(highlight_energy_burden*100),"\\%")
num_two <- round(highlight_ner,1)
# glue::glue(
```


```{r}
total_homes <- tidycensus::get_acs(geography = "us",
                    variables = c(households="B25002_002"),
                    year = acs_version)
# head(total_homes)
estimated_homes <- compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","value"]
min_homes <- total_homes$estimate - total_homes$moe
max_homes <- total_homes$estimate + total_homes$moe
```


[We use LEAD[@maLowIncomeEnergyAffordability2019] (n=`r compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","print_value"]` households) to evaluate the *N~h~* dynamics across the US. The average US home in the dataset]{color=`r edit_color`} has an income of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="income","print_value"]` and an annual energy expenditure of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","print_value"]` (`r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","value"])/12)`/month), which equates to an average *E~b~* of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_burden","print_value"]` or an average [*N~h~*]{color=`r edit_color`} of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="ner","print_value"]`. While the dataset slightly overrepresents households below the median income due to the limitations of the statistical methods used to compile them, it represents estimates for approximately `r to_percent(as.numeric(estimated_homes/(max_homes)))`-`r to_percent(as.numeric(estimated_homes/(min_homes)))` of the `r to_million(min_homes, suffix="")`-`r to_million(max_homes)` family-occupied households evaluated by the American Community Survey. Table \@ref(tab:comparison-table) shows a summary of these data for households and their average statistics [delineated by their]{color=`r edit_color`} incomes relative to [the median income of similar size families in the same metropolitan area or non-metropolitan county, known as]{color=`r edit_color`} Area Median Income (AMI). We can see that high burdens are found mostly in the very-low-income group, with an average *E~b~* of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` or [*N~h~*]{color=`r edit_color`} of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="ner","print_value"]`. Income drives the escape from energy poverty: middle and high-income groups do not spend drastically different amounts on energy (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` and `r to_percent(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` more, respectively) but earn `r to_big(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` and `r to_big(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` times that of the very low-income group, respectively. An *E~b~* of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` means that `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month is spent on energy, which is quite high on a monthly income of `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"])/12)`. The additional `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month that the next rung of moderate-income groups spends on energy represents a minuscule proportion of their income (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"]))`).


(ref:comparison-table-caption) Average annual household energy expenditures, incomes, net incomes, [*N~h~*]{color=`r edit_color`}s, and [*E~b~*]{color=`r edit_color`}s portrayed for different income groups based on their relationship to [AMI]{color=`r edit_color`}. Note that the statistics for [*E~b~*]{color=`r edit_color`} and [*N~h~*]{color=`r edit_color`} are calculated per cohort after averaging the income and expenditure statistics to avoid the effect of extreme values skewing the interpretability of these metrics as described in the text. For example, the actual weighted average [*E~b~*]{color=`r edit_color`} for households from 0-30% AMI is `r num_one`, and the average [*N~h~*]{color=`r edit_color`} for this cohort is `r num_two` due to subsets of the dataset with very low incomes or low energy expenditures. [*N~h~*]{color=`r edit_color`} is not as susceptible to this skewing effect.

```{r comparison-table, include=TRUE, results="asis"}
final_table <- subset(create_printable_comparison_table(compare_table), 
                      subset=TRUE, select=-All) %>%  
  knitr::kable(booktabs=T,
               escape = F,
               caption='(ref:comparison-table-caption)') %>% 
  kableExtra::kable_styling(latex_options = "H") %>% 
  kableExtra::add_footnote(
    # input,
    label = c(
      "AMI: Area Median Income",
      #"*E~b~*: Energy Burden",
      #"*N~h~*: Net Energy Return",
      "\\textit{N\\textsubscript{h}}: Household Net Energy Return",
      "\\textit{E\\textsubscript{b}}: Household Energy Burden"
              ),
    notation = "none", #number, alphabet, symbol and none
    threeparttable = FALSE,
    escape = FALSE
    )
  # kableExtra::row_spec(c(2,3,4,6), bold=T)
  # kableExtra::kable_styling(latex_options = c("striped"), #,"hold_position"
                            # position="center")
final_table
```

[[Because cleaner investments could lower costs over time, we can immediately see a disproportionate burden for those making low income to shifting expenditures to other forms of fuel if any upfront investment is required. Fossil fuel costs are not internalized, so it seems like lower-income cohorts are paying less monetarily. Still, they are paying the costs in other ways, such as through health and environmental externalities. Even without these externalities priced in, the burden of energy for low-income groups is already very high.]{strike=`r strike_show`}]{color=`r edit_color`}

[Another contribution of this work is that by using *N~h~*, we can display these data spatially across the US to explore how different communities are experiencing energy outcomes as in Figure \@ref(fig:continental-map) and investigate specific communities at multiple scales such as census tract, county, state, and regional as in Figure \@ref(fig:inset-map). Furthermore, we can break down the data among meaningful subsets as in Figure \@ref(fig:density-charts) and examine state-by-state trends as in Figure \@ref(fig:state-violin). This is useful because the presence of energy inequity is harder to see in urban areas compared to rural areas for which census tracts are a larger physical area or when certain household characteristics such as primary heating fuel are related to widely differing energy outcomes in the same area. Additionally, it shows a spatial variation of energy poverty that includes `r to_million(number_in_poverty[1]+clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum())` more households that would not be captured by traditional poverty metrics because their incomes are too low (*E~b~*>100%) or too high (above the FPL). By processing disparate data sources into a coherent structure and providing a convenient open-source tool for others to do the same, these data can be used in urban planning, public policy, and other relevant contexts.]{color=`r edit_color`}

Displayed geospatially in Figure \@ref(fig:continental-map), [*N~h~* allows a nuanced view of widely ranging income dynamics by portraying them on a scale that matches the scope of the issues: areas of high energy burden (close to *N~h~*=0) are visible in orange while highly affluent areas are also visually perceptible as dark blue even though these groups' average metrics are multiple orders of magnitude apart.]{color=`r edit_color`}

(ref:continental-map-fig-cap) Map of the average net earned income per secondary energy expenditure for each census tract in the continental [US]{color=`r edit_color`}. Shades of yellow and red[, respectively,]{color=`r edit_color`} indicate communities at or below the energy poverty line as defined by earning [`r ifelse(ner_poverty_line==round(ner_poverty_line),"","approximately ")` `r round(ner_poverty_line,0)`]{color=`r edit_color`} dollars or less in income per dollar of energy expenditures. This corresponds to the traditional definition of energy poverty as spending [`r to_percent(energy_burden_poverty_line)`]{color=`r edit_color`} or more of income on energy. Low [*N~h~*]{color=`r edit_color`}s can be starkly observed in the Black Belt across the Southeastern US, Hispanic communities near the US-Mexico border, Native American lands, and rural New England.

```{r continental-map, include=TRUE, results='asis', fig.cap='(ref:continental-map-fig-cap)', fig.width=8.0,fig.height=5.5}

group_variable <- "geoid"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami_all, group_columns, metric_name)


# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

# full_map_data <- left_join(tract_shp, gwm, by=c("geoid"))

gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami_all,
                                                    c("geoid"),
                                                    metric_name),
                           c("geoid"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)

gwm$metric_name <- metric_name

territory_map_data <- left_join(territory_shp, gwm, by=c("geoid"))
state_map_data <- left_join(state_shp, gwm, by=c("geoid"))
continental_map_data <- left_join(continental_shp, gwm, by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(graph_data %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens in SCP's Service Territory"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = TRUE,
    metric_long_name = bquote(N[h]) #"Net\nEnergy Return"
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)

# print(choropleth_chart_footnote)
```

Urban inequity results in lower *N~h~* populations not showing up in many dense or gentrified urban areas such as the San Francisco Bay Area, New York City, and New Orleans, as shown in Figure \@ref(fig:inset-map). [[A notable exception to this trend is Detroit, in which t]{strike=`r strike_show`}T]{color=`r edit_color`}he pervasiveness of urban energy poverty [in Detroit]{color=`r edit_color`} has been studied extensively and shown to have distinct geographic boundaries [down to the street level]{color=`r edit_color`}[@bednarIntersectionEnergyJustice2017]. While some of these conclusions are supported by existing evidence and literature, they should be confirmed with a rigorous analysis of this dataset using the *N~h~* metric for the reasons explained in [Applying NER to Energy Equity](#ratios)[: extremely low-income households are not visible on a 0-100% scale, and households with no income are often discarded as outliers.]{color=`r edit_color`} Additional analyses should incorporate additional demographic and household dimensions due to potential disparities within census tracts since diverse neighborhoods may not be represented accurately by aggregate census tract metrics.

(ref:inset-map-fig-cap) An inset focused on the city of New Orleans, Louisiana (Orleans Parish). This view shows an example of the dynamics of energy poverty in an urban area where the presence of energy inequity is harder to see compared to rural areas for which census tracts are a larger physical area.

```{r inset-map, eval=FALSE, include=TRUE, results='asis', fig.cap='(ref:inset-map-fig-cap)', fig.width=8.0,fig.height=5.5}

# find the largest urban area in the maps_data and zoom into that

# inset_map_data <- map_data %>% filter(county_name=="Orleans Parish"
#                                      & state_abbr=="LA")

inset_bb <- st_buffer(st_as_sfc(st_bbox(territory_map_data)) %>% st_transform(3857), dist=100000)

choropleth_chart_highlight <- choropleth_map(
    clean_data=state_map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    legend_position = "none"
    ) + 
  geom_sf(data = inset_bb, fill = NA, color = "green", size = 0.25) + 
  theme_void() + 
  theme(
      legend.position = "none")

# https://en.wikipedia.org/wiki/New_Orleans_metropolitan_area
choropleth_chart_inset <- choropleth_map(
    clean_data=territory_map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="Inset of Energy Burdens in SCP's Service Territory",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    legend_position = c(.85,.4),
    include_compass = TRUE,
    metric_long_name = bquote(N[h]))

gg_inset_map = ggdraw() +
  draw_plot(choropleth_chart_inset) +
  draw_plot(choropleth_chart_highlight, x = 0.150, y = 0.625, width = 0.35, height = 0.35)

# gg_inset_map

gg_inset_map_footnote <- gridExtra::grid.arrange(
  gg_inset_map,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
# ggsave2("national_map.pdf",plot=choropleth_chart)
# ggsave2("inset_map.pdf",plot=gg_inset_map)

# grid.arrange(choropleth_chart,gg_inset_map, nrow=2)
# cowplot::plot_grid(choropleth_chart,gg_inset_map, align = "v", nrow=2)
```

From this high level, we can see in Figure \@ref(fig:density-charts)[.a]{color=`r edit_color`} that approximately `r scales::percent(energy_poverty_rate, accuracy=1)` of households in the [US]{color=`r edit_color`} experience energy poverty. Displaying these communities defined by their relationship to the US Federal Poverty Line (FPL), which indicates income poverty status according to government policy, in [Figure \@ref(fig:density-charts).b]{color=`r edit_color`} provides a stark picture. While `r scales::percent(in_both_poverty, accuracy=1)` of households below the FPL also face energy poverty, [more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` of those households]{color=`r edit_color`} above the FPL face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap [and the inadequacy of FPL as an indicator of energy poverty in particular]{color=`r edit_color`}. When we break the group of relatively prosperous households into subsets [as outlined in Table \@ref(tab:comparison-table)]{color=`r edit_color`}, we find that `r scales::percent(as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","households_below_cutoff"])/as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","household_count"]),accuracy=1)` of households living at 30-80% of their [AMI]{color=`r edit_color`} are experiencing energy poverty. This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in [*N~h~*]{color=`r edit_color`} on the households’ energy investments is surprising.


```{r}
top_line_group <- NULL

p1 <-   density_chart(graph_data, 
                                 metric_name, 
                                 metric_label="", 
                                 group_columns=top_line_group, 
                                 metric_cutoff_level, 
                                 metric_cutoff_label, 
                                 chart_title=NULL, 
                                 chart_subtitle=NULL,
                                 x_label="")
```

```{r}
top_line_group <- "income_bracket"

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p2=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p3=top_line_charts[["density"]]
p3_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("super_simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")

fuel_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("super_simplified_primary_heating_fuel",
                    "income_bracket")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")

fuel_income_stats=top_line_charts[["metrics"]]
```


[Figure \@ref(fig:density-charts).c shows that h]{color=`r edit_color`}ouseholds with solar as a primary heating fuel have a higher [*N~h~* (*N~h~*=`r round(fuel_stats$metric_mean[fuel_stats$super_simplified_primary_heating_fuel=="Solar"],0)`)]{color=`r edit_color`} than those which rely on other fuel sources [(*N~h~*=`r round(fuel_stats$metric_mean[fuel_stats$super_simplified_primary_heating_fuel=="Other"],0)`)]{color=`r edit_color`}, [even for]{color=`r edit_color`} households far below the poverty line[: the average *N~h~* for income-impoverished households utilizing solar power is `r round(fuel_income_stats$metric_mean[fuel_income_stats$super_simplified_primary_heating_fuel=="Solar" & fuel_income_stats$income_bracket=="Below Federal Poverty Line"],0)`, compared to `r round(fuel_income_stats$metric_mean[fuel_income_stats$super_simplified_primary_heating_fuel=="Other" & fuel_income_stats$income_bracket=="Below Federal Poverty Line"],0)` for those relying on any other fuel source]{color=`r edit_color`}. [The slope of the *N~h~* density lines in Figure \@ref(fig:density-charts).c indicates that these lower-income households seem to experience a different rate of return on *N~h~* from the benefits of increased energy adoption than higher-income households.]{color=`r edit_color`} Why are [certain]{color=`r edit_color`} households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households' low consumption, meaning that the potential savings from [implementing energy efficiency measures]{color=`r edit_color`} are lower than for high-income households [according to the prebound effect identified by Sunikka-Blank and Galvin [@sunikka-blankIntroducingPreboundEffect2012] and Cong et al.[@congEnergyEquityGap2021]]{color=`r edit_color`}. Despite technological progress and rapid declines in technology costs and availability for cleaner, renewable electricity generation options such as solar photovoltaics and energy storage, many households cannot take advantage. Most households do not have access to advancements such as low-cost rooftop solar or energy efficiency upgrades that improve air quality, lower greenhouse gas emissions, and save money[@castellanosRooftopSolarPhotovoltaic2017][: only 18% of households that have adopted rooftop solar have been below the median household income in the US [@barboseIncomeTrendsResidential2020]]{color=`r edit_color`}.

```{r}
top_line_group <- c("number_of_units")
# c("number_of_units", "occupancy_type"),
#                           c("occupancy_type", "income_bracket"),
#                           c("number_of_units", "occupancy_type", "income_bracket"),

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p4=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("housing_tenure")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p5=top_line_charts[["density"]]
p5_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("housing_tenure",
                    "number_of_units")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
multifam_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("housing_tenure",
                    "income_bracket")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
housing_income_stats=top_line_charts[["metrics"]]
```


Examining these dynamics by the status of homeownership [in Figure \@ref(fig:density-charts).d]{color=`r edit_color`} reveals further disparities. Though renters and homeowners are similarly distributed below the energy poverty line [(`r to_percent(p5_stats$pct_in_group_below_cutoff[p5_stats$housing_tenure=="rented"])` of renters and `r to_percent(p5_stats$pct_in_group_below_cutoff[p5_stats$housing_tenure=="owned"])` of homeowners are in energy poverty)]{color=`r edit_color`}, there appears to be an advantage of homeownership from a net energy perspective for lower-income households [(*N~h~*=`r round(p5_stats$metric_mean[p5_stats$housing_tenure=="owned"],0)` for homeowners versus *N~h~*=`r round(p5_stats$metric_mean[p5_stats$housing_tenure=="rented"],0)` for renters)]{color=`r edit_color`}. Only at a relatively high [*N~h~*]{color=`r edit_color`} do renters seem to have an advantage[[, due to these tenants living in relatively new and efficient urban rentals]{strike=`r strike_show`}]{color=`r edit_color`}: owners of multi-family apartments earn `r round(multifam_stats$metric_mean[multifam_stats$housing_tenure=="owned" & multifam_stats$number_of_units=="multi-family"]/multifam_stats$metric_mean[multifam_stats$housing_tenure=="rented" & multifam_stats$number_of_units=="single-family"],1)` times as much as renters of single-family homes when normalized by energy expenditures. Renters face systemic disadvantages in the energy transition; they typically pay the home's energy costs while the landlord controls infrastructure upgrades, commonly understood as the split incentive problem[@birdPolicyOptionsSplit2012]. Tenure matters for more than just equity itself: renters are less likely to take actions to improve their [*N~h~*]{color=`r edit_color`}s due to a lack of property rights and [split incentives]{color=`r edit_color`}. Even when action is taken to improve the energy efficiency of a rental building, tenants are less likely to see any economic benefits from it.

```{r}
top_line_group <- c("simplified_utility_type")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p6=top_line_charts[["density"]]
```

```{r}
# "pop_hispanic"                               
# [35] "pop_african_american"                        "pop_asian"                                  
# [37] "pop_native_american"                         "pop_caucasian" 
# "pop_total"

minority_races <- c("hispanic","african_american","asian","native_american")
races <- c(minority_races,"caucasian")

pct_races <- replica_sup[,paste0("pop_",races)] / rowSums(replica_sup[,paste0("pop_",races)])
names(pct_races) <- paste0("pct_",races)

plurality_race <- races[max.col(pct_races,ties.method = "first")]

plurality_race <- ifelse(plurality_race=="african_american","black",
                                   ifelse(plurality_race=="native_american","indian",
                                          ifelse(plurality_race=="caucasian","white",
                                          plurality_race)))

race_data <- data.frame("geoid"=replica_sup$geoid,
                        "race"=plurality_race)

data_with_race <- inner_join(x=clean_data_ami, 
                             y=na.omit(race_data), by = "geoid")

top_line_group <- c("race")

top_line_charts <- make_all_charts(data_with_race,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p7=top_line_charts[["density"]]
p7_stats=top_line_charts[["metrics"]]
```

```{r}
top_line_group <- c("simplified_race")

data_with_race$simplified_race <- ifelse(data_with_race$race=="white",
                                         "white",
                                         "non-white")

top_line_charts <- make_all_charts(data_with_race,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")

simplified_race_stats=top_line_charts[["metrics"]]
```


```{r}
# "pop25_some_college_plus"                     "pop25_high_school"                          
# [41] "pop25_no_high_school"
# "pop_total"

# minority_races <- c("african_american","hispanic","asian","native_american")
# races <- c(minority_races,"caucasian")

education_levels <- c("some_college_plus","high_school", "no_high_school")

pct_education_levels <- replica_sup[,paste0("pop25_",education_levels)] / 
  rowSums(replica_sup[,paste0("pop25_",education_levels)])
names(pct_education_levels) <- paste0("pct_",education_levels)

plurality_education_level <- education_levels[max.col(pct_education_levels,ties.method = "first")]

plurality_education_level <- ifelse(plurality_education_level %in% 
                                      c("high_school","no_high_school"),
                                    "high school or less",
                                    ifelse(plurality_education_level=="some_college_plus",
                                           "college or more",
                                          plurality_education_level))

education_data <- data.frame("geoid"=replica_sup$geoid,
                        "simplified_education"=plurality_education_level)


top_line_group <- c("simplified_education")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(education_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p8=top_line_charts[["density"]]
p8_stats=top_line_charts[["metrics"]]

color_poverty_frequency <- (simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="non-white"] - 
                              simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="white"]) / 
  simplified_race_stats$pct_in_group_below_cutoff[simplified_race_stats$simplified_race=="white"]

color_poverty_frequency_modifier <- ifelse(color_poverty_frequency>0,"greater","less")

color_poverty_frequency_pct <- to_percent(abs(color_poverty_frequency))
```

[Furthermore, Figure \@ref(fig:density-charts).e shows that *N~h~* varies widely by racial demography. `r str_to_title(p7_stats$race[p7_stats$metric_mean==max(p7_stats$metric_mean)])` households have the highest *N~h~* across the entire population distribution (*N~h~*=`r round(sort(p7_stats$metric_mean, TRUE)[1],0)`), and `r str_to_title(p7_stats$race[p7_stats$metric_mean==sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)]])` households have the lowest (*N~h~*=`r round(sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)],0)`), with `r str_to_title(p7_stats$race[p7_stats$metric_mean==sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)-1]])` households a close second from the lowest (*N~h~*=`r round(sort(p7_stats$metric_mean, TRUE)[length(p7_stats$metric_mean)-1],0)`). These relative positions are the same across the entire population distribution, with only White (*N~h~*=`r round(p7_stats$metric_mean[p7_stats$race=="white"],0)`) and Hispanic (*N~h~*=`r round(p7_stats$metric_mean[p7_stats$race=="hispanic"],0)`) populations showing different relative *N~h~*s across the population. Households in communities of color experience energy poverty at a rate `r color_poverty_frequency_pct` `r color_poverty_frequency_modifier` than those in white communities. Education level also seems to be correlated with disparate *N~h~* outcomes according to Figure \@ref(fig:density-charts).f, with a wide gap between those households in areas with mostly high-school (*N~h~*=`r round(p8_stats$metric_mean[p8_stats$simplified_education=="high school or less"],0)`) or college-educated (*N~h~*=`r round(p8_stats$metric_mean[p8_stats$simplified_education=="college or more"],0)`) populations.]{color=`r edit_color`}


```{r}
# "climate_zone"                               
# [75] "climate_zone_description"

simplified_climate <- ifelse(replica_sup$climate_zone_description %in% c("Hot","Very Hot"), "Hot",
                             ifelse(replica_sup$climate_zone_description %in% c("Cold",
                                                                                "Very Cold",
                                                                                "Subarctic"),"Cold","Moderate")
                             )

climate_data <- data.frame("geoid"=replica_sup$geoid,
                           "simplified_climate"=simplified_climate)

top_line_group <- c("simplified_climate")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(climate_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p9=top_line_charts[["density"]]
```

(ref:density-charts-fig-cap) The distribution of [*N~h~*]{color=`r edit_color`}s across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure **b** shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure **c** shows the difference among groups of households identified by their primary heating fuel. Subfigure **d** shows the difference based on whether they are renters or owners. Subfigure **e** shows the difference based on the most prominent race in the census tract of each cohort. Subfigure **f** shows the difference based on the most prominent education history in the census tract of each cohort.

```{r density-charts, include=TRUE, results='asis', fig.cap='(ref:density-charts-fig-cap)', fig.width=8.0,fig.height=5.5}

old_density_charts_fig_cap <- paste0("The distribution of ",colorize("*N~h~*",edit_color),"s across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure b shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure c shows the difference among groups of households identified by their primary heating fuel. Subfigure d shows the difference based on whether they are renters or owners. Subfigure e shows the difference based on the most prominent race in the census tract of each cohort. Subfigure f shows the difference based on the most prominent education history in the census tract of each cohort.")

# grid.arrange(p1,
#              p2,
#              p3,
#              # p4,
#              p5,
#              # p6,
#              p7,
#              p8,
#              # p9,
#              nrow=2,
#              # top=chart_title,
#              # subtitle
#              bottom="Proportion of Households",
#              left=grid.text(label=
#                as.expression(
#                bquote(
#                  N[h]
#                  )
#                ),
#                draw=FALSE
#              )
# )  + 
#   plot_annotation(tag_levels = 'a') &
#   theme(plot.tag = element_text(face = 'bold'))
# 
# 
# facetted_plot <- patchwork::wrap_plots(p1,p2,p3,p5,p7,p8,
#                                        nrow=2) + 
#   plot_annotation(tag_levels = 'a') &
#   theme(plot.tag = element_text(face = 'bold'))
# 
# density_final <- arrangeGrob(grobs=facetted_plot,
#              bottom="Proportion of Households",
#              left=grid.text(label=
#                as.expression(
#                bquote(
#                  N[h]
#                  )
#                ),
#                draw=FALSE
#              )
# )

# result <- (p1+p2+p3)/(p5+p7+p8)
gt <- patchwork::patchworkGrob((p1+p2+p3)/(p5+p7+p8)  + 
                                 plot_layout(heights = c(1,1)) +
  plot_annotation(tag_levels = 'a') &
  theme(plot.tag = element_text(face = 'bold')))
# gridExtra::grid.arrange(gt, left = "Disp", bottom = "Hp // Cyl")
gt_all <- gridExtra::arrangeGrob(gt, 
                        top="Distribution of Energy Burdens Across Household Characteristics",
                        bottom="Proportion of Households",
                        left=grid.text(label=
                                         as.expression(
                                           bquote(~italic(
                                             N[h]
                                             ))
                                           ),
                                       draw=FALSE
                                       ))

gt_all_footnote <- gridExtra::grid.arrange(
  gt_all,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)

# multi_plot <- cowplot::plot_grid(p1,p2,p3,p4,p5,p6,p7,p8,p9,
#                    nrow=3, align="none",rel_heights = c(2,2,2))
# 
# #create common x and y labels
# 
# y.grob <- textGrob(paste0(str_to_upper(metric_name)," (",metric_label,")"), 
#                    gp=gpar(fontface="bold", col="black", fontsize=12), rot=90)
# 
# x.grob <- textGrob("Proportion of Households", 
#                    gp=gpar(fontface="bold", col="black", fontsize=12))
# 
# #add to plot
# 
# grid.arrange(arrangeGrob(multi_plot, left = y.grob, bottom = x.grob))
```

```{r}
group_columns <- c("state_abbr")
# utility type? see chartbook
graph_data <- filter_graph_data(clean_data=clean_data_ami_all[clean_data_ami_all$state_abbr!="DC",], 
                                group_columns=group_columns, 
                                metric_name=metric_name)

# percent of "other" fuel expenditures toward fossil fuel combustion
# want to make this more precise by state, county, and/or balancing authority eventually
other_gwm <- grouped_weighted_metrics(clean_data_fpl_all[clean_data_fpl_all$state_abbr!="DC",], 
                                      c("primary_heating_fuel"),
                                      "other_spend",
                                      0)

other_fuels <- c("COAL","FUEL OIL","NONE","OTHER","SOLAR","WOOD","BOTTLED GAS")
non_fossil_other_fuels <- c("NONE","SOLAR","WOOD")
fossil_other_fuels <- other_fuels[!(other_fuels %in% non_fossil_other_fuels)]

other_fossil <- other_gwm[other_gwm$primary_heating_fuel %in% fossil_other_fuels,
                              c("household_count","metric_mean")]

pct_other_fossil <- sum(other_fossil$household_count*other_fossil$metric_mean)/
  sum(other_gwm$household_count*other_gwm$metric_mean)

graph_data$pct_other_fossil <- pct_other_fossil

# percent of each state's electric grid decidated to fossil fuel combustion
# can refine by balancing authority based on REPLICA dataset
egrid <- get_state_egrid()

egrid$pct_electricity_fossil <- egrid$STCLPR + #coal
  egrid$STOLPR + #oil
  egrid$STGSPR + #gas
  egrid$STOFPR #+ #other fossil
  # egrid$STNCPR #+ #nuclear
  # egrid$STHYPR #+ #hydro
  # egrid$STOPPR #unknown/purchased

graph_data <- left_join(graph_data, egrid, by=c("state_fips"="FIPSST"))

# graph_data <- graph_data[graph_data$state_abbr!="DC",]

# percent of natural gas expenditures dedicateed to fossil fuel combustion...
pct_gas_fossil <- 1.0

graph_data$pct_gas_fossil <- pct_gas_fossil

graph_data$pct_fossil_tract <- (graph_data$pct_gas_fossil * graph_data$gas_spend + 
  graph_data$pct_electricity_fossil * graph_data$electricity_spend + 
  graph_data$pct_other_fossil * graph_data$other_spend) / 
  (graph_data$gas_spend + graph_data$electricity_spend + graph_data$other_spend)


pct_fossil_gwm <- grouped_weighted_metrics(graph_data, "state_fips","pct_fossil_tract",0) %>% 
  dplyr::rename(pct_fossil=metric_mean)

graph_data <- left_join(graph_data, 
                        pct_fossil_gwm[,c("state_fips","pct_fossil")], 
                        by="state_fips")

top_line_charts <- make_all_charts(graph_data,
                            group_columns="state_abbr",
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL)

state_by_state <- top_line_charts[["metrics"]]

electricity_prices_summary <- calculate_weighted_metrics(graph_data, 
                                                         c("state_abbr"), 
                                                         "dlrs_kwh", 
                                                         metric_cutoff_level = 
                                                           ner_poverty_line)
```


Assessing the [*N~h~*]{color=`r edit_color`}s among different states in Figure \@ref(fig:state-violin) presents a counterintuitive picture of how states address energy poverty and energy equity. [*N~h~*]{color=`r edit_color`} can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as Connecticut [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CT"],0)`)]{color=`r edit_color`} and Vermont [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="VT"],0)`)]{color=`r edit_color`}, where [`r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="CT"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` and `r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="VT"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])`]{color=`r edit_color`} higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="MS"],0)`)]{color=`r edit_color`} and Alabama [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="AL"],0)`)]{color=`r edit_color`}, which have significant low-income populations and low per-unit energy prices [(`r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="MS"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` and `r to_percent((electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"]-electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="AL"])/electricity_prices_summary$metric_mean[electricity_prices_summary$state_abbr=="All"])` lower than average, respectively)]{color=`r edit_color`}. Not only are households in these states falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood may suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on a diverse selection of metrics.

Although they are the states with the highest [*N~h~*]{color=`r edit_color`}, California [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CA"],0)`)]{color=`r edit_color`} and Colorado [(*N~h~*=`r round(state_by_state$metric_mean[state_by_state$state_abbr=="CO"],0)`)]{color=`r edit_color`} are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely, this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation are a common thread [among the top-performing states on an *N~h~* basis]{color=`r edit_color`}, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure \@ref(fig:state-violin) shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high [*N~h~*]{color=`r edit_color`}s than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.

(ref:state-violin-fig-cap) A comparison of [*N~h~*]{color=`r edit_color`}s among each state in the [US]{color=`r edit_color`}. The bars are sorted by median household [*N~h~*]{color=`r edit_color`} and represent the interquartile range (25%-75% percentiles) of household [*N~h~*]{color=`r edit_color`}s colored by the percent of household energy expenditures in each state that goes to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's [(EPA)]{color=`r edit_color`} [Emissions and Generation Resource Integrated Database (]{color=`r edit_color`}eGRID[)]{color=`r edit_color`} for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users.

```{r state-violin, include=TRUE, eval=TRUE, results='asis', fig.cap='(ref:state-violin-fig-cap)', fig.width=8.0,fig.height=5.5}

old_state_violin_fig_cap <- paste0("A comparison of ",colorize("*N~h~*",edit_color),"s among each state in the ",colorize("US",edit_color),". The bars are sorted by median household *N~h~* and represent the interquartile range (25%-75% percentiles) of household *N~h~*s colored by the percent of household energy expenditures in each state that go to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's ",colorize("(EPA)",edit_color)," ",colorize("Emissions and Generation Resource Integrated Database (",edit_color),"eGRID",colorize(")",edit_color)," for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users.")
# violin plot
# x_label <- bquote(~italic(N[h]))
x_label <- as.expression(bquote(~italic(N[h])~": Household Net Energy Return"))


y <- make_violin_chart(graph_data=graph_data,
                      group_columns=group_columns,
                      metric_name=metric_name,
                      metric_label=metric_label,
                      metric_cutoff_level=metric_cutoff_level,
                      fill_metric="pct_fossil",#"STCYPR",#"STSOPR",
                      fill_label="% of Energy Expenditures on \nFossil Fuel Combustion",#Combustion",#Solar",
                      group_name="State",
                      chart_title="Comparison of Energy Burdens Among the United States",
                      x_label=x_label)
print(y)
```

```{r}
group_variable <- "eia_id"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(left_join(clean_data_ami, replica_sup, by=c("geoid")), group_columns, metric_name)

util_group <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)

member_minumum <- 10000
lowest_ner_utility <- filter(arrange(util_group,metric_mean),household_count>=member_minumum)[1,]

unique_utils <- distinct(replica_sup[c("eia_id","company_na","state_name","dlrs_kwh")])

lowest_ner_utility_specs <- filter(unique_utils,eia_id==as.numeric(lowest_ner_utility["eia_id"]))

lowest_ner_utility_name <- lowest_ner_utility_specs$company_na
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Corp","Corporation")
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Member","Membership")
```

```{r eval=FALSE}
#group_variable <- "eia_id"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c("company_na", "company_ty.x") #c("gisjoin") #
graph_data <- filter_graph_data(left_join(clean_data_ami, 
                                          replica_sup, by=c("geoid")), 
                                group_columns, 
                                metric_name)

grid_operator_group <- calculate_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)

grid_operator_group
# left_join(clean_data_ami, replica_sup, by=c("geoid")) %>% 
#   filter(state_abbr.x=="CA", county_name %in% c("Sonoma County","Mendocino County")) %>% 
#   dplyr::select(c(company_ty.x, company_na, county_name)) %>% 
#   distinct() %>% 
#   arrange(company_ty.x, company_na) %>% 
#   print(n=50)
```

```{r eval=FALSE}
#group_variable <- "eia_id"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c("company_na", "company_ty.x", "county_name") #c("gisjoin") #
graph_data <- filter_graph_data(left_join(clean_data_ami, 
                                          replica_sup, by=c("geoid")), 
                                group_columns, 
                                metric_name)

grid_operator_group <- calculate_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)

grid_operator_group
# left_join(clean_data_ami, replica_sup, by=c("geoid")) %>% 
#   filter(state_abbr.x=="CA", county_name %in% c("Sonoma County","Mendocino County")) %>% 
#   dplyr::select(c(company_ty.x, company_na, county_name)) %>% 
#   distinct() %>% 
#   arrange(company_ty.x, company_na) %>% 
#   print(n=50)
```

#### Discussion  {#discussion}

A sensible prior hypothesis is that everyone experiences the same efficiency from the energy system as measured by return on energy investment. Differences in absolute outcomes may be related to the quantity of energy investment, but the marginal unit of energy consumed by one household should lead to as much benefit for that household as any other. However, here we see that [*N~h~*]{color=`r edit_color`}s are different among different groups of households in the US. This difference is often correlated to factors out of the households’ control and even those related to persistent social inequalities, such as race and education. These striking disparities suggest the existence of deeply structural barriers to prosperity in the US. Energy is central to equity and economic prosperity, but the[[odds are stacked against many people. The]{strike=`r strike_show`}]{color=`r edit_color`} energy system appears to be regressive in that costs accrue disproportionately to those of lower-income levels[[and the most energy-efficient homes belong to wealthier families]{strike=`r strike_show`}]{color=`r edit_color`}.

Furthermore, we demonstrate that owning a home and consuming solar power are associated with increased income multipliers for energy expenditures. This advantage leads to gains that are not being realized by many communities. When households adopt solar power, their *N~h~* increases as a result of decreasing their energy expenditures, which creates a disparity between those with access to renewable energy and those reliant on fossil-fuel-based energy sources. This helps explain why there has been a disparity in how the benefits of the energy transition are accruing among socioeconomic groups [@vaishnavWasItWorthwhile2017]. There is the potential for electrification and the transition to clean fuels to exacerbate this division if appropriate policies are not implemented[@cullenwardDynamicallyEstimatingDistributional2016].

Indeed, there are clear, mutually synergistic, positive reinforcement mechanisms to alleviate health and environmental disparities in air pollution exposure by reducing household energy burdens and improving economic mobility across low-income households. Combustion of biofuels and hydrocarbons is a significant source of air pollution and exacerbates other household costs like healthcare and maintenance[, yet we find that utilization of these sources is not associated with increased *N~h~*s at a state or household scale]{color=`r edit_color`}. [Not only are h]{color=`r edit_color`}ouseholds living in more poverty and closer proximity to highly polluted areas [at greater risk of adverse health impacts; they]{color=`r edit_color`} must [also]{color=`r edit_color`} consume more energy to overcome the particulate emissions[, which, themselves, reduce the efficiency of clean sources such as solar panels[@heIncreaseDomesticElectricity2020]]{color=`r edit_color`}.

The inherent benefits of solar electricity must be accessible to all populations in the [US]{color=`r edit_color`} to promote sustainability, but [[barriers such as high capital investment, lack of financing, and inability to take advantage of existing business models continue to hold back]{strike=`r strike_show`}]{color=`r edit_color`} communities of color [[from]{strike=`r strike_show`}are not]{color=`r edit_color`} receiving a similar benefit to white and wealthier households [from their energy expenditures]{color=`r edit_color`}. Net energy metrics exhibit this income multiplier effect and the resulting divide. Designing solar policies to benefit those facing low [*N~h~*]{color=`r edit_color`}s may substantially improve net energy income ratios and raise households out of energy poverty in the [US]{color=`r edit_color`}.

Pachauri et al. distinguish between affordability and cost of supply, implying that more focus should be applied toward how energy burdens vary among customers of different energy suppliers than on how per-unit costs of energy vary[@pachauriAdvancingEnergyPoverty2020]. For instance, `r lowest_ner_utility_name` is the electric utility with more than `r to_big(member_minumum)` customers whose members have the lowest average [*N~h~*]{color=`r edit_color`} (`r to_big(lowest_ner_utility$metric_mean)`)[, according to LEAD]{color=`r edit_color`}. At the same time, the per-unit cost of electricity in this service territory is only more expensive than `r to_percent(ecdf(unique_utils$dlrs_kwh)(lowest_ner_utility_specs$dlrs_kwh))` of utilities at `r to_dollar(lowest_ner_utility_specs$dlrs_kwh)`/kWh. [Is an exceptionally high burden acceptable because the per-unit costs are not exceptional?]{color=`r edit_color`}

This relevance especially holds for electricity because it is a commodity delivered via a stationary, centralized grid system, and households retain little control over their own energy choices. [[The vastness of the modern electric grid eludes affordability for everyday households because of the relationships between the utility companies and the users. Secondary energy is unique among residential consumption categories because a single service provider is usually the authority for determining energy costs for each of its customers.]{strike=`r strike_show`}]{color=`r edit_color`} In vertically integrated energy markets, the monopoly utility is the only option available to all consumers. In organized energy markets, the public utility is designated as the last resort provider for those unable or unwilling to participate in the competitive procurement of energy. Even in organized markets, local utilities retain monopolistic control of the transmission and distribution systems. 

Consumers are price takers with relatively inelastic demand. Changes in the unit price of energy or slight differences in consumption patterns matter more to those with low incomes than those with higher incomes. Furthermore, the current lack of storage infrastructure on the grid and behind each meter means that households are bound to electricity providers at the time of use. The "forward-looking" or "reactive" tendencies of these public electric utilities have implications for the energy transition in their jurisdictions and beyond[@wolakFutureElectricityRetailing2020]. A more in-depth examination of the energy system’s underlying regulatory structures and robust assessments of energy burden could provide a path forward and track how the benefits of the energy transition are being accrued.

In some markets, specialized rates or programs are available for Low and Moderate Income (LMI) consumers, who may have higher energy burdens. We find it notable that more than half of all funding to address high energy burdens in the US is from utility ratepayer-funded bill and energy efficiency assistance[@rossHighCostEnergy2018]. At a national scale, the Low Income Home Energy Assistance Program (LIHEAP) and the Weatherization Assistance Program (WAP) in the US seek to address aspects of energy poverty through bill payment assistance and energy efficiency measures, but the efficacy of these programs has been mixed in addressing distributional equity in energy burdens and receiving benefits from energy efficiency programs[@bednarRecognitionResponseEnergy2020]. [In part, this may be because these programs rely on income-based poverty lines such as the FPL to determine eligibility for benefits.]{color=`r edit_color`}

The [US]{color=`r edit_color`} benchmarks its FPL to the food requirements of the average household[@coferFamilyFoodPlans1962] and uses this threshold as is an eligibility criterion for more than 40 federal programs across ten agencies (in addition to state, charitable, and private enterprises that also do so)[@unitedstatesdepartmentofhealthandhumanservicesProgramsThatUse2015]. Practitioners have posited that the standard policy of “using the ‘economy food plan’ to determine who can afford to hire an attorney” may be depriving citizens of their basic rights[@grossTooPoorHire2013]. In some cases, food assistance programs are more inclusive than energy assistance programs[: we show that more than `r ifelse(number_in_poverty[1]>10^6,to_million(number_in_poverty[1]),to_big(number_in_poverty[1]))` households above the FPL experience energy poverty.]{color=`r edit_color`}

[Research using detailed qualitative sociological and public health interview data links energy burden with housing and energy policy[@hernandezEnergyBurdenNeed2010]. Other articles have linked technology adoption barriers to low-income communities of color[@hsuPublicElectricVehicle2021]^,^[@tidwellDecarbonizingDisparitiesProblematizing2021]^,^[@brockwayInequitableAccessDistributed2021a] and identified that households that are in the same peer social network often adopt technologies such as solar[@bollingerPeerEffectsDiffusion2012]. While some studies already acknowledge the benefits of improving energy efficiency and equity outcomes through surveys and interviews[@hernandezBenefitBurdenPerceptions2015], this study adds to the literature by building a comprehensive quantitative framework and empirical result based on a large dataset. This toolkit adds more quantitative backing to this body of qualitative work and can be used in future analysis with technology adoption data to identify strategic opportunities to improve energy efficiency and access to clean technology in a more equitable manner.]{color=`r edit_color`}

[Previous work provided theoretical frameworks for understanding energy poverty beyond a simple income-based measure[@sovacoolEnergyJusticeConceptual2015], and limited examples of applications to empirical data that rely on building-specific efficiency characteristics[@faiellaEnergyPovertyHow2021] or subjective self-assessments[@sokolowskiMultidimensionalIndexMeasure2020]. Applying *N~h~* to a nationwide dataset for the US builds on this work by providing a tangible tool that includes `r to_million(number_in_poverty[1]+clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum())` households with energy expenditures greater than their incomes or with incomes above the FPL that are left out by other measures, and is a way to visualize the disparities between groups that may allow for further investigation around different household characteristics. *N~h~* highlights inequality better than a simple linear metric while allowing the assessment of a wide variety of households, such as those with no income or for which efficiency data is not available.]{color=`r edit_color`} A significant insight from [NEA]{color=`r edit_color`} that should be incorporated into future work is that embodied energy takes many forms across the household budget (food, goods, services, transportation, housing, etc.), and these can all be compared using the same units of measure (e.g., joules) to scale the *N~h~* framework across multiple expenditure categories.

The [Coronavirus Disease 2019 (]{color=`r edit_color`}COVID-19[)]{color=`r edit_color`} pandemic and associated recovery measures may be a critical opportunity to provide relief payments related to energy expenditures and to invest in more efficient residential[@RecoveringFastSlow2020a] and commercial energy infrastructure that enables newer and cleaner systems[@chapmanImpactsCOVID19Transitioning2020]. We show that US households are already spending excessive amounts on energy, notwithstanding more families staying at home for longer periods of time during pandemic lockdowns. The ongoing crisis offers a chance to address inequity with a focus on residential energy burdens[@graffCOVID19AssistanceNeeds2020]. [The EU is in the process of defining how communities can participate in the energy transition[@uihleinEnergyCommunitiesOverview2020] and how burdens can be alleviated through this process using proactive policy tools and business models such as One Stop Shops (OSS) for energy efficiency and renewable energy upgrades[@bertoldiRoleOnestopShops2021].]{color=`r edit_color`} Adopting energy criteria for energy and other programs [like these]{color=`r edit_color`} could expand access for those underserved populations in need of assistance independent of their needs in other consumption categories.

Creating a federal energy poverty line would be a critical step in identifying families that face large disparities in access to affordable electricity and energy in the [US]{color=`r edit_color`} and improve programs’ abilities to address energy burdens. A toolkit based on this analysis enables neighborhood level outreach where burdens are highest and identifies opportunities where households could benefit from emerging technologies.
[[A more comprehensive approach to poverty alleviation in the US would also consider the energy situation of each household and the options available to improve its efficiency. Then, it would make those options accessible to the stakeholders who could benefit.]{strike=`r strike_show`}]{color=`r edit_color`}
[[Even for energy assistance programs that do exist, many households reliant on inefficient fuels such as kerosene for heating must pay upfront costs to fill a tank for the winter season. These subsidy programs are largely ineffective as the cost of kerosene can be expensive, and pressure remains on households to offset existing gaps. Better opportunities to convert to alternative fuels would also provide households the opportunity to take advantage of the efficiency gains in better technology. In this way, broader programs need to be designed to provide households more options.]{strike=`r strike_show`}]{color=`r edit_color`}
[[How can our energy system be operated and improved to provide equitable access? Are there ways that clean electrification can be used to better benefit currently underserved communities?]{strike=`r strike_show`}]{color=`r edit_color`}
[[High burdens may be associated with intermittent grid access when extreme weather events interrupt energy supply chains. The same households are often at greater risk of energy service disconnection due to non-payment. Re-connection fees can compound to increase burdens in ways not captured by our analysis.]{strike=`r strike_show`}]{color=`r edit_color`} 
[[High energy burdens have already been linked to local and global air pollution, and we can connect these impacts directly to the full scope of household prosperity via net energy.]{strike=`r strike_show`}]{color=`r edit_color`}
[[Energy is essential to deal with other inequities in society. There must be a way to design a structure that addresses this disparity more equitably.]{strike=`r strike_show`}]{color=`r edit_color`}
[[While well-intended programs such as PACE or solar loans have reached few people, community-oriented programs focusing on peer-mentorship could improve programmatic outcomes. Building support for community-led programs can also reduce the burden on individuals to expand access to the benefits of solar and efficiency.]{strike=`r strike_show`}]{color=`r edit_color`}
[[Policymakers have not systematically deployed interventions based on [NEA]{color=`r edit_color`} across American households.]{strike=`r strike_show`}]{color=`r edit_color`} 
[[Net energy income is holding back socioeconomic mobility in the US.]{strike=`r strike_show`}]{color=`r edit_color`}
[[However, concerted attention to technology and policy details matter to implement a national scheme.]{strike=`r strike_show`}]{color=`r edit_color`}
[[The data demonstrate a need for quantitative methodologies to support equitable energy infrastructure investments.]{strike=`r strike_show`}]{color=`r edit_color`}

## Methods  {#methods}

#### Why Net Energy?  {#ratios}

```{r metric-comparison-data}
eb_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% 
                                            mutate(energy_burden = round(100*energy_burden,digits=1)),
                                          group_columns = c("energy_burden","income_bracket"), 
                                          metric_name="net_income", 
                                          metric_cutoff_level = energy_burden_poverty_line) %>% 
  mutate(metric_name="Energy Burden (%)") %>% 
  rename(energy_metric=energy_burden) #%>% 
  # mutate(energy_metric=100*energy_metric)

ner_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% mutate(ner = round(ner,digits=0)), 
                                     group_columns = c("ner","income_bracket"), 
                                     metric_name="net_income", 
                                     metric_cutoff_level = ner_poverty_line) %>% 
  mutate(metric_name="Net Energy Return ($/$)") %>% rename(energy_metric=ner)

comparison_chart_data <- rbind(eb_chart_data,ner_chart_data)

metric_comparison_net_income_lbound <- -1000
metric_comparison_net_income_ubound <- 6*10^4
metric_comparison_x_axis_lbound <- -10
metric_comparison_x_axis_ubound <- 400
metric_comparison_pct <- sum(comparison_chart_data$household_count[
  comparison_chart_data$energy_metric <= metric_comparison_x_axis_ubound & 
    comparison_chart_data$energy_metric >= metric_comparison_x_axis_lbound & 
    comparison_chart_data$metric_mean <= metric_comparison_net_income_ubound & 
    comparison_chart_data$metric_mean >= metric_comparison_net_income_lbound & 
    !is.na(comparison_chart_data$metric_mean) & 
    is.finite(comparison_chart_data$metric_mean)]) / 
  sum(comparison_chart_data$household_count)

comparison_chart <- comparison_chart_data %>% 
  ggplot(aes(x=energy_metric, y=metric_mean, fill=income_bracket, color=income_bracket)) +
  # scale_x_continuous(trans=scales::pseudo_log_trans(base = 10)) +
  scale_y_continuous(labels=scales::dollar_format()) + 
  ggrastr::rasterise(geom_point(aes(size=household_count), 
                                alpha=0.25, 
                                position="jitter")) + 
  scale_fill_discrete(name="Income Bracket") + 
  scale_color_discrete(name="Income Bracket") + 
  scale_size_continuous(name="Households", labels=scales::label_comma()) + 
  # geom_hline(yintercept = .1) + 
  # geom_vline(xintercept = 9) + 
  # geom_smooth(method="lm",#NULL,#
  #             mapping=aes(weight=household_count),
  #             # formula=y~,
  #             se=FALSE,
  #             fullrange=TRUE,
  #             linetype="solid",
  #             alpha=0.75
  #             ) + 
  facet_grid(cols=vars(metric_name), switch="x", scales="free_x") +#, space="free_x") + 
  theme_bw() +
  labs(title = "Energy Burden and Net Energy Return in United States Households", 
       x="Energy Metric", 
       y="Household Annual Net Income ($)") + 
  theme(legend.position = c(.3,.6),
        legend.background = element_rect(fill = "#ffffffaa", colour = NA), 
        legend.key.size = unit(10, "points")#,
        # legend.justification = c(0, 0)
        )+
  coord_cartesian(#xlim=c(0,120),
               ylim=c(metric_comparison_net_income_lbound,
                      metric_comparison_net_income_ubound),
               xlim=c(metric_comparison_x_axis_lbound,
                      metric_comparison_x_axis_ubound),
               # default=FALSE,
               expand=TRUE)
```

[The main contribution of the study is the application of NER as an indicator of household energy poverty by utilizing a set of energy burden metrics based on NER to represent the disparity across those who face significant energy burdens in the US with those who do not. NER displays critical thresholds where more households face energy and income challenges.]{highlight=`r highlight`}

The [NER]{color=`r edit_color`} of a process is a relationship between the gross amount of energy extracted and the amount of embodied energy directed toward extraction[@brandtCalculatingSystemsscaleEnergy2013]. [For households extracting income from the economy, these ratios can be composed of gross income (*G*) and spending on energy (*S*)]{color=`r edit_color`}.

The NER is the standard metric of NEA because it reflects the role of energy as an input to a value-generating process in ecosystems[@brandtHowDoesEnergy2017]. *E~b~* is the metric of choice in the energy insecurity literature due to its [presumed]{color=`r edit_color`} interpretability as a percentage[@rossHighCostEnergy2018]^,^ [@bednarIntersectionEnergyJustice2017]^,^ [@drehoblUSLowIncomeEnergy2016]^,^ [@kawaiSpendingHouseholdEnergy2021]

While most [ERRs]{color=`r edit_color`}, including NER, are hyperbolic paraboloids, NER has several useful mathematical properties: it can smoothly handle systems with negative incomes and energy costs, accept households with zero income, and emphasize extreme incomes and energy costs in an interpretable fashion, as shown in Figure \@ref(fig:metric-comparison). [While *E~b~* appears inversely correlated to income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes (approximately n=`r to_big(round(clean_data_fpl$households[clean_data_fpl$net_income<0] %>% sum(),-3))` households in the dataset have *E~b~*>100% or *E~b~*<0%). Due to the structure of the *E~b~* equation (Equation 1), the *E~b~* of these households approaches infinity and cannot be captured on the standard 0-100% scale the metric is intended to be interpreted within: around `r to_big(round(clean_data_fpl$households[!is.finite(clean_data_fpl$energy_burden)] %>% sum(),-3))` homes have an infinite energy burden. Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. *N~h~* provides a framing of the same dataset that allows for exploration of most households on a similar scale without the long tail. *N~h~* appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing *N~h~* avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, *N~h~* offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent. Many households with moderate-to-high *E~b~*s are actually higher-income households with high energy expenditures, making their *N~h~*s quite high (e.g., >\$100 of income per \$1 of energy spending). Almost `r to_percent(metric_comparison_pct)` of the households in the dataset have net incomes between `r to_dollar(metric_comparison_net_income_lbound)` and `r to_dollar(metric_comparison_net_income_ubound)`, with *N~h~*s (or *E~b~*s) of between `r metric_comparison_x_axis_lbound` (`r to_percent(metric_comparison_x_axis_lbound/100)`) and `r metric_comparison_x_axis_ubound` (`r to_percent(metric_comparison_x_axis_ubound/100)`).]{color=`r edit_color`} Only households with no energy costs are excluded from the analysis, whereas households with no energy costs or incomes must be excluded from an analysis utilizing *E~b~*.

(ref:metric-comparison-fig-cap) Display of the relationship between [*E~b~*]{color=`r edit_color`} and [*N~h~*]{color=`r edit_color`} with net income (gross income - energy expenditures) for US households. While [*E~b~*]{color=`r edit_color`} appears inversely correlated to net income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the [*E~b~*]{color=`r edit_color`} equation (Equation 1), the [*E~b~*]{color=`r edit_color`} of these households approaches infinity [and cannot be captured on the standard 0-100% scale the metric is intended to be interpreted within]{color=`r edit_color`}. Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. [*N~h~*]{color=`r edit_color`} frames the same dataset on a scale without the long tail. [*N~h~*]{color=`r edit_color`} appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing [*N~h~*]{color=`r edit_color`} avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, [*N~h~*]{color=`r edit_color`} offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent: many households with moderate-to-high *E~b~*s are actually higher-income households with high energy expenditures, making their [*N~h~*]{color=`r edit_color`}s quite high (e.g., >\$100 of income per \$1 of energy spending)[, which is only visible on an *N~h~* scale]{color=`r edit_color`}.

```{r metric-comparison, include=TRUE, results='asis', fig.cap='(ref:metric-comparison-fig-cap)', fig.width=8.0,fig.height=5.5}
metric_comparison_fig_cap_old <- paste0("Display of the relationship between ",colorize("*E~b~*",edit_color)," and ",colorize("*N~h~*",edit_color)," with net income (gross income - energy expenditures) for US households. While *E~b~* appears inversely correlated to net income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the *E~b~* equation (Equation 1), the *E~b~* of these households approaches infinity ",colorize("and cannot be captured on the standard 0-100\\% scale the metric is intended to be interpreted within",edit_color),". Since LEAD is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. *N~h~* frames the same dataset on a scale without the long tail. *N~h~* appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing *N~h~* avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, *N~h~* offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent: many households with moderate-to-high *E~b~*s are actually higher-income households with high energy expenditures, making their *N~h~*s quite high (e.g., >\\$100 of income per \\$1 of energy spending)",colorize(", which is only visible on an *N~h~* scale",edit_color),".")

comparison_chart
```

#### Data  {#data}
To estimate the Net Energy Return (*N~h~*) of American households, we primarily utilize the Low Income Energy Affordability Data (LEAD)[@maLowIncomeEnergyAffordability2019] and Rooftop Energy Potential of Low-Income Communities in America (REPLICA)[@sigrinRooftopSolarTechnical2018] datasets, which the DOE assembled to help “stakeholders make data-driven decisions on energy goal setting and program planning by providing them information on low-income household populations and associated energy use characteristics”[@maLowIncomeEnergyAffordability2019]. These datasets encompass estimates of household energy expenditures (*S*), income (*G*), and demographic characteristics for most households at the census tract scale in all states and most territories of the [US]{color=`r edit_color`}.  

LEAD: The LEAD portrays the average income, electricity expenditures, gas expenditures, and other fuel expenditures for cohorts of households segmented by location (census tract, county, state) and household characteristics (whether the unit is rented or owned, the building’s year of first construction, the number of units in the building, whether the units are attached, and the unit’s primary heating fuel type). The dataset is assembled by applying an iterative proportional fitting (IPF) algorithm to cross-tabulations of household responses from the 2016 5-year American Community Survey (conducted by the US Census Bureau), which provides the samples for each cohort as Public Use Microdata Samples. IPF is a widely used spatial microsimulation method to allocate individuals (i.e., households) to zones (i.e., census tracts and utility service territories) while calibrating each zone's characteristics to known quantities. Using IPF, the microdata samples are scaled to match aggregate annual values from utility sales and revenues reported in Energy Information Administration forms 861 and 176.

REPLICA: The Renewable Energy Potential of Low-Income Communities in America (REPLICA) dataset includes [the racial and education level composition of each census tract]{color=`r edit_color`} used in the ultimate analysis[@sigrinRooftopSolarTechnical2018]. [In addition to providing a simpler designation of cohorts for each census tract, REPLICA also includes]{color=`r edit_color`} estimates of the technical potential of rooftop solar and additional techno-economic variables (e.g., demographics and electricity rates) [that will be useful for future research.]{color=`r edit_color`}

eGRID: We use the [EPA]{color=`r edit_color`}'s eGRID[@unitedstatesenvironmentalprotectionagencyepaEmissionsGenerationResource2020] to calculate the proportion of household energy expenditures that support fossil fuel combustion through the purchase of electricity. 100% of natural gas purchases are considered to support fossil fuel combustion. Electricity purchases are divided into their respective sources according to the state proportions indicated by the "STCLPR" (coal), "STOLPR" (oil), "STGSPR" (gas), and "STOFPR" (other fossil) fields in the 2018 eGRID dataset. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately `r scales::percent(pct_other_fossil, accuracy=1)` fossil fuel combustion.

#### Treatment  {#treatment}
The LEAD data represents the unit’s ownership status (OWNER vs. RENTER) and income bracket as a fraction of [AMI]{color=`r edit_color`} (0-30%, 30-60%, 60-80%, 80-100%, or 100%+) or [FPL]{color=`r edit_color`} (0-100%, 100-150%, etc.). These categorical variables are saved as factors. Then we create min_units from BLD INDEX, a variable which represents a non-uniformly distributed set of buckets for the range of the number of units in the building and whether single-unit households are attached or detached from neighboring households (1 ATTACHED, 1 DETACHED, 2 UNIT, 3-4 UNIT, 5-9 UNIT, 10-19 UNIT, 20-49 UNIT, 50+ UNIT, MOBILE_TRAILER, BOAT_RV_VAN, OTHER UNIT). We extract the minimum number of units from the range and whether the building is detached. Those households labeled OTHER UNIT, MOBILE_TRAILER, or BOAT_RV_VAN are given values of Not Applicable (NA) for this characteristic. Finally, we calculate *S* and *G* of which each metric is composed: 

*S* = annual expenditures on electricity (ELEP CAL) + natural gas (GASP CAL) + and other fuels (FULP)  

*G* = the cohort’s average annual income (HINCP) 

The metric formulas outlined in [Applying NER to Energy Equity](#ratios) are then used to calculate each cohort’s energy poverty metrics. Since we are examining homes’ relationships with the energy system, we ignore any homes that do not use energy as denoted by rows where *S*==0. The estimation procedure used by the DOE results in an estimated number of occupied housing units for each cohort (UNITS, renamed as households). It displays the number of American Community Survey responses that contribute to the estimate of energy expenditures (COUNT, renamed as acs_responses). We then remove any categories with fewer than 1 unit represented since this is not physically possible. `r removed_households = "This results in removing X% of the available rows (gross: X rows of X). This is a total of X housing units or X% of the estimated total X units in the sample. We have separated any cohorts with incomes or energy costs equal to 0 into another dataset for analysis. This represents approximately X% of the housing units and X% of the examined cohorts, so it will be important to make sure that this subset does not contain systematic bias. However, these data are excluded from the current analysis under the assumption that energy costs equal to 0 are not relevant to this analysis."`

We then combine this dataset with the REPLICA dataset. To do so, we must aggregate the income levels of the LEAD dataset to the simpler schema used by REPLICA for summarizing households’ income relative to the area’s median income (AMI):

- 0-30% AMI: Very-Low-Income
- 30-80% AMI: Low-to-Moderate-Income
- $\geq$ 80% AMI: Middle-to-High-Income

Also, we create an indicator of whether a particular cohort is in income poverty as defined by the relevant standards for its characteristics. For the AMI version of LEAD, this is defined as being “Very-Low-Income” or $\leq$ 30% of AMI. For the FPL version of LEAD, we translate directly from the designation of the income bracket as follows:

- 0-100% FPL: In Poverty
- $\geq$ 100% FPL: Not In Poverty

The REPLICA dataset also simplifies any households with only one unit per building into “Single Family” homes and any households with more than one unit per building as “Multi-family.” Non-stationary and non-traditional homes are not included in the REPLICA analysis. We match these simplifications in the LEAD dataset by aggregating by the number of units:

- 1 Unit: Single-Family
- $>$ 1 Unit: Multi-Family
- Other Unit: NA (excluded from analysis)

After simplifying these characteristics in the LEAD [AMI]{color=`r edit_color`} data, we merge the AMI dataset with the REPLICA dataset along the census tract, simplified income bracket, simplified number of units, and housing tenure variables to achieve the primary dataset used in the analysis. Merging with the REPLICA dataset provides additional demographic and geospatial data not available in the LEAD dataset only[@sigrinRooftopSolarTechnical2018]. Characteristics such as the utility type and locale description are sourced from REPLICA and unavailable in LEAD[, and we source the cost of electricity, racial composition, and education levels of census tracts from REPLICA for this analysis]{color=`r edit_color`}. Similarly, the REPLICA dataset contains only electrical expenditure estimates without natural gas or other fuel costs to households and could not be used to perform this analysis alone.

The FPL version of LEAD is not merged with all of the REPLICA data because of incompatibility between the FPL and [AMI]{color=`r edit_color`} bracket definitions. However, demographic data associated with each census tract as a whole can be merged with the FPL dataset. Both AMI and FPL versions of LEAD are combined with demographic data from the REPLICA dataset and geospatial shapefiles from the Census to produce the final datasets used in the analysis. [Since the FPL version of LEAD is not aggregated to the simpler categories found in REPLICA, more granular variables such as Primary Heating Fuel remain available for assessment across the entire population.]{color=`r edit_color`}

#### Considerations  {#considerations}
[While a helpful place to start, *E~b~* has certain drawbacks.]{color=`r edit_color`} Significantly, a simple proportion does not account for the fact that money spent on energy cannot be spent elsewhere and is therefore not useful income to the household for the purposes of measuring prosperity. Including gross income in *E~b~* has the effect of depressing the average *E~b~*, by definition.

Furthermore, because energy expenditures are a small proportion of even the most impoverished households' total income, *E~b~* is almost always a very small percentage (<10%). This leads to issues with interpretability in public discourse and policy settings and may even affect program outcomes that are based on *E~b~* if small numbers are rounded to even the nearest hundredth of a percent. [As the UK experienced when using *E~b~*, i]{color=`r edit_color`}f the household is above an energy poverty line defined by such a metric for public policy purposes, the family may not receive critical support[[@bednarRecognitionResponseEnergy2020].[, or energy may be sidelined by other basic needs.]{strike=`r strike_show`}]{color=`r edit_color`}

Because such a small proportion of expenditures can impact different income groups so differently, ratios of this type can be useful when delineating across income quantiles or other categories - particularly for vulnerable populations where energy poverty poses a significant difficulty or affordability threshold not captured by measures of absolute poverty. However, *E~b~* is often portrayed at a population scale (e.g., the average energy burden of the population is X%)[, which can be skewed by outliers within the population]{color=`r edit_color`}. Household metrics and surveys are important for further understanding of and policy development around issues of energy poverty. 

Finally, presenting the relationship between household income and energy expenditures as a proportion with income in the denominator suggests that improvements can only be made by decreasing energy expenditures or increasing incomes. However, in reality, there is a positive relationship between energy expenditures and incomes because energy is an input to wealth-creating processes[[and the unit costs of energy decrease as absolute consumption increases]{strike=`r strike_show`}]{color=`r edit_color`}. Households consume energy to unlock the utility that energy services provide to them as participants in society, whether to cook food or connect to the internet. This relationship is generally accepted when understanding individual household behavior[@thomasEstimatingDirectIndirect2013] and macro-economic effects of energy consumption[@saundersKhazzoomBrookesPostulateNeoclassical1992]. Therefore, a metric describing the efficiency of household wealth creation may be more intuitive with income in the numerator.

The iterative proportional fitting method has limitations as an estimation procedure that constrain the strength of conclusions that can be drawn from the simulated LEAD and REPLICA datasets. The relationship between constraint variables such as total energy spending by utility service territory and number of households per census tract will tend toward the average of the initializing dataset and depress variations among otherwise similar regions. This may explain the large quantities of households that are estimated to have very low incomes. Validating these estimated data would require randomized surveys of households along the dimensions of interest.

The meaning of the “primary heating fuel” category comes from the answer to the question “Which fuel is used most for heating this house, apartment, or mobile home?” on the American Community Survey. This question’s power to predict energy expenditures or fuel sources is unknown, and further analysis is required to understand the implications of this survey question for drawing broader conclusions about household energy use. However, the US Census Bureau has been asking this question since 1940. It states that these data are collected to help communities "provide assistance with utilities," "estimate future energy demand," and "measure environmental impacts"[@unitedstatescensusbureauWhyWeAsk2021].

Though the REPLICA dataset relies on a different vintage of the LEAD dataset (assembled in 2017[@sigrinRooftopSolarTechnical2018]) than this analysis (assembled in 2019[@maLowIncomeEnergyAffordability2019]), inferring differences among annual estimates is not meaningful due to the standard error of the data [@maLowIncomeEnergyAffordability2019]. A rigorous treatment of these metrics over time is an area for future research.

The results inferred from eGRID are only as good as the eGRID methodology itself. We choose to outline the proportion of combusted fuels rather than emissions data due to the limitations outlined by proponents of marginal emissions attribution in electric power system models[@vonwaldAnalyzingCaliforniaFramework2020]^,^[@siler-evansMarginalEmissionsFactors2012] and limitations in estimating regional electricity transfers[@vonwaldAccountingGreenhouseGas2021].
Expanding quantitative analysis of energy affordability can offer additional context, including the use of ratios to identify populations that could be particularly vulnerable to energy shocks or absolute energy burdens. Developing such metrics can elucidate the scale on which American households must save for energy consumption. Frequently used metrics in this category do not tell the whole story. For instance, the simple proportion of a household’s income spent on energy bills (a.k.a. energy burden) does not capture the underlying monthly cash flow patterns that may stress household budgets.

## Code Availability {#code-availability}

The code and data to fully reproduce this paper are available on GitHub at [https://github.com/ericscheier/net_energy_equity](https://github.com/ericscheier/net_energy_equity) under the GNU Affero General Public License v3.0. The most recent release of the software can be found at [DOI: 10.5281/zenodo.5676225](https://doi.org/10.5281/zenodo.5676225)[@scheierMeasurementStrategyAddress2021].

## Data Availability  {#data-availability}

The data generated in this study have been deposited in the the Zenodo database under [DOI: 10.5281/zenodo.5676225](https://doi.org/10.5281/zenodo.5676225)[@scheierMeasurementStrategyAddress2021].

All data necessary for the composition of the source datasets used in this analysis are freely available from US government sources as open data. All functions to automatically retrieve and assemble these data and compiled versions of these data are made available to the user as part of the software available at [DOI: 10.5281/zenodo.5676225](https://doi.org/10.5281/zenodo.5676225)[@scheierMeasurementStrategyAddress2021].

## References  {#references}

::: {#refs}
:::

```{r eval=FALSE}
# # Works Not Yet Cited  {#uncited}
# 
# ---
# nocite: |
#   @*
# ...
# 
# # Software Used  {#software}
# 
# List of R packages used to be entered here automatically
#
```

## Acknowledgements  {#acknowledgements}
[The authors wish to thank Nikhil Kaza and Andy Yates for insightful conversations, review, comments, feedback, and advice on this study.]{highlight=`r highlight`}


```{r eval=FALSE}
# 
# # Additional Information  {#additional-information}
# 
# # (APPENDIX) Appendix {-}  {#appendix}
# 
# # Charts for All Variables {#charts}
```

```{r, include = FALSE, eval=FALSE}
r_packages_used <- c("rmarkdown", "knitr")
knitr::write_bib(x = r_packages_used, file = "bibliography.bib")
#https://stackoverflow.com/questions/60026015/use-citation-in-r-markdown-to-automatically-generate-a-bibliography-of-r-packa
```

## Tables

\captionsetup[table]{labelformat=empty}
Table \@ref(tab:comparison-table): 
```{r comparison-table-display, include=TRUE, results="asis"}
final_table
```
\captionsetup[table]{labelformat=default}

## Figure Legends/Captions

Figure \@ref(fig:metric-comparison): (ref:metric-comparison-fig-cap)

Figure \@ref(fig:continental-map): (ref:continental-map-fig-cap)

Figure \@ref(fig:inset-map): (ref:inset-map-fig-cap)

Figure \@ref(fig:density-charts): (ref:density-charts-fig-cap)

Figure \@ref(fig:state-violin): (ref:state-violin-fig-cap)


```{r}
# merge data together
if(!is_preview==TRUE & refresh==TRUE){
  write.csv(x=clean_data_fpl,file="CohortData_FederalPovertyLine.csv")
  write.csv(x=clean_data_ami,file="CohortData_AreaMedianIncome.csv")
  write.csv(x=replica_sup,file="CensusTractData.csv")
}
# save as csv

```


<!--chapter:end:net_energy_equity_state.Rmd-->

---
title:
subtitle: 
titlerunning: Net Energy Equity
authorrunning: Scheier & Kittner
thanks:
bibliography: references.bib
bibstyle: spphys
csl: nature-no-et-al.csl
journalname: Nature Energy
toc: false
documentclass: article
output:
  bookdown::pdf_document2:
    number_sections: true
    keep_tex: true
    subparagraph: yes
  bookdown::html_document2:
    number_sections: false
  bookdown::word_document2:
    number_sections: false
    pandoc_args:
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
  bookdown::pdf_book:
    base_format: rticles::springer_article
    keep_tex: true
tables: true
fig_caption: true
always_allow_html: true
header-includes:
- \usepackage{booktabs}
- \usepackage{setspace}
---
\clearpage
\addcontentsline{toc}{chapter}{MAIN TEXT}
\begin{center}
\normalfont \textbf{MAIN TEXT}
\vspace{17pt}
\end{center}

```{r setup, include=FALSE}
is_final=FALSE #TRUE
is_preview= TRUE #FALSE
is_draft= TRUE
set.seed(456)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','asis')),
                      fig.keep='all', #'last'
                      dev='cairo_pdf',#'pdf',
                      fig.show='hold',#'hide
                      # fig.pos = "!H",
                      # out.extra = "",
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=TRUE, #ifelse(is_draft, TRUE, ifelse(is_preview, TRUE, !is_final)),
                      cache.lazy=FALSE,
                      fig.margin=FALSE,
                      fig.fullwidth=TRUE, #FALSE
                      eval.after = "fig.cap"#,
                      # cache.path = 'net_energy_equity_cache/', 
                      # fig.path = 'net_energy_equity_files/'
                      )

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 
    "latex" else "pipe"
})
```

```{r option-view, include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)

# knitr::opts_current$get(c(
#   "cache",
#   "cache.path",
#   "cache.rebuild",
#   "dependson",
#   "autodep"
# ))

kable(knitr::opts_chunk$get() %>% enframe())
```


```{r sources, cache=FALSE}
source("sources.R")
```

```{r parameters}
states <- "all" #c("ca","nc","sc") #
refresh <- FALSE
acs_version <- 2018
# geographic_scope <- "tract" #statecitycounty
```

```{r run-methods, cache=TRUE}
paper_methods(states=states,
              acs_version=acs_version,
              refresh=refresh)
```


```{r load-data}
income_metric <- "AMI" #"AMI" #"fpl15" #
geographic_scope <- "Census Tracts" #statecitycounty

version_text <- as.character(acs_version)
if(acs_version==2016){
  version_text <- "sh"
}

base_file_name <- tolower(paste(income_metric,
                                geographic_scope,
                                version_text,
                                paste(states,collapse="_",sep=""), sep = "_"))

clean_data_ami <- read_csv(paste0("data/very_clean_data_",base_file_name,".csv"), guess_max = 10^6)

income_metric <- "FPL"
base_file_name <- tolower(paste(income_metric,
                                geographic_scope,
                                version_text,
                                paste(states,collapse="_",sep=""), sep = "_"))
clean_data_fpl <- read_csv(paste0("data/very_clean_data_",base_file_name,".csv"), guess_max = 10^6)

tract_file_name <- paste0("data/",paste(states,collapse="_",sep=""),"_census_tracts.geojson")

census_tracts_shp <- st_read(tract_file_name)
replica_sup <- get_replica_supplemental_dataset()
tract_shp <- st_sf(left_join(census_tracts_shp, replica_sup, by=c("gisjoin")))
```

```{r}
# Things in here should probably be moved further up the data processing pipeline
# clean_data_ami$number_of_units <- as.factor(ifelse(clean_data_ami$min_units > 1, "mf", "sf"))
# clean_data_fpl$number_of_units <- as.factor(ifelse(clean_data_fpl$min_units > 1, "mf", "sf"))
```


```{r poverty-lines, eval=TRUE}


energy_burden_poverty_line <- 0.10

eroi_poverty_line <- eroi_func(g=1,
                               s=energy_burden_poverty_line)

average_energy_cost <- weighted.mean(clean_data_ami$energy_cost, 
                                     clean_data_ami$total_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.mean(clean_data_ami$total_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)

median_energy_cost <- weighted.median(clean_data_ami$energy_cost, 
                                     clean_data_ami$total_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$total_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)
# 12*(clean_data_ami$electricity_spend + 
#       clean_data_ami$gas_spend + 
#       clean_data_ami$other_spend)
# clean_data_ami$total_kWh <- clean_data_ami$gas_kWh + clean_data_ami$electricity_kWh
median_electricity_cost <- weighted.median(clean_data_ami$electricity_spend,
                              clean_data_ami$electricity_kWh*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$electricity_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)

median_gas_cost <- weighted.median(clean_data_ami$gas_spend, 
                                     clean_data_ami$gas_kWh*clean_data_ami$households, 
                                     na.rm = 
                                    T)/weighted.median(clean_data_ami$gas_kWh,
                                                              clean_data_ami$households,
                                                              na.rm = T)
median_gas_cost_Mcf <- weighted.median(clean_data_ami$gas_spend, 
                                     clean_data_ami$gas_Mcf*clean_data_ami$households, 
                                     na.rm = T)/weighted.median(clean_data_ami$gas_Mcf,
                                                              clean_data_ami$households,
                                                              na.rm = T)


ner_poverty_line_dlrs <- ner_func(g=1,
                                  s=energy_burden_poverty_line)

ner_poverty_line_mean <- ner_func(g=1,
                             s=energy_burden_poverty_line,
                             se=energy_burden_poverty_line/(average_energy_cost))

ner_poverty_line_median <- ner_func(g=1,
                             s=energy_burden_poverty_line,
                             se=median_energy_cost/energy_burden_poverty_line)

ner_poverty_line <- ner_poverty_line_dlrs #ner_poverty_line_median


dear_poverty_line <- dear_func(g=1,
                               s=energy_burden_poverty_line)

ner_dear_poverty_line <- dear_func(g=1+median_energy_cost*ner_poverty_line_median,
                               s=1)


```

```{r figure-parameters}
#chart_title <- "Household Economic Return on Energy Spending"
chart_title <- "Community Net Energy Return"
chart_subtitle <- "Net Earnings per Dollar of Energy Consumed"

group_columns <- NULL#"income_bracket")#in_poverty
                   #"primary_heating_fuel"

metric_name <- "ner" #"energy_burden" #"ner" #"dear" #"eroi"
metric_label <- "$/$"
metric_cutoff_level <- ner_poverty_line
metric_cutoff_label <- "Energy Poverty Line"

upper_quantile_view <- 1.0
lower_quantile_view <- 0.0
```

```{r top_metrics}
group_variable <- NULL# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

top_metrics <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.99, 
                         lower_quantile_view=0.00)
# head(top_metrics)
```


```{r grouped_weighted_metrics}
#data$GEOID <- sub('.', '', data$gisjoin)
group_variable <- "geoid"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

gwm <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)
# head(gwm)
```

```{r eval=TRUE}
fpl_graph_data <- filter_graph_data(clean_data_fpl, group_columns="in_poverty", metric_name)

fpl_top_metrics <- grouped_weighted_metrics(fpl_graph_data, 
                         group_columns="in_poverty", 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)

fpl_ep_data <- filter_graph_data(clean_data_fpl,
                                 group_columns=c("in_poverty",
                                                 "energy_burden_poverty"), 
                                 metric_name)

fpl_ep_top_metrics <- grouped_weighted_metrics(fpl_ep_data, 
                         group_columns=c("in_poverty",
                                                 "energy_burden_poverty"), 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)


# should replace this with weighted metrics data
# How many households are below the poverty line in this data?
total_households <- fpl_top_metrics$household_count

number_in_poverty <- fpl_top_metrics$households_below_cutoff

pct_in_poverty <- number_in_poverty / total_households

pct_of_ep_below_fpl <- fpl_top_metrics$households_below_cutoff[fpl_top_metrics$in_poverty=="Below Federal Poverty Line"] / sum(number_in_poverty)

# number_above_poverty <- sum((data$income_bracket!=poverty_cutoff) * (data$households))

pct_above_poverty <- 1 - pct_in_poverty

in_both_poverty <- pct_in_poverty[2]

in_only_energy_poverty <- pct_in_poverty[1]

energy_poverty_rate <- sum(number_in_poverty) / sum(total_households)

ami_graph_data <- filter_graph_data(clean_data_ami,
                                    group_columns=c("in_poverty",
                                                    "income_bracket"),
                                    metric_name)
ami_top_metrics <- grouped_weighted_metrics(ami_graph_data, 
                         group_columns=c("in_poverty",
                                         "income_bracket"), 
                         metric_name, 
                         metric_cutoff_level,
                         upper_quantile_view=1.00, 
                         lower_quantile_view=0.00)
```

```{r}
# \newpage
# **Abstract: Energy poverty in the United States is an issue of increasing urgency, exacerbated by rising inequality. Few policy-relevant datasets evaluate the energy burden of typical American households. Here, we develop a framework using net energy analysis and socioeconomic data at the census tract-level to observe systematic energy inequity across the United States among critical groups that heed policy attention. We find substantial instances of energy poverty in the United States -- `r scales::percent(energy_poverty_rate, accuracy=1)` of households experience energy poverty as presently defined as spending more than 10% of household income on energy expenditures. While `r scales::percent(in_both_poverty, accuracy=1)` of households below the federal poverty line also face energy poverty, fewer than `r scales::percent(in_only_energy_poverty, accuracy=0.01)` of those above the federal poverty line face this scarcity. The federal poverty line is not enough to capture the experience and disparity in energy poverty across the United States and excludes households that would benefit immensely from programs available to support low-income communities. We identify that energy expenditures across census tracts disproportionately burden Black, Hispanic, and Native American communities. For solar, wind, and energy efficiency to address socioeconomic mobility, programs must reduce relative energy expenditures by expanding eligibility requirements for support and access to improved conservation measures, efficiency upgrades, and distributed renewables. We recommend the United States  develop a more inclusive federal energy poverty categorization that provides greater assistance for household energy costs.**
```

# Introduction {#intro}

Energy is becoming increasingly unaffordable for American households. In the United States (US), energy poverty is now a significant challenge as families struggle to meet monthly bills and live paycheck to paycheck[@bednarRecognitionResponseEnergy2020]. Despite technological progress and rapid declines in technology costs and availability for cleaner, renewable electricity generation options such as solar photovoltaics and energy storage, many households cannot take advantage. Most households do not have access to advancements such as low-cost rooftop solar or energy efficiency upgrades that improve air quality, lower greenhouse gas emissions, and save money[@castellanosRooftopSolarPhotovoltaic2017]. Rooftop solar may be capital intensive, although the investments may recoup costs. Similarly, for households living in older buildings, the ability improve building ventilation systems and energy efficiency may require awareness and resources left out from current policies. Renters face systemic disadvantages in the energy transition; they typically pay the home's energy costs while the landlord controls infrastructure upgrades, commonly understood as a principal-agent dilemma.

It is becoming increasingly clear that there is a growing disparity between wealthier and lower-income households based on their abilities to meet basic energy needs[@brownLowincomeEnergyAffordability2020]. While per-unit residential energy costs for energy have increased below the rate of inflation in the United States since the 1980s[@ShortTermEnergyOutlook2021], many households still struggle to make utility bill payments and are especially vulnerable to economic shocks[@kawaiSpendingHouseholdEnergy2021]. This gap is not just a financial issue - many of the households living in poverty lack the agency to perform efficiency upgrades or technology enhancements that could decrease the gap between wealthy and poor households. Even though low-interest loans may be available for solar or efficiency upgrades in some communities, the bureaucracy and institutional inertia hold back a more rapid transition. In other examples, such as Property Assessed Clean Energy (PACE) programs implemented in Missouri, loans intended to support low-income homes with energy efficiency improvements allowed predatory lenders to charge high-interest rates (9-10%) and claim first lien on property taxes, leading to a spate of foreclosures [@coryneStateSupportedCleanEnergy].

The United States benchmarks its Federal Poverty Level (FPL) to the food requirements of the average household[@coferFamilyFoodPlans1962]. The FPL is an eligibility criterion for more than 40 federal programs across ten agencies (in addition to state, charitable, and private enterprises that also do so)[@divisiondcdProgramsThatUse2015]. Food and energy are interlinked in crises. Household energy use for services such as heating, cooling[@limaReviewRelationHousehold2020] and cooking[@mobarakLowDemandNontraditional2012] is crucial for decent living conditions[@raoEnergyRequirementsDecent2019]. By definition, the implications of a limited estimate of poverty used for public policy decisions stretch far beyond direct connections to food. Practitioners have posited that the standard policy of “using the ‘economy food plan’ to determine who can afford to hire an attorney” may be depriving citizens of their basic rights[@grossTooPoorHire2013]. In some cases, food assistance programs are more inclusive than energy assistance programs.

Prior research of household prosperity in limited global jurisdictions has found that gender, age, housing age[@rossHighCostEnergy2018], tenure type[@mayerTwoFacesEnergy2014], energy inefficiency[@drehoblUSLowIncomeEnergy2016], education, employment[@linAffordabilityAccessFocus2018], geography[@linDoesEnergyPoverty2020], socioeconomic status[@bednarIntersectionEnergyJustice2017], race/ethnicity[@tongMeasuringSocialEquity2021], and macroeconomic conditions[@kawaiSpendingHouseholdEnergy2021] are associated with high energy burdens in various geographical areas. Unaffordable energy is a persistent trend[@brownPersistenceHighEnergy2020] that is negatively related to social cohesion, climate change responses, and disproportionate environmental impacts on low-income populations and minority groups [@carleyJusticeEquityImplications2020]. These connections could have significant implications for navigating sustainable development and meeting societal goals around decarbonization and energy use. Adopting energy criteria for energy and other programs could expand access to services for those underserved populations in need of assistance independent of their needs in other consumption categories.

Here, we examine the relationship between energy spending and household income for all census tracts in the United States, with particular emphasis on how disparate household net energy ratios signal economic disparities across communities, racial and ethnic groups, and levels of income. This empirical analysis will fill a gap in the current discussion about energy equity by providing a biophysical framework to evaluate the disparities among household net energy outcomes.

Energy poverty is not just a lack of money to meet basic energy needs - it is a lack of the capability to enable a sustainable and prosperous society built on equity and justice principles.

# Findings

## Household Energy Burdens Across the United States  {#burdens}

Net energy refers to the newly released potential to do work as a result of some external activity. Previous studies estimate the net energy return (NER) of a process as a relationship between the gross amount of energy extracted and the amount of embodied energy directed toward extraction[@brandtCalculatingSystemsscaleEnergy2013]: 

\[
G = Gross\ Resource\ Extracted
\]

\[
S = Spending\ on\ Extraction\ Process
\]

\begin{align}
Net\ Energy\ Return\ (NER) = \frac{G - S}{S}
\end{align}


For households extracting income from the economy, these ratios can be composed of:

\[
G_{income} = Gross\ Income
\]

\[
S_{energy} = Spending\ on\ Energy
\]


From these metrics, we can create a version of net energy return for households:

\begin{align}
NER_{household} = \frac{G_{income} - S_{energy}}{S_{energy}}
\end{align}

This metric represents the net earnings a household receives for every expenditure on secondary energy.

## Applying Net Energy Ratios to Energy Equity  {#ratios}

From these concepts, we can summarize relevant energy ratios. Energy burden is the proportion of income spent on energy:

\begin{align}
Energy\ Burden = \frac{S_{energy}}{G_{income}}
\end{align}

Net Energy Ratio (or Net Energy Return) (NER) prevents the double counting of energy expenditures found in Energy Burden:

\begin{align}
Net\ Energy\ Return = \frac{G_{income}-S_{energy}}{S_{energy}}
\end{align}

```{r metric-comparison, include=TRUE, results='asis', fig.cap=metric_comparison_fig_cap}


eb_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% 
                                            mutate(energy_burden = round(100*energy_burden,digits=1)),
                                          group_columns = c("energy_burden","income_bracket"), 
                                          metric_name="net_income", 
                                          metric_cutoff_level = .1) %>% 
  mutate(metric_name="Energy Burden (%)") %>% 
  rename(energy_metric=energy_burden) #%>% 
  # mutate(energy_metric=100*energy_metric)

ner_chart_data <- grouped_weighted_metrics(clean_data_fpl %>% mutate(ner = round(ner,digits=0)), 
                                     group_columns = c("ner","income_bracket"), 
                                     metric_name="net_income", 
                                     metric_cutoff_level = 9) %>% 
  mutate(metric_name="Net Energy Return ($/$)") %>% rename(energy_metric=ner)

comparison_chart_data <- rbind(eb_chart_data,ner_chart_data)

metric_comparison_net_income_lbound <- -1000
metric_comparison_net_income_ubound <- 6*10^4
metric_comparison_x_axis_lbound <- -10
metric_comparison_x_axis_ubound <- 400
metric_comparison_pct <- sum(comparison_chart_data$household_count[
  comparison_chart_data$energy_metric <= metric_comparison_x_axis_ubound & 
    comparison_chart_data$energy_metric >= metric_comparison_x_axis_lbound & 
    comparison_chart_data$metric_mean <= metric_comparison_net_income_ubound & 
    comparison_chart_data$metric_mean >= metric_comparison_net_income_lbound & 
    !is.na(comparison_chart_data$metric_mean) & 
    is.finite(comparison_chart_data$metric_mean)]) / 
  sum(comparison_chart_data$household_count)

comparison_chart <- comparison_chart_data %>% 
  ggplot(aes(x=energy_metric, y=metric_mean, fill=income_bracket, color=income_bracket)) +
  # scale_x_continuous(trans=scales::pseudo_log_trans(base = 10)) +
  scale_y_continuous(labels=scales::dollar_format()) + 
  ggrastr::rasterise(geom_point(aes(size=household_count), 
                                alpha=0.25, 
                                position="jitter")) + 
  scale_fill_discrete(name="Income Bracket") + 
  scale_color_discrete(name="Income Bracket") + 
  scale_size_continuous(name="Households", labels=scales::label_comma()) + 
  # geom_hline(yintercept = .1) + 
  # geom_vline(xintercept = 9) + 
  # geom_smooth(method="lm",#NULL,#
  #             mapping=aes(weight=household_count),
  #             # formula=y~,
  #             se=FALSE,
  #             fullrange=TRUE,
  #             linetype="solid",
  #             alpha=0.75
  #             ) + 
  facet_grid(cols=vars(metric_name), switch="x", scales="free_x") +#, space="free_x") + 
  theme_bw() +
  labs(title = "Energy Burden and Net Energy Return in US Households", 
       x="Energy Metric", 
       y="Household Annual Net Income ($)") + 
  theme(legend.position = c(.3,.6),
        legend.background = element_rect(fill = "#ffffffaa", colour = NA), 
        legend.key.size = unit(10, "points")#,
        # legend.justification = c(0, 0)
        )+
  coord_cartesian(#xlim=c(0,120),
               ylim=c(metric_comparison_net_income_lbound,
                      metric_comparison_net_income_ubound),
               xlim=c(metric_comparison_x_axis_lbound,
                      metric_comparison_x_axis_ubound),
               # default=FALSE,
               expand=TRUE)

metric_comparison_fig_cap <- paste0("Display of the relationship between energy burden and net energy return with income for US households. While energy burden appears inversely correlated to income, this is primarily driven by a long tail of households with zero or very low incomes, often with energy expenditures exceeding their incomes. Due to the structure of the energy burden equation, the energy burden of these households approaches infinity. Since the data is estimated and provided for the express purpose of exploring low-income communities, we are hesitant to discard these households as outliers. Net energy return provides a framing of the same dataset that allows for exploration of most households on a similar scale without the long tail. Net energy return appears positively related to income, and most communities appear within a few orders of magnitude. Utilizing net energy return avoids discarding low-income communities as outliers in energy poverty analysis. Furthermore, net energy return offers a way to view the relationship between energy expenditures and income such that the wide disparity between those in broader poverty is immediately apparent. Many households with moderate-to-high energy burdens are actually higher-income households with high energy expenditures, making their net energy returns quite high (e.g., >\\$100 of income per \\$1 of energy spending). Almost ",to_percent(metric_comparison_pct)," of the households in the dataset have net incomes between ",to_dollar(metric_comparison_net_income_lbound)," and ",to_dollar(metric_comparison_net_income_ubound)," with net energy returns (or energy burdens) of between ",metric_comparison_x_axis_lbound," (",to_percent(metric_comparison_x_axis_lbound/100),") and ",metric_comparison_x_axis_ubound," (",to_percent(metric_comparison_x_axis_ubound/100),").")

comparison_chart
```

The NER is the standard metric of Net Energy Analysis because it reflects the role of energy as an input to a value-generating process in ecosystems[@brandtHowDoesEnergy2017]. Energy Burden is the metric of choice in the energy insecurity literature[@rossHighCostEnergy2018]^,^ [@bednarIntersectionEnergyJustice2017]^,^ [@drehoblUSLowIncomeEnergy2016]^,^ [@kawaiSpendingHouseholdEnergy2021]. As a percentage, it is an easily interpretable metric that helps policymakers and researchers understand the distribution and impacts of energy poverty throughout communities.

We will primarily examine the Net Energy Return, as it is the primary indicator in the study of macro-energy systems[@leviMacroEnergySystemsNew2019] like the US residential housing stock. While most Energy Return Ratios, including NER, are hyperbolic paraboloids, NER has several useful mathematical properties: it can smoothly handle systems with negative incomes and energy costs, accept households with zero income, and emphasize extreme incomes and energy costs in an interpretable fashion as shown in Figure \@ref(fig:metric-comparison). Only households with no energy costs are excluded from the analysis, whereas households with no energy costs or incomes must be excluded from an analysis utilizing energy burden.

For the discussion of household energy poverty, we are primarily interested in how households of different characteristics are distributed according to their Net Energy Returns, representing how many net dollars are earned by a household for every dollar it spends on energy. Since the NER is unitless but is a ratio of return on investment, we present it below interchangeably with no units or in units of $\$/\$$ depending on context. In this context, we may refer to NER as the Community Net Energy Return due to the community-wide scope of the underlying data used for this analysis. Other proposed indicators of energy poverty may be similarly examined in this manner. 


## Application to energy poverty  {#poverty-line}

Energy poverty is commonly defined in terms of energy burden as an expenditure of greater than 10% of household income on energy[@bednarRecognitionResponseEnergy2020]:

\begin{align}
Energy\ Burden^{*} = \frac{S_{energy}}{G_{income}} > 10\%
\end{align}

. Calibrating our net energy return analysis to this level will help gauge different thresholds of energy poverty and benchmark the results of this paper to the energy poverty literature while acknowledging the continuum of experiences across household energy consumption. Translated into its relative level for net energy return, the energy poverty line NER* is defined as:

\begin{align}
NER^{*} = \frac{G_{income}-S_{energy}}{S_{energy}}\ 
such\ that \ \frac{S_{energy}}{G_{income}} > 10\%
\end{align}

\begin{align}
NER^{*} < 9: Household\ at\ Energy\ Poverty\ Line
\end{align}

This means that a household that earns less than $9 of income for every dollar it spends on secondary energy will be considered to be in energy poverty by the traditional energy burden accounting method. A NER of 9 or lower is equivalent to an energy burden of 10% or higher. This threshold is arbitrary and may not be suitable in situations where households fall very close to this line or where the number of family members or measures of certain building characteristics vary widely. Simply, it is presented as a benchmark. We examine the net energy return at a community scale across the United States in Table 1.

## The Household Net Energy Landscape  {#landscape}


```{r comparison-table, include=TRUE, results="asis"}
# table with states'/groups' median annual household energy expenditures, incomes, net incomes, NER, and EB
compare_metrics <- function(metric_name="ner"){
  gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami,c("income_bracket"),metric_name),
                           c("income_bracket"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)
  gwm$metric_name <- metric_name
  return(gwm)
}

compare_table <- rbindlist(lapply(c("income",
                                    "energy_cost",
                                    # "energy_burden",
                                    "net_income"#,
                                    # "ner"
                                    ), compare_metrics))

compare_table_totals <- compare_table %>% 
  filter(metric_name=="income") %>% 
  pivot_wider(id_cols=income_bracket,
              names_from=metric_name,
              values_from=household_count,
              ) %>% 
  rename(households=income) %>% pivot_longer(cols="households")

compare_table <- compare_table %>% 
  pivot_wider(id_cols=income_bracket,
              names_from=metric_name,
              values_from=metric_mean) %>% 
  mutate(energy_burden = energy_burden_func(g=income, s=energy_cost),
         ner = ner_func(g=income, s=energy_cost)) %>% 
  pivot_longer(cols=c("income","energy_cost","energy_burden","net_income","ner"))

compare_table <- rbind(compare_table_totals, compare_table)

#format the metrics accordingly
# income = 0 decimal place $
# energy_cost = 0 decimal place $
# energy_burden = 0 decimal place %
# net_income = 0 decimal place $
# ner = 1 decimal place number

which_metric <- "value" #"metric_mean" #"metric_median"

compare_table$print_value <- ifelse(compare_table$name %in% c("income",
                                                                     "energy_cost",
                                                                     "net_income"),
                                    to_dollar(compare_table[[which_metric]]),
                                    ifelse(compare_table$name %in% c("energy_burden"),
                                           to_percent(compare_table[[which_metric]]),
                                           ifelse(compare_table$name %in% c("ner"),
                                                  round(compare_table[[which_metric]],1),
                                                  ifelse(compare_table$name %in% c("households"),
                                                         to_million(compare_table[[which_metric]]),
                                                  to_big(compare_table[[which_metric]])))))

compare_table$display_income_bracket <- dplyr::recode_factor(compare_table$income_bracket, 
                                       very_low="0-30% AMI",
                                       low_mod="30-80% AMI", 
                                       mid_high="Above 80% AMI",
                                       All="All",
                                       .ordered=TRUE)


compare_table[,"Metric Name"] <- dplyr::recode(compare_table$name,
                                               households="Households in Sample",
                                    income="Annual Income (G)",
                                    energy_cost="Annual Energy Expenditures (S)",
                                    energy_burden="Energy Burden (S/G)",
                                    net_income="Net Income (G-S)",
                                    ner="Net Energy Return ([G-S]/S)")

print_table <- compare_table[,c("Metric Name","display_income_bracket","print_value")] %>% 
  arrange(display_income_bracket) %>% 
  pivot_wider(names_from=display_income_bracket,values_from=print_value)

write_csv(print_table, "comparison_table.csv")

highlight_metrics <- rbindlist(lapply(c(
                                    "energy_burden",
                                    "ner"
                                    ), compare_metrics))

highlight_energy_burden <- as.numeric(highlight_metrics[metric_name=="energy_burden" & income_bracket=="very_low","metric_mean"])

highlight_ner <- as.numeric(highlight_metrics[metric_name=="ner" & income_bracket=="very_low","metric_mean"])

num_one <- paste0(to_big(highlight_energy_burden*100),"\\%")
num_two <- round(highlight_ner,1)
# glue::glue(

print_caption <- paste0("Average annual household energy expenditures, incomes, net incomes, net energy returns, and energy burdens portrayed for different income groups based on their relationship to Area Median Income. Note that the statistics for energy burden and net energy return are calculated per cohort after averaging the income and expenditure statistics to avoid the effect of extreme values skewing the interpretability of these metrics as described in the text. For example, the actual weighted average energy burden for households from 0-30\\% AMI is ",num_one,", and the average net energy return for this cohort is ", num_two," due to subsets of the dataset with very low incomes or low energy expenditures. Net energy return is not as susceptible to this skewing effect.")

# print_caption <- "caption \\% caption"


final_table <- subset(print_table, select=-All) %>%  knitr::kable(booktabs=T,
               caption=print_caption) %>% 
  kableExtra::kable_styling() %>% 
  kableExtra::row_spec(c(2,3,4,6), bold=T)
  # kableExtra::kable_styling(latex_options = c("striped"), #,"hold_position"
                            # position="center")
final_table
```


```{r}
total_homes <- tidycensus::get_acs(geography = "us",
                    variables = c(households="B25002_002"),
                    year = acs_version)
# head(total_homes)
estimated_homes <- compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","value"]
min_homes <- total_homes$estimate - total_homes$moe
max_homes <- total_homes$estimate + total_homes$moe
```


The average American home in the Low-Income Energy Affordability Data (LEAD)[@maLowIncomeEnergyAffordability2019] (n=`r compare_table[compare_table$income_bracket=="All" & compare_table$name=="households","print_value"]` households) has an income of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="income","print_value"]` and an annual energy expenditure of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","print_value"]` (`r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_cost","value"])/12)`/month), which equates to an average energy burden of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="energy_burden","print_value"]` or an average net energy return of `r compare_table[compare_table$income_bracket=="All" & compare_table$name=="ner","print_value"]`. While the dataset slightly overrepresents households below the median income due to the limitations of the statistical methods used to compile them, it represents estimates for approximately `r to_percent(as.numeric(estimated_homes/(max_homes)))`-`r to_percent(as.numeric(estimated_homes/(min_homes)))` of the `r to_million(min_homes, suffix="")`-`r to_million(max_homes)` family-occupied households evaluated by the American Community Survey. Table 1 shows a summary of these data for households and their average statistics broken down based on household incomes relative to Area Median Income (AMI). We can see that high energy burdens are found mostly in the very low income group, with an average energy burden of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` or net energy return of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="ner","print_value"]`. Income drives the escape from energy poverty: middle and high-income groups do not spend drastically different amounts on energy (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` and `r to_percent(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="energy_cost","value"] - compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"]))` more, respectively) but earn `r to_big(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` and `r to_big(as.numeric((compare_table[compare_table$income_bracket=="mid_high" & compare_table$name=="income","value"])/compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"]))` times that of the very low-income group, respectively. An energy burden of `r compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_burden","print_value"]` means that `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month is spent on energy, which is quite high on a monthly income of `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="income","value"])/12)`. The additional `r to_dollar(as.numeric(compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/12)` per month that the next rung of moderate-income groups spends on energy represents a minuscule proportion of their income (`r to_percent(as.numeric((compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="energy_cost","value"]-compare_table[compare_table$income_bracket=="very_low" & compare_table$name=="energy_cost","value"])/compare_table[compare_table$income_bracket=="low_mod" & compare_table$name=="income","value"]))`).

Because cleaner investments could lower costs over time, we can immediately see a disproportionate burden for those making low income to shifting expenditures to other forms of fuel if any upfront investment is required. Fossil fuel costs are not internalized, so it seems like lower-income cohorts are paying less monetarily. Still, they are paying the costs in other ways, such as through health and environmental externalities. Even without these externalities priced in, the burden of energy for low-income groups is already very high.


```{r}
# show some pie / bar charts of the breakdown between fuels
```


```{r continental-map, include=TRUE, results='asis', fig.cap=continental_map_fig_cap}

continental_map_fig_cap <- "Map of the average net earned income per secondary energy expenditure for each census tract in the continental United States. Shades of yellow and red indicate communities at or below the energy poverty line as defined by earning 9 dollars or less in income per dollar of energy expenditures. This corresponds to the traditional definition of energy poverty as spending 10 percent or more of income on energy. Low net energy returns can be starkly observed in the Black Belt across the Southeastern US, Hispanic communities near the US-Mexico border, Native American lands, and rural New England."

continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))
# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

# full_map_data <- left_join(tract_shp, gwm, by=c("geoid"))

map_data <- left_join(continental_shp, gwm, by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(graph_data %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="Energy Burdens Across the United States",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = TRUE,
    metric_long_name = "Net\nEnergy Return")

choropleth_chart
```


```{r inset-map, include=TRUE, results='asis', fig.cap=inset_map_fig_cap}

inset_map_fig_cap <- "An inset focused on the city of New Orleans, Louisiana (Orleans Parish), showing an example of the dynamics of energy poverty in an urban area where the presence of energy inequity is harder to see compared to rural areas for which census tracts are a larger physical area."

nola_msa_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish")

nola_csa_parishes <- c(nola_msa_parishes, 
                       "Tangipahoa Parish",
                       "Washington Parish")

nola_rpc_parishes <- c("Jefferson Parish", 
                   "Orleans Parish", 
                   "Plaquemines Parish", 
                   "St. Bernard Parish", 
                   "St. Charles Parish", 
                   # "St. James Parish", 
                   "St. John the Baptist Parish", 
                   "St. Tammany Parish",
                   "Tangipahoa Parish")

orleans_and_neighbors <- c("Orleans Parish",
                           "St. Tammany Parish",
                           "Jefferson Parish",
                           "Plaquemines Parish", 
                   "St. Bernard Parish"
                           )

inset_map_data <- map_data %>% filter(county_name=="Orleans Parish"
                                     & state_abbr=="LA")

inset_bb <- st_buffer(st_as_sfc(st_bbox(inset_map_data)) %>% st_transform(3857), dist=10)

choropleth_chart_highlight <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    legend_position = "none"
    ) + 
  geom_sf(data = inset_bb, fill = NA, color = "blue", size = 0.2)

# https://en.wikipedia.org/wiki/New_Orleans_metropolitan_area
choropleth_chart_inset <- choropleth_map(
    clean_data=inset_map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title="Inset of Energy Burdens In New Orleans, Louisiana",
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    legend_position = c(.85,.4),
    include_compass = TRUE,
    metric_long_name = "Net\nEnergy Return")

gg_inset_map = ggdraw() +
  draw_plot(choropleth_chart_inset) +
  draw_plot(choropleth_chart_highlight, x = 0.1, y = 0.65, width = 0.35, height = 0.35)

gg_inset_map
# ggsave2("national_map.pdf",plot=choropleth_chart)
# ggsave2("inset_map.pdf",plot=gg_inset_map)

# grid.arrange(choropleth_chart,gg_inset_map, nrow=2)
# cowplot::plot_grid(choropleth_chart,gg_inset_map, align = "v", nrow=2)
```


```{r places_of_interest, eval=FALSE}
# remove HI and AK
continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))
# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

map_data <- left_join(continental_shp, gwm, by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(graph_data %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)
# head(clean_top_metrics)

```

```{r maps_of_interest, eval=FALSE, out.width="100%", fig.cap="Some selections of interesting areas on the map"}
# figure_name <- "choropleth_map"
# figure_file <- paste0("figures/",figure_name,".png")
# if(!file.exists(figure_file) || refresh){
choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title,
    chart_subtitle,
    weighted_metrics=clean_top_metrics)
  # ggsave(figure_file, plot=choropleth_chart)
# }
choropleth_chart
```

Displayed geospatially in Figure \@ref(fig:continental-map), it is clear that the Black Belt in the American Southeast is visibly perceptible, indicating that low-NER follows racial lines in areas where inexpensive energy is available, and energy burdens are more dependent on housing quality and patterns of consumption than they are dependent on price. Likewise, border populations and immigrant populated areas in the Southwest have higher burdens, as do Native American lands. The use of heating oil in the Northeast states such as Maine can be seen through the prevalance of low-NER communities in this area since heating oil is a notably expensive and inefficient source of heating commonly used in this region. Urban inequity results in lower NER populations not showing up in many dense or gentrified urban areas such as the San Francisco Bay Area, New York City, and New Orleans as shown in Figure \@ref(fig:inset-map). A notable exception to this trend is Detroit, in which the pervasiveness of urban energy poverty has been studied extensively and shown to have distinct geographic boundaries. While some of these conclusions are supported by existing evidence and literature, they should be confirmed with a rigorous analysis of this dataset using the NER metric for reasons explained in Section \ref{ratios}. Additional analyses should incorporate additional demographic and household dimensions due to potential disparities within census tracts since diverse neighborhoods may not be represented accurately by aggregate census tract metrics.

```{r}
clean_data_fpl$simplified_primary_heating_fuel <- as.factor(ifelse(clean_data_fpl$primary_heating_fuel=="ELECTRICITY",
                                                              "Electricity", 
                                                               ifelse(clean_data_fpl$primary_heating_fuel %in% 
                                                                        c("UTILITY GAS","BOTTLED GAS"),
                                                                      "Gas",
                                                    ifelse(clean_data_fpl$primary_heating_fuel=="SOLAR",
                                                           "Solar",
                                                                      "Other"))))


clean_data_ami$all <- as.factor("all")

clean_data_ami <- dplyr::left_join(clean_data_ami, replica_sup[c("geoid","company_ty","locale")], by=c("geoid"))

clean_data_ami$simplified_utility_type <- ifelse(clean_data_ami$company_ty %in% c("Coop","DistCoop"),
                                                 "Cooperatively Owned",
                                                 ifelse(clean_data_ami$company_ty %in% c("Federal",
                                                                                         "Muni",
                                                                                         "State"),
                                                        "Government Owned",
                                                        ifelse(clean_data_ami$company_ty %in% 
                                                                 c("Private","PSubdiv"),
                                                               "Privately Held",
                                                               ifelse(clean_data_ami$company_ty=="IOU",
                                                                      "Publicly Held",
                                                                      "Other")
                                                               )
                                                        ))

clean_data_ami$simplified_locale <- sub(" .*", "", clean_data_ami$locale)
```

```{r eval=FALSE}
chart_groups <- list(c(NULL),
                     federal poverty line
                     fuel type?
                       rent+mf
- utility types
- locale types
                  )
```


```{r}
top_line_group <- NULL

p1 <-   density_chart(graph_data, 
                                 metric_name, 
                                 metric_label="", 
                                 group_columns=top_line_group, 
                                 metric_cutoff_level, 
                                 metric_cutoff_label, 
                                 chart_title=NULL, 
                                 chart_subtitle=NULL,
                                 x_label="a")
```

```{r}
top_line_group <- "income_bracket"

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="b")
p2=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="c")
p3=top_line_charts[["density"]]
```


```{r}
top_line_group <- c("number_of_units")
# c("number_of_units", "occupancy_type"),
#                           c("occupancy_type", "income_bracket"),
#                           c("number_of_units", "occupancy_type", "income_bracket"),

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="d")
p4=top_line_charts[["density"]]
```

```{r}
top_line_group <- c("housing_tenure")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="d")
p5=top_line_charts[["density"]]
```


```{r}
top_line_group <- c("simplified_utility_type")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="f")
p6=top_line_charts[["density"]]
```


```{r}
# "pop_hispanic"                               
# [35] "pop_african_american"                        "pop_asian"                                  
# [37] "pop_native_american"                         "pop_caucasian" 
# "pop_total"

minority_races <- c("hispanic","african_american","asian","native_american")
races <- c(minority_races,"caucasian")

pct_races <- replica_sup[,paste0("pop_",races)] / rowSums(replica_sup[,paste0("pop_",races)])
names(pct_races) <- paste0("pct_",races)

plurality_race <- races[max.col(pct_races,ties.method = "first")]

plurality_race <- ifelse(plurality_race=="african_american","black",
                                   ifelse(plurality_race=="native_american","indian",
                                          ifelse(plurality_race=="caucasian","white",
                                          plurality_race)))

race_data <- data.frame("geoid"=replica_sup$geoid,
                        "race"=plurality_race)

top_line_group <- c("race")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(race_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="e")
p7=top_line_charts[["density"]]
```

```{r}
# "pop25_some_college_plus"                     "pop25_high_school"                          
# [41] "pop25_no_high_school"
# "pop_total"

# minority_races <- c("african_american","hispanic","asian","native_american")
# races <- c(minority_races,"caucasian")

education_levels <- c("some_college_plus","high_school", "no_high_school")

pct_education_levels <- replica_sup[,paste0("pop25_",education_levels)] / 
  rowSums(replica_sup[,paste0("pop25_",education_levels)])
names(pct_education_levels) <- paste0("pct_",education_levels)

plurality_education_level <- education_levels[max.col(pct_education_levels,ties.method = "first")]

plurality_education_level <- ifelse(plurality_education_level %in% 
                                      c("high_school","no_high_school"),
                                    "high school or less",
                                    ifelse(plurality_education_level=="some_college_plus",
                                           "college or more",
                                          plurality_education_level))

education_data <- data.frame("geoid"=replica_sup$geoid,
                        "simplified_education"=plurality_education_level)


top_line_group <- c("simplified_education")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(education_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="f")
p8=top_line_charts[["density"]]
```

```{r}
# "climate_zone"                               
# [75] "climate_zone_description"

simplified_climate <- ifelse(replica_sup$climate_zone_description %in% c("Hot","Very Hot"), "Hot",
                             ifelse(replica_sup$climate_zone_description %in% c("Cold",
                                                                                "Very Cold",
                                                                                "Subarctic"),"Cold","Moderate")
                             )

climate_data <- data.frame("geoid"=replica_sup$geoid,
                           "simplified_climate"=simplified_climate)

top_line_group <- c("simplified_climate")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(climate_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="i")
p9=top_line_charts[["density"]]
```



```{r density-charts, include=TRUE, results='asis', fig.cap=density_charts_fig_cap}

density_charts_fig_cap <- "The distribution of net energy returns across different household characteristics. Subfigure **a** shows the overall distribution. Subfigure b shows the difference among those groups of households above and below the Federal Poverty Line. Subfigure c shows the difference among groups of households identified by their primary heating fuel. Subfigure d shows the difference based on whether they are renters or owners. Subfigure e shows the difference based on the most prominent race in the census tract of each cohort. Subfigure f shows the difference based on the most prominent education history in the census tract of each cohort."

grid.arrange(p1,
             p2,
             p3,
             # p4,
             p5,
             # p6,
             p7,
             p8,
             # p9, 
             nrow=2,
             # top=chart_title,
             # subtitle
             bottom="Proportion of Households",
             left=paste0("Net Energy Return (",metric_label,")"))

# multi_plot <- cowplot::plot_grid(p1,p2,p3,p4,p5,p6,p7,p8,p9,
#                    nrow=3, align="none",rel_heights = c(2,2,2))
# 
# #create common x and y labels
# 
# y.grob <- textGrob(paste0(str_to_upper(metric_name)," (",metric_label,")"), 
#                    gp=gpar(fontface="bold", col="black", fontsize=12), rot=90)
# 
# x.grob <- textGrob("Proportion of Households", 
#                    gp=gpar(fontface="bold", col="black", fontsize=12))
# 
# #add to plot
# 
# grid.arrange(arrangeGrob(multi_plot, left = y.grob, bottom = x.grob))
```

From this high level, we can see in Figure \@ref(fig:density-charts) that approximately `r scales::percent(energy_poverty_rate, accuracy=1)` of households in the United States experience energy poverty. Displaying by those communities defined by their relationship to the Federal Poverty line provides a stark picture. While `r scales::percent(in_both_poverty, accuracy=1)` of households below the federal poverty line also face energy poverty, fewer than `r scales::percent(in_only_energy_poverty, accuracy=0.01)` of those above the federal poverty line face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap. When we break the group of relatively prosperous households into subsets, we find that `r scales::percent(as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","households_below_cutoff"])/as.numeric(ami_top_metrics[ami_top_metrics$income_bracket=="low_mod","household_count"]),accuracy=1)` of households living at 30-80% of their Area Median Income are experiencing energy poverty. This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in net energy return on the households’ energy investments is surprising.

Examining these dynamics by the status of homeownership reveals further disparities. Though renters and homeowners are similarly distributed below the energy poverty line, there appears to be a clear advantage of homeownership from a net energy perspective for most of the population. Only at a relatively high return on investment do renters seem to have a net energy advantage, presumably due to these tenants living in relatively new and efficient urban rentals. Tenure matters for more than just equity itself: renters are less likely to take actions to improve their net energy returns due to a lack of property rights and misaligned incentives (the principal-agent issue). Even when action is taken to improve the energy efficiency of a rental building, tenants are less likely to see any economic benefits from it.

Households with solar as a primary heating fuel have a higher net energy income ratio than those with other fuel sources, except for households far below the energy poverty line. Why are solar households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households' low consumption, meaning that the potential savings from installing a renewable energy system are lower than for high-income households.

```{r eval=FALSE}
weighted_medians <- clean_data %>%
   group_by(housing_tenure) %>% 
   summarise(median_electricity_spend = if( sum(!is.na(households))<3 ){NA} else { weighted.median(electricity_spend, households, na.rm=TRUE)},
             median_eroi = if( sum(!is.na(households))<3 ){NA} else { weighted.median(mean_eroi, households, na.rm=TRUE)},
            median_income = if( sum(!is.na(households))<3 ){NA} else { weighted.median(annual_income, households, na.rm=TRUE)},
            median_electricity_price = if( sum(!is.na(households))<3 ){NA} else { weighted.median(implied_price_kWh, households, na.rm=TRUE)},
            median_electricity_use = if( sum(!is.na(households))<3 ){NA} else { weighted.median(implied_electricity_use, households, na.rm=TRUE)},
            median_energy_burden = if( sum(!is.na(households))<3 ){NA} else { weighted.median(mean_energy_burden, households, na.rm=TRUE)},
            median_energy_cost = if( sum(!is.na(households))<3 ){NA} else { weighted.median(mean_energy_cost, households, na.rm=TRUE)}
            )
```


```{r eval=FALSE}
gwm <- grouped_weighted_metrics(graph_data=graph_data, 
                                  group_columns=group_columns, 
                                  metric_name=metric_name, 
                                  metric_cutoff_level=metric_cutoff_level, 
                                  upper_quantile_view=upper_quantile_view, 
                                  lower_quantile_view=lower_quantile_view)
gwm <- gwm %>% {if(!is.null(group_columns)) unite(., "group_name", all_of(group_columns), remove=FALSE, sep="+", na.rm=FALSE) else (mutate(., group_name="all"))}

mean_eroi <- graph_data %>%
  ggplot(aes_string(x=metric_name, 
             weight="group_household_weights", 
             fill="group_name", 
             color="group_name")) + 
  geom_density(alpha=0.1) + 
  ggtitle("Household Energy Return on Investment By Utility Ownership Type") + 
  scale_x_continuous(labels = scales::unit_format(unit = "x", scale = 1, accuracy = 1),
                     breaks=seq(from=0,to=100,by=10), 
                     minor_breaks=seq(from=0,to=100,by=1),
                     limits=c(0,100), name="Household Energy Return on Investment\n(Income Earned for each Dollar Spent on Energy)") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.05), name="Proportion of Households") + 
  theme_minimal() + 
  theme(legend.justification = c(1, 1), legend.position = c(1, 1), legend.title=element_blank()) + 
  geom_vline(data=gwm, aes(xintercept=metric_median,  color=group_name),
               linetype="solid", size=0.5, alpha=0.75) + 
  geom_vline(xintercept = 10, linetype="dotted", 
                color = "red", size=1.0, alpha=0.75)

mean_eroi + annotate("text", x = 10, y = 0.0075/3, angle = 90, color="red", label = "Energy Poverty Line", 
    vjust = -0.5, parse = FALSE, alpha=0.75) + 
  annotate("text", x = min(weighted_medians$median_eroi), y = 0.005/3, angle = 90, color="gray25", label = "Median", 
    vjust = -0.5, parse = FALSE, alpha=0.75)
```


```{r eval=FALSE}
independent_variable <- "replica_mwh"
electricity_v_eroi_contour_plot <- graph_data %>% 
  ggplot(aes_string(x=independent_variable,
                    y=metric_name,
             weight="group_household_weights", 
             fill="group_name", 
             color="group_name")) +
  stat_density_2d(aes(alpha = ..piece..), geom="polygon", na.rm=TRUE) +
  guides(alpha = FALSE) +
  stat_smooth(method = "lm", fullrange = TRUE) +
  # geom_rug() + 
  scale_x_continuous(name = "Monthly Electricity Cost", 
                     labels = scales::dollar_format(),
                     limits = c(0, 1000), expand = c(0, 0)) + 
  scale_y_continuous(name = "EROI", 
                     labels = scales::unit_format(unit = "x", scale = 1, accuracy = 1),
                     limits = c(0, 100), expand = c(0, 0)) + 
  theme_pubr() + #   theme(plot.margin = margin()) + 
  theme(legend.position = "bottom")
electricity_v_eroi_contour_plot
```


```{r eval=FALSE}
electricity_spend + theme_void() + theme(legend.position = "none") + labs(title = NULL, x=NULL, y=NULL) + 
  ggtitle("Monthly Electricity Cost vs. EROI") + 
  plot_spacer() + 
  electricity_v_eroi_contour_plot + theme(legend.justification = c(1, 1), legend.position = c(1, 1), legend.title=element_blank()) + 
  mean_eroi + coord_flip() + theme_void() + theme(legend.position = "none") + labs(title = NULL, x=NULL, y=NULL) + 
  plot_layout(ncol = 2, nrow = 2, widths = c(4, 1), heights = c(1, 4))
```


```{r eval=FALSE}
# Monthly Electricity Expenditures
electricity_spend <- clean_data %>%
  ggplot(aes(x=electricity_spend, weight=ownership_type_household_weights/3, fill=ownership_type, color=ownership_type)) + 
  geom_density(alpha=0.1) + 
  ggtitle("Household Monthly Electricity Spending By Utility Ownership Type") + 
  scale_x_continuous(labels = scales::dollar_format(), limits=c(0,300), name="Energy Spend",
                     breaks=seq(from=0,to=300,by=50), 
                     minor_breaks=seq(from=0,to=300,by=10)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.0005), name="Proportion of Households") + 
  theme_minimal() + 
  theme(legend.justification = c(1, 1), legend.position = c(1, 1), legend.title=element_blank()) + 
  geom_vline(data=weighted_medians, aes(xintercept=median_electricity_spend,  color=ownership_type),
               linetype="solid", size=0.5, alpha=0.75)

electricity_spend + annotate("text", x = min(weighted_medians$median_electricity_spend), y = 0.0025/3, angle = 90, color="gray25", label = "Median",vjust = -0.5, parse = FALSE, alpha=0.75)
```



```{r eval=FALSE}
s1 <- scatter_chart(graph_data, 
                          metric_name, 
                          metric_label,
                          group_columns, 
                          metric_cutoff_level, 
                          metric_cutoff_label, 
                          chart_title, 
                          chart_subtitle,
                          independent_variable="group_households")
s1
```


```{r eval=FALSE}
# Compare maps of energy burden vs. solar rooftop potential
```

```{r eval=FALSE}
From an equity perspective, the Gini coefficient of net energy returns among US households is `r print("X")`. This means that the net energy returns are distributed `r print("Y")` by household compared to a uniform distribution. Even this perspective is limited given that we would expect the productivity of energy usage by each household would be similar, even if the absolute values of energy consumption vary. In other words: there is no reason that net energy returns should differ among households at all.
```

```{r}
group_columns <- c("state_abbr")
# utility type? see chartbook
graph_data <- filter_graph_data(clean_data=clean_data_ami[clean_data_ami$state_abbr!="DC",], 
                                group_columns=group_columns, 
                                metric_name=metric_name)
```

```{r}
# percent of "other" fuel expenditures toward fossil fuel combustion
# want to make this more precise by state, county, and/or balancing authority eventually
other_gwm <- grouped_weighted_metrics(clean_data_fpl[clean_data_fpl$state_abbr!="DC",], 
                                      c("primary_heating_fuel"),
                                      "other_spend",
                                      0)

other_fuels <- c("COAL","FUEL OIL","NONE","OTHER","SOLAR","WOOD","BOTTLED GAS")
non_fossil_other_fuels <- c("NONE","SOLAR","WOOD")
fossil_other_fuels <- other_fuels[!(other_fuels %in% non_fossil_other_fuels)]

other_fossil <- other_gwm[other_gwm$primary_heating_fuel %in% fossil_other_fuels,
                              c("household_count","metric_mean")]

pct_other_fossil <- sum(other_fossil$household_count*other_fossil$metric_mean)/
  sum(other_gwm$household_count*other_gwm$metric_mean)

graph_data$pct_other_fossil <- pct_other_fossil
```

```{r}
# percent of each state's electric grid decidated to fossil fuel combustion
# can refine by balancing authority based on REPLICA dataset
egrid <- get_state_egrid()

egrid$pct_electricity_fossil <- egrid$STCLPR + #coal
  egrid$STOLPR + #oil
  egrid$STGSPR + #gas
  egrid$STOFPR #+ #other fossil
  # egrid$STNCPR #+ #nuclear
  # egrid$STHYPR #+ #hydro
  # egrid$STOPPR #unknown/purchased

graph_data <- left_join(graph_data, egrid, by=c("state_fips"="FIPSST"))

# graph_data <- graph_data[graph_data$state_abbr!="DC",]
```

```{r}
# percent of natural gas expenditures dedicateed to fossil fuel combustion...
pct_gas_fossil <- 1.0

graph_data$pct_gas_fossil <- pct_gas_fossil
```


```{r}
graph_data$pct_fossil_tract <- (graph_data$pct_gas_fossil * graph_data$gas_spend + 
  graph_data$pct_electricity_fossil * graph_data$electricity_spend + 
  graph_data$pct_other_fossil * graph_data$other_spend) / 
  (graph_data$gas_spend + graph_data$electricity_spend + graph_data$other_spend)


pct_fossil_gwm <- grouped_weighted_metrics(graph_data, "state_fips","pct_fossil_tract",0) %>% 
  dplyr::rename(pct_fossil=metric_mean)

graph_data <- left_join(graph_data, 
                        pct_fossil_gwm[,c("state_fips","pct_fossil")], 
                        by="state_fips")
```



```{r state-violin, include=TRUE, eval=TRUE, results='asis', fig.cap=state_violin_fig_cap}

state_violin_fig_cap <- "A comparison of net energy returns among each state in the United States. The bars are sorted by median household NER and represent the interquartile range (25%-75% percentiles) of household NERs colored by the percent of household energy expenditures in each state that go to support fossil fuel combustion, whether directly through natural gas purchases or indirectly through the electricity grid in each state. Natural gas purchases are assumed to be entirely combusted by the end-user, and electricity purchases are divided into their respective sources according to the US Environmental Protection Agency's eGRID dataset for each state. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately 75% fossil fuel combustion. The figure suggests that a reliance on fossil fuel combustion does not lead to a more affordable energy system for end-users."
# violin plot
y <- make_violin_chart(graph_data=graph_data,
                      group_columns=group_columns,
                      metric_name=metric_name,
                      metric_label=metric_label,
                      metric_cutoff_level=metric_cutoff_level,
                      fill_metric="pct_fossil",#"STCYPR",#"STSOPR",
                      fill_label="% of Energy Expenditures on \nFossil Fuel Combustion",#Combustion",#Solar",
                      group_name="State",
                      x_label="Net Energy Return ($ of net income per $ of energy expenditure)")
print(y)
```

Assessing the Net Energy Return metric among different states in Figure \@ref(fig:state-violin) presents a counterintuitive picture of how states address energy poverty and energy equity. 

The nature of the metric is that it can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as Connecticut and Vermont, where higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi and Alabama, which have significant low-income populations. Not only are households falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood will suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on new metrics.

Although they are the states with the highest NER (California and Colorado) are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely, this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation in states such as California, Colorado, Hawaii, and Washington are a common thread, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure \@ref(fig:state-violin) shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high net energy returns than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.

```{r}
group_variable <- "eia_id"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(left_join(clean_data_ami, replica_sup, by=c("geoid")), group_columns, metric_name)

util_group <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)

member_minumum <- 10000
lowest_ner_utility <- filter(arrange(util_group,metric_mean),household_count>=member_minumum)[1,]

unique_utils <- distinct(replica_sup[c("eia_id","company_na","state_name","dlrs_kwh")])

lowest_ner_utility_specs <- filter(unique_utils,eia_id==as.numeric(lowest_ner_utility["eia_id"]))

lowest_ner_utility_name <- lowest_ner_utility_specs$company_na
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Corp","Corporation")
lowest_ner_utility_name <- str_replace_all(lowest_ner_utility_name,"Member","Membership")
```

# Discussion  {#discussion}

Net energy returns are different among different groups of households in America. These striking disparities suggest the existence of deeply structural barriers to prosperity in American society, ones which may not be alleviated and may even be exacerbated by electrification and the transition to clean fuels. How can our energy system be operated and improved to provide equitable access? Are there ways that clean electrification can be used to better benefit currently underserved communities?

A sensible prior hypothesis is that everyone experiences the same efficiency from the energy system as measured by return on energy investment. The marginal unit of energy consumed by one household should lead to as much benefit for that household as any other. Differences in absolute outcomes may be related to the quantity of energy investment. However, here we see that system efficiency is different for different households on a relative basis. This difference is often correlated to factors out of the households’ control and even those related to persistent social inequalities. High burdens may be associated with intermittent grid access when extreme weather events interrupt energy supply chains. The same households are often at greater risk of energy service disconnection due to non-payment. Re-connection fees can compound to increase burdens in ways not captured by our analysis.

Energy is central to equity and economic prosperity, but the odds are stacked against many people. The energy system appears to be regressive in that costs accrue disproportionately to those of lower-income levels and the most energy-efficient homes belong to wealthier families. As a result, there has been a disparity in how the benefits of the energy transition are accruing among socioeconomic groups [@vaishnavWasItWorthwhile2017]. There is the potential for further division if appropriate policies are not implemented[@cullenwardDynamicallyEstimatingDistributional2016]. Typically, households using solar are higher-income with access to upfront capital to invest in new technology. When they do so, their NER increases as a result of decreasing their energy expenditures. This creates a disparity between those with access to renewable energy and those reliant on fossil-fuel-based energy sources, which does not have to be the case. A more comprehensive approach to poverty alleviation in the US would also consider the energy situation of each household and the options available to improve its efficiency. Then, it would make those options accessible to the stakeholders who could benefit.

Instead, a negative feedback loop results: in-home combustion of biofuels and hydrocarbons is a significant source of air pollution and exacerbates other household costs like healthcare and maintenance. High energy burdens have already been linked to local and global air pollution, and we can connect these impacts directly to the full scope of household prosperity via net energy. Energy is essential to deal with other inequities in society. There must be a way to design a structure that addresses this disparity more equitably. While well-intended programs such as PACE or solar loans have reached few people, community-oriented programs focusing on peer-mentorship could improve programmatic outcomes. Building support for community-led programs can also reduce the burden on individuals to expand access to the benefits of solar and efficiency. A more in-depth examination of the energy system’s underlying regulatory structures and robust assessments of energy burden could provide a path forward and track how the benefits of the energy transition are being accrued through such programs.

The vastness of the modern electric grid eludes affordability for everyday households because of the relationships between the utility companies and the users. Secondary energy is unique among residential consumption categories because a single service provider is usually the authority for determining energy costs for each of its customers. In vertically integrated energy markets, the monopoly utility is the only option available to all consumers. In restructured energy markets, the public utility is designated as the last resort provider for those unable or unwilling to participate in the competitive procurement of energy. Pachauri et al.[@pachauriAdvancingEnergyPoverty2020] distinguish between affordability and cost of supply, implying that more focus should be applied toward how energy burdens vary among customers of different energy suppliers than on how per-unit costs of energy vary. For instance, `r lowest_ner_utility_name` is the electric utility with more than `r to_big(member_minumum)` customers whose members have the lowest average net energy return (`r to_big(lowest_ner_utility$metric_mean)`). At the same time, the per-unit cost of electricity in this service territory is only more expensive than `r to_percent(ecdf(unique_utils$dlrs_kwh)(lowest_ner_utility_specs$dlrs_kwh))` of utilities at `r to_dollar(lowest_ner_utility_specs$dlrs_kwh)`/kWh. In some markets, specialized rates or programs are available for Low and Moderate Income (LMI) consumers, who may have higher energy burdens. We find it notable that more than half of all funding to address high energy burdens in the US is from utility ratepayer-funded bill and energy efficiency assistance[@rossHighCostEnergy2018].

In addition to these relatively local measures, the Low Income Home Energy Assistance Program (LIHEAP) and the Weatherization Assistance Program (WAP) seek to address aspects of energy poverty through bill payment assistance and energy efficiency measures. The efficacy of these programs has been mixed in addressing distributional equity in energy burdens and receiving benefits from energy efficiency programs. The COVID-19 pandemic and associated economic downturn may be a critical opportunity to provide relief payments related to energy expenditures and to invest in more efficient residential[@RecoveringFastSlow2020a] and commercial energy infrastructure that enables newer and cleaner systems[@chapmanImpactsCOVID19Transitioning2020]. US households are already spending excessive amounts on energy, especially with more families staying at home for longer periods of time. The ongoing crisis offers a chance to address the lack of infrastructure and employment opportunities with a focus on residential energy burdens[@graffCOVID19AssistanceNeeds2020a].

Even for energy assistance programs that do exist, many households reliant on inefficient fuels such as kerosene for heating must pay upfront costs to fill a tank for the winter season. These subsidy programs are largely ineffective as the cost of kerosene can be expensive, and pressure remains on households to offset existing gaps. Better opportunities to convert to alternative fuels would also provide households the opportunity to take advantage of the efficiency gains in better technology. In this way, broader programs need to be designed to provide households more options.

This relevance especially holds for electricity because it is a commodity delivered via a stationary, centralized grid system. Even in organized markets, local utilities retain control of the transmission and distribution systems. Households retain little control over their own energy choices. Consumers are price takers with relatively inelastic demand. Changes in the unit price of energy or slight differences in consumption patterns matter more to those with low incomes than those with higher incomes. Furthermore, the current lack of storage infrastructure on the grid and behind each meter means that households are bound to electricity providers for the time of use. The "forward-looking" or "reactive" tendencies of these public electric utilities have implications for the energy transition in their jurisdictions and beyond[@wolakFutureElectricityRetailing2020].

# Conclusion  {#conclusion}

Policymakers have not systematically deployed interventions based on net energy analysis across American households. Creating a federal energy poverty line would be a critical step in identifying families that face large disparities in access to affordable electricity and energy in the United States and improve programs’ abilities to address energy burdens. A toolkit based on this analysis enables neighborhood-level outreach where energy burdens are highest.  

Furthermore, this type of dataset can identify opportunities where households could benefit from emerging technologies that have disproportionately benefited wealthy families. We demonstrate that owning a home and consuming solar power is associated with increased income multipliers for energy expenditures. This advantage leads to gains that are not being realized by many neglected or oppressed communities. 

Energy burden also overlaps with health disparities and environmental justice efforts. Households living in more poverty and closer proximity to highly polluted areas must consume more energy to overcome the particulate emissions. There are clear, mutually synergistic, positive reinforcement mechanisms to alleviate health and environmental disparities in air pollution exposure by reducing household energy burdens and improving economic mobility across low-income households. 

Net energy income is holding back socioeconomic mobility in the US Renters of multi-family apartments earn half as much as owners of single-family homes when normalized by energy expenditures.`r to_insert="[Add more with demographic data once have queries for this: e.g., Households in communities of color experience energy poverty at ?x the average rate]. "` The inherent benefits of solar electricity must be accessible to all populations in the United States to promote sustainability, but barriers such as high capital investment, lack of financing, and inability to take advantage of existing business models continue to hold back communities of color from receiving a similar benefit to white and wealthier households. Net energy metrics exhibit this income multiplier effect and the resulting divide. Designing solar policies to benefit those facing low net energy ratios will substantially improve net energy income ratios and raise households out of energy poverty in the United States. 

However, concerted attention to technology and policy details matter to implement a national scheme. The data demonstrate a need for quantitative methodologies to support equitable energy infrastructure investments. 

# Methods  {#methods}

## Data  {#data}
To estimate the Net Energy Income Ratio of American households, we primarily utilize the Low Income Energy Affordability Data (LEAD)[@maLowIncomeEnergyAffordability2019] and Rooftop Energy Potential of Low-Income Communities in America (REPLICA)[@sigrinRooftopSolarTechnical2018] datasets, which the US Department of Energy assembled to help “stakeholders make data-driven decisions on energy goal setting and program planning by providing them information on low-income household populations and associated energy use characteristics”[@maLowIncomeEnergyAffordability2019]. These datasets encompass estimates of household energy consumption, income, solar generation potential, and demographic characteristic for all states and most territories in the United States at the census tract scale.  

LEAD: The Low-Income Energy Affordability Data (LEAD) portrays the average income, electricity expenditures, gas expenditures, and other fuel expenditures for cohorts of households segmented by location (census tract, county, state) and household characteristics (whether the unit is rented or owned, the building’s year of first construction, the number of units in the building, whether the units are attached, and the unit’s primary heating fuel type). The dataset is assembled by applying an iterative proportional fitting (IPF) algorithm to cross-tabulations of household responses from the 2016 5-year American Community Survey (conducted by the US Census Bureau), which provides the samples for each cohort as Public Use Microdata Samples. IPF is a widely used spatial microsimulation method to allocate individuals (i.e., households) to zones (i.e., census tracts and utility service territories) while calibrating each zone's characteristics to known quantities. Using IPF, the microdata samples are scaled to match aggregate annual values from utility sales and revenues reported in Energy Information Administration forms 861 and 176.

REPLICA: The Renewable Energy Potential of Low-Income Communities in America (REPLICA) dataset adds the technical potential of rooftop solar and additional techno-economic variables (e.g., demographics and electricity rates) used in the ultimate analysis[@sigrinRooftopSolarTechnical2018]. 

eGRID: We use the Environmental Protection Agency's (EPA) Emissions & Generation Resource Integrated Database (eGRID)[@usepaEmissionsGenerationResource2020] to calculate the proportion of household energy expenditures that support fossil fuel combustion through the purchase of electricity. 100% of natural gas purchases are considered to support fossil fuel combustion. Electricity purchases are divided into their respective sources according to the state proportions indicated by the "STCLPR" (coal), "STOLPR" (oil), "STGSPR" (gas), and "STOFPR" (other fossil) fields in the 2018 eGRID dataset. Other expenditures are divided according to the primary heating fuels other than electricity or natural gas used by American households according to the Census, which are approximately `r scales::percent(pct_other_fossil, accuracy=1)` fossil fuel combustion.

## Treatment  {#treatment}
The LEAD data represents the unit’s ownership status (OWNER vs. RENTER) and income bracket as a fraction of Area Median Income (0-30%, 30-60%, 60-80%, 80-100%, or 100%+) or Federal Poverty Level (0-100%, 100-150%, etc.). These categorical variables are saved as factors. Then we create min_units from BLD INDEX. The variable BLD INDEX represents a non-uniformly distributed set of buckets for the range of the number of units in the building, and whether single-unit households are attached or detached from neighboring households. We extract the minimum number of units from the range and whether the building is detached. Those households labeled OTHER UNIT are given values of Not Applicable (NA) for this characteristic. Finally, we create Energy Burden Indicators by creating the metrics s & g of which each indicator is composed: 

s = annual expenditures on electricity (ELEP CAL) + natural gas (GASP CAL) + and other fuels (FULP)  

g = the cohort’s average annual income (HINCP) 

The metric formulas outlined in Section \ref{ratios} are then used to calculate each cohort’s energy poverty metrics. Since we are examining homes’ relationships with the energy system, we ignore any homes that do not use energy as denoted by rows where s==0. The estimation procedure used by the DOE results in an estimated number of occupied housing units meeting the subset characteristics (UNITS, renamed as households). It displays the number of American Community Survey responses that contribute to the estimate of energy expenditures (COUNT, renamed as acs_responses). We then remove any categories with fewer than 1 unit represented since this is not physically possible. `r removed_households = "This results in removing X% of the available rows (gross: X rows of X). This is a total of X housing units or X% of the estimated total X units in the sample. We have separated any cohorts with incomes or energy costs equal to 0 into another dataset for analysis. This represents approximately X% of the housing units and X% of the examined cohorts, so it will be important to make sure that this subset does not contain systematic bias. However, these data are excluded from the current analysis under the assumption that energy costs equal to 0 are not relevant to this analysis."`

We then combine this dataset with the REPLICA dataset. To do so, we must aggregate the income levels of the LEAD dataset to the simpler schema used by REPLICA for summarizing households’ income relative to the area’s median income (AMI):

- 0-30% AMI: Very Low Income
- 30-80% AMI: Low-to-Moderate Income
- \>=80% AMI: Middle-to-High Income

Also, we create an indicator of whether a particular cohort is in income poverty as defined by the relevant standards for its characteristics. For the AMI data, this is defined as being “Very Low Income” or <=30% of AMI. For the Federal Poverty Line (FPL) version of the LEAD dataset, we translate directly from the designation of the income bracket as follows:

- 0-100% FPL: In Poverty
- \>= 100% FPL: Not In Poverty

The REPLICA dataset also simplifies any households with only one unit per building into “Single Family” homes and any households with more than one unit per building as “Multi-family.” Non-stationary and non-traditional homes are not included in the REPLICA analysis. We match these simplifications in the LEAD dataset by aggregating by the number of units:

- 1 Unit: Single-Family
- \>1 Unit: Multi-Family
- Other Unit: NA (excluded from analysis)

After simplifying these characteristics in the LEAD Area Median Income data, we merge the AMI dataset with the REPLICA dataset along the census tract, simplified income bracket, simplified number of units, and housing tenure to achieve the primary dataset used in the analysis. Merging with the REPLICA dataset provides additional demographic and geospatial data not available in the LEAD dataset only[@sigrinRooftopSolarTechnical2018]. Characteristics such as the utility type and locale description are sourced from REPLICA and unavailable in LEAD. Similarly, the REPLICA dataset contains only electrical expenditure estimates without natural gas or other fuel costs to households and could not be used to perform this analysis alone.

The FPL dataset The FPL version of the LEAD dataset is not merged with all of the REPLICA data because of incompatibility between the poverty line and area median income bracket definitions. However, demographic data associated with each census tract as a whole can be merged with the FPL dataset. Both AMI and FPL datasets are combined with demographic data from the REPLICA dataset and geospatial shapefiles from the Census to produce the final datasets used in the analysis.

## Considerations  {#considerations}
Iterative proportional fitting has limitations as an estimation procedure that constrain the strength of conclusions that can be drawn from the simulated LEAD and REPLICA datasets. The relationship between constraint variables such as total energy spending by utility service territory and number of households per census tract will tend toward the average of the initializing dataset and depress variations among otherwise similar regions. This may explain the large quantities of households that are estimated to have very low incomes. Validating these estimated data would require randomized surveys of households along the dimensions of interest.


The meaning of the “primary heating fuel” category comes from the answer to the question “Which fuel is used most for heating this house, apartment, or mobile home?” on the American Community Survey. This question’s power to predict energy expenditures or fuel sources is unknown, and further analysis is required to understand the implications of this survey question for drawing broader conclusions about household energy use. However, the US Census Bureau has been asking this question since 1940. It states that these data are collected to help communities "provide assistance with utilities", "estimate future energy demand", and "measure environmental impacts"[@bureauWhyWeAsk].

Though the REPLICA dataset relies on a different vintage of the LEAD dataset (assembled in 2017[@sigrinRooftopSolarTechnical2018]) than this analysis (assembled in 2019[@maLowIncomeEnergyAffordability2019]), inferring differences among annual estimates is not meaningful due to the standard error of the data [@maLowIncomeEnergyAffordability2019]. A rigorous treatment of these metrics over time is an area for future research.

The results inferred from eGRID are only as good as the eGRID methodology itself. We choose to outline the proportion of combusted fuels rather than emissions data due to the limitations outlined by proponents of marginal emissions attribution in electric power system models[@vonwaldAnalyzingCaliforniaFramework2020] [@siler-evansMarginalEmissionsFactors2012] and limitations in estimating regional electricity transfers[@vonwaldAccountingGreenhouseGas2021].

Expanding quantitative analysis of energy affordability can offer additional context, including the use of ratios to identify populations that could be particularly vulnerable to energy shocks or absolute energy burdens. Developing such metrics can elucidate the scale on which American households must save for energy consumption. Frequently used metrics in this category do not tell the whole story. For instance, the simple proportion of a household’s income spent on energy bills (a.k.a. energy burden) does not capture the underlying monthly cash flow patterns that may stress household budgets. More significantly, a simple proportion does not account for the fact that money spent on energy cannot be spent elsewhere and is therefore not useful income to the household for the purposes of measuring prosperity. Including gross income in the energy burden metric has the effect of depressing the average energy burden, by definition.

Furthermore, because energy expenditures are a small proportion of even the most impoverished households' total income, energy burdens are almost always very small percentages (<10%). This leads to issues with interpretability in public discourse and policy settings and may even affect program outcomes that are based on this metric if these small numbers are rounded to even the nearest hundredth of a percent.  If the household is above an energy poverty line defined by such a metric for public policy purposes, the family may not receive critical support, or energy may be sidelined by other basic needs. Because such a small proportion of expenditures can impact different income groups so differently, ratios of this type can be a useful metric when separating across income quantiles or other categories - particularly for vulnerable populations where the absolute energy burden poses a significant difficulty or affordability threshold. However, energy burden is typically portrayed at a population scale (e.g., the average energy burden of the population is X%). Household metrics and surveys are important for further understanding of and policy development around issues of energy burden. Finally, presenting the relationship between household income and energy expenditures as a proportion with income in the denominator suggests that improvements can only be made by decreasing energy expenditures or increasing incomes. However, in reality, there is a positive relationship between energy expenditures and incomes because energy is an input in wealth-creating processes, and the unit costs of energy decrease as absolute consumption increases. Therefore, stakeholders relying solely on energy burden have limited knowledge of which historical interventions have effectively promoted the energy system's success and a limited ability to design new interventions to promote community growth and address inequity in the energy system.

Net energy analysis (NEA) offers potential support to understanding energy poverty through the use of formally defined Energy Return Ratios (ERR's) that articulate the relationship between the energy flows within complex systems[@carbajales-daleBetterCurrencyInvesting2014]. The implications of numerous metrics of systems-scale efficiency and net energy returns have been explored through this lens to date[@brandtGeneralMathematicalFramework2011] and are recommended as a framework for future analysis[@carbajales-daleBetterCurrencyInvesting2014]. This research's primary insight into the energy burden conversation is to treat the income remaining after energy expenditures (i.e., net income) as the focus of analysis to avoid the double-counting of energy expenditures. Furthermore, net income is a result of energy consumption rather than the inverse: households consume energy to unlock the utility that energy services provide to them as participants in society, whether to cook food or connect to the internet. This relationship is generally accepted when understanding individual household behavior[@thomasEstimatingDirectIndirect2013] and macro-economic effects of energy consumption[@saundersKhazzoomBrookesPostulateNeoclassical1992]. Therefore, a metric describing the efficiency of household wealth creation may be more intuitive with net income in the numerator. These insights are incorporated into the new metric presented in this article. A final significant insight from net energy analysis that should be incorporated into future work is that embodied energy takes many forms across the household budget (food, goods, services, housing, etc.), and these can all be compared using the same units of measure (e.g., joules).

# Code Availability {#code-availability} 

The code and data to fully reproduce this paper are available on Github at [https://github.com/ericscheier/net_energy_equity](https://github.com/ericscheier/net_energy_equity) under the GNU Affero General Public License v3.0.

# Data Availability {#data-availability}

All data necessary for the composition of the source datasets used in this analysis are freely available from United States government sources as open data. All functions to automatically retrieve and assemble these data, and compiled versions of these data are made available to the user as part of the software referred to in Section \ref{code-availability}.

\newpage

\clearpage
\phantomsection


\addcontentsline{toc}{chapter}{REFERENCES}
\begin{center}
\normalfont \textbf{REFERENCES}
\vspace{17pt}
\end{center}

```{r eval=FALSE}
# \begin{center}
# 
# \section{REFERENCES}
# 
# \end{center}
```

::: {#refs}
:::

```{r eval=FALSE}
# # Works Not Yet Cited  {#uncited}
# 
# ---
# nocite: |
#   @*
# ...
# 
# # Software Used  {#software}
# 
# List of R packages used to be entered here automatically
# 
# # Acknowledgements  {#acknowledgements}
#
```

```{r}
# ## Author Contributions  {#author-contributions}
# 
# ES and NK conceived of and designed the project. ES created the software used for data acquisition and analysis and created the figures. NK contributed the introduction of the topic and interpretation of the results.
# 
# ## Competing Interests  {#competing-interests}
# 
# The authors declare no competing interests.

```


```{r eval=FALSE}
# 
# # Additional Information  {#additional-information}
# 
# # (APPENDIX) Appendix {-}  {#appendix}
# 
# # Charts for All Variables {#charts}
```

```{r eval=FALSE}
# ---Template / Style Examples After This---
# 
# # Introduction {#intro}
# 
# Your text comes here. Separate text sections with \cite{R-rmarkdown}. 
# 
# # Section title {#sec:1}
# 
# Text with citations by \cite{Galyardt14mmm}.
# 
# # References 1
# 
# 
# 
# ## Subsection title {#sec:2}
# 
# as required. Don't forget to give each section
# and subsection a unique label (see Sect. \ref{sec:1}).
# 
# #### Paragraph headings 
# 
# Use paragraph headings as needed.
# 
# \begin{align}
# a^2+b^2=c^2
# \end{align}
```

```{r, include = FALSE, eval=FALSE}
r_packages_used <- c("rmarkdown", "knitr")
knitr::write_bib(x = r_packages_used, file = "bibliography.bib")
```

```{r}
# 
# # Figure Legends
# 
# Figure \@ref(fig:metric-comparison) (`metric-comparison-1.pdf`): `r metric_comparison_fig_cap`
# 
# Figure \@ref(fig:continental-map) (`continental-map-1.pdf`): `r continental_map_fig_cap`
# 
# Figure \@ref(fig:inset-map) (`inset-map-1.pdf`): `r inset_map_fig_cap`
# 
# Figure \@ref(fig:density-charts) (`density-charts-1.pdf`): `r density_charts_fig_cap`
# 
# Figure \@ref(fig:state-violin) (`state-violin-1.pdf`): `r state_violin_fig_cap`
# 
# 
# # Tables
# 
# ```{r comparison-table-display, include=TRUE, results="asis"}
# final_table
# ```
```


```{r}
# merge data together
write.csv(x=clean_data_fpl,file="CohortData_FederalPovertyLine.csv")
write.csv(x=clean_data_ami,file="CohortData_AreaMedianIncome.csv")
write.csv(x=replica_sup,file="CensusTractData.csv")
# save as csv

```


<!--chapter:end:net_energy_equity_unc_thesis.Rmd-->

---
title: "A measurement strategy to address disparities across household energy burdens"
author: "Eric Scheier & Noah Kittner"
institute: 
  - "PLAN 574"
  - "This Presentation Was Created On:"
date: "`r format(Sys.time(), '%Y-%B-%d')`"
output: 
  beamer_presentation:
    slide_level: 1
    toc: false #true
    theme: "Berkeley"
    colortheme: "seagull"
    fonttheme: "structurebold"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{makecell}
  - \setbeameroption{show notes} #{show/hide notes}
  - \setbeamerfont{note page}{size=\tiny} 
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)

# make this dynamic to most recent 
version_path <- "net_energy_equity_final_review20211217200747_files"

knitr::opts_chunk$set(echo=FALSE)
```

# New Data

Low-Income Energy Affordability Data (LEAD)

**Purpose**: "to help state and local partners understand housing and energy characteristics for the low- and moderate-income (LMI) communities they serve"

  + **Source**: U.S. Department of Energy
  + **Method**: Iterative Proportional Fitting (IPF) of responses from the 5-year American Community Survey (ACS-5)
  + **Geography**: Census tracts for 50 states, D.C., & P.R.
  + **Provides**: Incomes and Energy Costs by Housing Characteristics
  + **Years**: 2016, 2018

\note{
Distinct urban and rural analyses have been performed to describe energy inequity in the US. While limited by geographic and demographic focus and a lack of peer-review, these studies have established the proportion of income (G) spent on energy expenditures (S), or energy burden (Eb), as the standard benchmark for energy poverty in the US today (Equation 1). The US Department of Energy (DOE) significantly improved upon previous methodology by assembling its Low-Income Energy Affordability Dataset (LEAD), which estimates incomes and energy expenditures for most households in the US at a census tract scale.
}

# Energy Burden & Net Energy Return

\[G = Gross\ Income\ ;\ S = Spending\ on\ Energy\]
\[
Energy\ Burden\ (E_{b})= \frac{S}{G}
\]
\[
Household\ Net\ Energy\ Return\ (N_{h}) = \frac{G - S}{S}
\]
\[E_{B}^{*} = \frac{S}{G} = 6\%\ ;\ N_{h}^{*} \approx 16 \Rightarrow Household\ at\ Energy\ Poverty\ Line\]

```{r load-table-full, include=FALSE}
print_table <- read_csv("comparison_table.csv")
```

```{r table-full, results="asis"}
print_table %>%  knitr::kable(booktabs=T, escape = F) %>%
  kable_styling(latex_options="scale_down")
  #kableExtra::kable_styling(latex_options = c("striped","hold_position"))
```

\note{
While a variety of thresholds have been developed and explored, energy-poor households in the US are commonly defined in terms of Eb as those with an expenditure of greater than 6\% of household income on energy.

While a helpful place to start, EB has certain drawbacks. A simple proportion does not account for the fact that money spent on energy cannot be spent elsewhere and is therefore not useful income to the household for the purposes of measuring prosperity, effectively depressing the average EB, by definition.

Energy expenditures are a small proportion of even the most impoverished households’ total income, Eb is almost always a very small percentage (<10\%). This leads to issues with interpretability in public discourse and policy settings and may even affect program outcomes that are based on Eb if small numbers are rounded to even the nearest hundredth of a percent. If the household is above an energy poverty line defined by such a metric for public policy purposes, the family may not receive critical support.

Ratios of this type can be useful when delineating across income quantiles or other categories - particularly for vulnerable populations where energy poverty poses a significant difficulty or affordability threshold not captured by measures of absolute poverty. However, Eb is often portrayed at a population scale, which can be skewed by outliers within the population.

Finally, presenting the relationship between household income and energy expenditures as a proportion with income in the denominator suggests that improvements can only be made by decreasing energy expenditures or increasing incomes. However, in reality, there is a positive relationship between energy expenditures and incomes because energy is an input to wealth-creating processes. Households consume energy to unlock the utility that energy services provide to them as participants in society, whether to cook food or connect to the internet. Therefore, a metric describing the efficiency of household wealth creation may be more intuitive with income in the numerator.

Net Energy Return, which describes the newly released potential to do work as a result of some activity, is recommended as a basis for future analysis, especially in the study of macro-energy systems like the US residential housing stock. The main contribution of the study is the application of NER as an indicator of household energy poverty.

Translated into its relative level for Net Energy Return, the 6\% energy poverty line is approximately 16. This means that a household that earns less than approximately \$16 of income for every dollar it spends on secondary energy.
}

# Geography

```{r pressure, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/continental-map-1.pdf",sep="/"))
```

\note{
Another contribution of this work is that by using Nh, we can display these data spatially across the US to
explore how different communities are experiencing energy outcomes as in Figure 2 and investigate specific
communities at multiple scales such as census tract, county, state, and regional as in Figure 3. This figure shows a spatial display of energy poverty that includes 5.3 million more households that would not be captured by traditional poverty metrics because their incomes are too low (Eb>100\%) or too high (above the FPL). By processing disparate data sources into a coherent structure and providing a convenient open-source tool for others to do the same, these data can be used in urban planning, public policy, and other relevant contexts. Displayed geospatially in Figure 2, the Black Belt in the American Southeast is visibly perceptible as an area of high burden, indicating that low-Nh follows racial lines. Likewise, border populations and immigrant populated areas in the Southwest have higher burdens, as do Native American lands. High burdens can also be seen in rural Northeast states where heating burdens are high. Nh allows a nuanced view of these widely ranging income dynamics by portraying them on a scale that matches the scope of the issues: areas of high energy burden (close to Nh=0) are visible in orange while highly affluent areas are also visually perceptible as dark blue even though these groups’ average metrics are multiple orders of magnitude apart.
}

# Urban Scale

```{r, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/inset-map-1.pdf",sep="/"))
```

\note{
Urban inequity results in lower Nh populations not showing up in many dense or gentrified urban areas such
as the San Francisco Bay Area, New York City, and New Orleans, as shown in Figure 3. The pervasiveness
of urban energy poverty in Detroit has been studied extensively and shown to have distinct geographic
boundaries down to the street level19. While some of these conclusions are supported by existing evidence
and literature, they should be confirmed with a rigorous analysis of this dataset using the Nh metric for the
reasons explained in Applying NER to Energy Equity: extremely low-income households are not visible on a
0-100\% scale, and households with no income are often discarded as outliers. Additional analyses should
incorporate additional demographic and household dimensions due to potential disparities within census
tracts since diverse neighborhoods may not be represented accurately by aggregate census tract metrics.
}

# Household Breakdowns

```{r breakdowns, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/density-charts-1.pdf",sep="/"))
```

\note{
From this high level, we can see in Figure 4.a that approximately 16\% of households in the US experience energy poverty.

Displaying these communities defined by their relationship to the US Federal Poverty Line
(FPL), which indicates income poverty status according to government policy, in Figure 4.b provides a stark picture. While 94\% of households below the FPL also face energy poverty, more than 5.2 million of those households above the FPL face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap and the inadequacy of FPL as an indicator of energy poverty in particular. 

This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in Nh on the households’ energy investments is surprising.

Figure 4.c shows that households with solar as a primary heating fuel have a higher Nh (Nh=111) than those which rely on other fuel sources (Nh=33), even for households far below the energy poverty line: the average
Nh for energy-impoverished households utilizing solar power is 19, compared to 7 for those relying on any other fuel source. The slope of the Nh density lines in Figure 4.c indicates that these lower-income households seem to experience a different rate of return on Nh from the benefits of increased energy adoption than higher-income households. Why are certain households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households’ low consumption, meaning that the potential savings from implementing energy efficiency measures are lower than for high-income households.
}


# State Comparison by Fuel Composition

```{r states, fig.cap=""}
knitr::include_graphics(paste(version_path,"figure-latex/state-violin-1.pdf",sep="/"))
```

\note{
Assessing the Nhs among different states in Figure 5 presents a counterintuitive picture of how states address energy poverty and energy equity. Nh can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as
Connecticut (Nh=26) and Vermont (Nh=23), where 47\% and 30\% higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi (Nh=22) and Alabama (Nh=24), which have significant low-income populations
and low per-unit energy prices (22\% and 8\% lower than average, respectively"‘). Not only are households in these states falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in
Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood may suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on new metrics.

Although they are the states with the highest Nh, California (Nh=59) and Colorado (Nh=63) are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely,
this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation are a common thread among the top-performing states on an Nh basis, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure 5 shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high Nhs than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.
}

# Conclusions

+ 16% of households experience energy poverty as presently defined (>6% of household income on energy expenditures)
+ 94% of households below the federal poverty line also face energy poverty
+ More than 5.2m of those above the federal poverty line face this scarcity
+ Fossil fuel reliance does not lead to lower energy poverty rates at a state scale
+ Solar power is associated with decreased energy poverty at a household scale
+ Energy poverty presents an obstacle to decarbonization and wealth creation

# Conclusions

Energy expenditures in the US disproportionately burden those in:

+ Communities of color
+ Communities with limited education
+ Rural cold areas
+ Urban Centers

The United States should develop and implement a federal energy poverty line.


<!--chapter:end:PLAN574_slides.Rmd-->

---
title: "Power Safety Shutoffs"
output: html_document
date: "`r Sys.Date()`"
---

Ideas:

+ Who is more likely to experience a power safety shutoff
+ Weighting by time and severity of shutoffs
+ Use shapefile to cross reference with LEAD extrapolation, and HDI file


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo=FALSE,
  message=FALSE,
  warning=FALSE,
  include=FALSE
  )

library(tidyverse)
library(knitr)
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)

source("sources.R")
```

```{r}
metric_name="ner"
```


```{r load-data}
clean_data_ami_all <- read_csv("CohortData_AreaMedianIncome.csv")
clean_data_fpl_all <- read_csv("CohortData_FederalPovertyLine.csv")
replica_sup <- read_csv("CensusTractData.csv") #get_replica_supplemental_dataset()

census_tracts_shp <- get_tract_shapefiles(
    states="all",
    acs_version=acs_version,
    refresh=refresh,
    return_files=TRUE,
    all_from_list=unique(replica_sup$state_abbr)
  )

clean_data_ami_all_sup <- left_join(clean_data_ami_all, replica_sup, by=c("geoid"))
clean_data_fpl_all_sup <- left_join(clean_data_fpl_all, replica_sup, by=c("geo_id"="geoid"))

clean_data_ami_all_sup_shp <- st_sf(left_join(census_tracts_shp, clean_data_ami_all_sup, by=c("gisjoin")))
clean_data_fpl_all_sup_shp <- st_sf(left_join(census_tracts_shp, clean_data_fpl_all_sup, by=c("gisjoin")))
```

```{r}
require(sf)
psps <- sf::st_read("PGE_POSTSR2A_3-1-2022.gdb")
psps
```

```{r preprocessing}
clean_data_ami_all_sup_shp$neb <- clean_data_ami_all_sup_shp$ner^(-1)

clean_data_ami <- clean_data_ami_all_sup_shp %>%
                                  filter(
                                    # as.numeric(geoid) %in% psps$Tract
                                    company_na %in% c("Pacific Gas & Electric Co")
                                  )

neb_poverty_line <- 0.06

metric_name <- "neb"

# gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami_all,
#                                                     c("geoid"),
#                                                     metric_name),
#                            c("geoid"),
#                            metric_name,
#                            metric_cutoff_level=neb_poverty_line,
#                            upper_quantile_view = 1,
#                            lower_quantile_view=0)
# 
# gwm$metric_name <- metric_name
# 
# psps_ami <- st_sf(left_join(psps, gwm %>% mutate(Tract=as.numeric(as.character(geoid))), by=c("Tract")))

clean_data_ami_pge_sup_shp_psps <- st_sf(left_join(clean_data_ami %>% mutate(Tract=as.numeric(as.character(geoid))), st_drop_geometry(psps), by=c("Tract")))

clean_data_ami_pge_sup_shp_psps$has_psps <- !is.na(clean_data_ami_pge_sup_shp_psps$TotCustomer)
```


```{r}
ggplotRegression <- function (fit) {

require(ggplot2)

ggplot(fit$model, aes_string(x = names(fit$model)[2], y = names(fit$model)[1])) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                     "Intercept =",signif(fit$coef[[1]],5 ),
                     " Slope =",signif(fit$coef[[2]], 5),
                     " P =",signif(summary(fit)$coef[2,4], 5)))
}
```


```{r}
ggplotRegression(lm(has_psps~neb, data = clean_data_ami_pge_sup_shp_psps, weights = households))
```

```{r}
make_all_charts(
  clean_data=psps_map_data, 
  metric_name="ner", 
  group_columns=c("geo_id"),
  metric_cutoff_level = ner_func(1,0.6)
)[["density"]]
```

```{r}
summary(glm(has_psps~neb, data = clean_data_ami_pge_sup_shp_psps, weights = households))
```







<!--chapter:end:psps.Rmd-->

---
title: "A measurement strategy to address disparities across household energy burdens"
author: ""
institute: 
  - "Focus: Sonoma Clean Power"
  - "These Slides Were Created On:"
date: "`r format(Sys.time(), '%Y-%B-%d')`"
output: 
  beamer_presentation:
    slide_level: 1
    toc: false #true
    theme: "Berkeley"
    colortheme: "seagull"
    fonttheme: "structurebold"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{makecell}
  - \setbeameroption{hide notes} #{show/hide notes}
  - \setbeamerfont{note page}{size=\tiny} 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo=FALSE,
  message=FALSE,
  warning=FALSE
  )

library(tidyverse)
library(knitr)
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)

states <- "all" #c("ca","nc","sc") #
refresh <- FALSE
acs_version <- 2018
energy_burden_poverty_line <- 0.06
metric_name <- "energy_burden"
# geographic_scope <- "tract" #statecitycounty

source("sources.R")
```


```{r preprocessing, include=FALSE}
clean_data_ami_all <- read_csv("CohortData_AreaMedianIncome.csv")
clean_data_fpl_all <- read_csv("CohortData_FederalPovertyLine.csv")
replica_sup <- read_csv("CensusTractData.csv") #get_replica_supplemental_dataset()

clean_data_ami <- left_join(clean_data_ami_all, 
                            replica_sup[,c("geoid","company_na","county_name")], 
                            by=c("geoid")) %>%
                                  filter(state_abbr=="CA", 
                                         county_name %in% 
                                           c("Sonoma County",
                                             "Mendocino County"),
                                         company_na %in% c("Pacific Gas & Electric Co",
                                                           "Trinity Public Utilities District")
                                         )

clean_data_fpl <- left_join(clean_data_fpl_all, 
                            replica_sup[,c("geoid","company_na","county_name")], 
                            by=c("geo_id"="geoid")) %>%
                                  filter(state_abbr=="CA", 
                                         county_name %in% 
                                           c("Sonoma County",
                                             "Mendocino County"),
                                         company_na %in% c("Pacific Gas & Electric Co",
                                                           "Trinity Public Utilities District")
                                         )

# this is where geospatial and other filtering should happen

## define territory 
## define zoom scope/area - if NULL, use the most populous scale below the territory scale (e.g. largest city in the county)

source("paper_source.R")
# tract_file_name <- paste0("data/",paste(states,collapse="_",sep=""),"_census_tracts.geojson")

census_tracts_shp <- get_tract_shapefiles(
    states=states,
    acs_version=acs_version,
    refresh=refresh,
    return_files=TRUE,
    all_from_list=unique(replica_sup$state_abbr)
  )

tract_shp <- st_sf(left_join(census_tracts_shp, replica_sup, by=c("gisjoin")))

continental_shp <- tract_shp %>% filter(!(state_abbr %in% c("HI","AK", NA)))

state_shp <- tract_shp %>% filter(state_abbr=="CA")

county_shp <- state_shp %>% filter(county_name %in% c("Sonoma County", "Mendocino County"))

grid_operator_shp <- tract_shp %>% filter(company_na=="Pacific Gas & Electric Co")

territory_shp <- tract_shp %>% filter(state_abbr=="CA", 
                                         county_name %in% 
                                           c("Sonoma County",
                                             "Mendocino County"),
                                         company_na %in% c("Pacific Gas & Electric Co",
                                                           "Trinity Public Utilities District")
                                         )

group_variable <- "geoid"# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #


# add utility cutout
# utility_shp <- tract_shp %>% filter(company_na=="")

# full_map_data <- left_join(tract_shp, gwm, by=c("geoid"))

gwm <- calculate_weighted_metrics(filter_graph_data(clean_data_ami_all,
                                                    c("geoid"),
                                                    metric_name),
                           c("geoid"),
                           metric_name,
                           metric_cutoff_level=0,
                           upper_quantile_view = 1,
                           lower_quantile_view=0)

gwm$metric_name <- metric_name

territory_map_data <- left_join(territory_shp, gwm, by=c("geoid"))
state_map_data <- left_join(state_shp, gwm, by=c("geoid"))
county_map_data <- left_join(county_shp, gwm, by=c("geoid"))
continental_map_data <- left_join(continental_shp, gwm, by=c("geoid"))
grid_operator_map_data <- left_join(grid_operator_shp, gwm, by=c("geoid"))


knitr::opts_chunk$set(echo=FALSE)
```

# Continental US Scale

```{r pressure, fig.cap=""}
clean_top_metrics <- grouped_weighted_metrics(filter_graph_data(clean_data_ami_all, 
                                                                group_columns=NULL,
                                                                metric_name),# %>% 
                                                #filter(!(state_abbr %in% c("HI","AK", NA))), 
                         group_columns=NULL, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=.995, 
                         lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=continental_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens in the Continental United States"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = TRUE,
    metric_long_name = bquote(E[b]),
    include_borders=TRUE,
    border_field="state_fips",
    legend_position="right", #c(0.15, 0.125),
    legend_direction="vertical",
    flip_scale=TRUE
)
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             E[b]
                                             )~": Energy Burden")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```


# State Scale

```{r, fig.cap=""}
choropleth_chart <- choropleth_map(
    clean_data=state_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens in California"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = FALSE,
    # legend_position=c(0.25, 0.125),
    metric_long_name = bquote(E[b]),
    include_borders=TRUE,
    border_field="county_fips",
    legend_position="right", #c(0.15, 0.125),
    legend_direction="vertical",
    flip_scale=TRUE
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             E[b]
                                             )~": Energy Burden")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```

# County Scale

```{r}
# clean_top_metrics <- grouped_weighted_metrics(graph_data,# %>% 
#                                                 #filter(!(state_abbr %in% c("HI","AK", NA))), 
#                          group_columns=NULL, 
#                          metric_name, 
#                          metric_cutoff_level, 
#                          upper_quantile_view=.995, 
#                          lower_quantile_view=0.005)

choropleth_chart <- choropleth_map(
    clean_data=county_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view=.75,
    lower_quantile_view=.001,
    chart_title=paste0("Energy Burdens in Sonoma & Mendocino Counties"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = FALSE,
    include_compass = FALSE,
    legend_position=c(0.25, 0.125),
    metric_long_name = bquote(E[b]),
    include_borders=TRUE,
    border_field="tract_fips"
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             E[b]
                                             )~": Energy Burden")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```


# Service Territory Scale

```{r}
choropleth_chart <- choropleth_map(
    clean_data=territory_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens in SCP Service Territory"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    include_compass = FALSE,
    legend_position=c(0.30, 0.125),
    metric_long_name = bquote(E[b]),
    include_borders=TRUE,
    border_field="tract_fips"
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             E[b]
                                             )~": Energy Burden")
                                           ),
                    x = 1,
                    hjust = 1,
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```

```{r}
# Urban Scale

# zoom into Santa Rosa or similar metro area?
```


# Distrubution Grid Operator Scale

```{r}
# PG&E
choropleth_chart <- choropleth_map(
    clean_data=grid_operator_map_data,
    group_columns,
    metric_name,
    metric_label="%",
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title=paste0("Energy Burdens on PG&E Grid"),
    chart_subtitle=NULL,
    weighted_metrics=clean_top_metrics,
    include_basemap = TRUE,
    include_compass = FALSE,
    legend_position=c(0.30, 0.125),
    metric_long_name = bquote(N[h]),
    include_borders=TRUE,
    border_field="county_fips"
      ) 
  

# choropleth_chart

choropleth_chart_footnote <- gridExtra::grid.arrange(
  choropleth_chart,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             E[b]
                                             )~": Energy Burden")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```

# Data

Low-Income Energy Affordability Data (LEAD)

**Purpose**: "to help state and local partners understand housing and energy characteristics for the low- and moderate-income (LMI) communities they serve"

  + **Source**: U.S. Department of Energy
  + **Method**: Iterative Proportional Fitting (IPF) of responses from the 5-year American Community Survey (ACS-5)
  + **Geography**: Census tracts for 50 states, D.C., & P.R.
  + **Provides**: Incomes and Energy Costs by Housing Characteristics
  + **Years**: 2016, 2018

\note{
Distinct urban and rural analyses have been performed to describe energy inequity in the US. While limited by geographic and demographic focus and a lack of peer-review, these studies have established the proportion of income (G) spent on energy expenditures (S), or energy burden (Eb), as the standard benchmark for energy poverty in the US today (Equation 1). The US Department of Energy (DOE) significantly improved upon previous methodology by assembling its Low-Income Energy Affordability Dataset (LEAD), which estimates incomes and energy expenditures for most households in the US at a census tract scale.
}

# Theory

\[G = Gross\ Income\ ;\ S = Spending\ on\ Energy\]
\[
Energy\ Burden\ (E_{b})= \frac{S}{G}
\]
\[
Household\ Net\ Energy\ Return\ (N_{h}) = \frac{G - S}{S}
\]
\[E_{B}^{*} = \frac{S}{G} = 6\%\ ;\ N_{h}^{*} \approx 16 \Rightarrow Household\ at\ Energy\ Poverty\ Line\]

```{r load-table-full, include=FALSE}
compare_table <- create_comparison_table(
    metrics_to_compare=NULL,
    input_dataset=clean_data_ami_all,
    include_totals=TRUE
)
```

```{r table-full, results="asis"}
create_printable_comparison_table(compare_table) %>%  knitr::kable(booktabs=T, escape = F) %>%
  kable_styling(latex_options="scale_down")
  #kableExtra::kable_styling(latex_options = c("striped","hold_position"))
```

# High Level

```{r}

calc_energy_poverty_rates <- function(
    input_dataset,
    metric_name,
    metric_cutoff_level
    ){
      fpl_top_metrics <- grouped_weighted_metrics(
        filter_graph_data(
          input_dataset, 
          group_columns="in_poverty", 
          metric_name),
        group_columns="in_poverty", 
        metric_name=metric_name, 
        metric_cutoff_level=metric_cutoff_level, 
        upper_quantile_view=1.00, 
        lower_quantile_view=0.00)
      
      total_households <- fpl_top_metrics$household_count
      
      number_in_poverty <- fpl_top_metrics$households_below_cutoff
      
      pct_in_poverty <- number_in_poverty / total_households
      
      pct_above_poverty <- 1 - pct_in_poverty
      
      in_both_poverty <- pct_in_poverty[2]
      
      in_only_energy_poverty <- pct_in_poverty[1]
      
      energy_poverty_rate <- sum(number_in_poverty) / sum(total_households)
      
      energy_poverty_rates <- list(
        total_households=total_households,
        number_in_poverty=number_in_poverty,
        pct_in_poverty=pct_in_poverty,
        pct_above_poverty=pct_above_poverty,
        in_both_poverty=in_both_poverty,
        in_only_energy_poverty=in_only_energy_poverty,
        energy_poverty_rate=energy_poverty_rate
      )
      
      return(energy_poverty_rates)
}
```


```{r}
all_ep_rates <- calc_energy_poverty_rates(
    input_dataset=clean_data_fpl_all,
    metric_name,
    metric_cutoff_level
    )

territory_ep_rates <- calc_energy_poverty_rates(
    input_dataset=clean_data_fpl,
    metric_name,
    metric_cutoff_level
    )

energy_poverty_rate <- all_ep_rates$energy_poverty_rate
territory_energy_poverty_rate <- territory_ep_rates$energy_poverty_rate

territory_energy_burden_poverty_line <- energy_burden_poverty_line

fpl_gap_households <- ifelse(
  all_ep_rates$number_in_poverty[1]>10^6,
  to_million(all_ep_rates$number_in_poverty[1]),
  to_big(all_ep_rates$number_in_poverty[1]))

territory_fpl_gap_households <- ifelse(
  territory_ep_rates$number_in_poverty[1]>10^6,
  to_million(territory_ep_rates$number_in_poverty[1]),
  to_big(territory_ep_rates$number_in_poverty[1]))
```

In SCP's service territory [the United States] -- `r scales::percent(territory_energy_poverty_rate, accuracy=1)` [`r scales::percent(energy_poverty_rate, accuracy=1)`] of households experience energy poverty as presently defined as spending more than `r to_percent(territory_energy_burden_poverty_line)` [`r to_percent(energy_burden_poverty_line)`] of household income on energy expenditures and more than `r territory_fpl_gap_households` [`r fpl_gap_households`] households above the Federal Poverty Line face energy poverty (`r to_percent(territory_ep_rates$in_only_energy_poverty)` [`r to_percent(all_ep_rates$in_only_energy_poverty)`] of this subset).

```{r territory-load-table-full, include=FALSE}
territory_compare_table <- create_comparison_table(
    metrics_to_compare=NULL,
    input_dataset=clean_data_ami,
    include_totals=TRUE
)
```

```{r territory-table-full, results="asis"}
create_printable_comparison_table(territory_compare_table) %>%  knitr::kable(booktabs=T, escape = F) %>%
  kable_styling(latex_options="scale_down")
  #kableExtra::kable_styling(latex_options = c("striped","hold_position"))
```

# Energy Burden Distribution in Service Territory

```{r}
top_line_group <- NULL

p1 <-   density_chart(graph_data, 
                                 metric_name, 
                                 metric_label=as.expression(
                                           bquote(~italic(
                                             N[h]
                                             ))
                                           ), 
                                 group_columns=top_line_group, 
                                 metric_cutoff_level, 
                                 metric_cutoff_label, 
                                 chart_title="Distribution of Energy Burdens", 
                                 chart_subtitle=NULL,
                                 x_label="Proportion of Households")
p1
```


# Household Breakdowns

```{r}
top_line_group <- "income_bracket"

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p2=top_line_charts[["density"]]
p2_stats=top_line_charts[["metrics"]]
```
\note{
`r p2_stats`
}

```{r}
top_line_group <- c("simplified_primary_heating_fuel")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p3=top_line_charts[["density"]]
p3_stats=top_line_charts[["metrics"]]
```
```{r}
top_line_group <- c("number_of_units")
# c("number_of_units", "occupancy_type"),
#                           c("occupancy_type", "income_bracket"),
#                           c("number_of_units", "occupancy_type", "income_bracket"),

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p4=top_line_charts[["density"]]
```


```{r}
top_line_group <- c("housing_tenure")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
p5=top_line_charts[["density"]]
p5_stats=top_line_charts[["metrics"]]
```


```{r}
minority_races <- c("hispanic","african_american","asian","native_american")
races <- c(minority_races,"caucasian")

pct_races <- replica_sup[,paste0("pop_",races)] / rowSums(replica_sup[,paste0("pop_",races)])
names(pct_races) <- paste0("pct_",races)

plurality_race <- races[max.col(pct_races,ties.method = "first")]

plurality_race <- ifelse(plurality_race=="african_american","black",
                                   ifelse(plurality_race=="native_american","indian",
                                          ifelse(plurality_race=="caucasian","white",
                                          plurality_race)))

race_data <- data.frame("geoid"=replica_sup$geoid,
                        "race"=plurality_race)

data_with_race <- inner_join(x=clean_data_ami, 
                             y=na.omit(race_data), by = "geoid")

top_line_group <- c("race")

top_line_charts <- make_all_charts(data_with_race,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p7=top_line_charts[["density"]]
p7_stats=top_line_charts[["metrics"]]
education_levels <- c("some_college_plus","high_school", "no_high_school")
```


```{r}
pct_education_levels <- replica_sup[,paste0("pop25_",education_levels)] / 
  rowSums(replica_sup[,paste0("pop25_",education_levels)])
names(pct_education_levels) <- paste0("pct_",education_levels)

plurality_education_level <- education_levels[max.col(pct_education_levels,ties.method = "first")]

plurality_education_level <- ifelse(plurality_education_level %in% 
                                      c("high_school","no_high_school"),
                                    "high school or less",
                                    ifelse(plurality_education_level=="some_college_plus",
                                           "college or more",
                                          plurality_education_level))

education_data <- data.frame("geoid"=replica_sup$geoid,
                        "simplified_education"=plurality_education_level)


top_line_group <- c("simplified_education")

top_line_charts <- make_all_charts(inner_join(x=clean_data_ami, y=na.omit(education_data), by = "geoid"),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p8=top_line_charts[["density"]]
p8_stats=top_line_charts[["metrics"]]
```


```{r breakdowns, fig.cap=""}
gt <- patchwork::patchworkGrob((p2+p3+p4)/(p5+p7+p8)  + 
                                 plot_layout(heights = c(1,1)) +
  plot_annotation(tag_levels = 'a') &
  theme(plot.tag = element_text(face = 'bold')))
# gridExtra::grid.arrange(gt, left = "Disp", bottom = "Hp // Cyl")
gt_all <- gridExtra::arrangeGrob(gt, 
                        top="Distribution of Energy Burdens Across Household Characteristics",
                        bottom="Proportion of Households",
                        left=grid.text(label=
                                         as.expression(
                                           bquote(~italic(
                                             N[h]
                                             ))
                                           ),
                                       draw=FALSE
                                       ))

gt_all_footnote <- gridExtra::grid.arrange(
  gt_all,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```

\note{
From this high level, we can see in Figure 4.a that approximately 16\% of households in the US experience energy poverty.

Displaying these communities defined by their relationship to the US Federal Poverty Line
(FPL), which indicates income poverty status according to government policy, in Figure 4.b provides a stark picture. While 94\% of households below the FPL also face energy poverty, more than 5.2 million of those households above the FPL face this scarcity, underscoring the relative burden of energy expenditures as a poverty trap and the inadequacy of FPL as an indicator of energy poverty in particular. 

This suggests that energy poverty may be a useful metric for identifying households at risk of other forms of poverty. However, we find that most households experiencing energy poverty are also suffering from a broader lack of access to resources characterized by income-based poverty. Given that the quality of energy used by low-income households is expected to be of similar inherent usefulness, this stark contrast in Nh on the households’ energy investments is surprising.

Figure 4.c shows that households with solar as a primary heating fuel have a higher Nh (Nh=111) than those which rely on other fuel sources (Nh=33), even for households far below the energy poverty line: the average
Nh for energy-impoverished households utilizing solar power is 19, compared to 7 for those relying on any other fuel source. The slope of the Nh density lines in Figure 4.c indicates that these lower-income households seem to experience a different rate of return on Nh from the benefits of increased energy adoption than higher-income households. Why are certain households not receiving the same benefits of their fuel source across the distribution of incomes? This could be due to lower-income households’ low consumption, meaning that the potential savings from implementing energy efficiency measures are lower than for high-income households.
}

# Confounding Characteristics

```{r}
top_line_group <- c("housing_tenure",
                    "number_of_units")

top_line_charts <- make_all_charts(clean_data_fpl %>% filter(!is.na(number_of_units)),
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
multifam_stats=top_line_charts
```

```{r}
top_line_group <- c("housing_tenure",
                    "income_bracket")

top_line_charts <- make_all_charts(clean_data_fpl,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            x_label="")
housing_income_stats=top_line_charts
```

```{r}
gt <- patchwork::patchworkGrob(multifam_stats[["density"]]+housing_income_stats[["density"]]  + 
                                 plot_layout(
                                   widths = c(1,1)) +
  plot_annotation(tag_levels = 'a') &
  theme(plot.tag = element_text(face = 'bold')))
# gridExtra::grid.arrange(gt, left = "Disp", bottom = "Hp // Cyl")
gt_all <- gridExtra::arrangeGrob(gt, 
                        top="Distribution of Energy Burdens Across Household Characteristics",
                        bottom="Proportion of Households",
                        left=grid.text(label=
                                         as.expression(
                                           bquote(~italic(
                                             N[h]
                                             ))
                                           ),
                                       draw=FALSE
                                       ))

gt_all_footnote <- gridExtra::grid.arrange(
  gt_all,
  bottom = textGrob(as.expression(
                                           bquote(~italic(
                                             N[h]
                                             )~": Household Net Energy Return")
                                           ), 
                    x = 1,
                    hjust = 1, 
                    gp = gpar(
                                  # fontface = 3L,
                                  fontsize = 9))
)
```

# Supplementary Stats

```{r}
p5_stats
```

```{r}
multifam_stats[["metrics"]]
```


# How do CCAs stack up?

```{r}
top_line_group <- c("simplified_utility_type")

top_line_charts <- make_all_charts(clean_data_ami_all,
                            group_columns=top_line_group,
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL,
                            x_label="")
p6=top_line_charts[["density"]]
p6
```

# State Comparison by Fuel Composition

```{r states, fig.cap=""}
group_columns <- c("state_abbr")
# utility type? see chartbook
graph_data <- filter_graph_data(clean_data=clean_data_ami_all[clean_data_ami_all$state_abbr!="DC",], 
                                group_columns=group_columns, 
                                metric_name=metric_name)

# percent of "other" fuel expenditures toward fossil fuel combustion
# want to make this more precise by state, county, and/or balancing authority eventually
other_gwm <- grouped_weighted_metrics(clean_data_fpl_all[clean_data_fpl_all$state_abbr!="DC",], 
                                      c("primary_heating_fuel"),
                                      "other_spend",
                                      0)

other_fuels <- c("COAL","FUEL OIL","NONE","OTHER","SOLAR","WOOD","BOTTLED GAS")
non_fossil_other_fuels <- c("NONE","SOLAR","WOOD")
fossil_other_fuels <- other_fuels[!(other_fuels %in% non_fossil_other_fuels)]

other_fossil <- other_gwm[other_gwm$primary_heating_fuel %in% fossil_other_fuels,
                              c("household_count","metric_mean")]

pct_other_fossil <- sum(other_fossil$household_count*other_fossil$metric_mean)/
  sum(other_gwm$household_count*other_gwm$metric_mean)

graph_data$pct_other_fossil <- pct_other_fossil

# percent of each state's electric grid decidated to fossil fuel combustion
# can refine by balancing authority based on REPLICA dataset
egrid <- get_state_egrid()

egrid$pct_electricity_fossil <- egrid$STCLPR + #coal
  egrid$STOLPR + #oil
  egrid$STGSPR + #gas
  egrid$STOFPR #+ #other fossil
  # egrid$STNCPR #+ #nuclear
  # egrid$STHYPR #+ #hydro
  # egrid$STOPPR #unknown/purchased

graph_data <- left_join(graph_data, egrid, by=c("state_fips"="FIPSST"))

# graph_data <- graph_data[graph_data$state_abbr!="DC",]

# percent of natural gas expenditures dedicateed to fossil fuel combustion...
pct_gas_fossil <- 1.0

graph_data$pct_gas_fossil <- pct_gas_fossil

graph_data$pct_fossil_tract <- (graph_data$pct_gas_fossil * graph_data$gas_spend + 
  graph_data$pct_electricity_fossil * graph_data$electricity_spend + 
  graph_data$pct_other_fossil * graph_data$other_spend) / 
  (graph_data$gas_spend + graph_data$electricity_spend + graph_data$other_spend)


pct_fossil_gwm <- grouped_weighted_metrics(graph_data, "state_fips","pct_fossil_tract",0) %>% 
  dplyr::rename(pct_fossil=metric_mean)

graph_data <- left_join(graph_data, 
                        pct_fossil_gwm[,c("state_fips","pct_fossil")], 
                        by="state_fips")

top_line_charts <- make_all_charts(graph_data,
                            group_columns="state_abbr",
                            metric_name,
                            metric_label="", 
                            metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            #upper_quantile_view,
                            #lower_quantile_view,
                            chart_title=NULL,
                            chart_subtitle=NULL,
                            chart_caption=NULL)

state_by_state <- top_line_charts[["metrics"]]

electricity_prices_summary <- calculate_weighted_metrics(graph_data, 
                                                         c("state_abbr"), 
                                                         "dlrs_kwh", 
                                                         metric_cutoff_level = 
                                                           ner_poverty_line)

x_label <- as.expression(bquote(~italic(N[h])~": Household Net Energy Return"))


y <- make_violin_chart(graph_data=graph_data,
                      group_columns=group_columns,
                      metric_name=metric_name,
                      metric_label=metric_label,
                      metric_cutoff_level=metric_cutoff_level,
                      fill_metric="pct_fossil",#"STCYPR",#"STSOPR",
                      fill_label="% of Energy Expenditures on \nFossil Fuel Combustion",#Combustion",#Solar",
                      group_name="State",
                      chart_title="Comparison of Energy Burdens Among the United States",
                      x_label=x_label)
print(y)
```

\note{
Assessing the Nhs among different states in Figure 5 presents a counterintuitive picture of how states address energy poverty and energy equity. Nh can equate communities that experience high energy costs and low incomes with those with high incomes and even higher energy costs. This explains why states such as
Connecticut (Nh=26) and Vermont (Nh=23), where 47\% and 30\% higher than average electricity prices may pose affordability threats for communities affected by higher prices, are similarly positioned on the list to states such as Mississippi (Nh=22) and Alabama (Nh=24), which have significant low-income populations
and low per-unit energy prices (22\% and 8\% lower than average, respectively"‘). Not only are households in these states falling behind in terms of income, but net incomes are lower relative to energy expenditures than neighboring states and other parts of the country. This may be appropriate: while the equity issues in
Southeastern states are well studied, states such as Maine that continue to utilize residential heating energy sources like oil and fuelwood may suffer not only from lack of efficiency but also health impacts. States may need to pay attention to these dynamics from an affordability perspective, and further targeted energy assistance may be needed based on new metrics.

Although they are the states with the highest Nh, California (Nh=59) and Colorado (Nh=63) are not immune to these problems and likely represent a greater spread and diversity of energy affordability impacts. Likely,
this diversity captures the benefits accrued by early adopters and the challenges of having high populations of those struggling with energy poverty and high housing costs. In many of these places, residents have self-sorted into geographic areas based on the overall costs of living. Also, advances in clean energy legislation are a common thread among the top-performing states on an Nh basis, signaling the value of strong decarbonization targets and accompanying policies to ensure electricity affordability for low-income households.

Visualizing the proportion of end-use energy sourced from the combustion of fossil fuels in Figure 5 shows that such reliance does not necessarily lead to a more affordable system for energy consumers. Households in states with a high proportion of fossil fuel are no less likely to have high Nhs than those in other states that rely on clean energy, defying the conventional wisdom that fossil fuel consumption is a chosen tradeoff between environmental health and affordability for citizens.
}

# Conclusions

+ 16% of households experience energy poverty as presently defined (>6% of household income on energy expenditures)
+ 94% of households below the federal poverty line also face energy poverty
+ More than 5.2m of those above the federal poverty line face this scarcity
+ Fossil fuel reliance does not lead to lower energy poverty rates at a state scale
+ Solar power is associated with decreased energy poverty at a household scale
+ Energy poverty presents an obstacle to decarbonization and wealth creation

# Conclusions

Energy expenditures in the US disproportionately burden those in:

+ Communities of color
+ Communities with limited education
+ Rural cold areas
+ Urban Centers

The United States should develop and implement a federal energy poverty line.


<!--chapter:end:scp_territory_slides.Rmd-->

---
title: Net energy metrics reveal striking disparities across United States household energy burdens
subtitle: 
titlerunning: Net Energy Equity
authorrunning: Scheier & Kittner
thanks:
author:
  - Eric Scheier:
      institute: e3p
  - name: Noah Kittner
    email: kittner@unc.edu
    institute: [gillings, e3p, planning]
    correspondence: true
institute:
  - e3p: Environment, Ecology, and Energy Program, The University of North Carolina at Chapel Hill
  - gillings: Department of Environmental Sciences and Engineering, The University of North Carolina at Chapel Hill
  - planning: Department of City and Regional Planning, The University of North Carolina at Chapel Hill
keywords:
  - energy burden
  - net energy
  - macro-energy systems
  - energy inequality
bibliography: references.bib
bibstyle: spphys
csl: nature-no-et-al.csl
journalname: Nature Energy
date: "`r format(Sys.time(), '%d %B %Y')`"
toc: false
output:
  bookdown::pdf_document2:
    keep_tex: true
    documentclass: article
    pandoc_args:
      - '--lua-filter=color-text.lua'
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
    header-includes:
      - \usepackage[left]{lineno}\linenumbers
  bookdown::html_document2: default
  bookdown::word_document2:
    keep_tex: true
    documentclass: article
    pandoc_args:
      - '--lua-filter=color-text.lua'
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
    header-includes:
      - \usepackage{setspace}\doublespacing
  bookdown::pdf_book:
    base_format: rticles::springer_article
    keep_tex: true
tables: true
fig_caption: true
header-includes:
- \usepackage{booktabs}
- \usepackage[left]{lineno}\linenumbers
- \usepackage{etoolbox}
- \pretocmd{\abstract}{\newpage}{}{}
- \usepackage{color}
- \usepackage{soul}
- \definecolor{lightblue}{rgb}{0.90, 0.95, 1}
- \definecolor{fancycolor}{rgb}{0.258, 0.517, 0.960}
- \sethlcolor{fancycolor}
---


---
abstract: | 
  Energy poverty in the United States is an issue of increasing urgency, exacerbated by rising inequality. Few policy-relevant datasets evaluate the energy burden of typical American households. Here, we develop a framework using net energy analysis and socioeconomic data at the census tract-level to observe systematic energy inequity across the United States among critical groups that heed policy attention.
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
edit_color="red"
```

Substantive edits based on peer-review are [red]{color=`r edit_color`}, with major standalone deletions denoted by [~~red strikethrough~~]{color=`r edit_color`}. Rearrangements of existing text order are not necessarily noted in this document.

[This text should be struck through]{strike="show"}

[[This text should be red and struck through]{strike="show"}]{color="red"}

[This text should not appear at all]{strike="hide"}

[This text should be highlighted]{highlight="TRUE"}

*N~h~*

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

(ref:metric-comparison-fig-cap) Display of the relationship between [E~b~]{color=`r edit_color`} and [N~h~]{color=`r edit_color`} with net income (gross income - energy expenditures) for US households.

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE, fig.cap='(ref:metric-comparison-fig-cap)'}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}
library(magrittr)
library(knitr)
library(kableExtra)
df <- data.frame(Parameter = c("NO\\textsubscript{x} emissions", "SO\\textsubscript{2} emissions", "CO\\textsubscript{2}     emissions"),
                 "Value mg/Nm\\textsuperscript{3}" = c("800\\%",900,1000),
                 check.names = F)

knitr::kable(df,escape = F, caption = 'Example table!',  booktabs = TRUE, format = "latex") %>% #
  row_spec(0, bold = T, color = "white", background = "#045a8d") %>%
  row_spec(c(2), bold = T, color = "white", background = "#3690c0")
```

blah blah

<!--chapter:end:test.Rmd-->

---
title: "Value of DER"
author: "Eric Scheier"
date: "`r Sys.Date()`"
output: html_document
---

# Technologies

## electric vehicles
## electric vehicle charging stations
## solar systems
### behind-the-meter
#### net metered
#### zero backfeed
### distribution-interconnected
### transmission-interconnected
## battery storage
### standalone
### paired with solar
### paired with [x]
## thermostats
## heat pump water heaters
## heat pump HVAC systems
## other smart home appliances
## energy efficiency measures


# Value Streams

## energy
## capacity
## ancillary services
## deferred upgrades
### distribution 
### transmission
## resilience
## subsidy
### programs
+ DSIRE
  https://www.dsireusa.org/resources/data-and-tools/
  http://programs.dsireusa.org/api/v1/getprograms/json
  http://virtuoso.dsireusa.org:8890/sparql
  https://www.w3.org/TR/sparql11-query/
### rate tariffs

# Technical Capacity

# Program Designs

# Deployment Scenarios

<!--chapter:end:value_of_der.Rmd-->

---
title: "Walkthrough"
author: "Eric Scheier"
date: "`r format(Sys.time(), '%Y-%B-%d')`"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
is_final=FALSE
is_preview=TRUE#
is_draft=TRUE
set.seed(123)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','markup')),
                      fig.keep='all',
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=TRUE,
                      fig.margin=FALSE,
                      fig.fullwidth = TRUE
                      )
```

All of the libraries and functions needed to download and munge the data and create the paper and figures are located in `sources.R`, so we must source this file first.

```{r sources}
source("sources.R")
```

We only need to define a few parameters to get things in motion:

+ `states`: which states we want to asses. In addition to defining a single state (e.g. `"nc"`), note that we can define multiple states (`c("nc","sc")`) or `"all"` states.
+ `refresh`: whether we want to gather the data fresh regardless of whether we already have some downloaded. This is especially useful in development, but in most cases you want `refresh=FALSE` to avoid recreating data you have already downloaded and munged.
+ `acs_version`: which end-year of the five year American Community Survey to pull data from. At the moment, only `2016` and `2018` are available.
+ `geographic_scope`: which geography to pull the data for. Note that while states, cities, and counties are also available for analysis, we only work with the census tract level for now.

```{r parameters}
states <- "nc" #c("ca","nc","sc") #"all"
refresh <- FALSE
acs_version <- 2018
geographic_scope <- "census tracts" #statecitycounty
```

With those methods defined we can perform the methods to support the paper. This function is the only logic contained in `methods.R`. If you already have data in a `/data` directory, you will want to make sure that the parent directory of `/data` is your working directory before running this function. If you have no `/data` directory, the `paper_methods()` function will create one and populate it accordingly.

The data used in this paper is available in 3 formats related to how the income brackets are framed. These are portrayed relative to:

+ The Federal Poverty Line (FPL)
+ Area Median Income (AMI)
+ State Median Income (SMI) [only available for 2018 ACS data]

This paper utilizes the framing relative to the Federal Poverty Level and that relative to Area Median Income, so the methods will run a loop to process each of these datasets. We also only utilize census tract data currently, so the `geographic_scope` parameter is not yet used in this function.

```{r run-methods, cache=FALSE}
paper_methods(states=states,
              acs_version=acs_version,
              refresh=refresh)
```

The full `paper_methods()` function can be found in `methods.R`, but to explain in more detail how this method works before moving on:


The methods rely heavily on the `get_multiple_states()` function and it, in turn, relies heavily on the `get_lead_dataset()` function. These are found in `lead_munging.R`, and the behavior of the `get_lead_dataset()` is portrayed below. `get_multiple_states()` is basically a wrapper around this function to enter the correct parameters based on the year of data being called upon, and loop over multiple states as needed. There are a few potential data munging steps that can be performed depending on how clean and in which format the data is desired, whether raw or to be merged with the REPLICA dataset. For demonstration, we will start by getting the raw dataset for a single state. Note that these can be rather large files and the function will download what it needs if it is not already in your `data/` directory.

```{r get-raw-lead-data}
raw_lead_data <- get_lead_dataset(state=states[1],
                             income_metric="AMI",
                             resource_id=NULL,
                             geographic_scope="Census Tracts",
                             all_resources=NULL,
                             refresh=FALSE,
                             load=TRUE,
                             save_format="raw",
                             load_format="raw",
                             save_ext="csv",
                             save=FALSE,
                             acs_version=2018
                             )
head(raw_lead_data)
```

Through the `raw_to_lead()` function, this data is munged into a slightly nicer looking format:

```{r clean-lead-data}
clean_lead_data <- raw_to_lead(raw_lead_data, acs_version = acs_version)
head(clean_lead_data)
```

And from here, we can convert this into the more aggregated format of the REPLICA dataset using `lead_to_replica()` found in `replica_munging.R`. The REPLICA format is useful because it simplifies the cohorts into fewer income brackets, fewer unit denominations, and dispenses with categories such as the age of the building and primary heating fuel. This does dispense with some categories as well, such as boats/RVs/vans and mobile trailers.


```{r replica-lead-data}
replica_lead_data <- lead_to_replica(clean_lead_data)
head(replica_lead_data)
```

This clean format is now more approachable than the raw LEAD format and can be merged with the REPLICA dataset to bring in technical data about rooftop solar potential for each cohort. Note that when generating clean datasets for analysis, we do not have to aggregate to the relatively extreme degree of the REPLICA dataset as we have with the AMI-denominated cohorts above. In fact, when treating the FPL dataset for analysis we leave the primary fuel type disaggregated while simplifying the remaining cohort characteristics.

Finally, we can calculate the relevant statistics for each cohort using basic arithmetic. The `energy_cost` is calculated in the methods function as `rowSum`s of `electricity_spend`, `gas_spend`, and `other_spend`. `s=energy_cost` and `g=income` are then used to calculate whichever metric is of interest as defined in `ratios.R`.

Ratios can be calculated using units of energy (`se`), if available, or as unitless ratios of income and expenditures. Only the latter is used in the current paper.

```{r}
energy_burden_func
```


```{r}
ner_func
```

This provides the final format of the data for use in the paper.

Now that we have run the methods and explained a bit about how they work at each major step of munging, we can load the clean datasets that have been generated. These are loaded as the following objects with the following meanings:

+ `clean_data_ami`: munged data with income brackets framed in terms of Area Median Income (AMI). Cohorts are defined by Income Bracket, Number of Units, and Housing Tenure for each census tract.
+ `clean_data_fpl`: munged data with income brackets framed in terms of the Federal Poverty Line (FPL). Cohorts are defined by Income Bracket, Primary Heating Fuel, Number of Units, and Housing Tenure for each census tract.
+ `replica_sup`: supplemental demographic and technical potential data for each census tract as aggregated by NREL for 2018.
+ `census_tracts_shp`: shapefiles for all the census tracts.

```{r load-data}
income_metric <- "AMI" #"AMI" #"fpl15" #

version_text <- as.character(acs_version)
if(acs_version==2016){
  version_text <- "sh"
}

base_file_name <- tolower(paste(income_metric,
                                geographic_scope,
                                version_text,
                                paste(states,collapse="_",sep=""), sep = "_"))

clean_data_ami <- read_csv(paste0("data/very_clean_data_",base_file_name,".csv"), guess_max = 10^6)
clean_data_ami$geo_id <- str_pad(as.character(clean_data_ami$geo_id), width=11, side="left", pad="0")

income_metric <- "FPL"
base_file_name <- tolower(paste(income_metric,
                                geographic_scope,
                                version_text,
                                paste(states,collapse="_",sep=""), sep = "_"))
clean_data_fpl <- read_csv(paste0("data/very_clean_data_",base_file_name,".csv"), guess_max = 10^6)
clean_data_fpl$geo_id <- str_pad(as.character(clean_data_fpl$geo_id), width=11, side="left", pad="0")

replica_sup <- get_replica_supplemental_dataset()
census_tracts_shp <- st_read("data/all_census_tracts.geojson")
```

Let's look at the `clean_data_ami` dataset, which reflect the steps we outlined above along with cleaning up the names.

```{r}
head(clean_data_ami)
```

To produce the density charts shown in the paper, we need to define which metric we want to view them in terms of (in this case: NER) and where to draw the energy poverty line.

```{r}
metric_name<-"ner"
metric_cutoff_level=9
```

Then, we preprocess the data using the `filter_graph_data()` (found in `helpers.R`) function to determine how many households are in each group that we want to portray and calculate how much weight each cohort should receive in the density graph. For the entire dataset, the group can be defined as `NULL`.

```{r cache=FALSE}
graph_data <- filter_graph_data(clean_data_ami, group_columns=NULL, metric_name="ner")
head(graph_data)
```

```{r}
head(graph_data[,c("households",
                   "group_households",
                   "group_household_weights",
                   "group_percentile",
                   "overall_percentile",
                   "group_name")])
```

We can then chart this data.

```{r cache=FALSE}
p1 <-   density_chart(graph_data=graph_data,
                      group_columns=NULL,
                       metric_name=metric_name,
                       metric_cutoff_level=metric_cutoff_level, 
                       metric_cutoff_label="Energy Poverty Line")
p1
```

To display groups, we simply define a non-null group variable.

```{r}
top_line_group <- "income_bracket"
graph_data <- filter_graph_data(clean_data_fpl,
                                group_columns=top_line_group,
                                metric_name=metric_name)

p2 <- density_chart(graph_data=graph_data, 
                               metric_name=metric_name, 
                               group_columns=top_line_group, 
                               metric_cutoff_level=metric_cutoff_level, 
                               metric_cutoff_label="Energy Poverty Line")
p2
```


We also can use the function `calculate_weighted_metrics()` (found in `helpers.R`) to show some statistics by group. The `metric_upper` and `metric_lower` stats are defined by the `upper_quantile_view` and `lower_quantile_view` paramters respectively.

```{r}
weighted_metrics <- calculate_weighted_metrics(graph_data=graph_data, 
                                               group_columns=top_line_group, 
                                               metric_name=metric_name, 
                                               metric_cutoff_level=metric_cutoff_level, 
                                               upper_quantile_view=0.25, 
                                               lower_quantile_view=0.75)
weighted_metrics
```

To define a group by more than one variable, simply use a vector of variable names. The `make_all_charts()` function performs the preprocessing using `filter_graph_data()` and calculates the summary statistics along with the potential for other graphs to be added.

```{r cache=FALSE}
top_line_group <- c("number_of_units", "housing_tenure")

top_line_charts <- make_all_charts(clean_data_ami,
                            group_columns=top_line_group,
                            metric_name=metric_name,
                            metric_cutoff_level=metric_cutoff_level,
                            metric_cutoff_label=NULL,
                            upper_quantile_view=0.75,
                            lower_quantile_view=0.25)
p4=top_line_charts[["density"]]
p4
```

```{r}
top_line_charts[["metrics"]]
```


Finally, we will show how the choropleths are made. First, let's calculate some demographic statistics based on the supplemental data that is provided from the REPLICA dataset:

```{r}
replica_sup$pct_african_american <- replica_sup$pop_african_american / replica_sup$pop_total

replica_sup$households <- (replica_sup$hu_own + replica_sup$hu_rent)

replica_sup$income_per_capita <- (replica_sup$hh_med_income * replica_sup$households) / replica_sup$pop_total

replica_sup$unemployment_rate <- replica_sup$p16_unempl / (replica_sup$p16_unempl + replica_sup$p16_employ)
```

Then, we join this demographic data to the census tract shapefiles:

```{r join_data}
tract_shp <- st_sf(left_join(census_tracts_shp, replica_sup, by=c("gisjoin")))
```

And then we redefine some variables that have been used in the charts above so far.

```{r chart_params}
#chart_title <- "Household Economic Return on Energy Spending"
chart_title <- "Median Net Energy Return"
chart_subtitle <- "Per Census Tract"

group_columns <- NULL #"income_bracket")#in_poverty
                   #"primary_heating_fuel"

metric_name <- "ner" #"energy_burden" #"ner" #"dear" #"eroi"
metric_label <- "$/$"
metric_cutoff_level <- 9
metric_cutoff_label <- "9"

upper_quantile_view <- 1.0
lower_quantile_view <- 0.0
```


To calculate the median NER per census tract, we use the `grouped_weighted_metrics()` function (found in `helpers.R`) and group by `geo_id`. The only difference between `grouped_weighted_metrics()` and `calculate_weighted_metrics()` is that the latter adds an `all` group to summarize the entire dataset, which we do not want for this purpose.

```{r grouped_weighted_metrics}
#data$GEOID <- sub('.', '', data$gisjoin)
group_columns <- c("geo_id") #c("gisjoin") #
graph_data <- filter_graph_data(clean_data_ami, group_columns, metric_name)

gwm <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.75, 
                         lower_quantile_view=0.25)
head(gwm)
```

For simplicity we just want to display the data for the state(s) we selected, so we filter our shapefiles to that area:

```{r select_area}
selection_shp <- tract_shp %>% dplyr::filter(state_abbr %in% toupper(states))

map_data <- left_join(selection_shp, gwm, by=c("geoid"="geo_id"))
```

We calculate the extent of the color scale for the choropleth using the grouped weighted metrics, for now.

```{r scale_extents}
clean_top_metrics <- grouped_weighted_metrics(graph_data, 
                         group_columns=NULL, 
                         metric_name=metric_name, 
                         metric_cutoff_level=metric_cutoff_level, 
                         upper_quantile_view=1, 
                         lower_quantile_view=0)
```


```{r continental_map, out.width="100%", fig.cap="Map of the median net earned income per secondary energy expenditure for each census tract in the continental United States."}
# figure_name <- "choropleth_map"
# figure_file <- paste0("figures/",figure_name,".png")
# if(!file.exists(figure_file) || refresh){
choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title,
    chart_subtitle,
    weighted_metrics=clean_top_metrics,
    include_basemap=FALSE)
  # ggsave(figure_file, plot=choropleth_chart)
# }
choropleth_chart
```

We can also display some of the demographic data calculated earlier in this fashion:

```{r}
#chart_title <- "Household Economic Return on Energy Spending"
chart_title <- "Percent African American"
chart_subtitle <- "Per Census Tract"

group_columns <- c("geoid") #"income_bracket")#in_poverty
                   #"primary_heating_fuel"

metric_name <- "pct_african_american" #"energy_burden" #"ner" #"dear" #"eroi"
metric_label <- "%"
metric_cutoff_level <- median(selection_shp$pct_african_american, na.rm = T)
metric_cutoff_label <- ""

upper_quantile_view <- 1.0
lower_quantile_view <- 0.0

graph_data <- filter_graph_data(selection_shp, group_columns, metric_name)

# gwm <- grouped_weighted_metrics(st_drop_geometry(graph_data),
#                          group_columns,
#                          metric_name,
#                          metric_cutoff_level,
#                          upper_quantile_view=1.0,#0.75,
#                          lower_quantile_view=0.0)#0.25)

gwm <- graph_data[,c("geoid", metric_name)]
gwm <- rename(gwm, metric_median = !!sym(metric_name))

map_data <- left_join(graph_data, st_drop_geometry(gwm), by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(replica_sup %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))),
                                              group_columns=NULL,
                                              metric_name,
                                              metric_cutoff_level,
                                              upper_quantile_view=1.0,
                                              lower_quantile_view=0.0)

choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title,
    chart_subtitle,
    weighted_metrics=clean_top_metrics,
    include_basemap=FALSE)
  # ggsave(figure_file, plot=choropleth_chart)
# }
choropleth_chart
```
```{r}
#chart_title <- "Household Economic Return on Energy Spending"
chart_title <- "Per Capita Income"
chart_subtitle <- "Per Census Tract"

group_columns <- c("geoid") #"income_bracket")#in_poverty
                   #"primary_heating_fuel"

metric_name <- "income_per_capita" #"energy_burden" #"ner" #"dear" #"eroi"
metric_label <- "$"
metric_cutoff_level <- median(selection_shp$income_per_capita, na.rm = T)
metric_cutoff_label <- ""

upper_quantile_view <- 1.0
lower_quantile_view <- 0.0

graph_data <- filter_graph_data(selection_shp, group_columns, metric_name)

# gwm <- grouped_weighted_metrics(graph_data,
#                          group_columns,
#                          metric_name,
#                          metric_cutoff_level,
#                          upper_quantile_view=1.0,#0.75,
#                          lower_quantile_view=0.0)#0.25)

gwm <- graph_data[,c("geoid", metric_name)]
gwm <- rename(gwm, metric_median = !!sym(metric_name))

map_data <- left_join(graph_data, st_drop_geometry(gwm), by=c("geoid"))

clean_top_metrics <- grouped_weighted_metrics(replica_sup %>% 
                                                filter(!(state_abbr %in% c("HI","AK", NA))),
                                              group_columns=NULL,
                                              metric_name,
                                              metric_cutoff_level,
                                              upper_quantile_view=1.0,
                                              lower_quantile_view=0.0)

choropleth_chart <- choropleth_map(
    clean_data=map_data,
    group_columns,
    metric_name,
    metric_label,
    metric_cutoff_level,
    metric_cutoff_label,
    upper_quantile_view,
    lower_quantile_view,
    chart_title,
    chart_subtitle,
    weighted_metrics=clean_top_metrics,
    include_basemap=FALSE)
  # ggsave(figure_file, plot=choropleth_chart)
# }
choropleth_chart
```



<!--chapter:end:Walkthrough.Rmd-->

